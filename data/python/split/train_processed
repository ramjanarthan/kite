#!/usr/bin/envஅpythonந"""நBroadlyஅspeaking,அthisஅscriptஅtakesஅtheஅaudioஅdownloadedஅfromஅCommonஅVoiceநforஅaஅcertainஅlanguage,அinஅadditionஅtoஅtheஅ*.tsvஅfilesஅoutputஅbyஅCorporaCreator,நandஅtheஅscriptஅformatsஅtheஅdataஅandஅtranscriptsஅtoஅbeஅinஅaஅstateஅusableஅbyநDeepSpeech.pyநUseஅ"python0அimport_cv0.pyஅ-h"அforஅhelpந"""நimportஅcsvநimportஅosநimportஅsubprocessநimportஅunicodedataநfromஅmultiprocessingஅimportஅPoolநநimportஅprogressbarநimportஅsoxநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BARநfromஅdeepspeech_training.util.importersஅimportஅ(நஅஅஅஅget_counter,நஅஅஅஅget_imported_samples,நஅஅஅஅget_importers_parser,நஅஅஅஅget_validate_label,நஅஅஅஅprint_import_report,ந)நfromஅds_ctcdecoderஅimportஅAlphabetநநFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நSAMPLE_RATEஅ=அ00000நCHANNELSஅ=அ0நMAX_SECSஅ=அ00நPARAMSஅ=அNoneநFILTER_OBJஅ=அNoneநநநclassஅLabelFilter:நஅஅஅஅdefஅ__init__(self,அnormalize,அalphabet,அvalidate_fun):நஅஅஅஅஅஅஅஅself.normalizeஅ=அnormalizeநஅஅஅஅஅஅஅஅself.alphabetஅ=அalphabetநஅஅஅஅஅஅஅஅself.validate_funஅ=அvalidate_funநநஅஅஅஅdefஅfilter(self,அlabel):நஅஅஅஅஅஅஅஅifஅself.normalize:நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அunicodedata.normalize("NFKD",அlabel.strip()).encode("ascii",அ"ignore").decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅlabelஅ=அself.validate_fun(label)நஅஅஅஅஅஅஅஅifஅself.alphabetஅandஅlabelஅandஅnotஅself.alphabet.CanEncode(label):நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அNoneநஅஅஅஅஅஅஅஅreturnஅlabelநநநdefஅinit_worker(params):நஅஅஅஅglobalஅFILTER_OBJஅஅ#அpylint:அdisable=global-statementநஅஅஅஅvalidate_labelஅ=அget_validate_label(params)நஅஅஅஅalphabetஅ=அAlphabet(params.filter_alphabet)அifஅparams.filter_alphabetஅelseஅNoneநஅஅஅஅFILTER_OBJஅ=அLabelFilter(params.normalize,அalphabet,அvalidate_label)நநநdefஅone_sample(sample):நஅஅஅஅ"""அTakeஅanஅaudioஅfile,அandஅoptionallyஅconvertஅitஅtoஅ00kHzஅWAVஅ"""நஅஅஅஅmp0_filenameஅ=அsample[0]நஅஅஅஅifஅnotஅos.path.splitext(mp0_filename.lower())[0]அ==அ".mp0":நஅஅஅஅஅஅஅஅmp0_filenameஅ+=அ".mp0"நஅஅஅஅ#அStoringஅwavஅfilesஅnextஅtoஅtheஅmp0அonesஅ-அjustஅwithஅaஅdifferentஅsuffixநஅஅஅஅwav_filenameஅ=அos.path.splitext(mp0_filename)[0]அ+அ".wav"நஅஅஅஅ_maybe_convert_wav(mp0_filename,அwav_filename)நஅஅஅஅfile_sizeஅ=அ-0நஅஅஅஅframesஅ=அ0நஅஅஅஅifஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅfile_sizeஅ=அos.path.getsize(wav_filename)நஅஅஅஅஅஅஅஅframesஅ=அint(நஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_output(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ["soxi",அ"-s",அwav_filename],அstderr=subprocess.STDOUTநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅ)நஅஅஅஅlabelஅ=அFILTER_OBJ.filter(sample[0])நஅஅஅஅrowsஅ=அ[]நஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅifஅfile_sizeஅ==அ-0:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅuponஅconversionநஅஅஅஅஅஅஅஅcounter["failed"]அ+=அ0நஅஅஅஅelifஅlabelஅisஅNone:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅonஅlabelஅvalidationநஅஅஅஅஅஅஅஅcounter["invalid_label"]அ+=அ0நஅஅஅஅelifஅint(framesஅ/அSAMPLE_RATEஅ*அ0000அ/அ00அ/அ0)அ<அlen(str(label)):நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅareஅtooஅshortஅtoஅfitஅtheஅtranscriptநஅஅஅஅஅஅஅஅcounter["too_short"]அ+=அ0நஅஅஅஅelifஅframesஅ/அSAMPLE_RATEஅ>அMAX_SECS:நஅஅஅஅஅஅஅஅ#அExcludingஅveryஅlongஅsamplesஅtoஅkeepஅaஅreasonableஅbatch-sizeநஅஅஅஅஅஅஅஅcounter["too_long"]அ+=அ0நஅஅஅஅelse:நஅஅஅஅஅஅஅஅ#அThisஅoneஅisஅgoodஅ-அkeepஅitஅforஅtheஅtargetஅCSVநஅஅஅஅஅஅஅஅrows.append((os.path.split(wav_filename)[-0],அfile_size,அlabel,அsample[0]))நஅஅஅஅஅஅஅஅcounter["imported_time"]அ+=அframesநஅஅஅஅcounter["all"]அ+=அ0நஅஅஅஅcounter["total_time"]அ+=அframesநநஅஅஅஅreturnஅ(counter,அrows)நநநdefஅ_maybe_convert_set(dataset,அtsv_dir,அaudio_dir,அfilter_obj,அspace_after_every_character=None,அrows=None,அexclude=None):நஅஅஅஅexclude_transcriptsஅ=அset()நஅஅஅஅexclude_speakersஅ=அset()நஅஅஅஅifஅexcludeஅisஅnotஅNone:நஅஅஅஅஅஅஅஅforஅsampleஅinஅexclude:நஅஅஅஅஅஅஅஅஅஅஅஅexclude_transcripts.add(sample[0])நஅஅஅஅஅஅஅஅஅஅஅஅexclude_speakers.add(sample[0])நநஅஅஅஅifஅrowsஅisஅNone:நஅஅஅஅஅஅஅஅrowsஅ=அ[]நஅஅஅஅஅஅஅஅinput_tsvஅ=அos.path.join(os.path.abspath(tsv_dir),அdatasetஅ+அ".tsv")நஅஅஅஅஅஅஅஅifஅnotஅos.path.isfile(input_tsv):நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅrowsநஅஅஅஅஅஅஅஅprint("LoadingஅTSVஅfile:அ",அinput_tsv)நஅஅஅஅஅஅஅஅ#அGetஅaudiofileஅpathஅandஅtranscriptஅforஅeachஅsentenceஅinஅtsvநஅஅஅஅஅஅஅஅsamplesஅ=அ[]நஅஅஅஅஅஅஅஅwithஅopen(input_tsv,அencoding="utf-0")அasஅinput_tsv_file:நஅஅஅஅஅஅஅஅஅஅஅஅreaderஅ=அcsv.DictReader(input_tsv_file,அdelimiter="\t")நஅஅஅஅஅஅஅஅஅஅஅஅforஅrowஅinஅreader:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsamples.append((os.path.join(audio_dir,அrow["path"]),அrow["sentence"],அrow["client_id"]))நநஅஅஅஅஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅஅஅஅஅnum_samplesஅ=அlen(samples)நநஅஅஅஅஅஅஅஅprint("Importingஅmp0அfiles...")நஅஅஅஅஅஅஅஅpoolஅ=அPool(initializer=init_worker,அinitargs=(PARAMS,))நஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅஅஅஅஅforஅi,அprocessedஅinஅenumerate(pool.imap_unordered(one_sample,அsamples),அstart=0):நஅஅஅஅஅஅஅஅஅஅஅஅcounterஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅஅஅஅஅrowsஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅஅஅஅஅbar.update(i)நஅஅஅஅஅஅஅஅbar.update(num_samples)நஅஅஅஅஅஅஅஅpool.close()நஅஅஅஅஅஅஅஅpool.join()நநஅஅஅஅஅஅஅஅimported_samplesஅ=அget_imported_samples(counter)நஅஅஅஅஅஅஅஅassertஅcounter["all"]அ==அnum_samplesநஅஅஅஅஅஅஅஅassertஅlen(rows)அ==அimported_samplesநஅஅஅஅஅஅஅஅprint_import_report(counter,அSAMPLE_RATE,அMAX_SECS)நநஅஅஅஅoutput_csvஅ=அos.path.join(os.path.abspath(audio_dir),அdatasetஅ+அ".csv")நஅஅஅஅprint("SavingஅnewஅDeepSpeech-formattedஅCSVஅfileஅto:அ",அoutput_csv)நஅஅஅஅwithஅopen(output_csv,அ"w",அencoding="utf-0",அnewline="")அasஅoutput_csv_file:நஅஅஅஅஅஅஅஅprint("WritingஅCSVஅfileஅforஅDeepSpeech.pyஅas:அ",அoutput_csv)நஅஅஅஅஅஅஅஅwriterஅ=அcsv.DictWriter(output_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅwriter.writeheader()நஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(rows),அwidgets=SIMPLE_BAR)நஅஅஅஅஅஅஅஅforஅfilename,அfile_size,அtranscript,அspeakerஅinஅbar(rows):நஅஅஅஅஅஅஅஅஅஅஅஅifஅtranscriptஅinஅexclude_transcriptsஅorஅspeakerஅinஅexclude_speakers:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅifஅspace_after_every_character:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filename":அfilename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filesize":அfile_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript":அ"அ".join(transcript),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filename":அfilename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filesize":அfile_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript":அtranscript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅreturnஅrowsநநநdefஅ_preprocess_data(tsv_dir,அaudio_dir,அspace_after_every_character=False):நஅஅஅஅexcludeஅ=அ[]நஅஅஅஅforஅdatasetஅinஅ["test",அ"dev",அ"train",அ"validated",அ"other"]:நஅஅஅஅஅஅஅஅset_samplesஅ=அ_maybe_convert_set(dataset,அtsv_dir,அaudio_dir,அspace_after_every_character)நஅஅஅஅஅஅஅஅifஅdatasetஅinஅ["test",அ"dev"]:நஅஅஅஅஅஅஅஅஅஅஅஅexcludeஅ+=அset_samplesநஅஅஅஅஅஅஅஅifஅdatasetஅ==அ"validated":நஅஅஅஅஅஅஅஅஅஅஅஅ_maybe_convert_set("train-all",அtsv_dir,அaudio_dir,அspace_after_every_character,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrows=set_samples,அexclude=exclude)நநநdefஅ_maybe_convert_wav(mp0_filename,அwav_filename):நஅஅஅஅifஅnotஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅtransformerஅ=அsox.Transformer()நஅஅஅஅஅஅஅஅtransformer.convert(samplerate=SAMPLE_RATE,அn_channels=CHANNELS)நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(mp0_filename,அwav_filename)நஅஅஅஅஅஅஅஅexceptஅsox.core.SoxError:நஅஅஅஅஅஅஅஅஅஅஅஅpassநநநdefஅparse_args():நஅஅஅஅparserஅ=அget_importers_parser(description="ImportஅCommonVoiceஅv0.0அcorpora")நஅஅஅஅparser.add_argument("tsv_dir",அhelp="Directoryஅcontainingஅtsvஅfiles")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--audio_dir",நஅஅஅஅஅஅஅஅhelp='Directoryஅcontainingஅtheஅaudioஅclipsஅ-அdefaultsஅtoஅ"<tsv_dir>/clips"',நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--filter_alphabet",நஅஅஅஅஅஅஅஅhelp="Excludeஅsamplesஅwithஅcharactersஅnotஅinஅprovidedஅalphabet",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--normalize",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Convertsஅdiacriticஅcharactersஅtoஅtheirஅbaseஅones",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--space_after_every_character",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Toஅhelpஅtranscriptஅjoinஅbyஅwhiteஅspace",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநdefஅmain():நஅஅஅஅaudio_dirஅ=அPARAMS.audio_dirஅifஅPARAMS.audio_dirஅelseஅos.path.join(PARAMS.tsv_dir,அ"clips")நஅஅஅஅ_preprocess_data(PARAMS.tsv_dir,அaudio_dir,அPARAMS.space_after_every_character)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅPARAMSஅ=அparse_args()நஅஅஅஅmain()ந#!/usr/bin/envஅpythonநimportஅcodecsநimportஅfnmatchநimportஅosநimportஅrandomநimportஅsubprocessநimportஅsysநimportஅunicodedataநநimportஅlibrosaநimportஅpandasநimportஅsoundfileஅஅ#அ<=அHasஅanஅexternalஅdependencyஅonஅlibsndfileநநfromஅdeepspeech_training.util.importersஅimportஅvalidate_label_engஅasஅvalidate_labelநந#அPrerequisite:அHavingஅtheஅsph0pipeஅtoolஅinஅyourஅPATH:ந#அhttps://www.ldc.upenn.edu/language-resources/tools/sphere-conversion-toolsநநநdefஅ_download_and_preprocess_data(data_dir):நஅஅஅஅ#அAssumeஅdata_dirஅcontainsஅextractedஅLDC0000S00,அLDC0000T00,அLDC0000S00,அLDC0000T00நநஅஅஅஅ#அConditionallyஅconvertஅFisherஅsphஅdataஅtoஅwavநஅஅஅஅ_maybe_convert_wav(data_dir,அ"LDC0000S00",அ"fisher-0000-wav")நஅஅஅஅ_maybe_convert_wav(data_dir,அ"LDC0000S00",அ"fisher-0000-wav")நநஅஅஅஅ#அConditionallyஅsplitஅFisherஅwavஅdataநஅஅஅஅall_0000அ=அ_split_wav_and_sentences(நஅஅஅஅஅஅஅஅdata_dir,நஅஅஅஅஅஅஅஅoriginal_data="fisher-0000-wav",நஅஅஅஅஅஅஅஅconverted_data="fisher-0000-split-wav",நஅஅஅஅஅஅஅஅtrans_data=os.path.join("LDC0000T00",அ"fe_00_p0_tran",அ"data",அ"trans"),நஅஅஅஅ)நஅஅஅஅall_0000அ=அ_split_wav_and_sentences(நஅஅஅஅஅஅஅஅdata_dir,நஅஅஅஅஅஅஅஅoriginal_data="fisher-0000-wav",நஅஅஅஅஅஅஅஅconverted_data="fisher-0000-split-wav",நஅஅஅஅஅஅஅஅtrans_data=os.path.join("LDC0000T00",அ"fe_00_p0_tran",அ"data",அ"trans"),நஅஅஅஅ)நநஅஅஅஅ#அTheஅfollowingஅfilesஅhaveஅincorrectஅtranscriptsஅthatஅareஅmuchஅlongerஅthanநஅஅஅஅ#அtheirஅaudioஅsource.அTheஅresultஅisஅthatஅweஅendஅupஅwithஅmoreஅlabelsஅthanஅtimeநஅஅஅஅ#அslices,அwhichஅbreaksஅCTC.நஅஅஅஅall_0000.loc[நஅஅஅஅஅஅஅஅall_0000["wav_filename"].str.endswith("fe_00_00000-00.00-00.00.wav"),நஅஅஅஅஅஅஅஅ"transcript",நஅஅஅஅ]அ=அ"correct"நஅஅஅஅall_0000.loc[நஅஅஅஅஅஅஅஅall_0000["wav_filename"].str.endswith("fe_00_00000-000.00-000.0.wav"),நஅஅஅஅஅஅஅஅ"transcript",நஅஅஅஅ]அ=அ"that'sஅoneஅofஅthose"நஅஅஅஅall_0000.loc[நஅஅஅஅஅஅஅஅall_0000["wav_filename"].str.endswith("fe_00_00000-000.00-000.00.wav"),நஅஅஅஅஅஅஅஅ"transcript",நஅஅஅஅ]அ=அ"theyஅdon'tஅwant"நஅஅஅஅall_0000.loc[நஅஅஅஅஅஅஅஅall_0000["wav_filename"].str.endswith("fe_00_00000-000.00-000.00.wav"),நஅஅஅஅஅஅஅஅ"transcript",நஅஅஅஅ]அ=அ"uhஅmyஅmineஅyeahஅtheஅgermanஅshepherdஅpitbullஅmixஅheஅsnoresஅalmostஅasஅloudஅasஅiஅdo"நநஅஅஅஅ#அTheஅfollowingஅfileஅisஅjustஅaஅshortஅsoundஅandஅnotஅatஅallஅtranscribedஅlikeஅprovided.நஅஅஅஅ#அSoஅweஅjustஅexcludeஅit.நஅஅஅஅall_0000அ=அall_0000[நஅஅஅஅஅஅஅஅ~all_0000["wav_filename"].str.endswith("fe_00_00000-000.0-000.00.wav")நஅஅஅஅ]நநஅஅஅஅ#அTheஅfollowingஅfileஅisஅfarஅtooஅlongஅandஅwouldஅruinஅourஅtrainingஅbatchஅsize.நஅஅஅஅ#அSoஅweஅjustஅexcludeஅit.நஅஅஅஅall_0000அ=அall_0000[நஅஅஅஅஅஅஅஅ~all_0000["wav_filename"].str.endswith("fe_00_00000-00.00-000.00.wav")நஅஅஅஅ]நநஅஅஅஅ#அTheஅfollowingஅfileஅisஅtooஅlargeஅforஅitsஅtranscript,அsoஅweஅjustஅexcludeஅit.நஅஅஅஅall_0000அ=அall_0000[நஅஅஅஅஅஅஅஅ~all_0000["wav_filename"].str.endswith("fe_00_00000-000.00-000.00.wav")நஅஅஅஅ]நநஅஅஅஅ#அConditionallyஅsplitஅFisherஅdataஅintoஅtrain/validation/testஅsetsநஅஅஅஅtrain_0000,அdev_0000,அtest_0000அ=அ_split_sets(all_0000)நஅஅஅஅtrain_0000,அdev_0000,அtest_0000அ=அ_split_sets(all_0000)நநஅஅஅஅ#அJoinஅ0000அandஅ0000அdataநஅஅஅஅtrain_filesஅ=அtrain_0000.append(train_0000)நஅஅஅஅdev_filesஅ=அdev_0000.append(dev_0000)நஅஅஅஅtest_filesஅ=அtest_0000.append(test_0000)நநஅஅஅஅ#அWriteஅsetsஅtoஅdiskஅasஅCSVஅfilesநஅஅஅஅtrain_files.to_csv(os.path.join(data_dir,அ"fisher-train.csv"),அindex=False)நஅஅஅஅdev_files.to_csv(os.path.join(data_dir,அ"fisher-dev.csv"),அindex=False)நஅஅஅஅtest_files.to_csv(os.path.join(data_dir,அ"fisher-test.csv"),அindex=False)நநநdefஅ_maybe_convert_wav(data_dir,அoriginal_data,அconverted_data):நஅஅஅஅsource_dirஅ=அos.path.join(data_dir,அoriginal_data)நஅஅஅஅtarget_dirஅ=அos.path.join(data_dir,அconverted_data)நநஅஅஅஅ#அConditionallyஅconvertஅsphஅfilesஅtoஅwavஅfilesநஅஅஅஅifஅos.path.exists(target_dir):நஅஅஅஅஅஅஅஅprint("skippingஅmaybe_convert_wav")நஅஅஅஅஅஅஅஅreturnநநஅஅஅஅ#அCreateஅtarget_dirநஅஅஅஅos.makedirs(target_dir)நநஅஅஅஅ#அLoopஅoverஅsphஅfilesஅinஅsource_dirஅandஅconvertஅeachஅtoஅ00-bitஅPCMஅwavநஅஅஅஅforஅroot,அdirnames,அfilenamesஅinஅos.walk(source_dir):நஅஅஅஅஅஅஅஅforஅfilenameஅinஅfnmatch.filter(filenames,அ"*.sph"):நஅஅஅஅஅஅஅஅஅஅஅஅsph_fileஅ=அos.path.join(root,அfilename)நஅஅஅஅஅஅஅஅஅஅஅஅforஅchannelஅinஅ["0",அ"0"]:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.splitext(os.path.basename(sph_file))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"_c"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அchannelநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ".wav"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_fileஅ=அos.path.join(target_dir,அwav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("convertingஅ{}அtoஅ{}".format(sph_file,அwav_file))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_call(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ["sph0pipe",அ"-c",அchannel,அ"-p",அ"-f",அ"rif",அsph_file,அwav_file]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநநdefஅ_parse_transcriptions(trans_file):நஅஅஅஅsegmentsஅ=அ[]நஅஅஅஅwithஅcodecs.open(trans_file,அ"r",அ"utf-0")அasஅfin:நஅஅஅஅஅஅஅஅforஅlineஅinஅfin:நஅஅஅஅஅஅஅஅஅஅஅஅifஅline.startswith("#")அorஅlen(line)அ<=அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅஅஅஅஅtokensஅ=அline.split()நஅஅஅஅஅஅஅஅஅஅஅஅstart_timeஅ=அfloat(tokens[0])நஅஅஅஅஅஅஅஅஅஅஅஅstop_timeஅ=அfloat(tokens[0])நஅஅஅஅஅஅஅஅஅஅஅஅspeakerஅ=அtokens[0]நஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அ"அ".join(tokens[0:])நநஅஅஅஅஅஅஅஅஅஅஅஅ#அWeஅneedஅtoஅdoஅtheஅencode-decodeஅdanceஅhereஅbecauseஅencodeநஅஅஅஅஅஅஅஅஅஅஅஅ#அreturnsஅaஅbytes()அobjectஅonஅPythonஅ0,அandஅtext_to_char_arrayநஅஅஅஅஅஅஅஅஅஅஅஅ#அexpectsஅaஅstring.நஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅunicodedata.normalize("NFKD",அtranscript)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅஅஅஅஅsegments.append(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"start_time":அstart_time,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"stop_time":அstop_time,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"speaker":அspeaker,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript":அtranscript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅreturnஅsegmentsநநநdefஅ_split_wav_and_sentences(data_dir,அtrans_data,அoriginal_data,அconverted_data):நஅஅஅஅtrans_dirஅ=அos.path.join(data_dir,அtrans_data)நஅஅஅஅsource_dirஅ=அos.path.join(data_dir,அoriginal_data)நஅஅஅஅtarget_dirஅ=அos.path.join(data_dir,அconverted_data)நஅஅஅஅifஅnotஅos.path.exists(target_dir):நஅஅஅஅஅஅஅஅos.makedirs(target_dir)நநஅஅஅஅfilesஅ=அ[]நநஅஅஅஅ#அLoopஅoverஅtranscriptionஅfilesஅandஅsplitஅcorrespondingஅwavநஅஅஅஅforஅroot,அdirnames,அfilenamesஅinஅos.walk(trans_dir):நஅஅஅஅஅஅஅஅforஅfilenameஅinஅfnmatch.filter(filenames,அ"*.txt"):நஅஅஅஅஅஅஅஅஅஅஅஅtrans_fileஅ=அos.path.join(root,அfilename)நஅஅஅஅஅஅஅஅஅஅஅஅsegmentsஅ=அ_parse_transcriptions(trans_file)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அOpenஅwavஅcorrespondingஅtoஅtranscriptionஅfileநஅஅஅஅஅஅஅஅஅஅஅஅwav_filenamesஅ=அ[நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.splitext(os.path.basename(trans_file))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"_c"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அchannelநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ".wav"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅchannelஅinஅ["0",அ"0"]நஅஅஅஅஅஅஅஅஅஅஅஅ]நஅஅஅஅஅஅஅஅஅஅஅஅwav_filesஅ=அ[நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(source_dir,அwav_filename)அforஅwav_filenameஅinஅwav_filenamesநஅஅஅஅஅஅஅஅஅஅஅஅ]நநஅஅஅஅஅஅஅஅஅஅஅஅprint("splittingஅ{}அaccordingஅtoஅ{}".format(wav_files,அtrans_file))நநஅஅஅஅஅஅஅஅஅஅஅஅorigAudiosஅ=அ[நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlibrosa.load(wav_file,அsr=00000,அmono=False)அforஅwav_fileஅinஅwav_filesநஅஅஅஅஅஅஅஅஅஅஅஅ]நநஅஅஅஅஅஅஅஅஅஅஅஅ#அLoopஅoverஅsegmentsஅandஅsplitஅwav_fileஅforஅeachஅsegmentநஅஅஅஅஅஅஅஅஅஅஅஅforஅsegmentஅinஅsegments:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அCreateஅwavஅsegmentஅfilenameநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstart_timeஅ=அsegment["start_time"]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstop_timeஅ=அsegment["stop_time"]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_filenameஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.splitext(os.path.basename(trans_file))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அstr(start_time)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அstr(stop_time)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ".wav"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_fileஅ=அos.path.join(target_dir,அnew_wav_filename)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅchannelஅ=அ0அifஅsegment["speaker"]அ==அ"A:"அelseஅ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ_split_and_resample_wav(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅorigAudios[channel],அstart_time,அstop_time,அnew_wav_fileநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_filesizeஅ=அos.path.getsize(new_wav_file)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அvalidate_label(segment["transcript"])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅtranscriptஅ!=அNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfiles.append(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(os.path.abspath(new_wav_file),அnew_wav_filesize,அtranscript)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅreturnஅpandas.DataFrame(நஅஅஅஅஅஅஅஅdata=files,அcolumns=["wav_filename",அ"wav_filesize",அ"transcript"]நஅஅஅஅ)நநநdefஅ_split_audio(origAudio,அstart_time,அstop_time):நஅஅஅஅaudioData,அframeRateஅ=அorigAudioநஅஅஅஅnChannelsஅ=அlen(audioData.shape)நஅஅஅஅstartIndexஅ=அint(start_timeஅ*அframeRate)நஅஅஅஅstopIndexஅ=அint(stop_timeஅ*அframeRate)நஅஅஅஅreturnஅ(நஅஅஅஅஅஅஅஅaudioData[startIndex:stopIndex]நஅஅஅஅஅஅஅஅifஅ0அ==அnChannelsநஅஅஅஅஅஅஅஅelseஅaudioData[:,அstartIndex:stopIndex]நஅஅஅஅ)நநநdefஅ_split_and_resample_wav(origAudio,அstart_time,அstop_time,அnew_wav_file):நஅஅஅஅframeRateஅ=அorigAudio[0]நஅஅஅஅchunkDataஅ=அ_split_audio(origAudio,அstart_time,அstop_time)நஅஅஅஅsoundfile.write(new_wav_file,அchunkData,அframeRate,அ"PCM_00")நநநdefஅ_split_sets(filelist):நஅஅஅஅ"""நஅஅஅஅrandomplyஅsplitஅtheஅdatasetsஅintoஅtrain,அvalidation,அandஅtestஅsetsஅwhereஅtheஅsizeஅofஅtheநஅஅஅஅvalidationஅandஅtestஅsetsஅareஅdeterminedஅbyஅtheஅ`get_sample_size`அfunction.அநஅஅஅஅ"""நஅஅஅஅrandom.shuffle(filelist)நஅஅஅஅsample_sizeஅ=அget_sample_size(len(filelist))நநஅஅஅஅtrain_begஅ=அ0நஅஅஅஅtrain_endஅ=அlen(filelist)அ-அ0அ*அsample_sizeநநஅஅஅஅdev_begஅ=அtrain_endநஅஅஅஅdev_endஅ=அtrain_endஅ+அsample_sizeநநஅஅஅஅtest_begஅ=அdev_endநஅஅஅஅtest_endஅ=அlen(filelist)நநஅஅஅஅreturnஅ(நஅஅஅஅஅஅஅஅfilelist[train_beg:train_end],நஅஅஅஅஅஅஅஅfilelist[dev_beg:dev_end],நஅஅஅஅஅஅஅஅfilelist[test_beg:test_end],நஅஅஅஅ)நநநdefஅget_sample_size(population_size):நஅஅஅஅ"""calculatesஅtheஅsampleஅsizeஅforஅaஅ00%அconfidenceஅandஅ0%அmarginஅofஅerrorநஅஅஅஅ"""நஅஅஅஅmargin_of_errorஅ=அ0.00நஅஅஅஅfraction_pickingஅ=அ0.00நஅஅஅஅz_scoreஅ=அ0.00அஅ#அCorrespondsஅtoஅconfidenceஅlevelஅ00%நஅஅஅஅnumeratorஅ=அ(z_scoreஅ**அ0அ*அfraction_pickingஅ*அ(0அ-அfraction_picking))அ/அ(நஅஅஅஅஅஅஅஅmargin_of_errorஅ**அ0நஅஅஅஅ)நஅஅஅஅsample_sizeஅ=அ0நஅஅஅஅforஅtrain_sizeஅinஅrange(population_size,அ0,அ-0):நஅஅஅஅஅஅஅஅdenominatorஅ=அ0அ+அ(z_scoreஅ**அ0அ*அfraction_pickingஅ*அ(0அ-அfraction_picking))அ/அ(நஅஅஅஅஅஅஅஅஅஅஅஅmargin_of_errorஅ**அ0அ*அtrain_sizeநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅsample_sizeஅ=அint(numeratorஅ/அdenominator)நஅஅஅஅஅஅஅஅifஅ0அ*அsample_sizeஅ+அtrain_sizeஅ<=அpopulation_size:நஅஅஅஅஅஅஅஅஅஅஅஅbreakநஅஅஅஅreturnஅsample_sizeநநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_download_and_preprocess_data(sys.argv[0])ந#!/usr/bin/envஅpythonந#அ-*-அcoding:அutf-0அ-*-நநimportஅsysநநimportஅtensorflow.compat.v0அasஅtfv0நfromஅgoogle.protobufஅimportஅtext_formatநநநdefஅmain():நஅஅஅஅ#அLoadஅandஅexportஅasஅstringநஅஅஅஅwithஅtfv0.gfile.FastGFile(sys.argv[0],அ"rb")அasஅfin:நஅஅஅஅஅஅஅஅgraph_defஅ=அtfv0.GraphDef()நஅஅஅஅஅஅஅஅgraph_def.ParseFromString(fin.read())நநஅஅஅஅஅஅஅஅwithஅtfv0.gfile.FastGFile(sys.argv[0]அ+அ"txt",அ"w")அasஅfout:நஅஅஅஅஅஅஅஅஅஅஅஅfout.write(text_format.MessageToString(graph_def))நநநifஅ__name__அ==அ"__main__":நஅஅஅஅmain()ந#!/usr/bin/envஅpythonந#அVCTKஅusedஅinஅwavenetஅpaperஅhttps://arxiv.org/pdf/0000.00000.pdfந#அLicencedஅunderஅOpenஅDataஅCommonsஅAttributionஅLicenseஅ(ODC-By)அv0.0.ந#அasஅperஅhttps://homepages.inf.ed.ac.uk/jyamagis/page0/page00/page00.htmlநimportஅosநimportஅrandomநimportஅreநfromஅmultiprocessingஅimportஅPoolநfromஅzipfileஅimportஅZipFileநநimportஅlibrosaநimportஅprogressbarநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.importersஅimportஅ(நஅஅஅஅget_counter,நஅஅஅஅget_imported_samples,நஅஅஅஅprint_import_report,ந)நநSAMPLE_RATEஅ=அ00000நMAX_SECSஅ=அ00நMIN_SECSஅ=அ0நARCHIVE_DIR_NAMEஅ=அ"VCTK-Corpus"நARCHIVE_NAMEஅ=அ"VCTK-Corpus.zip?sequence=0&isAllowed=y"நARCHIVE_URLஅ=அ(நஅஅஅஅ"https://datashare.is.ed.ac.uk/bitstream/handle/00000/0000/"அ+அARCHIVE_NAMEந)நநநdefஅ_download_and_preprocess_data(target_dir):நஅஅஅஅ#அMakingஅpathஅabsoluteநஅஅஅஅtarget_dirஅ=அos.path.abspath(target_dir)நஅஅஅஅ#அConditionallyஅdownloadஅdataநஅஅஅஅarchive_pathஅ=அmaybe_download(ARCHIVE_NAME,அtarget_dir,அARCHIVE_URL)நஅஅஅஅ#அConditionallyஅextractஅcommonஅvoiceஅdataநஅஅஅஅ_maybe_extract(target_dir,அARCHIVE_DIR_NAME,அarchive_path)நஅஅஅஅ#அConditionallyஅconvertஅcommonஅvoiceஅCSVஅfilesஅandஅmp0அdataஅtoஅDeepSpeechஅCSVsஅandஅwavநஅஅஅஅ_maybe_convert_sets(target_dir,அARCHIVE_DIR_NAME)நநநdefஅ_maybe_extract(target_dir,அextracted_data,அarchive_path):நஅஅஅஅ#அIfஅtarget_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅtarget_dirநஅஅஅஅextracted_pathஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅifஅnotஅos.path.exists(extracted_path):நஅஅஅஅஅஅஅஅprint(f"Noஅdirectoryஅ{extracted_path}அ-அextractingஅarchive...")நஅஅஅஅஅஅஅஅwithஅZipFile(archive_path,அ"r")அasஅzipobj:நஅஅஅஅஅஅஅஅஅஅஅஅ#அExtractஅallஅtheஅcontentsஅofஅzipஅfileஅinஅcurrentஅdirectoryநஅஅஅஅஅஅஅஅஅஅஅஅzipobj.extractall(target_dir)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint(f"Foundஅdirectoryஅ{extracted_path}அ-அnotஅextractingஅitஅfromஅarchive.")நநநdefஅ_maybe_convert_sets(target_dir,அextracted_data):நஅஅஅஅextracted_dirஅ=அos.path.join(target_dir,அextracted_data,அ"wav00")நஅஅஅஅtxt_dirஅ=அos.path.join(target_dir,அextracted_data,அ"txt")நநஅஅஅஅdirectoryஅ=அos.path.expanduser(extracted_dir)நஅஅஅஅsrtdஅ=அlen(sorted(os.listdir(directory)))நஅஅஅஅall_samplesஅ=அ[]நநஅஅஅஅforஅtargetஅinஅsorted(os.listdir(directory)):நஅஅஅஅஅஅஅஅall_samplesஅ+=அ_maybe_prepare_set(நஅஅஅஅஅஅஅஅஅஅஅஅpath.join(extracted_dir,அos.path.split(target)[-0])நஅஅஅஅஅஅஅஅ)நநஅஅஅஅnum_samplesஅ=அlen(all_samples)நஅஅஅஅprint(f"Convertingஅwavஅfilesஅtoஅ{SAMPLE_RATE}hz...")நஅஅஅஅpoolஅ=அPool()நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅforஅi,அ_அinஅenumerate(pool.imap_unordered(one_sample,அall_samples),அstart=0):நஅஅஅஅஅஅஅஅbar.update(i)நஅஅஅஅbar.update(num_samples)நஅஅஅஅpool.close()நஅஅஅஅpool.join()நநஅஅஅஅ_write_csv(extracted_dir,அtxt_dir,அtarget_dir)நநநdefஅone_sample(sample):நஅஅஅஅifஅis_audio_file(sample):நஅஅஅஅஅஅஅஅy,அsrஅ=அlibrosa.load(sample,அsr=00000)நநஅஅஅஅஅஅஅஅ#அTrimஅtheஅbeginningஅandஅendingஅsilenceநஅஅஅஅஅஅஅஅyt,அindexஅ=அlibrosa.effects.trim(y)அஅ#அpylint:அdisable=unused-variableநநஅஅஅஅஅஅஅஅdurationஅ=அlibrosa.get_duration(yt,அsr)நஅஅஅஅஅஅஅஅifஅdurationஅ>அMAX_SECSஅorஅdurationஅ<அMIN_SECS:நஅஅஅஅஅஅஅஅஅஅஅஅos.remove(sample)நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅlibrosa.output.write_wav(sample,அyt,அsr)நநநdefஅ_maybe_prepare_set(target_csv):நஅஅஅஅsamplesஅ=அsorted(os.listdir(target_csv))நஅஅஅஅnew_samplesஅ=அ[]நஅஅஅஅforஅsஅinஅsamples:நஅஅஅஅஅஅஅஅnew_samples.append(os.path.join(target_csv,அs))நஅஅஅஅsamplesஅ=அnew_samplesநஅஅஅஅreturnஅsamplesநநநdefஅ_write_csv(extracted_dir,அtxt_dir,அtarget_dir):நஅஅஅஅprint(f"WritingஅCSVஅfile")நஅஅஅஅdset_abs_pathஅ=அextracted_dirநஅஅஅஅdset_txt_abs_pathஅ=அtxt_dirநநஅஅஅஅaudiosஅ=அmake_manifest(dset_abs_path)நஅஅஅஅutterencesஅ=அload_txts(dset_txt_abs_path)நநஅஅஅஅcsvஅ=அ[]நநஅஅஅஅforஅfileஅinஅaudios:நநஅஅஅஅஅஅஅஅstஅ=அos.stat(file)நஅஅஅஅஅஅஅஅfile_sizeஅ=அst.st_sizeநநஅஅஅஅஅஅஅஅ#அSeemsஅtoஅbeஅoneஅwavஅdirectoryஅmissingஅfromஅtxtsஅ-அskipஅitநஅஅஅஅஅஅஅஅfile_partsஅ=அfile.split(os.sep)நஅஅஅஅஅஅஅஅfile_subdirஅ=அfile_parts[-0]நஅஅஅஅஅஅஅஅifஅfile_subdirஅ==அ"p000":நஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅfile_nameஅ=அfile_parts[-0]நஅஅஅஅஅஅஅஅfile_name_no_extஅ=அfile_name.split(".")[0]நநஅஅஅஅஅஅஅஅutterenceஅ=அutterences[file_name_no_ext]நஅஅஅஅஅஅஅஅutterence_cleanஅ=அre.sub(r"[^a-zA-Z'அ]+",அ"",அutterence).lower().strip()நநஅஅஅஅஅஅஅஅcsv_lineஅ=அf"{file},{file_size},{utterence_clean}\n"நஅஅஅஅஅஅஅஅcsv.append(csv_line)நநஅஅஅஅrandom.seed(0000)நஅஅஅஅrandom.shuffle(csv)நநஅஅஅஅtrain_dataஅ=அcsv[:00000]நஅஅஅஅdev_dataஅ=அcsv[00000:00000]நஅஅஅஅtest_dataஅ=அcsv[00000:]நநஅஅஅஅwithஅopen(os.path.join(target_dir,அ"vctk_full.csv"),அ"w")அasஅfd:நஅஅஅஅஅஅஅஅfd.write("wav_filename,wav_filesize,transcript\n")நஅஅஅஅஅஅஅஅforஅiஅinஅcsv:நஅஅஅஅஅஅஅஅஅஅஅஅfd.write(i)நஅஅஅஅwithஅopen(os.path.join(target_dir,அ"vctk_train.csv"),அ"w")அasஅfd:நஅஅஅஅஅஅஅஅfd.write("wav_filename,wav_filesize,transcript\n")நஅஅஅஅஅஅஅஅforஅiஅinஅtrain_data:நஅஅஅஅஅஅஅஅஅஅஅஅfd.write(i)நஅஅஅஅwithஅopen(os.path.join(target_dir,அ"vctk_dev.csv"),அ"w")அasஅfd:நஅஅஅஅஅஅஅஅfd.write("wav_filename,wav_filesize,transcript\n")நஅஅஅஅஅஅஅஅforஅiஅinஅdev_data:நஅஅஅஅஅஅஅஅஅஅஅஅfd.write(i)நஅஅஅஅwithஅopen(os.path.join(target_dir,அ"vctk_test.csv"),அ"w")அasஅfd:நஅஅஅஅஅஅஅஅfd.write("wav_filename,wav_filesize,transcript\n")நஅஅஅஅஅஅஅஅforஅiஅinஅtest_data:நஅஅஅஅஅஅஅஅஅஅஅஅfd.write(i)நநஅஅஅஅprint(f"Wroteஅ{len(csv)}அentries")நநநdefஅmake_manifest(directory):நஅஅஅஅaudiosஅ=அ[]நஅஅஅஅdirectoryஅ=அos.path.expanduser(directory)நஅஅஅஅforஅtargetஅinஅsorted(os.listdir(directory)):நஅஅஅஅஅஅஅஅdஅ=அos.path.join(directory,அtarget)நஅஅஅஅஅஅஅஅifஅnotஅos.path.isdir(d):நஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅforஅroot,அ_,அfnamesஅinஅsorted(os.walk(d)):நஅஅஅஅஅஅஅஅஅஅஅஅforஅfnameஅinஅfnames:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnew_pathஅ=அos.path.join(root,அfname)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅitemஅ=அnew_pathநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudios.append(item)நஅஅஅஅreturnஅaudiosநநநdefஅload_txts(directory):நஅஅஅஅutterencesஅ=அdict()நஅஅஅஅdirectoryஅ=அos.path.expanduser(directory)நஅஅஅஅforஅtargetஅinஅsorted(os.listdir(directory)):நஅஅஅஅஅஅஅஅdஅ=அos.path.join(directory,அtarget)நஅஅஅஅஅஅஅஅifஅnotஅos.path.isdir(d):நஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅforஅroot,அ_,அfnamesஅinஅsorted(os.walk(d)):நஅஅஅஅஅஅஅஅஅஅஅஅforஅfnameஅinஅfnames:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅfname.endswith(".txt"):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen(os.path.join(root,அfname),அ"r")அasஅf:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfname_no_extஅ=அos.path.basename(fname).rsplit(".",அ0)[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅutterences[fname_no_ext]அ=அf.readline()நஅஅஅஅreturnஅutterencesநநநAUDIO_EXTENSIONSஅ=அ[".wav",அ"WAV"]நநநdefஅis_audio_file(filepath):நஅஅஅஅreturnஅany(நஅஅஅஅஅஅஅஅos.path.basename(filepath).endswith(extension)அforஅextensionஅinஅAUDIO_EXTENSIONSநஅஅஅஅ)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_download_and_preprocess_data(sys.argv[0])ந#!/usr/bin/envஅpythonநந"""நஅஅஅஅNAMEஅஅஅஅ:அLDCஅTIMITஅDatasetநஅஅஅஅURLஅஅஅஅஅ:அhttps://catalog.ldc.upenn.edu/ldc00s0நஅஅஅஅHOURSஅஅஅ:அ0நஅஅஅஅTYPEஅஅஅஅ:அReadஅ-அEnglishநஅஅஅஅAUTHORSஅ:அGarofolo,அJohn,அetஅal.நஅஅஅஅTYPEஅஅஅஅ:அLDCஅMembershipநஅஅஅஅLICENCEஅ:அLDCஅUserஅAgreementந"""நநimportஅerrnoநimportஅfnmatchநimportஅosநimportஅsubprocessநimportஅsysநimportஅtarfileநfromஅosஅimportஅpathநநimportஅpandasஅasஅpdநநநdefஅclean(word):நஅஅஅஅ#அLCஅALLஅ&அstripஅpunctuationஅwhichஅareஅnotஅrequiredநஅஅஅஅnewஅ=அword.lower().replace(".",அ"")நஅஅஅஅnewஅ=அnew.replace(",",அ"")நஅஅஅஅnewஅ=அnew.replace(";",அ"")நஅஅஅஅnewஅ=அnew.replace('"',அ"")நஅஅஅஅnewஅ=அnew.replace("!",அ"")நஅஅஅஅnewஅ=அnew.replace("?",அ"")நஅஅஅஅnewஅ=அnew.replace(":",அ"")நஅஅஅஅnewஅ=அnew.replace("-",அ"")நஅஅஅஅreturnஅnewநநநdefஅ_preprocess_data(args):நநஅஅஅஅ#அAssumeஅdataஅisஅdownloadedஅfromஅLDCஅ-அhttps://catalog.ldc.upenn.edu/ldc00s0நநஅஅஅஅ#அSAஅsentencesஅareஅrepeatedஅthroughoutஅbyஅeachஅspeakerஅthereforeஅcanஅbeஅremovedஅforஅASRஅasஅtheyஅwillஅaffectஅWERநஅஅஅஅignoreSASentencesஅ=அTrueநநஅஅஅஅifஅignoreSASentences:நஅஅஅஅஅஅஅஅprint("UsingஅrecommendedஅignoreஅSAஅsentences")நஅஅஅஅஅஅஅஅprint(நஅஅஅஅஅஅஅஅஅஅஅஅ"IgnoringஅSAஅsentencesஅ(0அxஅsentencesஅwhichஅareஅrepeatedஅbyஅallஅspeakers)"நஅஅஅஅஅஅஅஅ)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint("UsingஅunrecommendedஅsettingஅtoஅincludeஅSAஅsentences")நநஅஅஅஅdatapathஅ=அargsநஅஅஅஅtargetஅ=அpath.join(datapath,அ"TIMIT")நஅஅஅஅprint(நஅஅஅஅஅஅஅஅ"Checkingஅtoஅseeஅifஅdataஅhasஅalreadyஅbeenஅextractedஅinஅgivenஅargument:அ%s",நஅஅஅஅஅஅஅஅtarget,நஅஅஅஅ)நநஅஅஅஅifஅnotஅpath.isdir(target):நஅஅஅஅஅஅஅஅprint(நஅஅஅஅஅஅஅஅஅஅஅஅ"Couldஅnotஅfindஅextractedஅdata,அtryingஅtoஅfind:அTIMIT-LDC00S0.tgzஅin:அ",நஅஅஅஅஅஅஅஅஅஅஅஅdatapath,நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅfilepathஅ=அpath.join(datapath,அ"TIMIT-LDC00S0.tgz")நஅஅஅஅஅஅஅஅifஅpath.isfile(filepath):நஅஅஅஅஅஅஅஅஅஅஅஅprint("Fileஅfound,அextracting")நஅஅஅஅஅஅஅஅஅஅஅஅtarஅ=அtarfile.open(filepath)நஅஅஅஅஅஅஅஅஅஅஅஅtar.extractall(target)நஅஅஅஅஅஅஅஅஅஅஅஅtar.close()நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅprint("FileஅshouldஅbeஅdownloadedஅfromஅLDCஅandஅplacedஅat:",அfilepath)நஅஅஅஅஅஅஅஅஅஅஅஅstrerrorஅ=அ"Fileஅnotஅfound"நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅIOError(errno,அstrerror,அfilepath)நநஅஅஅஅelse:நஅஅஅஅஅஅஅஅ#அisஅpathஅthereforeஅcontinueநஅஅஅஅஅஅஅஅprint("Foundஅextractedஅdataஅin:அ",அtarget)நநஅஅஅஅprint("Preprocessingஅdata")நஅஅஅஅ#அWeஅconvertஅtheஅ.WAVஅ(NISTஅsphereஅformat)அintoஅMSOFTஅ.wavநஅஅஅஅ#அcreatesஅ_rif.wavஅasஅtheஅnewஅ.wavஅfileநஅஅஅஅforஅroot,அdirnames,அfilenamesஅinஅos.walk(target):நஅஅஅஅஅஅஅஅforஅfilenameஅinஅfnmatch.filter(filenames,அ"*.WAV"):நஅஅஅஅஅஅஅஅஅஅஅஅsph_fileஅ=அos.path.join(root,அfilename)நஅஅஅஅஅஅஅஅஅஅஅஅwav_fileஅ=அos.path.join(root,அfilename)[:-0]அ+அ"_rif.wav"நஅஅஅஅஅஅஅஅஅஅஅஅprint("convertingஅ{}அtoஅ{}".format(sph_file,அwav_file))நஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_call(["sox",அsph_file,அwav_file])நநஅஅஅஅprint("PreprocessingஅComplete")நஅஅஅஅprint("BuildingஅCSVs")நநஅஅஅஅ#அListsஅtoஅbuildஅCSVஅfilesநஅஅஅஅtrain_list_wavs,அtrain_list_trans,அtrain_list_sizeஅ=அ[],அ[],அ[]நஅஅஅஅtest_list_wavs,அtest_list_trans,அtest_list_sizeஅ=அ[],அ[],அ[]நநஅஅஅஅforஅroot,அdirnames,அfilenamesஅinஅos.walk(target):நஅஅஅஅஅஅஅஅforஅfilenameஅinஅfnmatch.filter(filenames,அ"*_rif.wav"):நஅஅஅஅஅஅஅஅஅஅஅஅfull_wavஅ=அos.path.join(root,அfilename)நஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அpath.getsize(full_wav)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அneedஅtoஅremoveஅ_rif.wavஅ(0chars)அthenஅaddஅ.TXTநஅஅஅஅஅஅஅஅஅஅஅஅtrans_fileஅ=அfull_wav[:-0]அ+அ".TXT"நஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen(trans_file,அ"r")அasஅf:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅlineஅinஅf:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsplitஅ=அline.split()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstartஅ=அsplit[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅendஅ=அsplit[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅt_listஅ=அsplit[0:]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtransஅ=அ""நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅtஅinஅt_list:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtransஅ=அtransஅ+அ"அ"அ+அclean(t)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அifஅignoreSAsentencesஅweஅonlyஅwantஅthoseஅwithoutஅSAஅinஅtheஅnameநஅஅஅஅஅஅஅஅஅஅஅஅ#அORநஅஅஅஅஅஅஅஅஅஅஅஅ#அifஅnotஅignoreSAsentencesஅweஅwantஅallஅtoஅbeஅaddedநஅஅஅஅஅஅஅஅஅஅஅஅifஅ(ignoreSASentencesஅandஅnotஅ("SA"அinஅos.path.basename(full_wav)))அorஅ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnotஅignoreSASentencesநஅஅஅஅஅஅஅஅஅஅஅஅ):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅ"train"அinஅfull_wav.lower():நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_list_wavs.append(full_wav)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_list_trans.append(trans)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_list_size.append(wav_filesize)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelifஅ"test"அinஅfull_wav.lower():நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_list_wavs.append(full_wav)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_list_trans.append(trans)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_list_size.append(wav_filesize)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅraiseஅIOErrorநநஅஅஅஅaஅ=அ{நஅஅஅஅஅஅஅஅ"wav_filename":அtrain_list_wavs,நஅஅஅஅஅஅஅஅ"wav_filesize":அtrain_list_size,நஅஅஅஅஅஅஅஅ"transcript":அtrain_list_trans,நஅஅஅஅ}நநஅஅஅஅcஅ=அ{நஅஅஅஅஅஅஅஅ"wav_filename":அtest_list_wavs,நஅஅஅஅஅஅஅஅ"wav_filesize":அtest_list_size,நஅஅஅஅஅஅஅஅ"transcript":அtest_list_trans,நஅஅஅஅ}நநஅஅஅஅallஅ=அ{நஅஅஅஅஅஅஅஅ"wav_filename":அtrain_list_wavsஅ+அtest_list_wavs,நஅஅஅஅஅஅஅஅ"wav_filesize":அtrain_list_sizeஅ+அtest_list_size,நஅஅஅஅஅஅஅஅ"transcript":அtrain_list_transஅ+அtest_list_trans,நஅஅஅஅ}நநஅஅஅஅdf_allஅ=அpd.DataFrame(நஅஅஅஅஅஅஅஅall,அcolumns=["wav_filename",அ"wav_filesize",அ"transcript"],அdtype=intநஅஅஅஅ)நஅஅஅஅdf_trainஅ=அpd.DataFrame(நஅஅஅஅஅஅஅஅa,அcolumns=["wav_filename",அ"wav_filesize",அ"transcript"],அdtype=intநஅஅஅஅ)நஅஅஅஅdf_testஅ=அpd.DataFrame(நஅஅஅஅஅஅஅஅc,அcolumns=["wav_filename",அ"wav_filesize",அ"transcript"],அdtype=intநஅஅஅஅ)நநஅஅஅஅdf_all.to_csv(நஅஅஅஅஅஅஅஅtargetஅ+அ"/timit_all.csv",அsep=",",அheader=True,அindex=False,அencoding="ascii"நஅஅஅஅ)நஅஅஅஅdf_train.to_csv(நஅஅஅஅஅஅஅஅtargetஅ+அ"/timit_train.csv",அsep=",",அheader=True,அindex=False,அencoding="ascii"நஅஅஅஅ)நஅஅஅஅdf_test.to_csv(நஅஅஅஅஅஅஅஅtargetஅ+அ"/timit_test.csv",அsep=",",அheader=True,அindex=False,அencoding="ascii"நஅஅஅஅ)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_preprocess_data(sys.argv[0])நஅஅஅஅprint("Completed")ந#!/usr/bin/envஅpythonந#அensureஅthatஅyouஅhaveஅdownloadedஅtheஅLDCஅdatasetஅLDC00S00அandஅtarஅexistsஅinஅaஅfolderஅe.g.ந#அ./data/swb/swb0_LDC00S00.tgzந#அfromஅtheஅdeepspeechஅdirectoryஅrunஅwith:அ./bin/import_swb.pyஅ./data/swb/நimportஅcodecsநimportஅfnmatchநimportஅosநimportஅrandomநimportஅsubprocessநimportஅsysநimportஅtarfileநimportஅunicodedataநimportஅwaveநநimportஅlibrosaநimportஅpandasநimportஅrequestsநimportஅsoundfileஅஅ#அ<=அHasஅanஅexternalஅdependencyஅonஅlibsndfileநநfromஅdeepspeech_training.util.importersஅimportஅvalidate_label_engஅasஅvalidate_labelநந#அARCHIVE_NAMEஅrefersஅtoஅISIPஅalignmentsஅfromஅ00/00/00நARCHIVE_NAMEஅ=அ"switchboard_word_alignments.tar.gz"நARCHIVE_URLஅ=அ"http://www.openslr.org/resources/0/"நARCHIVE_DIR_NAMEஅ=அ"LDC00S00"நLDC_DATASETஅ=அ"swb0_LDC00S00.tgz"நநநdefஅdownload_file(folder,அurl):நஅஅஅஅ#அhttps://stackoverflow.com/a/00000000/000000நஅஅஅஅlocal_filenameஅ=அurl.split("/")[-0]நஅஅஅஅfull_filenameஅ=அos.path.join(folder,அlocal_filename)நஅஅஅஅrஅ=அrequests.get(url,அstream=True)நஅஅஅஅwithஅopen(full_filename,அ"wb")அasஅf:நஅஅஅஅஅஅஅஅforஅchunkஅinஅr.iter_content(chunk_size=0000):நஅஅஅஅஅஅஅஅஅஅஅஅifஅchunk:அஅ#அfilterஅoutஅkeep-aliveஅnewஅchunksநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅf.write(chunk)நஅஅஅஅreturnஅfull_filenameநநநdefஅmaybe_download(archive_url,அtarget_dir,அldc_dataset):நஅஅஅஅ#அIfஅarchiveஅfileஅdoesஅnotஅexist,அdownloadஅit...நஅஅஅஅarchive_pathஅ=அos.path.join(target_dir,அldc_dataset)நஅஅஅஅldc_pathஅ=அarchive_urlஅ+அldc_datasetநஅஅஅஅifஅnotஅos.path.exists(target_dir):நஅஅஅஅஅஅஅஅprint('Noஅpathஅ"%s"அ-அcreatingஅ...'அ%அtarget_dir)நஅஅஅஅஅஅஅஅos.makedirs(target_dir)நநஅஅஅஅifஅnotஅos.path.exists(archive_path):நஅஅஅஅஅஅஅஅprint('Noஅarchiveஅ"%s"அ-அdownloading...'அ%அarchive_path)நஅஅஅஅஅஅஅஅdownload_file(target_dir,அldc_path)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Foundஅarchiveஅ"%s"அ-அnotஅdownloading.'அ%அarchive_path)நஅஅஅஅreturnஅarchive_pathநநநdefஅ_download_and_preprocess_data(data_dir):நஅஅஅஅnew_data_dirஅ=அos.path.join(data_dir,அARCHIVE_DIR_NAME)நஅஅஅஅtarget_dirஅ=அos.path.abspath(new_data_dir)நஅஅஅஅarchive_pathஅ=அos.path.abspath(os.path.join(data_dir,அLDC_DATASET))நநஅஅஅஅ#அCheckஅswb0_LDC00S00.tgzஅthenஅextractநஅஅஅஅassertஅos.path.isfile(archive_path)நஅஅஅஅ_extract(target_dir,அarchive_path)நநஅஅஅஅ#அTranscriptsநஅஅஅஅtranscripts_pathஅ=அmaybe_download(ARCHIVE_URL,அtarget_dir,அARCHIVE_NAME)நஅஅஅஅ_extract(target_dir,அtranscripts_path)நநஅஅஅஅ#அCheckஅswb0_d0/0/0/0/swb_ms00_transcriptionsநஅஅஅஅexpected_foldersஅ=அ[நஅஅஅஅஅஅஅஅ"swb0_d0",நஅஅஅஅஅஅஅஅ"swb0_d0",நஅஅஅஅஅஅஅஅ"swb0_d0",நஅஅஅஅஅஅஅஅ"swb0_d0",நஅஅஅஅஅஅஅஅ"swb_ms00_transcriptions",நஅஅஅஅ]நஅஅஅஅassertஅall([os.path.isdir(os.path.join(target_dir,அe))அforஅeஅinஅexpected_folders])நநஅஅஅஅ#அConditionallyஅconvertஅswbஅsphஅdataஅtoஅwavநஅஅஅஅ_maybe_convert_wav(target_dir,அ"swb0_d0",அ"swb0_d0-wav")நஅஅஅஅ_maybe_convert_wav(target_dir,அ"swb0_d0",அ"swb0_d0-wav")நஅஅஅஅ_maybe_convert_wav(target_dir,அ"swb0_d0",அ"swb0_d0-wav")நஅஅஅஅ_maybe_convert_wav(target_dir,அ"swb0_d0",அ"swb0_d0-wav")நநஅஅஅஅ#அConditionallyஅsplitஅwavஅdataநஅஅஅஅd0அ=அ_maybe_split_wav_and_sentences(நஅஅஅஅஅஅஅஅtarget_dir,அ"swb_ms00_transcriptions",அ"swb0_d0-wav",அ"swb0_d0-split-wav"நஅஅஅஅ)நஅஅஅஅd0அ=அ_maybe_split_wav_and_sentences(நஅஅஅஅஅஅஅஅtarget_dir,அ"swb_ms00_transcriptions",அ"swb0_d0-wav",அ"swb0_d0-split-wav"நஅஅஅஅ)நஅஅஅஅd0அ=அ_maybe_split_wav_and_sentences(நஅஅஅஅஅஅஅஅtarget_dir,அ"swb_ms00_transcriptions",அ"swb0_d0-wav",அ"swb0_d0-split-wav"நஅஅஅஅ)நஅஅஅஅd0அ=அ_maybe_split_wav_and_sentences(நஅஅஅஅஅஅஅஅtarget_dir,அ"swb_ms00_transcriptions",அ"swb0_d0-wav",அ"swb0_d0-split-wav"நஅஅஅஅ)நநஅஅஅஅswb_filesஅ=அd0.append(d0).append(d0).append(d0)நநஅஅஅஅtrain_files,அdev_files,அtest_filesஅ=அ_split_sets(swb_files)நநஅஅஅஅ#அWriteஅsetsஅtoஅdiskஅasஅCSVஅfilesநஅஅஅஅtrain_files.to_csv(os.path.join(target_dir,அ"swb-train.csv"),அindex=False)நஅஅஅஅdev_files.to_csv(os.path.join(target_dir,அ"swb-dev.csv"),அindex=False)நஅஅஅஅtest_files.to_csv(os.path.join(target_dir,அ"swb-test.csv"),அindex=False)நநநdefஅ_extract(target_dir,அarchive_path):நஅஅஅஅwithஅtarfile.open(archive_path)அasஅtar:நஅஅஅஅஅஅஅஅtar.extractall(target_dir)நநநdefஅ_maybe_convert_wav(data_dir,அoriginal_data,அconverted_data):நஅஅஅஅsource_dirஅ=அos.path.join(data_dir,அoriginal_data)நஅஅஅஅtarget_dirஅ=அos.path.join(data_dir,அconverted_data)நநஅஅஅஅ#அConditionallyஅconvertஅsphஅfilesஅtoஅwavஅfilesநஅஅஅஅifஅos.path.exists(target_dir):நஅஅஅஅஅஅஅஅprint("skippingஅmaybe_convert_wav")நஅஅஅஅஅஅஅஅreturnநநஅஅஅஅ#அCreateஅtarget_dirநஅஅஅஅos.makedirs(target_dir)நநஅஅஅஅ#அLoopஅoverஅsphஅfilesஅinஅsource_dirஅandஅconvertஅeachஅtoஅ00-bitஅPCMஅwavநஅஅஅஅforஅroot,அdirnames,அfilenamesஅinஅos.walk(source_dir):நஅஅஅஅஅஅஅஅforஅfilenameஅinஅfnmatch.filter(filenames,அ"*.sph"):நஅஅஅஅஅஅஅஅஅஅஅஅforஅchannelஅinஅ["0",அ"0"]:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsph_fileஅ=அos.path.join(root,அfilename)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.splitext(os.path.basename(sph_file))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அchannelநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ".wav"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_fileஅ=அos.path.join(target_dir,அwav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtemp_wav_filenameஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.splitext(os.path.basename(sph_file))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அchannelநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-temp.wav"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtemp_wav_fileஅ=அos.path.join(target_dir,அtemp_wav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("convertingஅ{}அtoஅ{}".format(sph_file,அtemp_wav_file))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_call(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ[நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"sph0pipe",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"-c",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅchannel,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"-p",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"-f",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"rif",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsph_file,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtemp_wav_file,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("upsamplingஅ{}அtoஅ{}".format(temp_wav_file,அwav_file))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudioData,அframeRateஅ=அlibrosa.load(temp_wav_file,அsr=00000,அmono=True)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsoundfile.write(wav_file,அaudioData,அframeRate,அ"PCM_00")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.remove(temp_wav_file)நநநdefஅ_parse_transcriptions(trans_file):நஅஅஅஅsegmentsஅ=அ[]நஅஅஅஅwithஅcodecs.open(trans_file,அ"r",அ"utf-0")அasஅfin:நஅஅஅஅஅஅஅஅforஅlineஅinஅfin:நஅஅஅஅஅஅஅஅஅஅஅஅifஅline.startswith("#")அorஅlen(line)அ<=அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅஅஅஅஅtokensஅ=அline.split()நஅஅஅஅஅஅஅஅஅஅஅஅstart_timeஅ=அfloat(tokens[0])நஅஅஅஅஅஅஅஅஅஅஅஅstop_timeஅ=அfloat(tokens[0])நஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அvalidate_label("அ".join(tokens[0:]))நநஅஅஅஅஅஅஅஅஅஅஅஅifஅtranscriptஅ==அNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅஅஅஅஅ#அWeஅneedஅtoஅdoஅtheஅencode-decodeஅdanceஅhereஅbecauseஅencodeநஅஅஅஅஅஅஅஅஅஅஅஅ#அreturnsஅaஅbytes()அobjectஅonஅPythonஅ0,அandஅtext_to_char_arrayநஅஅஅஅஅஅஅஅஅஅஅஅ#அexpectsஅaஅstring.நஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅunicodedata.normalize("NFKD",அtranscript)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅஅஅஅஅsegments.append(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"start_time":அstart_time,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"stop_time":அstop_time,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript":அtranscript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅreturnஅsegmentsநநநdefஅ_maybe_split_wav_and_sentences(data_dir,அtrans_data,அoriginal_data,அconverted_data):நஅஅஅஅtrans_dirஅ=அos.path.join(data_dir,அtrans_data)நஅஅஅஅsource_dirஅ=அos.path.join(data_dir,அoriginal_data)நஅஅஅஅtarget_dirஅ=அos.path.join(data_dir,அconverted_data)நஅஅஅஅifஅos.path.exists(target_dir):நஅஅஅஅஅஅஅஅprint("skippingஅmaybe_split_wav")நஅஅஅஅஅஅஅஅreturnநநஅஅஅஅos.makedirs(target_dir)நநஅஅஅஅfilesஅ=அ[]நநஅஅஅஅ#அLoopஅoverஅtranscriptionஅfilesஅandஅsplitஅcorrespondingஅwavநஅஅஅஅforஅroot,அdirnames,அfilenamesஅinஅos.walk(trans_dir):நஅஅஅஅஅஅஅஅforஅfilenameஅinஅfnmatch.filter(filenames,அ"*.text"):நஅஅஅஅஅஅஅஅஅஅஅஅifஅ"trans"அnotஅinஅfilename:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅtrans_fileஅ=அos.path.join(root,அfilename)நஅஅஅஅஅஅஅஅஅஅஅஅsegmentsஅ=அ_parse_transcriptions(trans_file)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அOpenஅwavஅcorrespondingஅtoஅtranscriptionஅfileநஅஅஅஅஅஅஅஅஅஅஅஅchannelஅ=அ("0",அ"0")[நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(os.path.splitext(os.path.basename(trans_file))[0])[0]அ==அ"A"நஅஅஅஅஅஅஅஅஅஅஅஅ]நஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"sw0"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ(os.path.splitext(os.path.basename(trans_file))[0])[0:0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அchannelநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ".wav"நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅwav_fileஅ=அos.path.join(source_dir,அwav_filename)நநஅஅஅஅஅஅஅஅஅஅஅஅprint("splittingஅ{}அaccordingஅtoஅ{}".format(wav_file,அtrans_file))நநஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(wav_file):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("skipping.அdoesஅnotஅexist:"அ+அwav_file)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅஅஅஅஅorigAudioஅ=அwave.open(wav_file,அ"r")நநஅஅஅஅஅஅஅஅஅஅஅஅ#அLoopஅoverஅsegmentsஅandஅsplitஅwav_fileஅforஅeachஅsegmentநஅஅஅஅஅஅஅஅஅஅஅஅforஅsegmentஅinஅsegments:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அCreateஅwavஅsegmentஅfilenameநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstart_timeஅ=அsegment["start_time"]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstop_timeஅ=அsegment["stop_time"]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_filenameஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.splitext(os.path.basename(trans_file))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அstr(start_time)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அstr(stop_time)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ".wav"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅ_is_wav_too_short(new_wav_filename):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_fileஅ=அos.path.join(target_dir,அnew_wav_filename)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ_split_wav(origAudio,அstart_time,அstop_time,அnew_wav_file)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_filesizeஅ=அos.path.getsize(new_wav_file)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அsegment["transcript"]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfiles.append(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(os.path.abspath(new_wav_file),அnew_wav_filesize,அtranscript)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அCloseஅorigAudioநஅஅஅஅஅஅஅஅஅஅஅஅorigAudio.close()நநஅஅஅஅreturnஅpandas.DataFrame(நஅஅஅஅஅஅஅஅdata=files,அcolumns=["wav_filename",அ"wav_filesize",அ"transcript"]நஅஅஅஅ)நநநdefஅ_is_wav_too_short(wav_filename):நஅஅஅஅshort_wav_filenamesஅ=அ[நஅஅஅஅஅஅஅஅ"sw0000A-ms00-a-trans-00.0000-00.000000.wav",நஅஅஅஅஅஅஅஅ"sw0000A-ms00-a-trans-000.00000-000.000000.wav",நஅஅஅஅ]நஅஅஅஅreturnஅwav_filenameஅinஅshort_wav_filenamesநநநdefஅ_split_wav(origAudio,அstart_time,அstop_time,அnew_wav_file):நஅஅஅஅframeRateஅ=அorigAudio.getframerate()நஅஅஅஅorigAudio.setpos(int(start_timeஅ*அframeRate))நஅஅஅஅchunkDataஅ=அorigAudio.readframes(int((stop_timeஅ-அstart_time)அ*அframeRate))நஅஅஅஅchunkAudioஅ=அwave.open(new_wav_file,அ"w")நஅஅஅஅchunkAudio.setnchannels(origAudio.getnchannels())நஅஅஅஅchunkAudio.setsampwidth(origAudio.getsampwidth())நஅஅஅஅchunkAudio.setframerate(frameRate)நஅஅஅஅchunkAudio.writeframes(chunkData)நஅஅஅஅchunkAudio.close()நநநdefஅ_split_sets(filelist):நஅஅஅஅ"""நஅஅஅஅrandomplyஅsplitஅtheஅdatasetsஅintoஅtrain,அvalidation,அandஅtestஅsetsஅwhereஅtheஅsizeஅofஅtheநஅஅஅஅvalidationஅandஅtestஅsetsஅareஅdeterminedஅbyஅtheஅ`get_sample_size`அfunction.அநஅஅஅஅ"""நஅஅஅஅrandom.shuffle(filelist)நஅஅஅஅsample_sizeஅ=அget_sample_size(len(filelist))நநஅஅஅஅtrain_begஅ=அ0நஅஅஅஅtrain_endஅ=அlen(filelist)அ-அ0அ*அsample_sizeநநஅஅஅஅdev_begஅ=அtrain_endநஅஅஅஅdev_endஅ=அtrain_endஅ+அsample_sizeநநஅஅஅஅtest_begஅ=அdev_endநஅஅஅஅtest_endஅ=அlen(filelist)நநஅஅஅஅreturnஅ(நஅஅஅஅஅஅஅஅfilelist[train_beg:train_end],நஅஅஅஅஅஅஅஅfilelist[dev_beg:dev_end],நஅஅஅஅஅஅஅஅfilelist[test_beg:test_end],நஅஅஅஅ)நநநdefஅget_sample_size(population_size):நஅஅஅஅ"""calculatesஅtheஅsampleஅsizeஅforஅaஅ00%அconfidenceஅandஅ0%அmarginஅofஅerrorநஅஅஅஅ"""நஅஅஅஅmargin_of_errorஅ=அ0.00நஅஅஅஅfraction_pickingஅ=அ0.00நஅஅஅஅz_scoreஅ=அ0.00அஅ#அCorrespondsஅtoஅconfidenceஅlevelஅ00%நஅஅஅஅnumeratorஅ=அ(z_scoreஅ**அ0அ*அfraction_pickingஅ*அ(0அ-அfraction_picking))அ/அ(நஅஅஅஅஅஅஅஅmargin_of_errorஅ**அ0நஅஅஅஅ)நஅஅஅஅsample_sizeஅ=அ0நஅஅஅஅforஅtrain_sizeஅinஅrange(population_size,அ0,அ-0):நஅஅஅஅஅஅஅஅdenominatorஅ=அ0அ+அ(z_scoreஅ**அ0அ*அfraction_pickingஅ*அ(0அ-அfraction_picking))அ/அ(நஅஅஅஅஅஅஅஅஅஅஅஅmargin_of_errorஅ**அ0அ*அtrain_sizeநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅsample_sizeஅ=அint(numeratorஅ/அdenominator)நஅஅஅஅஅஅஅஅifஅ0அ*அsample_sizeஅ+அtrain_sizeஅ<=அpopulation_size:நஅஅஅஅஅஅஅஅஅஅஅஅbreakநஅஅஅஅreturnஅsample_sizeநநநdefஅ_read_data_set(நஅஅஅஅfilelist,நஅஅஅஅthread_count,நஅஅஅஅbatch_size,நஅஅஅஅnumcep,நஅஅஅஅnumcontext,நஅஅஅஅstride=0,நஅஅஅஅoffset=0,நஅஅஅஅnext_index=lambdaஅi:அiஅ+அ0,நஅஅஅஅlimit=0,ந):நஅஅஅஅ#அOptionallyஅapplyஅdatasetஅsizeஅlimitநஅஅஅஅifஅlimitஅ>அ0:நஅஅஅஅஅஅஅஅfilelistஅ=அfilelist.iloc[:limit]நநஅஅஅஅfilelistஅ=அfilelist[offset::stride]நநஅஅஅஅ#அReturnஅDataSetநஅஅஅஅreturnஅDataSet(நஅஅஅஅஅஅஅஅtxt_files,அthread_count,அbatch_size,அnumcep,அnumcontext,அnext_index=next_indexநஅஅஅஅ)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_download_and_preprocess_data(sys.argv[0])ந#!/usr/bin/envஅpython0நimportஅcsvநimportஅosநimportஅreநimportஅsubprocessநimportஅzipfileநfromஅmultiprocessingஅimportஅPoolநநimportஅprogressbarநimportஅsoxநநimportஅunidecodeநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.importersஅimportஅ(நஅஅஅஅget_counter,நஅஅஅஅget_imported_samples,நஅஅஅஅget_importers_parser,நஅஅஅஅget_validate_label,நஅஅஅஅprint_import_report,ந)நநFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நSAMPLE_RATEஅ=அ00000நMAX_SECSஅ=அ00நARCHIVE_NAMEஅ=அ"0000-00-00_fr_FR"நARCHIVE_DIR_NAMEஅ=அ"ts_"அ+அARCHIVE_NAMEநARCHIVE_URLஅ=அ(நஅஅஅஅ"https://deepspeech-storage-mirror.s0.fr-par.scw.cloud/"அ+அARCHIVE_NAMEஅ+அ".zip"ந)நநநdefஅ_download_and_preprocess_data(target_dir,அenglish_compatible=False):நஅஅஅஅ#அMakingஅpathஅabsoluteநஅஅஅஅtarget_dirஅ=அos.path.abspath(target_dir)நஅஅஅஅ#அConditionallyஅdownloadஅdataநஅஅஅஅarchive_pathஅ=அmaybe_download(நஅஅஅஅஅஅஅஅ"ts_"அ+அARCHIVE_NAMEஅ+அ".zip",அtarget_dir,அARCHIVE_URLநஅஅஅஅ)நஅஅஅஅ#அConditionallyஅextractஅarchiveஅdataநஅஅஅஅ_maybe_extract(target_dir,அARCHIVE_DIR_NAME,அarchive_path)நஅஅஅஅ#அConditionallyஅconvertஅTrainingSpeechஅdataஅtoஅDeepSpeechஅCSVsஅandஅwavநஅஅஅஅ_maybe_convert_sets(நஅஅஅஅஅஅஅஅtarget_dir,அARCHIVE_DIR_NAME,அenglish_compatible=english_compatibleநஅஅஅஅ)நநநdefஅ_maybe_extract(target_dir,அextracted_data,அarchive_path):நஅஅஅஅ#அIfஅtarget_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅtarget_dirநஅஅஅஅextracted_pathஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅifஅnotஅos.path.exists(extracted_path):நஅஅஅஅஅஅஅஅprint('Noஅdirectoryஅ"%s"அ-அextractingஅarchive...'அ%அextracted_path)நஅஅஅஅஅஅஅஅifஅnotஅos.path.isdir(extracted_path):நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(extracted_path)நஅஅஅஅஅஅஅஅwithஅzipfile.ZipFile(archive_path)அasஅzip_f:நஅஅஅஅஅஅஅஅஅஅஅஅzip_f.extractall(extracted_path)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Foundஅdirectoryஅ"%s"அ-அnotஅextractingஅitஅfromஅarchive.'அ%அarchive_path)நநநdefஅone_sample(sample):நஅஅஅஅ"""அTakeஅaஅaudioஅfile,அandஅoptionallyஅconvertஅitஅtoஅ00kHzஅWAVஅ"""நஅஅஅஅorig_filenameஅ=அsample["path"]நஅஅஅஅ#அStoringஅwavஅfilesஅnextஅtoஅtheஅwavஅonesஅ-அjustஅwithஅaஅdifferentஅsuffixநஅஅஅஅwav_filenameஅ=அos.path.splitext(orig_filename)[0]அ+அ".converted.wav"நஅஅஅஅ_maybe_convert_wav(orig_filename,அwav_filename)நஅஅஅஅfile_sizeஅ=அ-0நஅஅஅஅframesஅ=அ0நஅஅஅஅifஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅfile_sizeஅ=அos.path.getsize(wav_filename)நஅஅஅஅஅஅஅஅframesஅ=அint(நஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_output(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ["soxi",அ"-s",அwav_filename],அstderr=subprocess.STDOUTநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅ)நஅஅஅஅlabelஅ=அsample["text"]நநஅஅஅஅrowsஅ=அ[]நநஅஅஅஅ#அKeepஅtrackஅofஅhowஅmanyஅsamplesஅareஅgoodஅvs.அproblematicநஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅifஅfile_sizeஅ==அ-0:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅuponஅconversionநஅஅஅஅஅஅஅஅcounter["failed"]அ+=அ0நஅஅஅஅelifஅlabelஅisஅNone:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅonஅlabelஅvalidationநஅஅஅஅஅஅஅஅcounter["invalid_label"]அ+=அ0நஅஅஅஅelifஅint(framesஅ/அSAMPLE_RATEஅ*அ0000அ/அ00அ/அ0)அ<அlen(str(label)):நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅareஅtooஅshortஅtoஅfitஅtheஅtranscriptநஅஅஅஅஅஅஅஅcounter["too_short"]அ+=அ0நஅஅஅஅelifஅframesஅ/அSAMPLE_RATEஅ>அMAX_SECS:நஅஅஅஅஅஅஅஅ#அExcludingஅveryஅlongஅsamplesஅtoஅkeepஅaஅreasonableஅbatch-sizeநஅஅஅஅஅஅஅஅcounter["too_long"]அ+=அ0நஅஅஅஅelse:நஅஅஅஅஅஅஅஅ#அThisஅoneஅisஅgoodஅ-அkeepஅitஅforஅtheஅtargetஅCSVநஅஅஅஅஅஅஅஅrows.append((wav_filename,அfile_size,அlabel))நஅஅஅஅஅஅஅஅcounter["imported_time"]அ+=அframesநஅஅஅஅcounter["all"]அ+=அ0நஅஅஅஅcounter["total_time"]அ+=அframesநநஅஅஅஅreturnஅ(counter,அrows)நநநdefஅ_maybe_convert_sets(target_dir,அextracted_data,அenglish_compatible=False):நஅஅஅஅextracted_dirஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅ#அoverrideஅexistingஅCSVஅwithஅnormalizedஅoneநஅஅஅஅtarget_csv_templateஅ=அos.path.join(target_dir,அ"ts_"அ+அARCHIVE_NAMEஅ+அ"_{}.csv")நஅஅஅஅifஅos.path.isfile(target_csv_template):நஅஅஅஅஅஅஅஅreturnநஅஅஅஅpath_to_original_csvஅ=அos.path.join(extracted_dir,அ"data.csv")நஅஅஅஅwithஅopen(path_to_original_csv)அasஅcsv_f:நஅஅஅஅஅஅஅஅdataஅ=அ[நஅஅஅஅஅஅஅஅஅஅஅஅdநஅஅஅஅஅஅஅஅஅஅஅஅforஅdஅinஅcsv.DictReader(csv_f,அdelimiter=",")நஅஅஅஅஅஅஅஅஅஅஅஅifஅfloat(d["duration"])அ<=அMAX_SECSநஅஅஅஅஅஅஅஅ]நநஅஅஅஅforஅlineஅinஅdata:நஅஅஅஅஅஅஅஅline["path"]அ=அos.path.join(extracted_dir,அline["path"])நநஅஅஅஅnum_samplesஅ=அlen(data)நஅஅஅஅrowsஅ=அ[]நஅஅஅஅcounterஅ=அget_counter()நநஅஅஅஅprint("Importingஅ{}அwavஅfiles...".format(num_samples))நஅஅஅஅpoolஅ=அPool()நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅforஅi,அprocessedஅinஅenumerate(pool.imap_unordered(one_sample,அdata),அstart=0):நஅஅஅஅஅஅஅஅcounterஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅrowsஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅbar.update(i)நஅஅஅஅbar.update(num_samples)நஅஅஅஅpool.close()நஅஅஅஅpool.join()நநஅஅஅஅwithஅopen(target_csv_template.format("train"),அ"w",அencoding="utf-0",அnewline="")அasஅtrain_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("dev"),அ"w",அencoding="utf-0",அnewline="")அasஅdev_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("test"),அ"w",அencoding="utf-0",அnewline="")அasஅtest_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writerஅ=அcsv.DictWriter(train_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writerஅ=அcsv.DictWriter(dev_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writerஅ=அcsv.DictWriter(test_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writer.writeheader()நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅi,அitemஅinஅenumerate(rows):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அvalidate_label(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcleanup_transcript(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅitem[0],அenglish_compatible=english_compatibleநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅtranscript:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அos.path.join(target_dir,அextracted_data,அitem[0])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅi_modஅ=அiஅ%அ00நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtest_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அdev_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtrain_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdict(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filename=wav_filename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesize=os.path.getsize(wav_filename),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript=transcript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅimported_samplesஅ=அget_imported_samples(counter)நஅஅஅஅassertஅcounter["all"]அ==அnum_samplesநஅஅஅஅassertஅlen(rows)அ==அimported_samplesநநஅஅஅஅprint_import_report(counter,அSAMPLE_RATE,அMAX_SECS)நநநdefஅ_maybe_convert_wav(orig_filename,அwav_filename):நஅஅஅஅifஅnotஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅtransformerஅ=அsox.Transformer()நஅஅஅஅஅஅஅஅtransformer.convert(samplerate=SAMPLE_RATE)நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(orig_filename,அwav_filename)நஅஅஅஅஅஅஅஅexceptஅsox.core.SoxErrorஅasஅex:நஅஅஅஅஅஅஅஅஅஅஅஅprint("SoXஅprocessingஅerror",அex,அorig_filename,அwav_filename)நநநPUNCTUATIONS_REGஅ=அre.compile(r"[\-,;!?.()\[\]*…—]")நMULTIPLE_SPACES_REGஅ=அre.compile(r"\s{0,}")நநநdefஅcleanup_transcript(text,அenglish_compatible=False):நஅஅஅஅtextஅ=அtext.replace("’",அ"'").replace("\u00A0",அ"அ")நஅஅஅஅtextஅ=அPUNCTUATIONS_REG.sub("அ",அtext)நஅஅஅஅtextஅ=அMULTIPLE_SPACES_REG.sub("அ",அtext)நஅஅஅஅifஅenglish_compatible:நஅஅஅஅஅஅஅஅtextஅ=அunidecode.unidecode(text)நஅஅஅஅreturnஅtext.strip().lower()நநநdefஅhandle_args():நஅஅஅஅparserஅ=அget_importers_parser(description="ImporterஅforஅTrainingSpeechஅdataset.")நஅஅஅஅparser.add_argument(dest="target_dir")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--english-compatible",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅdest="english_compatible",நஅஅஅஅஅஅஅஅhelp="Removeஅdiactricsஅandஅotherஅnon-asciiஅchars.",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅcli_argsஅ=அhandle_args()நஅஅஅஅvalidate_labelஅ=அget_validate_label(cli_args)நஅஅஅஅ_download_and_preprocess_data(cli_args.target_dir,அcli_args.english_compatible)ந#!/usr/bin/envஅpythonநimportஅosநimportஅsysநநimportஅpandasநநfromஅdeepspeech_training.util.downloaderஅimportஅmaybe_downloadநநநdefஅ_download_and_preprocess_data(data_dir):நஅஅஅஅ#அConditionallyஅdownloadஅdataநஅஅஅஅLDC00S0_BASEஅ=அ"LDC00S0"நஅஅஅஅLDC00S0_BASE_URLஅ=அ"https://catalog.ldc.upenn.edu/desc/addenda/"நஅஅஅஅlocal_fileஅ=அmaybe_download(நஅஅஅஅஅஅஅஅLDC00S0_BASEஅ+அ".wav",அdata_dir,அLDC00S0_BASE_URLஅ+அLDC00S0_BASEஅ+அ".wav"நஅஅஅஅ)நஅஅஅஅtrans_fileஅ=அmaybe_download(நஅஅஅஅஅஅஅஅLDC00S0_BASEஅ+அ".txt",அdata_dir,அLDC00S0_BASE_URLஅ+அLDC00S0_BASEஅ+அ".txt"நஅஅஅஅ)நஅஅஅஅwithஅopen(trans_file,அ"r")அasஅfin:நஅஅஅஅஅஅஅஅtranscriptஅ=அ"அ".join(fin.read().strip().lower().split("அ")[0:]).replace(நஅஅஅஅஅஅஅஅஅஅஅஅ".",அ""நஅஅஅஅஅஅஅஅ)நநஅஅஅஅdfஅ=அpandas.DataFrame(நஅஅஅஅஅஅஅஅdata=[(os.path.abspath(local_file),அos.path.getsize(local_file),அtranscript)],நஅஅஅஅஅஅஅஅcolumns=["wav_filename",அ"wav_filesize",அ"transcript"],நஅஅஅஅ)நஅஅஅஅdf.to_csv(os.path.join(data_dir,அ"ldc00s0.csv"),அindex=False)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_download_and_preprocess_data(sys.argv[0])ந#!/usr/bin/envஅpythonநimportஅcsvநimportஅosநimportஅsysநimportஅsubprocessநimportஅtarfileநfromஅglobஅimportஅglobநfromஅmultiprocessingஅimportஅPoolநநimportஅprogressbarநimportஅsoxநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.importersஅimportஅ(நஅஅஅஅget_counter,நஅஅஅஅget_imported_samples,நஅஅஅஅprint_import_report,ந)நfromஅdeepspeech_training.util.importersஅimportஅvalidate_label_engஅasஅvalidate_labelநநFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நSAMPLE_RATEஅ=அ00000நMAX_SECSஅ=அ00நARCHIVE_DIR_NAMEஅ=அ"cv_corpus_v0"நARCHIVE_NAMEஅ=அARCHIVE_DIR_NAMEஅ+அ".tar.gz"நARCHIVE_URLஅ=அ(நஅஅஅஅ"https://s0.us-east-0.amazonaws.com/common-voice-data-download/"அ+அARCHIVE_NAMEந)நநநdefஅ_download_and_preprocess_data(target_dir):நஅஅஅஅ#அMakingஅpathஅabsoluteநஅஅஅஅtarget_dirஅ=அos.path.abspath(target_dir)நஅஅஅஅ#அConditionallyஅdownloadஅdataநஅஅஅஅarchive_pathஅ=அmaybe_download(ARCHIVE_NAME,அtarget_dir,அARCHIVE_URL)நஅஅஅஅ#அConditionallyஅextractஅcommonஅvoiceஅdataநஅஅஅஅ_maybe_extract(target_dir,அARCHIVE_DIR_NAME,அarchive_path)நஅஅஅஅ#அConditionallyஅconvertஅcommonஅvoiceஅCSVஅfilesஅandஅmp0அdataஅtoஅDeepSpeechஅCSVsஅandஅwavநஅஅஅஅ_maybe_convert_sets(target_dir,அARCHIVE_DIR_NAME)நநநdefஅ_maybe_extract(target_dir,அextracted_data,அarchive_path):நஅஅஅஅ#அIfஅtarget_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅtarget_dirநஅஅஅஅextracted_pathஅ=அos.join(target_dir,அextracted_data)நஅஅஅஅifஅnotஅos.path.exists(extracted_path):நஅஅஅஅஅஅஅஅprint('Noஅdirectoryஅ"%s"அ-அextractingஅarchive...'அ%அextracted_path)நஅஅஅஅஅஅஅஅwithஅtarfile.open(archive_path)அasஅtar:நஅஅஅஅஅஅஅஅஅஅஅஅtar.extractall(target_dir)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Foundஅdirectoryஅ"%s"அ-அnotஅextractingஅitஅfromஅarchive.'அ%அextracted_path)நநநdefஅ_maybe_convert_sets(target_dir,அextracted_data):நஅஅஅஅextracted_dirஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅforஅsource_csvஅinஅglob(os.path.join(extracted_dir,அ"*.csv")):நஅஅஅஅஅஅஅஅ_maybe_convert_set(நஅஅஅஅஅஅஅஅஅஅஅஅextracted_dir,நஅஅஅஅஅஅஅஅஅஅஅஅsource_csv,நஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(target_dir,அos.path.split(source_csv)[-0]),நஅஅஅஅஅஅஅஅ)நநநdefஅone_sample(sample):நஅஅஅஅmp0_filenameஅ=அsample[0]நஅஅஅஅ#அStoringஅwavஅfilesஅnextஅtoஅtheஅmp0அonesஅ-அjustஅwithஅaஅdifferentஅsuffixநஅஅஅஅwav_filenameஅ=அpath.splitext(mp0_filename)[0]அ+அ".wav"நஅஅஅஅ_maybe_convert_wav(mp0_filename,அwav_filename)நஅஅஅஅframesஅ=அint(நஅஅஅஅஅஅஅஅsubprocess.check_output(["soxi",அ"-s",அwav_filename],அstderr=subprocess.STDOUT)நஅஅஅஅ)நஅஅஅஅfile_sizeஅ=அ-0நஅஅஅஅifஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅfile_sizeஅ=அpath.getsize(wav_filename)நஅஅஅஅஅஅஅஅframesஅ=அint(நஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_output(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ["soxi",அ"-s",அwav_filename],அstderr=subprocess.STDOUTநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅ)நஅஅஅஅlabelஅ=அvalidate_label(sample[0])நஅஅஅஅrowsஅ=அ[]நஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅifஅfile_sizeஅ==அ-0:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅuponஅconversionநஅஅஅஅஅஅஅஅcounter["failed"]அ+=அ0நஅஅஅஅelifஅlabelஅisஅNone:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅonஅlabelஅvalidationநஅஅஅஅஅஅஅஅcounter["invalid_label"]அ+=அ0நஅஅஅஅelifஅint(framesஅ/அSAMPLE_RATEஅ*அ0000அ/அ00அ/அ0)அ<அlen(str(label)):நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅareஅtooஅshortஅtoஅfitஅtheஅtranscriptநஅஅஅஅஅஅஅஅcounter["too_short"]அ+=அ0நஅஅஅஅelifஅframesஅ/அSAMPLE_RATEஅ>அMAX_SECS:நஅஅஅஅஅஅஅஅ#அExcludingஅveryஅlongஅsamplesஅtoஅkeepஅaஅreasonableஅbatch-sizeநஅஅஅஅஅஅஅஅcounter["too_long"]அ+=அ0நஅஅஅஅelse:நஅஅஅஅஅஅஅஅ#அThisஅoneஅisஅgoodஅ-அkeepஅitஅforஅtheஅtargetஅCSVநஅஅஅஅஅஅஅஅrows.append((wav_filename,அfile_size,அlabel))நஅஅஅஅஅஅஅஅcounter["imported_time"]அ+=அframesநஅஅஅஅcounter["all"]அ+=அ0நஅஅஅஅcounter["total_time"]அ+=அframesநஅஅஅஅreturnஅ(counter,அrows)நநநdefஅ_maybe_convert_set(extracted_dir,அsource_csv,அtarget_csv):நஅஅஅஅprint()நஅஅஅஅifஅos.path.exists(target_csv):நஅஅஅஅஅஅஅஅprint('FoundஅCSVஅfileஅ"%s"அ-அnotஅimportingஅ"%s".'அ%அ(target_csv,அsource_csv))நஅஅஅஅஅஅஅஅreturnநஅஅஅஅprint('NoஅCSVஅfileஅ"%s"அ-அimportingஅ"%s"...'அ%அ(target_csv,அsource_csv))நஅஅஅஅsamplesஅ=அ[]நஅஅஅஅwithஅopen(source_csv)அasஅsource_csv_file:நஅஅஅஅஅஅஅஅreaderஅ=அcsv.DictReader(source_csv_file)நஅஅஅஅஅஅஅஅforஅrowஅinஅreader:நஅஅஅஅஅஅஅஅஅஅஅஅsamples.append((os.path.join(extracted_dir,அrow["filename"]),அrow["text"]))நநஅஅஅஅ#அMutableஅcountersஅforஅtheஅconcurrentஅembeddedஅroutineநஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅnum_samplesஅ=அlen(samples)நஅஅஅஅrowsஅ=அ[]நநஅஅஅஅprint("Importingஅmp0அfiles...")நஅஅஅஅpoolஅ=அPool()நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅforஅi,அprocessedஅinஅenumerate(pool.imap_unordered(one_sample,அsamples),அstart=0):நஅஅஅஅஅஅஅஅcounterஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅrowsஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅbar.update(i)நஅஅஅஅbar.update(num_samples)நஅஅஅஅpool.close()நஅஅஅஅpool.join()நநஅஅஅஅprint('Writingஅ"%s"...'அ%அtarget_csv)நஅஅஅஅwithஅopen(target_csv,அ"w",அencoding="utf-0",அnewline="")அasஅtarget_csv_file:நஅஅஅஅஅஅஅஅwriterஅ=அcsv.DictWriter(target_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅwriter.writeheader()நஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(rows),அwidgets=SIMPLE_BAR)நஅஅஅஅஅஅஅஅforஅfilename,அfile_size,அtranscriptஅinஅbar(rows):நஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filename":அfilename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filesize":அfile_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript":அtranscript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅimported_samplesஅ=அget_imported_samples(counter)நஅஅஅஅassertஅcounter["all"]அ==அnum_samplesநஅஅஅஅassertஅlen(rows)அ==அimported_samplesநநஅஅஅஅprint_import_report(counter,அSAMPLE_RATE,அMAX_SECS)நநநdefஅ_maybe_convert_wav(mp0_filename,அwav_filename):நஅஅஅஅifஅnotஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅtransformerஅ=அsox.Transformer()நஅஅஅஅஅஅஅஅtransformer.convert(samplerate=SAMPLE_RATE)நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(mp0_filename,அwav_filename)நஅஅஅஅஅஅஅஅexceptஅsox.core.SoxError:நஅஅஅஅஅஅஅஅஅஅஅஅpassநநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_download_and_preprocess_data(sys.argv[0])ந#!/usr/bin/envஅpythonந"""நDownloadsஅandஅpreparesஅ(partsஅof)அtheஅ"SpokenஅWikipediaஅCorpora"அforஅDeepSpeech.pyநUseஅ"python0அimport_swc.pyஅ-h"அforஅhelpந"""நநimportஅargparseநimportஅcsvநimportஅosநimportஅrandomநimportஅreநimportஅshutilநimportஅsysநimportஅtarfileநimportஅunicodedataநimportஅwaveநimportஅxml.etree.ElementTreeஅasஅETநfromஅcollectionsஅimportஅCounterநfromஅglobஅimportஅglobநfromஅmultiprocessing.poolஅimportஅThreadPoolநநimportஅprogressbarநimportஅsoxநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.importersஅimportஅvalidate_label_engஅasஅvalidate_labelநfromஅds_ctcdecoderஅimportஅAlphabetநநSWC_URLஅ=அ"https://www0.informatik.uni-hamburg.de/nats/pub/SWC/SWC_{language}.tar"நSWC_ARCHIVEஅ=அ"SWC_{language}.tar"நLANGUAGESஅ=அ["dutch",அ"english",அ"german"]நFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நFIELDNAMES_EXTஅ=அFIELDNAMESஅ+அ["article",அ"speaker"]நCHANNELSஅ=அ0நSAMPLE_RATEஅ=அ00000நUNKNOWNஅ=அ"<unknown>"நAUDIO_PATTERNஅ=அ"audio*.ogg"நWAV_NAMEஅ=அ"audio.wav"நALIGNED_NAMEஅ=அ"aligned.swc"நநSUBSTITUTIONSஅ=அ{நஅஅஅஅ"german":அ[நஅஅஅஅஅஅஅஅ(re.compile(r"\$"),அ"dollar"),நஅஅஅஅஅஅஅஅ(re.compile(r""),அ"euro"),நஅஅஅஅஅஅஅஅ(re.compile(r""),அ"pfund"),நஅஅஅஅஅஅஅஅ(நஅஅஅஅஅஅஅஅஅஅஅஅre.compile(r"einஅtausendஅ([^\s]+)அhundertஅ([^\s]+)அer(அ|$)"),நஅஅஅஅஅஅஅஅஅஅஅஅr"\0zehnhundertஅ\0erஅ",நஅஅஅஅஅஅஅஅ),நஅஅஅஅஅஅஅஅ(re.compile(r"einஅtausendஅ(acht|neun)அhundert"),அr"\0zehnhundert"),நஅஅஅஅஅஅஅஅ(நஅஅஅஅஅஅஅஅஅஅஅஅre.compile(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅr"einsஅpunktஅnullஅnullஅnullஅpunktஅnullஅnullஅnullஅpunktஅnullஅnullஅnull"நஅஅஅஅஅஅஅஅஅஅஅஅ),நஅஅஅஅஅஅஅஅஅஅஅஅ"eineஅmilliarde",நஅஅஅஅஅஅஅஅ),நஅஅஅஅஅஅஅஅ(நஅஅஅஅஅஅஅஅஅஅஅஅre.compile(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅr"punktஅnullஅnullஅnullஅpunktஅnullஅnullஅnullஅpunktஅnullஅnullஅnull"நஅஅஅஅஅஅஅஅஅஅஅஅ),நஅஅஅஅஅஅஅஅஅஅஅஅ"milliarden",நஅஅஅஅஅஅஅஅ),நஅஅஅஅஅஅஅஅ(re.compile(r"einsஅpunktஅnullஅnullஅnullஅpunktஅnullஅnullஅnull"),அ"eineஅmillion"),நஅஅஅஅஅஅஅஅ(re.compile(r"punktஅnullஅnullஅnullஅpunktஅnullஅnullஅnull"),அ"millionen"),நஅஅஅஅஅஅஅஅ(re.compile(r"einsஅpunktஅnullஅnullஅnull"),அ"einஅtausend"),நஅஅஅஅஅஅஅஅ(re.compile(r"punktஅnullஅnullஅnull"),அ"tausend"),நஅஅஅஅஅஅஅஅ(re.compile(r"punktஅnull"),அNone),நஅஅஅஅ]ந}நநDONT_NORMALIZEஅ=அ{"german":அ""}நநPRE_FILTERஅ=அstr.maketrans(dict.fromkeys("/()[]{}<>:"))நநநclassஅSample:நஅஅஅஅdefஅ__init__(self,அwav_path,அstart,அend,அtext,அarticle,அspeaker,அsub_set=None):நஅஅஅஅஅஅஅஅself.wav_pathஅ=அwav_pathநஅஅஅஅஅஅஅஅself.startஅ=அstartநஅஅஅஅஅஅஅஅself.endஅ=அendநஅஅஅஅஅஅஅஅself.textஅ=அtextநஅஅஅஅஅஅஅஅself.articleஅ=அarticleநஅஅஅஅஅஅஅஅself.speakerஅ=அspeakerநஅஅஅஅஅஅஅஅself.sub_setஅ=அsub_setநநநdefஅfail(message):நஅஅஅஅprint(message)நஅஅஅஅsys.exit(0)நநநdefஅgroup(lst,அget_key):நஅஅஅஅgroupsஅ=அ{}நஅஅஅஅforஅobjஅinஅlst:நஅஅஅஅஅஅஅஅkeyஅ=அget_key(obj)நஅஅஅஅஅஅஅஅifஅkeyஅinஅgroups:நஅஅஅஅஅஅஅஅஅஅஅஅgroups[key].append(obj)நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅgroups[key]அ=அ[obj]நஅஅஅஅreturnஅgroupsநநநdefஅget_sample_size(population_size):நஅஅஅஅmargin_of_errorஅ=அ0.00நஅஅஅஅfraction_pickingஅ=அ0.00நஅஅஅஅz_scoreஅ=அ0.00அஅ#அCorrespondsஅtoஅconfidenceஅlevelஅ00%நஅஅஅஅnumeratorஅ=அ(z_scoreஅ**அ0அ*அfraction_pickingஅ*அ(0அ-அfraction_picking))அ/அ(நஅஅஅஅஅஅஅஅmargin_of_errorஅ**அ0நஅஅஅஅ)நஅஅஅஅsample_sizeஅ=அ0நஅஅஅஅforஅtrain_sizeஅinஅrange(population_size,அ0,அ-0):நஅஅஅஅஅஅஅஅdenominatorஅ=அ0அ+அ(z_scoreஅ**அ0அ*அfraction_pickingஅ*அ(0அ-அfraction_picking))அ/அ(நஅஅஅஅஅஅஅஅஅஅஅஅmargin_of_errorஅ**அ0அ*அtrain_sizeநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅsample_sizeஅ=அint(numeratorஅ/அdenominator)நஅஅஅஅஅஅஅஅifஅ0அ*அsample_sizeஅ+அtrain_sizeஅ<=அpopulation_size:நஅஅஅஅஅஅஅஅஅஅஅஅbreakநஅஅஅஅreturnஅsample_sizeநநநdefஅmaybe_download_language(language):நஅஅஅஅlang_upperஅ=அlanguage[0].upper()அ+அlanguage[0:]நஅஅஅஅreturnஅmaybe_download(நஅஅஅஅஅஅஅஅSWC_ARCHIVE.format(language=lang_upper),நஅஅஅஅஅஅஅஅCLI_ARGS.base_dir,நஅஅஅஅஅஅஅஅSWC_URL.format(language=lang_upper),நஅஅஅஅ)நநநdefஅmaybe_extract(data_dir,அextracted_data,அarchive):நஅஅஅஅextractedஅ=அos.path.join(data_dir,அextracted_data)நஅஅஅஅifஅos.path.isdir(extracted):நஅஅஅஅஅஅஅஅprint('Foundஅdirectoryஅ"{}"அ-அnotஅextracting.'.format(extracted))நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Extractingஅ"{}"...'.format(archive))நஅஅஅஅஅஅஅஅwithஅtarfile.open(archive)அasஅtar:நஅஅஅஅஅஅஅஅஅஅஅஅmembersஅ=அtar.getmembers()நஅஅஅஅஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(members),அwidgets=SIMPLE_BAR)நஅஅஅஅஅஅஅஅஅஅஅஅforஅmemberஅinஅbar(members):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtar.extract(member=member,அpath=extracted)நஅஅஅஅreturnஅextractedநநநdefஅignored(node):நஅஅஅஅifஅnodeஅisஅNone:நஅஅஅஅஅஅஅஅreturnஅFalseநஅஅஅஅifஅnode.tagஅ==அ"ignored":நஅஅஅஅஅஅஅஅreturnஅTrueநஅஅஅஅreturnஅignored(node.find(".."))நநநdefஅread_token(token):நஅஅஅஅtexts,அstart,அendஅ=அ[],அNone,அNoneநஅஅஅஅnotesஅ=அtoken.findall("n")நஅஅஅஅifஅlen(notes)அ>அ0:நஅஅஅஅஅஅஅஅforஅnoteஅinஅnotes:நஅஅஅஅஅஅஅஅஅஅஅஅattributesஅ=அnote.attribநஅஅஅஅஅஅஅஅஅஅஅஅifஅstartஅisஅNoneஅandஅ"start"அinஅattributes:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstartஅ=அint(attributes["start"])நஅஅஅஅஅஅஅஅஅஅஅஅifஅ"end"அinஅattributes:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtoken_endஅ=அint(attributes["end"])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅendஅisஅNoneஅorஅtoken_endஅ>அend:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅendஅ=அtoken_endநஅஅஅஅஅஅஅஅஅஅஅஅifஅ"pronunciation"அinஅattributes:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtஅ=அattributes["pronunciation"]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtexts.append(t)நஅஅஅஅelifஅ"text"அinஅtoken.attrib:நஅஅஅஅஅஅஅஅtexts.append(token.attrib["text"])நஅஅஅஅreturnஅstart,அend,அ"அ".join(texts)நநநdefஅin_alphabet(alphabet,அc):நஅஅஅஅreturnஅalphabet.CanEncode(c)அifஅalphabetஅelseஅTrueநநநநALPHABETSஅ=அ{}நநநdefஅget_alphabet(language):நஅஅஅஅifஅlanguageஅinஅALPHABETS:நஅஅஅஅஅஅஅஅreturnஅALPHABETS[language]நஅஅஅஅalphabet_pathஅ=அgetattr(CLI_ARGS,அlanguageஅ+அ"_alphabet")நஅஅஅஅalphabetஅ=அAlphabet(alphabet_path)அifஅalphabet_pathஅelseஅNoneநஅஅஅஅALPHABETS[language]அ=அalphabetநஅஅஅஅreturnஅalphabetநநநdefஅlabel_filter(label,அlanguage):நஅஅஅஅlabelஅ=அlabel.translate(PRE_FILTER)நஅஅஅஅlabelஅ=அvalidate_label(label)நஅஅஅஅifஅlabelஅisஅNone:நஅஅஅஅஅஅஅஅreturnஅNone,அ"validation"நஅஅஅஅsubstitutionsஅ=அSUBSTITUTIONS[language]அifஅlanguageஅinஅSUBSTITUTIONSஅelseஅ[]நஅஅஅஅforஅpattern,அreplacementஅinஅsubstitutions:நஅஅஅஅஅஅஅஅifஅreplacementஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅifஅpattern.match(label):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅNone,அ"substitutionஅrule"நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அpattern.sub(replacement,அlabel)நஅஅஅஅcharsஅ=அ[]நஅஅஅஅdont_normalizeஅ=அDONT_NORMALIZE[language]அifஅlanguageஅinஅDONT_NORMALIZEஅelseஅ""நஅஅஅஅalphabetஅ=அget_alphabet(language)நஅஅஅஅforஅcஅinஅlabel:நஅஅஅஅஅஅஅஅifஅCLI_ARGS.normalizeஅandஅcஅnotஅinஅdont_normalizeஅandஅnotஅin_alphabet(alphabet,அc):நஅஅஅஅஅஅஅஅஅஅஅஅcஅ=அunicodedata.normalize("NFKD",அc).encode("ascii",அ"ignore").decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅforஅscஅinஅc:நஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅin_alphabet(alphabet,அsc):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅNone,அ"illegalஅcharacter"நஅஅஅஅஅஅஅஅஅஅஅஅchars.append(sc)நஅஅஅஅlabelஅ=அ"".join(chars)நஅஅஅஅlabelஅ=அvalidate_label(label)நஅஅஅஅreturnஅlabel,அ"validation"அifஅlabelஅisஅNoneஅelseஅNoneநநநdefஅcollect_samples(base_dir,அlanguage):நஅஅஅஅrootsஅ=அ[]நஅஅஅஅforஅroot,அ_,அfilesஅinஅos.walk(base_dir):நஅஅஅஅஅஅஅஅifஅALIGNED_NAMEஅinஅfilesஅandஅWAV_NAMEஅinஅfiles:நஅஅஅஅஅஅஅஅஅஅஅஅroots.append(root)நஅஅஅஅsamplesஅ=அ[]நஅஅஅஅreasonsஅ=அCounter()நநஅஅஅஅdefஅadd_sample(நஅஅஅஅஅஅஅஅp_wav_path,அp_article,அp_speaker,அp_start,அp_end,அp_text,அp_reason="complete"நஅஅஅஅ):நஅஅஅஅஅஅஅஅifஅp_startஅisஅnotஅNoneஅandஅp_endஅisஅnotஅNoneஅandஅp_textஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅdurationஅ=அp_endஅ-அp_startநஅஅஅஅஅஅஅஅஅஅஅஅtext,அfilter_reasonஅ=அlabel_filter(p_text,அlanguage)நஅஅஅஅஅஅஅஅஅஅஅஅskipஅ=அFalseநஅஅஅஅஅஅஅஅஅஅஅஅifஅfilter_reasonஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅskipஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reasonஅ=அfilter_reasonநஅஅஅஅஅஅஅஅஅஅஅஅelifஅCLI_ARGS.exclude_unknown_speakersஅandஅp_speakerஅ==அUNKNOWN:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅskipஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reasonஅ=அ"unknownஅspeaker"நஅஅஅஅஅஅஅஅஅஅஅஅelifஅCLI_ARGS.exclude_unknown_articlesஅandஅp_articleஅ==அUNKNOWN:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅskipஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reasonஅ=அ"unknownஅarticle"நஅஅஅஅஅஅஅஅஅஅஅஅelifஅdurationஅ>அCLI_ARGS.max_durationஅ>அ0அandஅCLI_ARGS.ignore_too_long:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅskipஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reasonஅ=அ"exceededஅduration"நஅஅஅஅஅஅஅஅஅஅஅஅelifஅint(durationஅ/அ00)அ<அlen(text):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅskipஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reasonஅ=அ"tooஅshortஅtoஅdecode"நஅஅஅஅஅஅஅஅஅஅஅஅelifஅdurationஅ/அlen(text)அ<அ00:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅskipஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reasonஅ=அ"lengthஅdurationஅratio"நஅஅஅஅஅஅஅஅஅஅஅஅifஅskip:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreasons[p_reason]அ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsamples.append(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅSample(p_wav_path,அp_start,அp_end,அtext,அp_article,அp_speaker)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅelifஅp_startஅisஅNoneஅorஅp_endஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅreasons["missingஅtimestamps"]அ+=அ0நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅreasons["missingஅtext"]அ+=அ0நநஅஅஅஅprint("Collectingஅsamples...")நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(roots),அwidgets=SIMPLE_BAR)நஅஅஅஅforஅrootஅinஅbar(roots):நஅஅஅஅஅஅஅஅwav_pathஅ=அos.path.join(root,அWAV_NAME)நஅஅஅஅஅஅஅஅalignedஅ=அET.parse(os.path.join(root,அALIGNED_NAME))நஅஅஅஅஅஅஅஅarticleஅ=அUNKNOWNநஅஅஅஅஅஅஅஅspeakerஅ=அUNKNOWNநஅஅஅஅஅஅஅஅforஅpropஅinஅaligned.iter("prop"):நஅஅஅஅஅஅஅஅஅஅஅஅattributesஅ=அprop.attribநஅஅஅஅஅஅஅஅஅஅஅஅifஅ"key"அinஅattributesஅandஅ"value"அinஅattributes:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅattributes["key"]அ==அ"DC.identifier":நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅarticleஅ=அattributes["value"]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelifஅattributes["key"]அ==அ"reader.name":நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅspeakerஅ=அattributes["value"]நஅஅஅஅஅஅஅஅforஅsentenceஅinஅaligned.iter("s"):நஅஅஅஅஅஅஅஅஅஅஅஅifஅignored(sentence):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅsplitஅ=அFalseநஅஅஅஅஅஅஅஅஅஅஅஅtokensஅ=அlist(map(read_token,அsentence.findall("t")))நஅஅஅஅஅஅஅஅஅஅஅஅsample_start,அsample_end,அtoken_texts,அsample_textsஅ=அNone,அNone,அ[],அ[]நஅஅஅஅஅஅஅஅஅஅஅஅforஅtoken_start,அtoken_end,அtoken_textஅinஅtokens:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅCLI_ARGS.exclude_numbersஅandஅany(c.isdigit()அforஅcஅinஅtoken_text):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅadd_sample(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_path,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅarticle,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅspeaker,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_start,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_end,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"அ".join(sample_texts),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reason="hasஅnumbers",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_start,அsample_end,அtoken_texts,அsample_textsஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅNone,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅNone,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ[],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ[],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅsample_startஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_startஅ=அtoken_startநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅsample_startஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtoken_texts.append(token_text)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅtoken_endஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtoken_startஅ!=அsample_startநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅandஅtoken_endஅ-அsample_startஅ>அCLI_ARGS.max_durationஅ>அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅadd_sample(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_path,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅarticle,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅspeaker,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_start,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_end,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"அ".join(sample_texts),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reason="split",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_startஅ=அsample_endநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_textsஅ=அ[]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsplitஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_endஅ=அtoken_endநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_texts.extend(token_texts)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtoken_textsஅ=அ[]நஅஅஅஅஅஅஅஅஅஅஅஅadd_sample(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_path,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅarticle,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅspeaker,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_start,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_end,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"அ".join(sample_texts),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅp_reason="split"அifஅsplitஅelseஅ"complete",நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅprint("Skippedஅsamples:")நஅஅஅஅforஅreason,அnஅinஅreasons.most_common():நஅஅஅஅஅஅஅஅprint("அ-அ{}:அ{}".format(reason,அn))நஅஅஅஅreturnஅsamplesநநநdefஅmaybe_convert_one_to_wav(entry):நஅஅஅஅroot,அ_,அfilesஅ=அentryநஅஅஅஅtransformerஅ=அsox.Transformer()நஅஅஅஅtransformer.convert(samplerate=SAMPLE_RATE,அn_channels=CHANNELS)நஅஅஅஅcombinerஅ=அsox.Combiner()நஅஅஅஅcombiner.convert(samplerate=SAMPLE_RATE,அn_channels=CHANNELS)நஅஅஅஅoutput_wavஅ=அos.path.join(root,அWAV_NAME)நஅஅஅஅifஅos.path.isfile(output_wav):நஅஅஅஅஅஅஅஅreturnநஅஅஅஅfilesஅ=அsorted(glob(os.path.join(root,அAUDIO_PATTERN)))நஅஅஅஅtry:நஅஅஅஅஅஅஅஅifஅlen(files)அ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(files[0],அoutput_wav)நஅஅஅஅஅஅஅஅelifஅlen(files)அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅwav_filesஅ=அ[]நஅஅஅஅஅஅஅஅஅஅஅஅforஅi,அfileஅinஅenumerate(files):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_pathஅ=அos.path.join(root,அ"audio{}.wav".format(i))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(file,அwav_path)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_files.append(wav_path)நஅஅஅஅஅஅஅஅஅஅஅஅcombiner.set_input_format(file_type=["wav"]அ*அlen(wav_files))நஅஅஅஅஅஅஅஅஅஅஅஅcombiner.build(wav_files,அoutput_wav,அ"concatenate")நஅஅஅஅexceptஅsox.core.SoxError:நஅஅஅஅஅஅஅஅreturnநநநdefஅmaybe_convert_to_wav(base_dir):நஅஅஅஅrootsஅ=அlist(os.walk(base_dir))நஅஅஅஅprint("Convertingஅandஅjoiningஅsourceஅaudioஅfiles...")நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(roots),அwidgets=SIMPLE_BAR)நஅஅஅஅtpஅ=அThreadPool()நஅஅஅஅforஅ_அinஅbar(tp.imap_unordered(maybe_convert_one_to_wav,அroots)):நஅஅஅஅஅஅஅஅpassநஅஅஅஅtp.close()நஅஅஅஅtp.join()நநநdefஅassign_sub_sets(samples):நஅஅஅஅsample_sizeஅ=அget_sample_size(len(samples))நஅஅஅஅspeakersஅ=அgroup(samples,அlambdaஅsample:அsample.speaker).values()நஅஅஅஅspeakersஅ=அlist(sorted(speakers,அkey=len))நஅஅஅஅsample_setsஅ=அ[[],அ[]]நஅஅஅஅwhileஅany(map(lambdaஅs:அlen(s)அ<அsample_size,அsample_sets))அandஅlen(speakers)அ>அ0:நஅஅஅஅஅஅஅஅforஅsample_setஅinஅsample_sets:நஅஅஅஅஅஅஅஅஅஅஅஅifஅlen(sample_set)அ<அsample_sizeஅandஅlen(speakers)அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_set.extend(speakers.pop(0))நஅஅஅஅtrain_setஅ=அsum(speakers,அ[])நஅஅஅஅifஅlen(train_set)அ==அ0:நஅஅஅஅஅஅஅஅprint(நஅஅஅஅஅஅஅஅஅஅஅஅ"WARNING:அUnableஅtoஅbuildஅdevஅandஅtestஅsetsஅwithoutஅspeakerஅbiasஅasஅthereஅisஅnoஅspeakerஅmetaஅdata"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅrandom.seed(00)அஅ#அsameஅsourceஅdataஅ==அsameஅoutputநஅஅஅஅஅஅஅஅrandom.shuffle(samples)நஅஅஅஅஅஅஅஅforஅindex,அsampleஅinஅenumerate(samples):நஅஅஅஅஅஅஅஅஅஅஅஅifஅindexஅ<அsample_size:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample.sub_setஅ=அ"dev"நஅஅஅஅஅஅஅஅஅஅஅஅelifஅindexஅ<அ0அ*அsample_size:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample.sub_setஅ=அ"test"நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample.sub_setஅ=அ"train"நஅஅஅஅelse:நஅஅஅஅஅஅஅஅforஅsub_set,அsub_set_samplesஅinஅ[நஅஅஅஅஅஅஅஅஅஅஅஅ("train",அtrain_set),நஅஅஅஅஅஅஅஅஅஅஅஅ("dev",அsample_sets[0]),நஅஅஅஅஅஅஅஅஅஅஅஅ("test",அsample_sets[0]),நஅஅஅஅஅஅஅஅ]:நஅஅஅஅஅஅஅஅஅஅஅஅforஅsampleஅinஅsub_set_samples:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample.sub_setஅ=அsub_setநஅஅஅஅforஅsub_set,அsub_set_samplesஅinஅgroup(samples,அlambdaஅs:அs.sub_set).items():நஅஅஅஅஅஅஅஅtஅ=அsum(map(lambdaஅs:அs.endஅ-அs.start,அsub_set_samples))அ/அ(0000அ*அ00அ*அ00)நஅஅஅஅஅஅஅஅprint(நஅஅஅஅஅஅஅஅஅஅஅஅ'Sub-setஅ"{}"அwithஅ{}அsamplesஅ(duration:அ{:.0f}அh)'.format(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsub_set,அlen(sub_set_samples),அtநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅ)நநநdefஅcreate_sample_dirs(language):நஅஅஅஅprint("Creatingஅsampleஅdirectories...")நஅஅஅஅforஅset_nameஅinஅ["train",அ"dev",அ"test"]:நஅஅஅஅஅஅஅஅdir_pathஅ=அos.path.join(CLI_ARGS.base_dir,அlanguageஅ+அ"-"அ+அset_name)நஅஅஅஅஅஅஅஅifஅnotஅos.path.isdir(dir_path):நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(dir_path)நநநdefஅsplit_audio_files(samples,அlanguage):நஅஅஅஅprint("Splittingஅaudioஅfiles...")நஅஅஅஅsub_setsஅ=அCounter()நஅஅஅஅsrc_wav_filesஅ=அgroup(samples,அlambdaஅs:அs.wav_path).items()நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(src_wav_files),அwidgets=SIMPLE_BAR)நஅஅஅஅforஅwav_path,அfile_samplesஅinஅbar(src_wav_files):நஅஅஅஅஅஅஅஅfile_samplesஅ=அsorted(file_samples,அkey=lambdaஅs:அs.start)நஅஅஅஅஅஅஅஅwithஅwave.open(wav_path,அ"r")அasஅsrc_wav_file:நஅஅஅஅஅஅஅஅஅஅஅஅrateஅ=அsrc_wav_file.getframerate()நஅஅஅஅஅஅஅஅஅஅஅஅforஅsampleஅinஅfile_samples:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅindexஅ=அsub_sets[sample.sub_set]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_wav_pathஅ=அos.path.join(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅCLI_ARGS.base_dir,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlanguageஅ+அ"-"அ+அsample.sub_set,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"sample-{0:00d}.wav".format(index),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample.wav_pathஅ=அsample_wav_pathநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsub_sets[sample.sub_set]அ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsrc_wav_file.setpos(int(sample.startஅ*அrateஅ/அ0000.0))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdataஅ=அsrc_wav_file.readframes(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅint((sample.endஅ-அsample.start)அ*அrateஅ/அ0000.0)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwithஅwave.open(sample_wav_path,அ"w")அasஅsample_wav_file:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_wav_file.setnchannels(src_wav_file.getnchannels())நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_wav_file.setsampwidth(src_wav_file.getsampwidth())நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_wav_file.setframerate(rate)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_wav_file.writeframes(data)நநநdefஅwrite_csvs(samples,அlanguage):நஅஅஅஅforஅsub_set,அset_samplesஅinஅgroup(samples,அlambdaஅs:அs.sub_set).items():நஅஅஅஅஅஅஅஅset_samplesஅ=அsorted(set_samples,அkey=lambdaஅs:அs.wav_path)நஅஅஅஅஅஅஅஅbase_dirஅ=அos.path.abspath(CLI_ARGS.base_dir)நஅஅஅஅஅஅஅஅcsv_pathஅ=அos.path.join(base_dir,அlanguageஅ+அ"-"அ+அsub_setஅ+அ".csv")நஅஅஅஅஅஅஅஅprint('Writingஅ"{}"...'.format(csv_path))நஅஅஅஅஅஅஅஅwithஅopen(csv_path,அ"w",அencoding="utf-0",அnewline="")அasஅcsv_file:நஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அcsv.DictWriter(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcsv_file,அfieldnames=FIELDNAMES_EXTஅifஅCLI_ARGS.add_metaஅelseஅFIELDNAMESநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅwriter.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmax_value=len(set_samples),அwidgets=SIMPLE_BARநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅforஅsampleஅinஅbar(set_samples):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrowஅ=அ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filename":அos.path.relpath(sample.wav_path,அbase_dir),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filesize":அos.path.getsize(sample.wav_path),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript":அsample.text,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅCLI_ARGS.add_meta:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrow["article"]அ=அsample.articleநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrow["speaker"]அ=அsample.speakerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(row)நநநdefஅcleanup(archive,அlanguage):நஅஅஅஅifஅnotஅCLI_ARGS.keep_archive:நஅஅஅஅஅஅஅஅprint('Removingஅarchiveஅ"{}"...'.format(archive))நஅஅஅஅஅஅஅஅos.remove(archive)நஅஅஅஅlanguage_dirஅ=அos.path.join(CLI_ARGS.base_dir,அlanguage)நஅஅஅஅifஅnotஅCLI_ARGS.keep_intermediateஅandஅos.path.isdir(language_dir):நஅஅஅஅஅஅஅஅprint('Removingஅintermediateஅfilesஅinஅ"{}"...'.format(language_dir))நஅஅஅஅஅஅஅஅshutil.rmtree(language_dir)நநநdefஅprepare_language(language):நஅஅஅஅarchiveஅ=அmaybe_download_language(language)நஅஅஅஅextractedஅ=அmaybe_extract(CLI_ARGS.base_dir,அlanguage,அarchive)நஅஅஅஅmaybe_convert_to_wav(extracted)நஅஅஅஅsamplesஅ=அcollect_samples(extracted,அlanguage)நஅஅஅஅassign_sub_sets(samples)நஅஅஅஅcreate_sample_dirs(language)நஅஅஅஅsplit_audio_files(samples,அlanguage)நஅஅஅஅwrite_csvs(samples,அlanguage)நஅஅஅஅcleanup(archive,அlanguage)நநநdefஅhandle_args():நஅஅஅஅparserஅ=அargparse.ArgumentParser(description="ImportஅSpokenஅWikipediaஅCorpora")நஅஅஅஅparser.add_argument("base_dir",அhelp="Directoryஅcontainingஅallஅdata")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--language",அdefault="all",அhelp="Oneஅofஅ(all|{})".format("|".join(LANGUAGES))நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--exclude_numbers",நஅஅஅஅஅஅஅஅtype=bool,நஅஅஅஅஅஅஅஅdefault=True,நஅஅஅஅஅஅஅஅhelp="Ifஅsequencesஅwithஅnon-transliteratedஅnumbersஅshouldஅbeஅexcluded",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--max_duration",நஅஅஅஅஅஅஅஅtype=int,நஅஅஅஅஅஅஅஅdefault=00000,நஅஅஅஅஅஅஅஅhelp="Maximumஅsampleஅdurationஅinஅmilliseconds",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--ignore_too_long",நஅஅஅஅஅஅஅஅtype=bool,நஅஅஅஅஅஅஅஅdefault=False,நஅஅஅஅஅஅஅஅhelp="Ifஅsamplesஅexceedingஅmax_durationஅshouldஅbeஅremoved",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--normalize",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Convertsஅdiacriticஅcharactersஅtoஅtheirஅbaseஅones",நஅஅஅஅ)நஅஅஅஅforஅlanguageஅinஅLANGUAGES:நஅஅஅஅஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅஅஅஅஅ"--{}_alphabet".format(language),நஅஅஅஅஅஅஅஅஅஅஅஅhelp="Excludeஅ{}அsamplesஅwithஅcharactersஅnotஅinஅprovidedஅalphabetஅfile".format(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlanguageநஅஅஅஅஅஅஅஅஅஅஅஅ),நஅஅஅஅஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--add_meta",அaction="store_true",அhelp="AddsஅarticleஅandஅspeakerஅCSVஅcolumns"நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--exclude_unknown_speakers",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Excludeஅunknownஅspeakers",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--exclude_unknown_articles",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Excludeஅunknownஅarticles",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--keep_archive",நஅஅஅஅஅஅஅஅtype=bool,நஅஅஅஅஅஅஅஅdefault=True,நஅஅஅஅஅஅஅஅhelp="Ifஅdownloadedஅarchivesஅshouldஅbeஅkept",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--keep_intermediate",நஅஅஅஅஅஅஅஅtype=bool,நஅஅஅஅஅஅஅஅdefault=False,நஅஅஅஅஅஅஅஅhelp="Ifஅintermediateஅfilesஅshouldஅbeஅkept",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅCLI_ARGSஅ=அhandle_args()நஅஅஅஅifஅCLI_ARGS.languageஅ==அ"all":நஅஅஅஅஅஅஅஅforஅlangஅinஅLANGUAGES:நஅஅஅஅஅஅஅஅஅஅஅஅprepare_language(lang)நஅஅஅஅelifஅCLI_ARGS.languageஅinஅLANGUAGES:நஅஅஅஅஅஅஅஅprepare_language(CLI_ARGS.language)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅfail("Wrongஅlanguageஅid")ந#!/usr/bin/envஅpythonந"""நToolஅforஅplayingஅ(andஅaugmenting)அsingleஅsamplesஅorஅsamplesஅfromஅSampleஅDatabasesஅ(SDBஅfiles)அandஅDeepSpeechஅCSVஅfilesநUseஅ"python0அplay.pyஅ-h"அforஅhelpந"""நநimportஅosநimportஅsysநimportஅrandomநimportஅargparseநநfromஅdeepspeech_training.util.audioஅimportஅget_loadable_audio_type_from_extension,அAUDIO_TYPE_PCM,அAUDIO_TYPE_WAVநfromஅdeepspeech_training.util.sample_collectionsஅimportஅSampleList,அLabeledSample,அsamples_from_sourceநfromஅdeepspeech_training.util.augmentationsஅimportஅparse_augmentations,அapply_sample_augmentations,அSampleAugmentationநநநdefஅget_samples_in_play_order():நஅஅஅஅextஅ=அos.path.splitext(CLI_ARGS.source)[0].lower()நஅஅஅஅifஅget_loadable_audio_type_from_extension(ext):நஅஅஅஅஅஅஅஅsamplesஅ=அSampleList([(CLI_ARGS.source,அ0)],அlabeled=False)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅsamplesஅ=அsamples_from_source(CLI_ARGS.source,அbuffering=0)நஅஅஅஅplayedஅ=அ0நஅஅஅஅindexஅ=அCLI_ARGS.startநஅஅஅஅwhileஅTrue:நஅஅஅஅஅஅஅஅifஅ0அ<=அCLI_ARGS.numberஅ<=அplayed:நஅஅஅஅஅஅஅஅஅஅஅஅreturnநஅஅஅஅஅஅஅஅifஅCLI_ARGS.random:நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅsamples[random.randint(0,அlen(samples)அ-அ0)]நஅஅஅஅஅஅஅஅelifஅindexஅ<அ0:நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅsamples[len(samples)அ+அindex]நஅஅஅஅஅஅஅஅelifஅindexஅ>=அlen(samples):நஅஅஅஅஅஅஅஅஅஅஅஅprint("Noஅsampleஅwithஅindexஅ{}".format(CLI_ARGS.start))நஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(0)நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅsamples[index]நஅஅஅஅஅஅஅஅplayedஅ+=அ0நஅஅஅஅஅஅஅஅindexஅ=அ(indexஅ+அ0)அ%அlen(samples)நநநdefஅplay_collection():நஅஅஅஅaugmentationsஅ=அparse_augmentations(CLI_ARGS.augment)நஅஅஅஅifஅany(notஅisinstance(a,அSampleAugmentation)அforஅaஅinஅaugmentations):நஅஅஅஅஅஅஅஅprint("Warning:அSomeஅofஅtheஅaugmentationsஅcannotஅbeஅsimulatedஅbyஅthisஅcommand.")நஅஅஅஅsamplesஅ=அget_samples_in_play_order()நஅஅஅஅsamplesஅ=அapply_sample_augmentations(samples,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudio_type=AUDIO_TYPE_PCM,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaugmentations=augmentations,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprocess_ahead=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅclock=CLI_ARGS.clock)நஅஅஅஅforஅsampleஅinஅsamples:நஅஅஅஅஅஅஅஅifஅnotஅCLI_ARGS.quiet:நஅஅஅஅஅஅஅஅஅஅஅஅprint('Sampleஅ"{}"'.format(sample.sample_id),அfile=sys.stderr)நஅஅஅஅஅஅஅஅஅஅஅஅifஅisinstance(sample,அLabeledSample):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint('அஅ"{}"'.format(sample.transcript),அfile=sys.stderr)நஅஅஅஅஅஅஅஅifஅCLI_ARGS.pipe:நஅஅஅஅஅஅஅஅஅஅஅஅsample.change_audio_type(AUDIO_TYPE_WAV)நஅஅஅஅஅஅஅஅஅஅஅஅsys.stdout.buffer.write(sample.audio.getvalue())நஅஅஅஅஅஅஅஅஅஅஅஅreturnநஅஅஅஅஅஅஅஅwave_objஅ=அsimpleaudio.WaveObject(sample.audio,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample.audio_format.channels,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample.audio_format.width,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample.audio_format.rate)நஅஅஅஅஅஅஅஅplay_objஅ=அwave_obj.play()நஅஅஅஅஅஅஅஅplay_obj.wait_done()நநநdefஅhandle_args():நஅஅஅஅparserஅ=அargparse.ArgumentParser(நஅஅஅஅஅஅஅஅdescription="Toolஅforஅplayingஅ(andஅaugmenting)அsingleஅsamplesஅorஅsamplesஅfromஅSampleஅDatabasesஅ(SDBஅfiles)அ"நஅஅஅஅஅஅஅஅ"andஅDeepSpeechஅCSVஅfiles"நஅஅஅஅ)நஅஅஅஅparser.add_argument("source",அhelp="SampleஅDB,அCSVஅorஅWAVஅfileஅtoஅplayஅsamplesஅfrom")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--start",நஅஅஅஅஅஅஅஅtype=int,நஅஅஅஅஅஅஅஅdefault=0,நஅஅஅஅஅஅஅஅhelp="Sampleஅindexஅtoஅstartஅatஅ(negativeஅnumbersஅareஅrelativeஅtoஅtheஅendஅofஅtheஅcollection)",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--number",நஅஅஅஅஅஅஅஅtype=int,நஅஅஅஅஅஅஅஅdefault=-0,நஅஅஅஅஅஅஅஅhelp="Numberஅofஅsamplesஅtoஅplayஅ(-0அforஅendless)",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--random",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Ifஅsamplesஅshouldஅbeஅplayedஅinஅrandomஅorder",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--augment",நஅஅஅஅஅஅஅஅaction='append',நஅஅஅஅஅஅஅஅhelp="Addஅanஅaugmentationஅoperation",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--clock",நஅஅஅஅஅஅஅஅtype=float,நஅஅஅஅஅஅஅஅdefault=0.0,நஅஅஅஅஅஅஅஅhelp="Simulatesஅclockஅvalueஅusedஅforஅaugmentationsஅduringஅtraining."நஅஅஅஅஅஅஅஅஅஅஅஅஅ"Rangesஅfromஅ0.0அ(representingஅparameterஅstartஅvalues)அto"நஅஅஅஅஅஅஅஅஅஅஅஅஅ"0.0அ(representingஅparameterஅendஅvalues)",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--pipe",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Pipeஅfirstஅsampleஅasஅwavஅfileஅtoஅstdout.அForcesஅ--numberஅtoஅ0.",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--quiet",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Noஅinfoஅloggingஅtoஅconsole",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅCLI_ARGSஅ=அhandle_args()நஅஅஅஅifஅnotஅCLI_ARGS.pipe:நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅimportஅsimpleaudioநஅஅஅஅஅஅஅஅexceptஅModuleNotFoundError:நஅஅஅஅஅஅஅஅஅஅஅஅprint('Unlessஅusingஅtheஅ--pipeஅflag,அplay.pyஅrequiresஅPythonஅpackageஅ"simpleaudio"அforஅplayingஅsamples')நஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(0)நஅஅஅஅtry:நஅஅஅஅஅஅஅஅplay_collection()நஅஅஅஅexceptஅKeyboardInterrupt:நஅஅஅஅஅஅஅஅprint("அStopped")நஅஅஅஅஅஅஅஅsys.exit(0)ந#!/usr/bin/envஅpython0நimportஅcsvநimportஅosநimportஅsubprocessநimportஅtarfileநimportஅunicodedataநfromஅglobஅimportஅglobநfromஅmultiprocessingஅimportஅPoolநநimportஅprogressbarநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.importersஅimportஅ(நஅஅஅஅget_counter,நஅஅஅஅget_imported_samples,நஅஅஅஅget_importers_parser,நஅஅஅஅget_validate_label,நஅஅஅஅprint_import_report,ந)நfromஅds_ctcdecoderஅimportஅAlphabetநநFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நSAMPLE_RATEஅ=அ00000நMAX_SECSஅ=அ00நநARCHIVE_DIR_NAMEஅ=அ"African_Accented_French"நARCHIVE_NAMEஅ=அ"African_Accented_French.tar.gz"நARCHIVE_URLஅ=அ"http://www.openslr.org/resources/00/"அ+அARCHIVE_NAMEநநநdefஅ_download_and_preprocess_data(target_dir):நஅஅஅஅ#அMakingஅpathஅabsoluteநஅஅஅஅtarget_dirஅ=அos.path.abspath(target_dir)நஅஅஅஅ#அConditionallyஅdownloadஅdataநஅஅஅஅarchive_pathஅ=அmaybe_download(ARCHIVE_NAME,அtarget_dir,அARCHIVE_URL)நஅஅஅஅ#அConditionallyஅextractஅdataநஅஅஅஅ_maybe_extract(target_dir,அARCHIVE_DIR_NAME,அarchive_path)நஅஅஅஅ#அProduceஅCSVஅfilesநஅஅஅஅ_maybe_convert_sets(target_dir,அARCHIVE_DIR_NAME)நநநdefஅ_maybe_extract(target_dir,அextracted_data,அarchive_path):நஅஅஅஅ#அIfஅtarget_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅtarget_dirநஅஅஅஅextracted_pathஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅifஅnotஅos.path.exists(extracted_path):நஅஅஅஅஅஅஅஅprint('Noஅdirectoryஅ"%s"அ-அextractingஅarchive...'அ%அextracted_path)நஅஅஅஅஅஅஅஅifஅnotஅos.path.isdir(extracted_path):நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(extracted_path)நஅஅஅஅஅஅஅஅtarஅ=அtarfile.open(archive_path)நஅஅஅஅஅஅஅஅtar.extractall(target_dir)நஅஅஅஅஅஅஅஅtar.close()நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Foundஅdirectoryஅ"%s"அ-அnotஅextractingஅitஅfromஅarchive.'அ%அarchive_path)நநநdefஅone_sample(sample):நஅஅஅஅ"""அTakeஅaஅaudioஅfile,அandஅoptionallyஅconvertஅitஅtoஅ00kHzஅWAVஅ"""நஅஅஅஅwav_filenameஅ=அsample[0]நஅஅஅஅfile_sizeஅ=அ-0நஅஅஅஅframesஅ=அ0நஅஅஅஅifஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅfile_sizeஅ=அos.path.getsize(wav_filename)நஅஅஅஅஅஅஅஅframesஅ=அint(நஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_output(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ["soxi",அ"-s",அwav_filename],அstderr=subprocess.STDOUTநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅ)நஅஅஅஅlabelஅ=அlabel_filter(sample[0])நஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅrowsஅ=அ[]நஅஅஅஅifஅfile_sizeஅ==அ-0:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅuponஅconversionநஅஅஅஅஅஅஅஅcounter["failed"]அ+=அ0நஅஅஅஅelifஅlabelஅisஅNone:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅonஅlabelஅvalidationநஅஅஅஅஅஅஅஅcounter["invalid_label"]அ+=அ0நஅஅஅஅelifஅint(framesஅ/அSAMPLE_RATEஅ*அ0000அ/அ00அ/அ0)அ<அlen(str(label)):நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅareஅtooஅshortஅtoஅfitஅtheஅtranscriptநஅஅஅஅஅஅஅஅcounter["too_short"]அ+=அ0நஅஅஅஅelifஅframesஅ/அSAMPLE_RATEஅ>அMAX_SECS:நஅஅஅஅஅஅஅஅ#அExcludingஅveryஅlongஅsamplesஅtoஅkeepஅaஅreasonableஅbatch-sizeநஅஅஅஅஅஅஅஅcounter["too_long"]அ+=அ0நஅஅஅஅelse:நஅஅஅஅஅஅஅஅ#அThisஅoneஅisஅgoodஅ-அkeepஅitஅforஅtheஅtargetஅCSVநஅஅஅஅஅஅஅஅrows.append((wav_filename,அfile_size,அlabel))நஅஅஅஅஅஅஅஅcounter["imported_time"]அ+=அframesநஅஅஅஅcounter["all"]அ+=அ0நஅஅஅஅcounter["total_time"]அ+=அframesநநஅஅஅஅreturnஅ(counter,அrows)நநநdefஅ_maybe_convert_sets(target_dir,அextracted_data):நஅஅஅஅextracted_dirஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅ#அoverrideஅexistingஅCSVஅwithஅnormalizedஅoneநஅஅஅஅtarget_csv_templateஅ=அos.path.join(நஅஅஅஅஅஅஅஅtarget_dir,அARCHIVE_DIR_NAME,அARCHIVE_NAME.replace(".tar.gz",அ"_{}.csv")நஅஅஅஅ)நஅஅஅஅifஅos.path.isfile(target_csv_template):நஅஅஅஅஅஅஅஅreturnநநஅஅஅஅwav_root_dirஅ=அos.path.join(extracted_dir)நநஅஅஅஅall_filesஅ=அ[நஅஅஅஅஅஅஅஅ"transcripts/train/yaounde/fn_text.txt",நஅஅஅஅஅஅஅஅ"transcripts/train/ca00_conv/transcripts.txt",நஅஅஅஅஅஅஅஅ"transcripts/train/ca00_read/conditioned.txt",நஅஅஅஅஅஅஅஅ"transcripts/dev/niger_west_african_fr/transcripts.txt",நஅஅஅஅஅஅஅஅ"speech/dev/niger_west_african_fr/niger_wav_file_name_transcript.tsv",நஅஅஅஅஅஅஅஅ"transcripts/devtest/ca00_read/conditioned.txt",நஅஅஅஅஅஅஅஅ"transcripts/test/ca00/prompts.txt",நஅஅஅஅ]நநஅஅஅஅtranscriptsஅ=அ{}நஅஅஅஅforஅtrஅinஅall_files:நஅஅஅஅஅஅஅஅwithஅopen(os.path.join(target_dir,அARCHIVE_DIR_NAME,அtr),அ"r")அasஅtr_source:நஅஅஅஅஅஅஅஅஅஅஅஅforஅlineஅinஅtr_source.readlines():நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlineஅ=அline.strip()நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅ".tsv"அinஅtr:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsepஅ=அ"ட"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsepஅ=அ"அ"நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudioஅ=அos.path.basename(line.split(sep)[0])நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅ(".wav"அinஅaudio):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅ".tdf"அinஅaudio:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudioஅ=அaudio.replace(".tdf",அ".wav")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudioஅ+=அ".wav"நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அ"அ".join(line.split(sep)[0:])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscripts[audio]அ=அtranscriptநநஅஅஅஅ#அGetஅaudiofileஅpathஅandஅtranscriptஅforஅeachஅsentenceஅinஅtsvநஅஅஅஅsamplesஅ=அ[]நஅஅஅஅglob_dirஅ=அos.path.join(wav_root_dir,அ"**/*.wav")நஅஅஅஅforஅrecordஅinஅglob(glob_dir,அrecursive=True):நஅஅஅஅஅஅஅஅrecord_fileஅ=அos.path.basename(record)நஅஅஅஅஅஅஅஅifஅrecord_fileஅinஅtranscripts:நஅஅஅஅஅஅஅஅஅஅஅஅsamples.append((record,அtranscripts[record_file]))நநஅஅஅஅ#அKeepஅtrackஅofஅhowஅmanyஅsamplesஅareஅgoodஅvs.அproblematicநஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅnum_samplesஅ=அlen(samples)நஅஅஅஅrowsஅ=அ[]நநஅஅஅஅprint("ImportingஅWAVஅfiles...")நஅஅஅஅpoolஅ=அPool()நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅforஅi,அprocessedஅinஅenumerate(pool.imap_unordered(one_sample,அsamples),அstart=0):நஅஅஅஅஅஅஅஅcounterஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅrowsஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅbar.update(i)நஅஅஅஅbar.update(num_samples)நஅஅஅஅpool.close()நஅஅஅஅpool.join()நநஅஅஅஅwithஅopen(target_csv_template.format("train"),அ"w",அencoding="utf-0",அnewline="")அasஅtrain_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("dev"),அ"w",அencoding="utf-0",அnewline="")அasஅdev_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("test"),அ"w",அencoding="utf-0",அnewline="")அasஅtest_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writerஅ=அcsv.DictWriter(train_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writerஅ=அcsv.DictWriter(dev_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writerஅ=அcsv.DictWriter(test_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writer.writeheader()நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅi,அitemஅinஅenumerate(rows):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அvalidate_label(item[0])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅtranscript:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அitem[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅi_modஅ=அiஅ%அ00நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtest_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அdev_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtrain_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdict(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filename=wav_filename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesize=os.path.getsize(wav_filename),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript=transcript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅimported_samplesஅ=அget_imported_samples(counter)நஅஅஅஅassertஅcounter["all"]அ==அnum_samplesநஅஅஅஅassertஅlen(rows)அ==அimported_samplesநநஅஅஅஅprint_import_report(counter,அSAMPLE_RATE,அMAX_SECS)நநநdefஅhandle_args():நஅஅஅஅparserஅ=அget_importers_parser(நஅஅஅஅஅஅஅஅdescription="ImporterஅforஅAfricanஅAccentedஅFrenchஅdataset.அMoreஅinformationஅonஅhttp://www.openslr.org/00/."நஅஅஅஅ)நஅஅஅஅparser.add_argument(dest="target_dir")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--filter_alphabet",நஅஅஅஅஅஅஅஅhelp="Excludeஅsamplesஅwithஅcharactersஅnotஅinஅprovidedஅalphabet",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--normalize",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Convertsஅdiacriticஅcharactersஅtoஅtheirஅbaseஅones",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅCLI_ARGSஅ=அhandle_args()நஅஅஅஅALPHABETஅ=அAlphabet(CLI_ARGS.filter_alphabet)அifஅCLI_ARGS.filter_alphabetஅelseஅNoneநஅஅஅஅvalidate_labelஅ=அget_validate_label(CLI_ARGS)நநஅஅஅஅdefஅlabel_filter(label):நஅஅஅஅஅஅஅஅifஅCLI_ARGS.normalize:நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅunicodedata.normalize("NFKD",அlabel.strip())நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅlabelஅ=அvalidate_label(label)நஅஅஅஅஅஅஅஅifஅALPHABETஅandஅlabelஅandஅnotஅALPHABET.CanEncode(label):நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அNoneநஅஅஅஅஅஅஅஅreturnஅlabelநநஅஅஅஅ_download_and_preprocess_data(target_dir=CLI_ARGS.target_dir)ந#!/usr/bin/envஅpythonந"""நToolஅforஅcomparingஅtwoஅwavஅsamplesந"""நimportஅsysநimportஅargparseநimportஅnumpyஅasஅnpநநfromஅdeepspeech_training.util.audioஅimportஅAUDIO_TYPE_NP,அmean_dbfsநfromஅdeepspeech_training.util.sample_collectionsஅimportஅload_sampleநநநdefஅfail(message):நஅஅஅஅprint(message,அfile=sys.stderr,அflush=True)நஅஅஅஅsys.exit(0)நநநdefஅcompare_samples():நஅஅஅஅsample0அ=அload_sample(CLI_ARGS.sample0).unpack()நஅஅஅஅsample0அ=அload_sample(CLI_ARGS.sample0).unpack()நஅஅஅஅifஅsample0.audio_formatஅ!=அsample0.audio_format:நஅஅஅஅஅஅஅஅfail('Samplesஅdifferஅon:அaudio-formatஅ({}அandஅ{})'.format(sample0.audio_format,அsample0.audio_format))நஅஅஅஅifஅabs(sample0.durationஅ-அsample0.duration)அ>அ0.000:நஅஅஅஅஅஅஅஅfail('Samplesஅdifferஅon:அdurationஅ({}அandஅ{})'.format(sample0.duration,அsample0.duration))நஅஅஅஅsample0.change_audio_type(AUDIO_TYPE_NP)நஅஅஅஅsample0.change_audio_type(AUDIO_TYPE_NP)நஅஅஅஅsamplesஅ=அ[sample0,அsample0]நஅஅஅஅlargestஅ=அnp.argmax([sample0.audio.shape[0],அsample0.audio.shape[0]])நஅஅஅஅsmallestஅ=அ(largestஅ+அ0)அ%அ0நஅஅஅஅsamples[largest].audioஅ=அsamples[largest].audio[:len(samples[smallest].audio)]நஅஅஅஅaudio_diffஅ=அsamples[largest].audioஅ-அsamples[smallest].audioநஅஅஅஅdiff_dbfsஅ=அmean_dbfs(audio_diff)நஅஅஅஅdiffer_msgஅ=அ'Samplesஅdifferஅon:அsampleஅdataஅ({:0.0f}அdBஅdifference)அ'.format(diff_dbfs)நஅஅஅஅequal_msgஅ=அ'Samplesஅareஅconsideredஅequalஅ({:0.0f}அdBஅdifference)'.format(diff_dbfs)நஅஅஅஅifஅCLI_ARGS.if_differ:நஅஅஅஅஅஅஅஅifஅdiff_dbfsஅ<=அCLI_ARGS.threshold:நஅஅஅஅஅஅஅஅஅஅஅஅfail(equal_msg)நஅஅஅஅஅஅஅஅifஅnotஅCLI_ARGS.no_success_output:நஅஅஅஅஅஅஅஅஅஅஅஅprint(differ_msg,அfile=sys.stderr,அflush=True)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅifஅdiff_dbfsஅ>அCLI_ARGS.threshold:நஅஅஅஅஅஅஅஅஅஅஅஅfail(differ_msg)நஅஅஅஅஅஅஅஅifஅnotஅCLI_ARGS.no_success_output:நஅஅஅஅஅஅஅஅஅஅஅஅprint(equal_msg,அfile=sys.stderr,அflush=True)நநநdefஅhandle_args():நஅஅஅஅparserஅ=அargparse.ArgumentParser(நஅஅஅஅஅஅஅஅdescription="Toolஅforஅcheckingஅsimilarityஅofஅtwoஅsamples"நஅஅஅஅ)நஅஅஅஅparser.add_argument("sample0",அhelp="Filenameஅofஅsampleஅ0அtoஅcompare")நஅஅஅஅparser.add_argument("sample0",அhelp="Filenameஅofஅsampleஅ0அtoஅcompare")நஅஅஅஅparser.add_argument("--threshold",அtype=float,அdefault=-00.0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅhelp="dBஅofஅsampleஅdeltasஅaboveஅwhichஅtheyஅareஅconsideredஅdifferent")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--if-differ",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Ifஅtoஅsucceedஅandஅreturnஅstatusஅcodeஅ0அonஅdifferentஅsignalsஅandஅfailஅonஅequalஅonesஅ(inverseஅcheck)."நஅஅஅஅஅஅஅஅஅஅஅஅஅ"Thisஅwillஅstillஅfailஅonஅdifferentஅformatsஅorஅdurations.",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--no-success-output",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Stayஅsilentஅonஅsuccessஅ(ifஅsamplesஅareஅequalஅofஅ-அwithஅ--if-differஅ-அsamplesஅareஅnotஅequal)",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅCLI_ARGSஅ=அhandle_args()நஅஅஅஅcompare_samples()ந#!/usr/bin/envஅpythonநநimportஅcsvநimportஅloggingநimportஅmathநimportஅosநimportஅsubprocessநimportஅurllibநfromஅpathlibஅimportஅPathநநimportஅpandasஅasஅpdநfromஅsoxஅimportஅTransformerநநimportஅswifterநfromஅdeepspeech_training.util.importersஅimportஅget_importers_parser,அget_validate_labelநந__version__அ=அ"0.0.0"ந_loggerஅ=அlogging.getLogger(__name__)நநநMAX_SECSஅ=அ00நBITDEPTHஅ=அ00நN_CHANNELSஅ=அ0நSAMPLE_RATEஅ=அ00000நநDEV_PERCENTAGEஅ=அ0.00நTRAIN_PERCENTAGEஅ=அ0.00நநநdefஅparse_args(args):நஅஅஅஅ"""ParseஅcommandஅlineஅparametersநஅஅஅஅArgs:நஅஅஅஅஅஅargsஅ([str]):அCommandஅlineஅparametersஅasஅlistஅofஅstringsநஅஅஅஅReturns:நஅஅஅஅஅஅ:obj:`argparse.Namespace`:அcommandஅlineஅparametersஅnamespaceநஅஅஅஅ"""நஅஅஅஅparserஅ=அget_importers_parser(description="ImportsஅGramVaaniஅdataஅforஅDeepஅSpeech")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--version",நஅஅஅஅஅஅஅஅaction="version",நஅஅஅஅஅஅஅஅversion="GramVaaniImporterஅ{ver}".format(ver=__version__),நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"-v",நஅஅஅஅஅஅஅஅ"--verbose",நஅஅஅஅஅஅஅஅaction="store_const",நஅஅஅஅஅஅஅஅrequired=False,நஅஅஅஅஅஅஅஅhelp="setஅloglevelஅtoஅINFO",நஅஅஅஅஅஅஅஅdest="loglevel",நஅஅஅஅஅஅஅஅconst=logging.INFO,நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"-vv",நஅஅஅஅஅஅஅஅ"--very-verbose",நஅஅஅஅஅஅஅஅaction="store_const",நஅஅஅஅஅஅஅஅrequired=False,நஅஅஅஅஅஅஅஅhelp="setஅloglevelஅtoஅDEBUG",நஅஅஅஅஅஅஅஅdest="loglevel",நஅஅஅஅஅஅஅஅconst=logging.DEBUG,நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"-c",நஅஅஅஅஅஅஅஅ"--csv_filename",நஅஅஅஅஅஅஅஅrequired=True,நஅஅஅஅஅஅஅஅhelp="PathஅtoஅtheஅGramVaaniஅcsv",நஅஅஅஅஅஅஅஅdest="csv_filename",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"-t",நஅஅஅஅஅஅஅஅ"--target_dir",நஅஅஅஅஅஅஅஅrequired=True,நஅஅஅஅஅஅஅஅhelp="DirectoryஅinஅwhichஅtoஅsaveஅtheஅimporterஅGramVaaniஅdata",நஅஅஅஅஅஅஅஅdest="target_dir",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args(args)நநநdefஅsetup_logging(level):நஅஅஅஅ"""SetupஅbasicஅloggingநஅஅஅஅArgs:நஅஅஅஅஅஅlevelஅ(int):அminimumஅlogஅlevelஅforஅemittingஅmessagesநஅஅஅஅ"""நஅஅஅஅformatஅ=அ"[%(asctime)s]அ%(levelname)s:%(name)s:%(message)s"நஅஅஅஅlogging.basicConfig(நஅஅஅஅஅஅஅஅlevel=level,அstream=sys.stdout,அformat=format,அdatefmt="%Y-%m-%dஅ%H:%M:%S"நஅஅஅஅ)நநநclassஅGramVaaniCSV:நஅஅஅஅ"""GramVaaniCSVஅrepresentingஅaஅGramVaaniஅdataset.நஅஅஅஅArgs:நஅஅஅஅஅஅcsv_filenameஅ(str):அPathஅtoஅtheஅGramVaaniஅcsvநஅஅஅஅAttributes:நஅஅஅஅஅஅஅஅdataஅ(:class:`pandas.DataFrame`):அ`pandas.DataFrame`அContainingஅtheஅGramVaaniஅcsvஅdataநஅஅஅஅ"""நநஅஅஅஅdefஅ__init__(self,அcsv_filename):நஅஅஅஅஅஅஅஅself.dataஅ=அself._parse_csv(csv_filename)நநஅஅஅஅdefஅ_parse_csv(self,அcsv_filename):நஅஅஅஅஅஅஅஅ_logger.info("Parsingஅcsvஅfile...%s",அos.path.abspath(csv_filename))நஅஅஅஅஅஅஅஅdataஅ=அpd.read_csv(நஅஅஅஅஅஅஅஅஅஅஅஅos.path.abspath(csv_filename),நஅஅஅஅஅஅஅஅஅஅஅஅnames=[நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"piece_id",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"audio_url",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript_labelled",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"labels",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"content_filename",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"audio_length",நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"user_id",நஅஅஅஅஅஅஅஅஅஅஅஅ],நஅஅஅஅஅஅஅஅஅஅஅஅusecols=["audio_url",அ"transcript",அ"audio_length"],நஅஅஅஅஅஅஅஅஅஅஅஅskiprows=[0],நஅஅஅஅஅஅஅஅஅஅஅஅengine="python",நஅஅஅஅஅஅஅஅஅஅஅஅencoding="utf-0",நஅஅஅஅஅஅஅஅஅஅஅஅquotechar='"',நஅஅஅஅஅஅஅஅஅஅஅஅquoting=csv.QUOTE_ALL,நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅdata.dropna(inplace=True)நஅஅஅஅஅஅஅஅ_logger.info("Parsedஅ%dஅlinesஅcsvஅfile."அ%அlen(data))நஅஅஅஅஅஅஅஅreturnஅdataநநநclassஅGramVaaniDownloader:நஅஅஅஅ"""GramVaaniDownloaderஅdownloadsஅaஅGramVaaniஅdataset.நஅஅஅஅArgs:நஅஅஅஅஅஅgram_vaani_csvஅ(GramVaaniCSV):அAஅGramVaaniCSVஅrepresentingஅtheஅdataஅtoஅdownloadநஅஅஅஅஅஅtarget_dirஅ(str):அTheஅpathஅtoஅdownloadஅtheஅdataஅtoநஅஅஅஅAttributes:நஅஅஅஅஅஅஅஅdataஅ(:class:`pandas.DataFrame`):அ`pandas.DataFrame`அContainingஅtheஅGramVaaniஅcsvஅdataநஅஅஅஅ"""நநஅஅஅஅdefஅ__init__(self,அgram_vaani_csv,அtarget_dir):நஅஅஅஅஅஅஅஅself.target_dirஅ=அtarget_dirநஅஅஅஅஅஅஅஅself.dataஅ=அgram_vaani_csv.dataநநஅஅஅஅdefஅdownload(self):நஅஅஅஅஅஅஅஅ"""DownloadsஅtheஅdataஅassociatedஅwithஅthisஅinstanceநஅஅஅஅஅஅஅஅReturn:நஅஅஅஅஅஅஅஅஅஅmp0_directoryஅ(os.path):அTheஅdirectoryஅintoஅwhichஅtheஅassociatedஅmp0'sஅwereஅdownloadedநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅmp0_directoryஅ=அself._pre_download()நஅஅஅஅஅஅஅஅself.data.swifter.apply(நஅஅஅஅஅஅஅஅஅஅஅஅfunc=lambdaஅarg:அself._download(*arg,அmp0_directory),அaxis=0,அraw=Trueநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅreturnஅmp0_directoryநநஅஅஅஅdefஅ_pre_download(self):நஅஅஅஅஅஅஅஅmp0_directoryஅ=அos.path.join(self.target_dir,அ"mp0")நஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(self.target_dir):நஅஅஅஅஅஅஅஅஅஅஅஅ_logger.info("Creatingஅdirectory...%s",அself.target_dir)நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(self.target_dir)நஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(mp0_directory):நஅஅஅஅஅஅஅஅஅஅஅஅ_logger.info("Creatingஅdirectory...%s",அmp0_directory)நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(mp0_directory)நஅஅஅஅஅஅஅஅreturnஅmp0_directoryநநஅஅஅஅdefஅ_download(self,அaudio_url,அtranscript,அaudio_length,அmp0_directory):நஅஅஅஅஅஅஅஅifஅaudio_urlஅ==அ"audio_url":நஅஅஅஅஅஅஅஅஅஅஅஅreturnநஅஅஅஅஅஅஅஅmp0_filenameஅ=அos.path.join(mp0_directory,அos.path.basename(audio_url))நஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(mp0_filename):நஅஅஅஅஅஅஅஅஅஅஅஅ_logger.debug("Downloadingஅmp0அfile...%s",அaudio_url)நஅஅஅஅஅஅஅஅஅஅஅஅurllib.request.urlretrieve(audio_url,அmp0_filename)நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅ_logger.debug("Alreadyஅdownloadedஅmp0அfile...%s",அaudio_url)நநநclassஅGramVaaniConverter:நஅஅஅஅ"""GramVaaniConverterஅconvertsஅtheஅmp0'sஅtoஅwav'sஅforஅaஅGramVaaniஅdataset.நஅஅஅஅArgs:நஅஅஅஅஅஅtarget_dirஅ(str):அTheஅpathஅtoஅdownloadஅtheஅdataஅfromநஅஅஅஅஅஅmp0_directoryஅ(os.path):அTheஅpathஅcontainingஅtheஅGramVaaniஅmp0'sநஅஅஅஅAttributes:நஅஅஅஅஅஅஅஅtarget_dirஅ(str):அTheஅtargetஅdirectoryஅpassedஅasஅaஅcommandஅlineஅargumentநஅஅஅஅஅஅஅஅmp0_directoryஅ(os.path):அTheஅpathஅcontainingஅtheஅGramVaaniஅmp0'sநஅஅஅஅ"""நநஅஅஅஅdefஅ__init__(self,அtarget_dir,அmp0_directory):நஅஅஅஅஅஅஅஅself.target_dirஅ=அtarget_dirநஅஅஅஅஅஅஅஅself.mp0_directoryஅ=அPath(mp0_directory)நநஅஅஅஅdefஅconvert(self):நஅஅஅஅஅஅஅஅ"""Convertsஅtheஅmp0'sஅassociatedஅwithஅthisஅinstanceஅtoஅwav'sநஅஅஅஅஅஅஅஅReturn:நஅஅஅஅஅஅஅஅஅஅwav_directoryஅ(os.path):அTheஅdirectoryஅintoஅwhichஅtheஅassociatedஅwav'sஅwereஅdownloadedநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅwav_directoryஅ=அself._pre_convert()நஅஅஅஅஅஅஅஅforஅmp0_filenameஅinஅself.mp0_directory.glob("**/*.mp0"):நஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அos.path.join(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_directory,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.splitext(os.path.basename(mp0_filename))[0]அ+அ".wav",நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ_logger.debug(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"Convertingஅmp0அfileஅ%sஅtoஅwavஅfileஅ%s"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ%அ(mp0_filename,அwav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtransformerஅ=அTransformer()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtransformer.convert(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsamplerate=SAMPLE_RATE,அn_channels=N_CHANNELS,அbitdepth=BITDEPTHநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(str(mp0_filename),அstr(wav_filename))நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ_logger.debug(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"Alreadyஅconvertedஅmp0அfileஅ%sஅtoஅwavஅfileஅ%s"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ%அ(mp0_filename,அwav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅreturnஅwav_directoryநநஅஅஅஅdefஅ_pre_convert(self):நஅஅஅஅஅஅஅஅwav_directoryஅ=அos.path.join(self.target_dir,அ"wav")நஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(self.target_dir):நஅஅஅஅஅஅஅஅஅஅஅஅ_logger.info("Creatingஅdirectory...%s",அself.target_dir)நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(self.target_dir)நஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(wav_directory):நஅஅஅஅஅஅஅஅஅஅஅஅ_logger.info("Creatingஅdirectory...%s",அwav_directory)நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(wav_directory)நஅஅஅஅஅஅஅஅreturnஅwav_directoryநநநclassஅGramVaaniDataSets:நஅஅஅஅdefஅ__init__(self,அtarget_dir,அwav_directory,அgram_vaani_csv):நஅஅஅஅஅஅஅஅself.target_dirஅ=அtarget_dirநஅஅஅஅஅஅஅஅself.wav_directoryஅ=அwav_directoryநஅஅஅஅஅஅஅஅself.csv_dataஅ=அgram_vaani_csv.dataநஅஅஅஅஅஅஅஅself.rawஅ=அpd.DataFrame(columns=["wav_filename",அ"wav_filesize",அ"transcript"])நஅஅஅஅஅஅஅஅself.validஅ=அpd.DataFrame(நஅஅஅஅஅஅஅஅஅஅஅஅcolumns=["wav_filename",அ"wav_filesize",அ"transcript"]நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅself.trainஅ=அpd.DataFrame(நஅஅஅஅஅஅஅஅஅஅஅஅcolumns=["wav_filename",அ"wav_filesize",அ"transcript"]நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅself.devஅ=அpd.DataFrame(columns=["wav_filename",அ"wav_filesize",அ"transcript"])நஅஅஅஅஅஅஅஅself.testஅ=அpd.DataFrame(columns=["wav_filename",அ"wav_filesize",அ"transcript"])நநஅஅஅஅdefஅcreate(self):நஅஅஅஅஅஅஅஅself._convert_csv_data_to_raw_data()நஅஅஅஅஅஅஅஅself.raw.indexஅ=அrange(len(self.raw.index))நஅஅஅஅஅஅஅஅself.validஅ=அself.raw[self._is_valid_raw_rows()]நஅஅஅஅஅஅஅஅself.validஅ=அself.valid.sample(frac=0).reset_index(drop=True)நஅஅஅஅஅஅஅஅtrain_size,அdev_size,அtest_sizeஅ=அself._calculate_data_set_sizes()நஅஅஅஅஅஅஅஅself.trainஅ=அself.valid.loc[0:train_size]நஅஅஅஅஅஅஅஅself.devஅ=அself.valid.loc[train_sizeஅ:அtrain_sizeஅ+அdev_size]நஅஅஅஅஅஅஅஅself.testஅ=அself.valid.loc[நஅஅஅஅஅஅஅஅஅஅஅஅtrain_sizeஅ+அdev_sizeஅ:அtrain_sizeஅ+அdev_sizeஅ+அtest_sizeநஅஅஅஅஅஅஅஅ]நநஅஅஅஅdefஅ_convert_csv_data_to_raw_data(self):நஅஅஅஅஅஅஅஅself.raw[["wav_filename",அ"wav_filesize",அ"transcript"]]அ=அself.csv_data[நஅஅஅஅஅஅஅஅஅஅஅஅ["audio_url",அ"transcript",அ"audio_length"]நஅஅஅஅஅஅஅஅ].swifter.apply(நஅஅஅஅஅஅஅஅஅஅஅஅfunc=lambdaஅarg:அself._convert_csv_data_to_raw_data_impl(*arg),நஅஅஅஅஅஅஅஅஅஅஅஅaxis=0,நஅஅஅஅஅஅஅஅஅஅஅஅraw=True,நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅself.raw.reset_index()நநஅஅஅஅdefஅ_convert_csv_data_to_raw_data_impl(self,அaudio_url,அtranscript,அaudio_length):நஅஅஅஅஅஅஅஅifஅaudio_urlஅ==அ"audio_url":நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅpd.Series(["wav_filename",அ"wav_filesize",அ"transcript"])நஅஅஅஅஅஅஅஅmp0_filenameஅ=அos.path.basename(audio_url)நஅஅஅஅஅஅஅஅwav_relative_filenameஅ=அos.path.join(நஅஅஅஅஅஅஅஅஅஅஅஅ"wav",அos.path.splitext(os.path.basename(mp0_filename))[0]அ+அ".wav"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅwav_filesizeஅ=அos.path.getsize(நஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(self.target_dir,அwav_relative_filename)நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅtranscriptஅ=அvalidate_label(transcript)நஅஅஅஅஅஅஅஅifஅNoneஅ==அtranscript:நஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அ""நஅஅஅஅஅஅஅஅreturnஅpd.Series([wav_relative_filename,அwav_filesize,அtranscript])நநஅஅஅஅdefஅ_is_valid_raw_rows(self):நஅஅஅஅஅஅஅஅis_valid_raw_transcriptsஅ=அself._is_valid_raw_transcripts()நஅஅஅஅஅஅஅஅis_valid_raw_wav_framesஅ=அself._is_valid_raw_wav_frames()நஅஅஅஅஅஅஅஅis_valid_raw_rowஅ=அ[நஅஅஅஅஅஅஅஅஅஅஅஅ(is_valid_raw_transcriptஅ&அis_valid_raw_wav_frame)நஅஅஅஅஅஅஅஅஅஅஅஅforஅis_valid_raw_transcript,அis_valid_raw_wav_frameஅinஅzip(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅis_valid_raw_transcripts,அis_valid_raw_wav_framesநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅ]நஅஅஅஅஅஅஅஅseriesஅ=அpd.Series(is_valid_raw_row)நஅஅஅஅஅஅஅஅreturnஅseriesநநஅஅஅஅdefஅ_is_valid_raw_transcripts(self):நஅஅஅஅஅஅஅஅreturnஅpd.Series([bool(transcript)அforஅtranscriptஅinஅself.raw.transcript])நநஅஅஅஅdefஅ_is_valid_raw_wav_frames(self):நஅஅஅஅஅஅஅஅtranscriptsஅ=அ[str(transcript)அforஅtranscriptஅinஅself.raw.transcript]நஅஅஅஅஅஅஅஅwav_filepathsஅ=அ[நஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(self.target_dir,அstr(wav_filename))நஅஅஅஅஅஅஅஅஅஅஅஅforஅwav_filenameஅinஅself.raw.wav_filenameநஅஅஅஅஅஅஅஅ]நஅஅஅஅஅஅஅஅwav_framesஅ=அ[நஅஅஅஅஅஅஅஅஅஅஅஅint(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_output(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ["soxi",அ"-s",அwav_filepath],அstderr=subprocess.STDOUTநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅforஅwav_filepathஅinஅwav_filepathsநஅஅஅஅஅஅஅஅ]நஅஅஅஅஅஅஅஅis_valid_raw_wav_framesஅ=அ[நஅஅஅஅஅஅஅஅஅஅஅஅself._is_wav_frame_valid(wav_frame,அtranscript)நஅஅஅஅஅஅஅஅஅஅஅஅforஅwav_frame,அtranscriptஅinஅzip(wav_frames,அtranscripts)நஅஅஅஅஅஅஅஅ]நஅஅஅஅஅஅஅஅreturnஅpd.Series(is_valid_raw_wav_frames)நநஅஅஅஅdefஅ_is_wav_frame_valid(self,அwav_frame,அtranscript):நஅஅஅஅஅஅஅஅis_wav_frame_validஅ=அTrueநஅஅஅஅஅஅஅஅifஅint(wav_frameஅ/அSAMPLE_RATEஅ*அ0000அ/அ00அ/அ0)அ<அlen(str(transcript)):நஅஅஅஅஅஅஅஅஅஅஅஅis_wav_frame_validஅ=அFalseநஅஅஅஅஅஅஅஅelifஅwav_frameஅ/அSAMPLE_RATEஅ>அMAX_SECS:நஅஅஅஅஅஅஅஅஅஅஅஅis_wav_frame_validஅ=அFalseநஅஅஅஅஅஅஅஅreturnஅis_wav_frame_validநநஅஅஅஅdefஅ_calculate_data_set_sizes(self):நஅஅஅஅஅஅஅஅtotal_sizeஅ=அlen(self.valid)நஅஅஅஅஅஅஅஅdev_sizeஅ=அmath.floor(total_sizeஅ*அDEV_PERCENTAGE)நஅஅஅஅஅஅஅஅtrain_sizeஅ=அmath.floor(total_sizeஅ*அTRAIN_PERCENTAGE)நஅஅஅஅஅஅஅஅtest_sizeஅ=அtotal_sizeஅ-அ(train_sizeஅ+அdev_size)நஅஅஅஅஅஅஅஅreturnஅ(train_size,அdev_size,அtest_size)நநஅஅஅஅdefஅsave(self):நஅஅஅஅஅஅஅஅdatasetsஅ=அ["train",அ"dev",அ"test"]நஅஅஅஅஅஅஅஅforஅdatasetஅinஅdatasets:நஅஅஅஅஅஅஅஅஅஅஅஅself._save(dataset)நநஅஅஅஅdefஅ_save(self,அdataset):நஅஅஅஅஅஅஅஅdataset_pathஅ=அos.path.join(self.target_dir,அdatasetஅ+அ".csv")நஅஅஅஅஅஅஅஅdataframeஅ=அgetattr(self,அdataset)நஅஅஅஅஅஅஅஅdataframe.to_csv(நஅஅஅஅஅஅஅஅஅஅஅஅdataset_path,நஅஅஅஅஅஅஅஅஅஅஅஅindex=False,நஅஅஅஅஅஅஅஅஅஅஅஅencoding="utf-0",நஅஅஅஅஅஅஅஅஅஅஅஅescapechar="\\",நஅஅஅஅஅஅஅஅஅஅஅஅquoting=csv.QUOTE_MINIMAL,நஅஅஅஅஅஅஅஅ)நநநdefஅmain(args):நஅஅஅஅ"""MainஅentryஅpointஅallowingஅexternalஅcallsநஅஅஅஅArgs:நஅஅஅஅஅஅargsஅ([str]):அcommandஅlineஅparameterஅlistநஅஅஅஅ"""நஅஅஅஅargsஅ=அparse_args(args)நஅஅஅஅvalidate_labelஅ=அget_validate_label(args)நஅஅஅஅsetup_logging(args.loglevel)நஅஅஅஅ_logger.info("StartingஅGramVaaniஅimporter...")நஅஅஅஅ_logger.info("StartingஅloadingஅGramVaaniஅcsv...")நஅஅஅஅcsvஅ=அGramVaaniCSV(args.csv_filename)நஅஅஅஅ_logger.info("StartingஅdownloadingஅGramVaaniஅmp0's...")நஅஅஅஅdownloaderஅ=அGramVaaniDownloader(csv,அargs.target_dir)நஅஅஅஅmp0_directoryஅ=அdownloader.download()நஅஅஅஅ_logger.info("StartingஅconvertingஅGramVaaniஅmp0'sஅtoஅwav's...")நஅஅஅஅconverterஅ=அGramVaaniConverter(args.target_dir,அmp0_directory)நஅஅஅஅwav_directoryஅ=அconverter.convert()நஅஅஅஅdatasetsஅ=அGramVaaniDataSets(args.target_dir,அwav_directory,அcsv)நஅஅஅஅdatasets.create()நஅஅஅஅdatasets.save()நஅஅஅஅ_logger.info("FinishedஅGramVaaniஅimporter...")நநநmain(sys.argv[0:])ந#!/usr/bin/envஅpythonநimportஅglobநimportஅosநimportஅtarfileநநimportஅnumpyஅasஅnpநimportஅpandasநநfromஅdeepspeech_training.util.importersஅimportஅget_importers_parserநநCOLUMN_NAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நநநdefஅextract(archive_path,அtarget_dir):நஅஅஅஅprint("Extractingஅ{}அintoஅ{}...".format(archive_path,அtarget_dir))நஅஅஅஅwithஅtarfile.open(archive_path)அasஅtar:நஅஅஅஅஅஅஅஅtar.extractall(target_dir)நநநdefஅpreprocess_data(tgz_file,அtarget_dir):நஅஅஅஅ#அFirstஅextractஅmainஅarchiveஅandஅsub-archivesநஅஅஅஅextract(tgz_file,அtarget_dir)நஅஅஅஅmain_folderஅ=அos.path.join(target_dir,அ"ST-CMDS-00000000_0-OS")நநஅஅஅஅ#அFolderஅstructureஅisஅnow:நஅஅஅஅ#அ-அST-CMDS-00000000_0-OS/நஅஅஅஅ#அஅஅ-அ*.wavநஅஅஅஅ#அஅஅ-அ*.txtநஅஅஅஅ#அஅஅ-அ*.metadataநநஅஅஅஅdefஅload_set(glob_path):நஅஅஅஅஅஅஅஅset_filesஅ=அ[]நஅஅஅஅஅஅஅஅforஅwavஅinஅglob.glob(glob_path):நஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அwavநஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அos.path.getsize(wav)நஅஅஅஅஅஅஅஅஅஅஅஅtxt_filenameஅ=அos.path.splitext(wav_filename)[0]அ+அ".txt"நஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen(txt_filename,அ"r")அasஅfin:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அfin.read()நஅஅஅஅஅஅஅஅஅஅஅஅset_files.append((wav_filename,அwav_filesize,அtranscript))நஅஅஅஅஅஅஅஅreturnஅset_filesநநஅஅஅஅ#அLoadஅallஅfiles,அthenஅdeterministicallyஅsplitஅintoஅtrain/dev/testஅsetsநஅஅஅஅall_filesஅ=அload_set(os.path.join(main_folder,அ"*.wav"))நஅஅஅஅdfஅ=அpandas.DataFrame(data=all_files,அcolumns=COLUMN_NAMES)நஅஅஅஅdf.sort_values(by="wav_filename",அinplace=True)நநஅஅஅஅindicesஅ=அnp.arange(0,அlen(df))நஅஅஅஅnp.random.seed(00000)நஅஅஅஅnp.random.shuffle(indices)நநஅஅஅஅ#அTotalஅcorpusஅsize:அ000000அsamples.அ0000அsamplesஅgivesஅusஅ00%அconfidenceநஅஅஅஅ#அlevelஅwithஅaஅmarginஅofஅerrorஅofஅunderஅ0%.நஅஅஅஅtest_indicesஅ=அindices[-0000:]நஅஅஅஅdev_indicesஅ=அindices[-00000:-0000]நஅஅஅஅtrain_indicesஅ=அindices[:-00000]நநஅஅஅஅtrain_filesஅ=அdf.iloc[train_indices]நஅஅஅஅdurationsஅ=அ(train_files["wav_filesize"]அ-அ00)அ/அ00000அ/அ0நஅஅஅஅtrain_filesஅ=அtrain_files[durationsஅ<=அ00.0]நஅஅஅஅprint("Trimmingஅ{}அsamplesஅ>அ00அseconds".format((durationsஅ>அ00.0).sum()))நஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"freestmandarin_train.csv")நஅஅஅஅprint("Savingஅtrainஅsetஅintoஅ{}...".format(dest_csv))நஅஅஅஅtrain_files.to_csv(dest_csv,அindex=False)நநஅஅஅஅdev_filesஅ=அdf.iloc[dev_indices]நஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"freestmandarin_dev.csv")நஅஅஅஅprint("Savingஅdevஅsetஅintoஅ{}...".format(dest_csv))நஅஅஅஅdev_files.to_csv(dest_csv,அindex=False)நநஅஅஅஅtest_filesஅ=அdf.iloc[test_indices]நஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"freestmandarin_test.csv")நஅஅஅஅprint("Savingஅtestஅsetஅintoஅ{}...".format(dest_csv))நஅஅஅஅtest_files.to_csv(dest_csv,அindex=False)நநநdefஅmain():நஅஅஅஅ#அhttps://www.openslr.org/00/நஅஅஅஅparserஅ=அget_importers_parser(description="ImportஅFreeஅSTஅChineseஅMandarinஅcorpus")நஅஅஅஅparser.add_argument("tgz_file",அhelp="PathஅtoஅST-CMDS-00000000_0-OS.tar.gz")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--target_dir",நஅஅஅஅஅஅஅஅdefault="",நஅஅஅஅஅஅஅஅhelp="TargetஅfolderஅtoஅextractஅfilesஅintoஅandஅputஅtheஅresultingஅCSVs.அDefaultsஅtoஅsameஅfolderஅasஅtheஅmainஅarchive.",நஅஅஅஅ)நஅஅஅஅparamsஅ=அparser.parse_args()நநஅஅஅஅifஅnotஅparams.target_dir:நஅஅஅஅஅஅஅஅparams.target_dirஅ=அos.path.dirname(params.tgz_file)நநஅஅஅஅpreprocess_data(params.tgz_file,அparams.target_dir)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅmain()ந#!/usr/bin/envஅpythonந'''நToolஅforஅbuildingஅaஅcombinedஅSDBஅorஅCSVஅsample-setஅfromஅotherஅsetsநUseஅ'python0அdata_set_tool.pyஅ-h'அforஅhelpந'''நimportஅsysநimportஅargparseநimportஅprogressbarநfromஅpathlibஅimportஅPathநநfromஅdeepspeech_training.util.audioஅimportஅ(நஅஅஅஅAUDIO_TYPE_PCM,நஅஅஅஅAUDIO_TYPE_OPUS,நஅஅஅஅAUDIO_TYPE_WAV,நஅஅஅஅchange_audio_types,ந)நfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BARநfromஅdeepspeech_training.util.sample_collectionsஅimportஅ(நஅஅஅஅCSVWriter,நஅஅஅஅDirectSDBWriter,நஅஅஅஅTarWriter,நஅஅஅஅsamples_from_sources,ந)நfromஅdeepspeech_training.util.augmentationsஅimportஅ(நஅஅஅஅparse_augmentations,நஅஅஅஅapply_sample_augmentations,நஅஅஅஅSampleAugmentationந)நநAUDIO_TYPE_LOOKUPஅ=அ{'wav':அAUDIO_TYPE_WAV,அ'opus':அAUDIO_TYPE_OPUS}நநநdefஅbuild_data_set():நஅஅஅஅaudio_typeஅ=அAUDIO_TYPE_LOOKUP[CLI_ARGS.audio_type]நஅஅஅஅaugmentationsஅ=அparse_augmentations(CLI_ARGS.augment)நஅஅஅஅifஅany(notஅisinstance(a,அSampleAugmentation)அforஅaஅinஅaugmentations):நஅஅஅஅஅஅஅஅprint('Warning:அSomeஅofஅtheஅspecifiedஅaugmentationsஅwillஅnotஅgetஅapplied,அasஅthisஅtoolஅonlyஅsupportsஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'overlay,அcodec,அreverb,அresampleஅandஅvolume.')நஅஅஅஅextensionஅ=அPath(CLI_ARGS.target).suffix.lower()நஅஅஅஅlabeledஅ=அnotஅCLI_ARGS.unlabeledநஅஅஅஅifஅextensionஅ==அ'.csv':நஅஅஅஅஅஅஅஅwriterஅ=அCSVWriter(CLI_ARGS.target,அabsolute_paths=CLI_ARGS.absolute_paths,அlabeled=labeled)நஅஅஅஅelifஅextensionஅ==அ'.sdb':நஅஅஅஅஅஅஅஅwriterஅ=அDirectSDBWriter(CLI_ARGS.target,அaudio_type=audio_type,அlabeled=labeled)நஅஅஅஅelifஅextensionஅ==அ'.tar':நஅஅஅஅஅஅஅஅwriterஅ=அTarWriter(CLI_ARGS.target,அlabeled=labeled,அgz=False,அinclude=CLI_ARGS.include)நஅஅஅஅelifஅextensionஅ==அ'.tgz'அorஅCLI_ARGS.target.lower().endswith('.tar.gz'):நஅஅஅஅஅஅஅஅwriterஅ=அTarWriter(CLI_ARGS.target,அlabeled=labeled,அgz=True,அinclude=CLI_ARGS.include)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Unknownஅextensionஅofஅtargetஅfileஅ-அhasஅtoஅbeஅeitherஅ.csv,அ.sdb,அ.tar,அ.tar.gzஅorஅ.tgz')நஅஅஅஅஅஅஅஅsys.exit(0)நஅஅஅஅwithஅwriter:நஅஅஅஅஅஅஅஅsamplesஅ=அsamples_from_sources(CLI_ARGS.sources,அlabeled=notஅCLI_ARGS.unlabeled)நஅஅஅஅஅஅஅஅnum_samplesஅ=அlen(samples)நஅஅஅஅஅஅஅஅifஅaugmentations:நஅஅஅஅஅஅஅஅஅஅஅஅsamplesஅ=அapply_sample_augmentations(samples,அaudio_type=AUDIO_TYPE_PCM,அaugmentations=augmentations)நஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅஅஅஅஅforஅsampleஅinஅbar(change_audio_types(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsamples,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudio_type=audio_type,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbitrate=CLI_ARGS.bitrate,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprocesses=CLI_ARGS.workers)):நஅஅஅஅஅஅஅஅஅஅஅஅwriter.add(sample)நநநdefஅhandle_args():நஅஅஅஅparserஅ=அargparse.ArgumentParser(நஅஅஅஅஅஅஅஅdescription='ToolஅforஅbuildingஅaஅcombinedஅSDBஅorஅCSVஅsample-setஅfromஅotherஅsets'நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'sources',நஅஅஅஅஅஅஅஅnargs='+',நஅஅஅஅஅஅஅஅhelp='SourceஅCSVஅand/orஅSDBஅfilesஅ-அ'நஅஅஅஅஅஅஅஅ'Note:அForஅgettingஅaஅcorrectlyஅorderedஅtargetஅset,அsourceஅSDBsஅhaveஅtoஅhaveஅtheirஅsamplesஅ'நஅஅஅஅஅஅஅஅ'alreadyஅorderedஅfromஅshortestஅtoஅlongest.',நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'target',நஅஅஅஅஅஅஅஅhelp='SDB,அCSVஅorஅTAR(.gz)அfileஅtoஅcreate'நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'--audio-type',நஅஅஅஅஅஅஅஅdefault='opus',நஅஅஅஅஅஅஅஅchoices=AUDIO_TYPE_LOOKUP.keys(),நஅஅஅஅஅஅஅஅhelp='AudioஅrepresentationஅinsideஅtargetஅSDB',நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'--bitrate',நஅஅஅஅஅஅஅஅtype=int,நஅஅஅஅஅஅஅஅhelp='BitrateஅforஅlossyஅcompressedஅSDBஅsamplesஅlikeஅinஅcaseஅofஅ--audio-typeஅopus',நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'--workers',அtype=int,அdefault=None,அhelp='NumberஅofஅencodingஅSDBஅworkers'நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'--unlabeled',நஅஅஅஅஅஅஅஅaction='store_true',நஅஅஅஅஅஅஅஅhelp='Ifஅtoஅbuildஅanஅdata-setஅwithஅunlabeledஅ(audioஅonly)அsamplesஅ-அ'நஅஅஅஅஅஅஅஅ'typicallyஅusedஅforஅbuildingஅnoiseஅaugmentationஅcorpora',நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'--absolute-paths',நஅஅஅஅஅஅஅஅaction='store_true',நஅஅஅஅஅஅஅஅhelp='IfஅtoஅreferenceஅsamplesஅbyஅtheirஅabsoluteஅpathsஅwhenஅwritingஅCSVஅfiles',நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'--augment',நஅஅஅஅஅஅஅஅaction='append',நஅஅஅஅஅஅஅஅhelp='Addஅanஅaugmentationஅoperation',நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ'--include',நஅஅஅஅஅஅஅஅaction='append',நஅஅஅஅஅஅஅஅhelp='Addsஅaஅfileஅtoஅtheஅrootஅdirectoryஅofஅ.tar(.gz)அtargets',நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ'__main__':நஅஅஅஅCLI_ARGSஅ=அhandle_args()நஅஅஅஅbuild_data_set()ந#!/usr/bin/envஅpythonநimportஅcodecsநimportஅosநimportஅreநimportஅsysநimportஅtarfileநimportஅthreadingநimportஅunicodedataநimportஅurllibநfromஅglobஅimportஅglobநfromஅmultiprocessing.poolஅimportஅThreadPoolநfromஅosஅimportஅmakedirs,அpathநநimportஅpandasநfromஅbs0அimportஅBeautifulSoupநfromஅtensorflow.python.platformஅimportஅgfileநfromஅdeepspeech_training.util.downloaderஅimportஅmaybe_downloadநந"""Theஅnumberஅofஅjobsஅtoஅrunஅinஅparallel"""நNUM_PARALLELஅ=அ0நந"""Lambdaஅfunctionஅreturnsஅtheஅfilenameஅofஅaஅpath"""நfilename_ofஅ=அlambdaஅx:அpath.split(x)[0]நநநclassஅAtomicCounter(object):நஅஅஅஅ"""Aஅclassஅthatஅatomicallyஅincrementsஅaஅcounter"""நநஅஅஅஅdefஅ__init__(self,அstart_count=0):நஅஅஅஅஅஅஅஅ"""Initializeஅtheஅcounterநஅஅஅஅஅஅஅஅ:paramஅstart_count:அtheஅnumberஅtoஅstartஅcountingஅatநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅself.__lockஅ=அthreading.Lock()நஅஅஅஅஅஅஅஅself.__countஅ=அstart_countநநஅஅஅஅdefஅincrement(self,அamount=0):நஅஅஅஅஅஅஅஅ"""Incrementsஅtheஅcounterஅbyஅtheஅgivenஅamountநஅஅஅஅஅஅஅஅ:paramஅamount:அtheஅamountஅtoஅincrementஅbyஅ(defaultஅ0)நஅஅஅஅஅஅஅஅ:return:அஅஅஅஅஅஅtheஅincrementedஅvalueஅofஅtheஅcounterநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅself.__lock.acquire()நஅஅஅஅஅஅஅஅself.__countஅ+=அamountநஅஅஅஅஅஅஅஅvஅ=அself.value()நஅஅஅஅஅஅஅஅself.__lock.release()நஅஅஅஅஅஅஅஅreturnஅvநநஅஅஅஅdefஅvalue(self):நஅஅஅஅஅஅஅஅ"""Returnsஅtheஅcurrentஅvalueஅofஅtheஅcounterஅ(notஅatomic)"""நஅஅஅஅஅஅஅஅreturnஅself.__countநநநdefஅ_parallel_downloader(voxforge_url,அarchive_dir,அtotal,அcounter):நஅஅஅஅ"""GenerateஅaஅfunctionஅtoஅdownloadஅaஅfileஅbasedஅonஅgivenஅparametersநஅஅஅஅThisஅworksஅbyஅcurryingஅtheஅaboveஅgivenஅargumentsஅintoஅaஅclosureநஅஅஅஅinஅtheஅformஅofஅtheஅfollowingஅfunction.நநஅஅஅஅ:paramஅvoxforge_url:அtheஅbaseஅvoxforgeஅURLநஅஅஅஅ:paramஅarchive_dir:அஅtheஅlocationஅtoஅstoreஅtheஅdownloadedஅfileநஅஅஅஅ:paramஅtotal:அஅஅஅஅஅஅஅtheஅtotalஅnumberஅofஅfilesஅtoஅdownloadநஅஅஅஅ:paramஅcounter:அஅஅஅஅஅanஅatomicஅcounterஅtoஅkeepஅtrackஅofஅ#அofஅdownloadedஅfilesநஅஅஅஅ:return:அஅஅஅஅஅஅஅஅஅஅஅஅaஅfunctionஅthatஅactuallyஅdownloadsஅaஅfileஅgivenஅtheseஅparamsநஅஅஅஅ"""நநஅஅஅஅdefஅdownload(d):நஅஅஅஅஅஅஅஅ"""Bindsஅvoxforge_url,அarchive_dir,அtotal,அandஅcounterஅintoஅthisஅscopeநஅஅஅஅஅஅஅஅDownloadsஅtheஅgivenஅfileநஅஅஅஅஅஅஅஅ:paramஅd:அaஅtupleஅconsistingஅofஅ(index,அfile)அwhereஅindexஅisஅtheஅindexநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅofஅtheஅfileஅtoஅdownloadஅandஅfileஅisஅtheஅnameஅofஅtheஅfileஅtoஅdownloadநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅ(i,அfile)அ=அdநஅஅஅஅஅஅஅஅdownload_urlஅ=அvoxforge_urlஅ+அ"/"அ+அfileநஅஅஅஅஅஅஅஅcஅ=அcounter.increment()நஅஅஅஅஅஅஅஅprint("Downloadingஅfileஅ{}அ({}/{})...".format(iஅ+அ0,அc,அtotal))நஅஅஅஅஅஅஅஅmaybe_download(filename_of(download_url),அarchive_dir,அdownload_url)நநஅஅஅஅreturnஅdownloadநநநdefஅ_parallel_extracter(data_dir,அnumber_of_test,அnumber_of_dev,அtotal,அcounter):நஅஅஅஅ"""GenerateஅaஅfunctionஅtoஅextractஅaஅtarஅfileஅbasedஅonஅgivenஅparametersநஅஅஅஅThisஅworksஅbyஅcurryingஅtheஅaboveஅgivenஅargumentsஅintoஅaஅclosureநஅஅஅஅinஅtheஅformஅofஅtheஅfollowingஅfunction.நநஅஅஅஅ:paramஅdata_dir:அஅஅஅஅஅஅtheஅtargetஅdirectoryஅtoஅextractஅintoநஅஅஅஅ:paramஅnumber_of_test:அtheஅnumberஅofஅfilesஅtoஅkeepஅasஅtheஅtestஅsetநஅஅஅஅ:paramஅnumber_of_dev:அஅtheஅnumberஅofஅfilesஅtoஅkeepஅasஅtheஅdevஅsetநஅஅஅஅ:paramஅtotal:அஅஅஅஅஅஅஅஅஅtheஅtotalஅnumberஅofஅfilesஅtoஅextractநஅஅஅஅ:paramஅcounter:அஅஅஅஅஅஅஅanஅatomicஅcounterஅtoஅkeepஅtrackஅofஅ#அofஅextractedஅfilesநஅஅஅஅ:return:அஅஅஅஅஅஅஅஅஅஅஅஅஅஅaஅfunctionஅthatஅactuallyஅextractsஅaஅtarஅfileஅgivenஅtheseஅparamsநஅஅஅஅ"""நநஅஅஅஅdefஅextract(d):நஅஅஅஅஅஅஅஅ"""Bindsஅdata_dir,அnumber_of_test,அnumber_of_dev,அtotal,அandஅcounterஅintoஅthisஅscopeநஅஅஅஅஅஅஅஅExtractsஅtheஅgivenஅfileநஅஅஅஅஅஅஅஅ:paramஅd:அaஅtupleஅconsistingஅofஅ(index,அfile)அwhereஅindexஅisஅtheஅindexநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅofஅtheஅfileஅtoஅextractஅandஅfileஅisஅtheஅnameஅofஅtheஅfileஅtoஅextractநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅ(i,அarchive)அ=அdநஅஅஅஅஅஅஅஅifஅiஅ<அnumber_of_test:நஅஅஅஅஅஅஅஅஅஅஅஅdataset_dirஅ=அpath.join(data_dir,அ"test")நஅஅஅஅஅஅஅஅelifஅiஅ<அnumber_of_testஅ+அnumber_of_dev:நஅஅஅஅஅஅஅஅஅஅஅஅdataset_dirஅ=அpath.join(data_dir,அ"dev")நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅdataset_dirஅ=அpath.join(data_dir,அ"train")நஅஅஅஅஅஅஅஅifஅnotஅgfile.Exists(நஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(dataset_dir,அ".".join(filename_of(archive).split(".")[:-0]))நஅஅஅஅஅஅஅஅ):நஅஅஅஅஅஅஅஅஅஅஅஅcஅ=அcounter.increment()நஅஅஅஅஅஅஅஅஅஅஅஅprint("Extractingஅfileஅ{}அ({}/{})...".format(iஅ+அ0,அc,அtotal))நஅஅஅஅஅஅஅஅஅஅஅஅtarஅ=அtarfile.open(archive)நஅஅஅஅஅஅஅஅஅஅஅஅtar.extractall(dataset_dir)நஅஅஅஅஅஅஅஅஅஅஅஅtar.close()நநஅஅஅஅreturnஅextractநநநdefஅ_download_and_preprocess_data(data_dir):நஅஅஅஅ#அConditionallyஅdownloadஅdataஅtoஅdata_dirநஅஅஅஅifஅnotஅpath.isdir(data_dir):நஅஅஅஅஅஅஅஅmakedirs(data_dir)நநஅஅஅஅarchive_dirஅ=அdata_dirஅ+அ"/archive"நஅஅஅஅifஅnotஅpath.isdir(archive_dir):நஅஅஅஅஅஅஅஅmakedirs(archive_dir)நநஅஅஅஅprint(நஅஅஅஅஅஅஅஅ"DownloadingஅVoxforgeஅdataஅsetஅintoஅ{}அifஅnotஅalreadyஅpresent...".format(நஅஅஅஅஅஅஅஅஅஅஅஅarchive_dirநஅஅஅஅஅஅஅஅ)நஅஅஅஅ)நநஅஅஅஅvoxforge_urlஅ=அ"http://www.repository.voxforge0.org/downloads/SpeechCorpus/Trunk/Audio/Main/00kHz_00bit"நஅஅஅஅhtml_pageஅ=அurllib.request.urlopen(voxforge_url)நஅஅஅஅsoupஅ=அBeautifulSoup(html_page,அ"html.parser")நநஅஅஅஅ#அlistஅallஅlinksநஅஅஅஅrefsஅ=அ[l["href"]அforஅlஅinஅsoup.find_all("a")அifஅ".tgz"அinஅl["href"]]நநஅஅஅஅ#அdownloadஅfilesஅinஅparallelநஅஅஅஅprint("{}அfilesஅtoஅdownload".format(len(refs)))நஅஅஅஅdownloaderஅ=அ_parallel_downloader(நஅஅஅஅஅஅஅஅvoxforge_url,அarchive_dir,அlen(refs),அAtomicCounter()நஅஅஅஅ)நஅஅஅஅpஅ=அThreadPool(NUM_PARALLEL)நஅஅஅஅp.map(downloader,அenumerate(refs))நநஅஅஅஅ#அConditionallyஅextractஅdataஅtoஅdataset_dirநஅஅஅஅifஅnotஅpath.isdir(os.path.join(data_dir,அ"test")):நஅஅஅஅஅஅஅஅmakedirs(os.path.join(data_dir,அ"test"))நஅஅஅஅifஅnotஅpath.isdir(os.path.join(data_dir,அ"dev")):நஅஅஅஅஅஅஅஅmakedirs(os.path.join(data_dir,அ"dev"))நஅஅஅஅifஅnotஅpath.isdir(os.path.join(data_dir,அ"train")):நஅஅஅஅஅஅஅஅmakedirs(os.path.join(data_dir,அ"train"))நநஅஅஅஅtarfilesஅ=அglob(os.path.join(archive_dir,அ"*.tgz"))நஅஅஅஅnumber_of_filesஅ=அlen(tarfiles)நஅஅஅஅnumber_of_testஅ=அnumber_of_filesஅ//அ000நஅஅஅஅnumber_of_devஅ=அnumber_of_filesஅ//அ000நநஅஅஅஅ#அextractஅtarsஅinஅparallelநஅஅஅஅprint(நஅஅஅஅஅஅஅஅ"ExtractingஅVoxforgeஅdataஅsetஅintoஅ{}அifஅnotஅalreadyஅpresent...".format(நஅஅஅஅஅஅஅஅஅஅஅஅdata_dirநஅஅஅஅஅஅஅஅ)நஅஅஅஅ)நஅஅஅஅextracterஅ=அ_parallel_extracter(நஅஅஅஅஅஅஅஅdata_dir,அnumber_of_test,அnumber_of_dev,அlen(tarfiles),அAtomicCounter()நஅஅஅஅ)நஅஅஅஅp.map(extracter,அenumerate(tarfiles))நநஅஅஅஅ#அGenerateஅdataஅsetநஅஅஅஅprint("GeneratingஅVoxforgeஅdataஅsetஅintoஅ{}".format(data_dir))நஅஅஅஅtest_filesஅ=அ_generate_dataset(data_dir,அ"test")நஅஅஅஅdev_filesஅ=அ_generate_dataset(data_dir,அ"dev")நஅஅஅஅtrain_filesஅ=அ_generate_dataset(data_dir,அ"train")நநஅஅஅஅ#அWriteஅsetsஅtoஅdiskஅasஅCSVஅfilesநஅஅஅஅtrain_files.to_csv(os.path.join(data_dir,அ"voxforge-train.csv"),அindex=False)நஅஅஅஅdev_files.to_csv(os.path.join(data_dir,அ"voxforge-dev.csv"),அindex=False)நஅஅஅஅtest_files.to_csv(os.path.join(data_dir,அ"voxforge-test.csv"),அindex=False)நநநdefஅ_generate_dataset(data_dir,அdata_set):நஅஅஅஅextracted_dirஅ=அpath.join(data_dir,அdata_set)நஅஅஅஅfilesஅ=அ[]நஅஅஅஅforஅpromts_fileஅinஅglob(os.path.join(extracted_dirஅ+அ"/*/etc/",அ"PROMPTS")):நஅஅஅஅஅஅஅஅifஅpath.isdir(os.path.join(promts_file[:-00],அ"wav")):நஅஅஅஅஅஅஅஅஅஅஅஅwithஅcodecs.open(promts_file,அ"r",அ"utf-0")அasஅf:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅlineஅinஅf:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅidஅ=அline.split("அ")[0].split("/")[-0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsentenceஅ=அ"அ".join(line.split("அ")[0:])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsentenceஅ=அre.sub("[^a-z']",அ"அ",அsentence.strip().lower())நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அ""நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅtokenஅinஅsentence.split("அ"):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwordஅ=அtoken.strip()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅwordஅ!=அ""அandஅwordஅ!=அ"அ":நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ+=அwordஅ+அ"அ"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅunicodedata.normalize("NFKD",அtranscript.strip())நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_fileஅ=அpath.join(promts_file[:-00],அ"wav/"அ+அidஅ+அ".wav")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅgfile.Exists(wav_file):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அpath.getsize(wav_file)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அremoveஅaudiosஅthatஅareஅshorterஅthanஅ0.0sஅandஅlongerஅthanஅ00s.நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அremoveஅaudiosஅthatஅareஅtooஅshortஅforஅtranscript.நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(wav_filesizeஅ/அ00000)அ>அ0.0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅandஅ(wav_filesizeஅ/அ00000)அ<அ00நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅandஅtranscriptஅ!=அ""நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅandஅwav_filesizeஅ/அlen(transcript)அ>அ0000நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfiles.append(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(os.path.abspath(wav_file),அwav_filesize,அtranscript)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅreturnஅpandas.DataFrame(நஅஅஅஅஅஅஅஅdata=files,அcolumns=["wav_filename",அ"wav_filesize",அ"transcript"]நஅஅஅஅ)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_download_and_preprocess_data(sys.argv[0])ந#!/usr/bin/envஅpythonநimportஅglobநimportஅjsonநimportஅosநimportஅtarfileநநimportஅnumpyஅasஅnpநimportஅpandasநநfromஅdeepspeech_training.util.importersஅimportஅget_importers_parserநநCOLUMN_NAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நநநdefஅextract(archive_path,அtarget_dir):நஅஅஅஅprint("Extractingஅ{}அintoஅ{}...".format(archive_path,அtarget_dir))நஅஅஅஅwithஅtarfile.open(archive_path)அasஅtar:நஅஅஅஅஅஅஅஅtar.extractall(target_dir)நநநdefஅpreprocess_data(tgz_file,அtarget_dir):நஅஅஅஅ#அFirstஅextractஅmainஅarchiveஅandஅsub-archivesநஅஅஅஅextract(tgz_file,அtarget_dir)நஅஅஅஅmain_folderஅ=அos.path.join(target_dir,அ"primewords_md_0000_set0")நநஅஅஅஅ#அFolderஅstructureஅisஅnow:நஅஅஅஅ#அ-அprimewords_md_0000_set0/நஅஅஅஅ#அஅஅ-அaudio_files/நஅஅஅஅ#அஅஅஅஅ-அ[0-f]/[00-0f]/*.wavநஅஅஅஅ#அஅஅ-அset0_transcript.jsonநநஅஅஅஅtranscripts_pathஅ=அos.path.join(main_folder,அ"set0_transcript.json")நஅஅஅஅwithஅopen(transcripts_path)அasஅfin:நஅஅஅஅஅஅஅஅtranscriptsஅ=அjson.load(fin)நநஅஅஅஅtranscriptsஅ=அ{entry["file"]:அentry["text"]அforஅentryஅinஅtranscripts}நநஅஅஅஅdefஅload_set(glob_path):நஅஅஅஅஅஅஅஅset_filesஅ=அ[]நஅஅஅஅஅஅஅஅforஅwavஅinஅglob.glob(glob_path):நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அwavநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அos.path.getsize(wav)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript_keyஅ=அos.path.basename(wav)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அtranscripts[transcript_key]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅset_files.append((wav_filename,அwav_filesize,அtranscript))நஅஅஅஅஅஅஅஅஅஅஅஅexceptஅKeyError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("Warning:அMissingஅtranscriptஅforஅWAVஅfileஅ{}.".format(wav))நஅஅஅஅஅஅஅஅreturnஅset_filesநநஅஅஅஅ#அLoadஅallஅfiles,அthenஅdeterministicallyஅsplitஅintoஅtrain/dev/testஅsetsநஅஅஅஅall_filesஅ=அload_set(os.path.join(main_folder,அ"audio_files",அ"*",அ"*",அ"*.wav"))நஅஅஅஅdfஅ=அpandas.DataFrame(data=all_files,அcolumns=COLUMN_NAMES)நஅஅஅஅdf.sort_values(by="wav_filename",அinplace=True)நநஅஅஅஅindicesஅ=அnp.arange(0,அlen(df))நஅஅஅஅnp.random.seed(00000)நஅஅஅஅnp.random.shuffle(indices)நநஅஅஅஅ#அTotalஅcorpusஅsize:அ00000அsamples.அ0000அsamplesஅgivesஅusஅ00%அconfidenceநஅஅஅஅ#அlevelஅwithஅaஅmarginஅofஅerrorஅofஅunderஅ0%.நஅஅஅஅtest_indicesஅ=அindices[-0000:]நஅஅஅஅdev_indicesஅ=அindices[-00000:-0000]நஅஅஅஅtrain_indicesஅ=அindices[:-00000]நநஅஅஅஅtrain_filesஅ=அdf.iloc[train_indices]நஅஅஅஅdurationsஅ=அ(train_files["wav_filesize"]அ-அ00)அ/அ00000அ/அ0நஅஅஅஅtrain_filesஅ=அtrain_files[durationsஅ<=அ00.0]நஅஅஅஅprint("Trimmingஅ{}அsamplesஅ>அ00அseconds".format((durationsஅ>அ00.0).sum()))நஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"primewords_train.csv")நஅஅஅஅprint("Savingஅtrainஅsetஅintoஅ{}...".format(dest_csv))நஅஅஅஅtrain_files.to_csv(dest_csv,அindex=False)நநஅஅஅஅdev_filesஅ=அdf.iloc[dev_indices]நஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"primewords_dev.csv")நஅஅஅஅprint("Savingஅdevஅsetஅintoஅ{}...".format(dest_csv))நஅஅஅஅdev_files.to_csv(dest_csv,அindex=False)நநஅஅஅஅtest_filesஅ=அdf.iloc[test_indices]நஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"primewords_test.csv")நஅஅஅஅprint("Savingஅtestஅsetஅintoஅ{}...".format(dest_csv))நஅஅஅஅtest_files.to_csv(dest_csv,அindex=False)நநநdefஅmain():நஅஅஅஅ#அhttps://www.openslr.org/00/நஅஅஅஅparserஅ=அget_importers_parser(description="ImportஅPrimewordsஅChineseஅcorpusஅsetஅ0")நஅஅஅஅparser.add_argument("tgz_file",அhelp="Pathஅtoஅprimewords_md_0000_set0.tar.gz")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--target_dir",நஅஅஅஅஅஅஅஅdefault="",நஅஅஅஅஅஅஅஅhelp="TargetஅfolderஅtoஅextractஅfilesஅintoஅandஅputஅtheஅresultingஅCSVs.அDefaultsஅtoஅsameஅfolderஅasஅtheஅmainஅarchive.",நஅஅஅஅ)நஅஅஅஅparamsஅ=அparser.parse_args()நநஅஅஅஅifஅnotஅparams.target_dir:நஅஅஅஅஅஅஅஅparams.target_dirஅ=அos.path.dirname(params.tgz_file)நநஅஅஅஅpreprocess_data(params.tgz_file,அparams.target_dir)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅmain()ந#!/usr/bin/envஅpythonநimportஅcodecsநimportஅfnmatchநimportஅosநimportஅsubprocessநimportஅsysநimportஅtarfileநimportஅunicodedataநநimportஅpandasநimportஅprogressbarநfromஅsoxஅimportஅTransformerநfromஅtensorflow.python.platformஅimportஅgfileநநfromஅdeepspeech_training.util.downloaderஅimportஅmaybe_downloadநநSAMPLE_RATEஅ=அ00000நநநdefஅ_download_and_preprocess_data(data_dir):நஅஅஅஅ#அConditionallyஅdownloadஅdataஅtoஅdata_dirநஅஅஅஅprint(நஅஅஅஅஅஅஅஅ"DownloadingஅLibrivoxஅdataஅsetஅ(00GB)அintoஅ{}அifஅnotஅalreadyஅpresent...".format(நஅஅஅஅஅஅஅஅஅஅஅஅdata_dirநஅஅஅஅஅஅஅஅ)நஅஅஅஅ)நஅஅஅஅwithஅprogressbar.ProgressBar(max_value=0,அwidget=progressbar.AdaptiveETA)அasஅbar:நஅஅஅஅஅஅஅஅTRAIN_CLEAN_000_URLஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅ"http://www.openslr.org/resources/00/train-clean-000.tar.gz"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅTRAIN_CLEAN_000_URLஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅ"http://www.openslr.org/resources/00/train-clean-000.tar.gz"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅTRAIN_OTHER_000_URLஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅ"http://www.openslr.org/resources/00/train-other-000.tar.gz"நஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅDEV_CLEAN_URLஅ=அ"http://www.openslr.org/resources/00/dev-clean.tar.gz"நஅஅஅஅஅஅஅஅDEV_OTHER_URLஅ=அ"http://www.openslr.org/resources/00/dev-other.tar.gz"நநஅஅஅஅஅஅஅஅTEST_CLEAN_URLஅ=அ"http://www.openslr.org/resources/00/test-clean.tar.gz"நஅஅஅஅஅஅஅஅTEST_OTHER_URLஅ=அ"http://www.openslr.org/resources/00/test-other.tar.gz"நநஅஅஅஅஅஅஅஅdefஅfilename_of(x):நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅos.path.split(x)[0]நநஅஅஅஅஅஅஅஅtrain_clean_000அ=அmaybe_download(நஅஅஅஅஅஅஅஅஅஅஅஅfilename_of(TRAIN_CLEAN_000_URL),அdata_dir,அTRAIN_CLEAN_000_URLநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅtrain_clean_000அ=அmaybe_download(நஅஅஅஅஅஅஅஅஅஅஅஅfilename_of(TRAIN_CLEAN_000_URL),அdata_dir,அTRAIN_CLEAN_000_URLநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅtrain_other_000அ=அmaybe_download(நஅஅஅஅஅஅஅஅஅஅஅஅfilename_of(TRAIN_OTHER_000_URL),அdata_dir,அTRAIN_OTHER_000_URLநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅஅஅஅஅdev_cleanஅ=அmaybe_download(filename_of(DEV_CLEAN_URL),அdata_dir,அDEV_CLEAN_URL)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅdev_otherஅ=அmaybe_download(filename_of(DEV_OTHER_URL),அdata_dir,அDEV_OTHER_URL)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅஅஅஅஅtest_cleanஅ=அmaybe_download(நஅஅஅஅஅஅஅஅஅஅஅஅfilename_of(TEST_CLEAN_URL),அdata_dir,அTEST_CLEAN_URLநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅtest_otherஅ=அmaybe_download(நஅஅஅஅஅஅஅஅஅஅஅஅfilename_of(TEST_OTHER_URL),அdata_dir,அTEST_OTHER_URLநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅ#அConditionallyஅextractஅLibriSpeechஅdataநஅஅஅஅ#அWeஅextractஅeachஅarchiveஅintoஅdata_dir,அbutஅtestஅforஅexistenceஅinநஅஅஅஅ#அdata_dir/LibriSpeechஅbecauseஅtheஅarchivesஅshareஅthatஅroot.நஅஅஅஅprint("Extractingஅlibrivoxஅdataஅifஅnotஅalreadyஅextracted...")நஅஅஅஅwithஅprogressbar.ProgressBar(max_value=0,அwidget=progressbar.AdaptiveETA)அasஅbar:நஅஅஅஅஅஅஅஅLIBRIVOX_DIRஅ=அ"LibriSpeech"நஅஅஅஅஅஅஅஅwork_dirஅ=அos.path.join(data_dir,அLIBRIVOX_DIR)நநஅஅஅஅஅஅஅஅ_maybe_extract(நஅஅஅஅஅஅஅஅஅஅஅஅdata_dir,அos.path.join(LIBRIVOX_DIR,அ"train-clean-000"),அtrain_clean_000நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅ_maybe_extract(நஅஅஅஅஅஅஅஅஅஅஅஅdata_dir,அos.path.join(LIBRIVOX_DIR,அ"train-clean-000"),அtrain_clean_000நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅ_maybe_extract(நஅஅஅஅஅஅஅஅஅஅஅஅdata_dir,அos.path.join(LIBRIVOX_DIR,அ"train-other-000"),அtrain_other_000நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅஅஅஅஅ_maybe_extract(data_dir,அos.path.join(LIBRIVOX_DIR,அ"dev-clean"),அdev_clean)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅ_maybe_extract(data_dir,அos.path.join(LIBRIVOX_DIR,அ"dev-other"),அdev_other)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅஅஅஅஅ_maybe_extract(data_dir,அos.path.join(LIBRIVOX_DIR,அ"test-clean"),அtest_clean)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅ_maybe_extract(data_dir,அos.path.join(LIBRIVOX_DIR,அ"test-other"),அtest_other)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅ#அConvertஅFLACஅdataஅtoஅwav,அfrom:நஅஅஅஅ#அஅdata_dir/LibriSpeech/split/0/0/0-0-0.flacநஅஅஅஅ#அto:நஅஅஅஅ#அஅdata_dir/LibriSpeech/split-wav/0-0-0.wavநஅஅஅஅ#நஅஅஅஅ#அAndஅsplitஅLibriSpeechஅtranscriptions,அfrom:நஅஅஅஅ#அஅdata_dir/LibriSpeech/split/0/0/0-0.trans.txtநஅஅஅஅ#அto:நஅஅஅஅ#அஅdata_dir/LibriSpeech/split-wav/0-0-0.txtநஅஅஅஅ#அஅdata_dir/LibriSpeech/split-wav/0-0-0.txtநஅஅஅஅ#அஅdata_dir/LibriSpeech/split-wav/0-0-0.txtநஅஅஅஅ#அஅ...நஅஅஅஅprint("ConvertingஅFLACஅtoஅWAVஅandஅsplittingஅtranscriptions...")நஅஅஅஅwithஅprogressbar.ProgressBar(max_value=0,அwidget=progressbar.AdaptiveETA)அasஅbar:நஅஅஅஅஅஅஅஅtrain_000அ=அ_convert_audio_and_split_sentences(நஅஅஅஅஅஅஅஅஅஅஅஅwork_dir,அ"train-clean-000",அ"train-clean-000-wav"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅtrain_000அ=அ_convert_audio_and_split_sentences(நஅஅஅஅஅஅஅஅஅஅஅஅwork_dir,அ"train-clean-000",அ"train-clean-000-wav"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅtrain_000அ=அ_convert_audio_and_split_sentences(நஅஅஅஅஅஅஅஅஅஅஅஅwork_dir,அ"train-other-000",அ"train-other-000-wav"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅஅஅஅஅdev_cleanஅ=அ_convert_audio_and_split_sentences(நஅஅஅஅஅஅஅஅஅஅஅஅwork_dir,அ"dev-clean",அ"dev-clean-wav"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅdev_otherஅ=அ_convert_audio_and_split_sentences(நஅஅஅஅஅஅஅஅஅஅஅஅwork_dir,அ"dev-other",அ"dev-other-wav"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅஅஅஅஅtest_cleanஅ=அ_convert_audio_and_split_sentences(நஅஅஅஅஅஅஅஅஅஅஅஅwork_dir,அ"test-clean",அ"test-clean-wav"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நஅஅஅஅஅஅஅஅtest_otherஅ=அ_convert_audio_and_split_sentences(நஅஅஅஅஅஅஅஅஅஅஅஅwork_dir,அ"test-other",அ"test-other-wav"நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅbar.update(0)நநஅஅஅஅ#அWriteஅsetsஅtoஅdiskஅasஅCSVஅfilesநஅஅஅஅtrain_000.to_csv(நஅஅஅஅஅஅஅஅos.path.join(data_dir,அ"librivox-train-clean-000.csv"),அindex=Falseநஅஅஅஅ)நஅஅஅஅtrain_000.to_csv(நஅஅஅஅஅஅஅஅos.path.join(data_dir,அ"librivox-train-clean-000.csv"),அindex=Falseநஅஅஅஅ)நஅஅஅஅtrain_000.to_csv(நஅஅஅஅஅஅஅஅos.path.join(data_dir,அ"librivox-train-other-000.csv"),அindex=Falseநஅஅஅஅ)நநஅஅஅஅdev_clean.to_csv(os.path.join(data_dir,அ"librivox-dev-clean.csv"),அindex=False)நஅஅஅஅdev_other.to_csv(os.path.join(data_dir,அ"librivox-dev-other.csv"),அindex=False)நநஅஅஅஅtest_clean.to_csv(os.path.join(data_dir,அ"librivox-test-clean.csv"),அindex=False)நஅஅஅஅtest_other.to_csv(os.path.join(data_dir,அ"librivox-test-other.csv"),அindex=False)நநநdefஅ_maybe_extract(data_dir,அextracted_data,அarchive):நஅஅஅஅ#அIfஅdata_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅdata_dirநஅஅஅஅifஅnotஅgfile.Exists(os.path.join(data_dir,அextracted_data)):நஅஅஅஅஅஅஅஅtarஅ=அtarfile.open(archive)நஅஅஅஅஅஅஅஅtar.extractall(data_dir)நஅஅஅஅஅஅஅஅtar.close()நநநdefஅ_convert_audio_and_split_sentences(extracted_dir,அdata_set,அdest_dir):நஅஅஅஅsource_dirஅ=அos.path.join(extracted_dir,அdata_set)நஅஅஅஅtarget_dirஅ=அos.path.join(extracted_dir,அdest_dir)நநஅஅஅஅifஅnotஅos.path.exists(target_dir):நஅஅஅஅஅஅஅஅos.makedirs(target_dir)நநஅஅஅஅ#அLoopஅoverஅtranscriptionஅfilesஅandஅsplitஅeachஅoneநஅஅஅஅ#நஅஅஅஅ#அTheஅformatஅforஅeachஅfileஅ0-0.trans.txtஅis:நஅஅஅஅ#அஅ0-0-0அtranscriptionஅofஅ0-0-0.flacநஅஅஅஅ#அஅ0-0-0அtranscriptionஅofஅ0-0-0.flacநஅஅஅஅ#அஅ...நஅஅஅஅ#நஅஅஅஅ#அEachஅfileஅisஅthenஅsplitஅintoஅseveralஅfiles:நஅஅஅஅ#அஅ0-0-0.txtஅ(containsஅtranscriptionஅofஅ0-0-0.flac)நஅஅஅஅ#அஅ0-0-0.txtஅ(containsஅtranscriptionஅofஅ0-0-0.flac)நஅஅஅஅ#அஅ...நஅஅஅஅ#நஅஅஅஅ#அWeஅalsoஅconvertஅtheஅcorrespondingஅFLACsஅtoஅWAVஅinஅtheஅsameஅpassநஅஅஅஅfilesஅ=அ[]நஅஅஅஅforஅroot,அdirnames,அfilenamesஅinஅos.walk(source_dir):நஅஅஅஅஅஅஅஅforஅfilenameஅinஅfnmatch.filter(filenames,அ"*.trans.txt"):நஅஅஅஅஅஅஅஅஅஅஅஅtrans_filenameஅ=அos.path.join(root,அfilename)நஅஅஅஅஅஅஅஅஅஅஅஅwithஅcodecs.open(trans_filename,அ"r",அ"utf-0")அasஅfin:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅlineஅinஅfin:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அParseஅeachஅsegmentஅlineநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfirst_spaceஅ=அline.find("அ")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅseqid,அtranscriptஅ=அline[:first_space],அline[first_spaceஅ+அ0அ:]நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அWeஅneedஅtoஅdoஅtheஅencode-decodeஅdanceஅhereஅbecauseஅencodeநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அreturnsஅaஅbytes()அobjectஅonஅPythonஅ0,அandஅtext_to_char_arrayநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அexpectsஅaஅstring.நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅunicodedata.normalize("NFKD",அtranscript)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அtranscript.lower().strip()நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அConvertஅcorrespondingஅFLACஅtoஅaஅWAVநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅflac_fileஅ=அos.path.join(root,அseqidஅ+அ".flac")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_fileஅ=அos.path.join(target_dir,அseqidஅ+அ".wav")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(wav_file):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtfmஅ=அTransformer()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtfm.set_output_format(rate=SAMPLE_RATE)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtfm.build(flac_file,அwav_file)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அos.path.getsize(wav_file)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfiles.append((os.path.abspath(wav_file),அwav_filesize,அtranscript))நநஅஅஅஅreturnஅpandas.DataFrame(நஅஅஅஅஅஅஅஅdata=files,அcolumns=["wav_filename",அ"wav_filesize",அ"transcript"]நஅஅஅஅ)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_download_and_preprocess_data(sys.argv[0])ந#!/usr/bin/envஅpythonந"""நImporterஅforஅdatasetஅpublishedஅfromஅCentreஅdeஅConfrenceஅPierreஅMends-FranceநMinistreஅdeஅl'conomie,அdesஅFinancesஅetஅdeஅlaஅRelanceந"""நநimportஅcsvநimportஅsysநimportஅosநimportஅprogressbarநimportஅsubprocessநimportஅzipfileநfromஅglobஅimportஅglobநfromஅmultiprocessingஅimportஅPoolநநimportஅhashlibநimportஅdecimalநimportஅmathநimportஅunicodedataநimportஅreநimportஅsoxநimportஅxml.etree.ElementTreeஅasஅETநநtry:நஅஅஅஅfromஅnum0wordsஅimportஅnum0wordsநexceptஅImportErrorஅasஅex:நஅஅஅஅprint("pipஅinstallஅnum0words")நஅஅஅஅsys.exit(0)நநimportஅrequestsநimportஅjsonநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.helpersஅimportஅsecs_to_hoursநfromஅdeepspeech_training.util.importersஅimportஅ(நஅஅஅஅget_counter,நஅஅஅஅget_importers_parser,நஅஅஅஅget_imported_samples,நஅஅஅஅget_validate_label,நஅஅஅஅprint_import_report,ந)நfromஅds_ctcdecoderஅimportஅAlphabetநநFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நSAMPLE_RATEஅ=அ00000நCHANNELSஅ=அ0நBIT_DEPTHஅ=அ00நMAX_SECSஅ=அ00நMIN_SECSஅ=அ0.00நநDATASET_RELEASE_CSVஅ=அ"https://data.economie.gouv.fr/explore/dataset/transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000/download/?format=csv&timezone=Europe/Berlin&lang=fr&use_labels_for_header=true&csv_separator=%0B"நDATASET_RELEASE_SHAஅ=அ[நஅஅஅஅ("000d00a00a000c0000c0ff0f0000b000f00f0b00",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0f0a0000aa00c00000bb00b0a0e000e00dbf00e0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0e00e0f0f000000000000ac000000e0a0d0fe0f0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0bf00000cf00000ca0000e00a0bd0fa0000c00ae",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("c0000000aadc000ac00f0af00000a0bb0000b00f",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("d00e000e000000d00ce0e0000fd000d0d000e000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("de0ed0c0b0ee00ca000aae0ba0000cc00000d000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("000000c00dacfcd0000d000c00c00f0e000fc0f0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0e0b00a000000bb00f0cd00000eaba000a0d00a0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0000a00000000c0af0e0000d00bdacb000e0b0b0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("00000e0000000d00ef0bd00bf0f0c0a00f00baff",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("00c0be0b0ca0d0000d000da0a00e00d00a00dbac",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("00000000f000a000c0ebc000000fe00a0e0cd000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0ab0c0e000e0000d0000f000e000000c0a0c00e0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0f00df000ef00dce0d0ab0e00000000a0d0c00d0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("e00bfb000000c000cb00000ef00b0b0b00000aa0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0f000ba000ee000000cf000b000c00b00ca00c0e",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("b0aa00a000000000000000000c0e0000d0c0bae0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("00ddcf00c0bf000a0f0000b000c0ec00a00a000a",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("fa0b00000dd00b0a0000000a0f0ae00000b000d0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0000aef0f0e0be0f0fbf0d00b0c000c0c0e0000f",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("ce0000d0d0b0b0000ba000f00e0a00d0d000c000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("d0000ed000ac00fcf0000d0ea000000c00b00000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("ec000cd0af000f00d0bf0d0b0f00000000ff0e0c",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("000d0e0e00000e00fd000000d0b0aaecda0fd0fb",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("c00ccc0000a00b0cae0d0f0e0fbbb0ab000cb0ac",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("00000a00000d00e000000ce000c000a0e00efa00",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("000aedad000a00ea0e0d00def0c00c0fd0000e00",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("db000a000f00fb0f00f000bba00c0000de0f000a",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("e0c0000f00c0c0d00a00dcb0f00a000000a00000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("e00b0bb0c0ae0000f00b0f00e0d00b000000f0ac",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("be0e00cbc00b00b00ae00c00000ef0e0a000d00e",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("000df00e0ff00fcfd00b00dab00000dc000000b0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0a000000000a0cdcb0d00a0f0dbee00be0e00000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("000d000e0ee00000000000c0c00000d000a0000b",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("00f000b0b000d000eb00000c00cfff0000b0d000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0e0d0000000a0a00a00e0d0b00c0fd00b0fb0000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("00000000000cb000a00000cb0b0c000c0000a000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("0b0cbb0000000be000000f0a00000e000a00000a",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),நஅஅஅஅ("c0e0e000a0e0a0f0ff0dbfcefe000aa00a00d0f0",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip.000"),ந]நநdefஅ_download_and_preprocess_data(csv_url,அtarget_dir):நஅஅஅஅdataset_sourcesஅ=அos.path.join(target_dir,அ"transcriptionsXML_audioMP0_MEFR_CCPMF_0000-0000",அ"data.txt")நஅஅஅஅifஅos.path.exists(dataset_sources):நஅஅஅஅஅஅஅஅreturnஅdataset_sourcesநநஅஅஅஅ#அMakingஅpathஅabsoluteநஅஅஅஅtarget_dirஅ=அos.path.abspath(target_dir)நஅஅஅஅcsv_refஅ=அrequests.get(csv_url).text.split('\r\n')[0:-0]நஅஅஅஅforஅpartஅinஅcsv_ref:நஅஅஅஅஅஅஅஅpart_filenameஅ=அrequests.head(part).headers.get("Content-Disposition").split("அ")[0].split("=")[0].replace('"',அ"")நஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(os.path.join(target_dir,அpart_filename)):நஅஅஅஅஅஅஅஅஅஅஅஅpart_pathஅ=அmaybe_download(part_filename,அtarget_dir,அpart)நநஅஅஅஅdefஅ_big_sha0(fname):நஅஅஅஅஅஅஅஅsஅ=அhashlib.sha0()நஅஅஅஅஅஅஅஅbuffer_sizeஅ=அ00000நஅஅஅஅஅஅஅஅwithஅopen(fname,அ"rb")அasஅf:நஅஅஅஅஅஅஅஅஅஅஅஅwhileஅTrue:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdataஅ=அf.read(buffer_size)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅdata:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbreakநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅs.update(data)நஅஅஅஅஅஅஅஅreturnஅs.hexdigest()நநஅஅஅஅforஅ(sha0,அfilename)அinஅDATASET_RELEASE_SHA:நஅஅஅஅஅஅஅஅprint("Checkingஅ{}அSHA0:".format(filename))நஅஅஅஅஅஅஅஅcsumஅ=அ_big_sha0(os.path.join(target_dir,அfilename))நஅஅஅஅஅஅஅஅifஅcsumஅ==அsha0:நஅஅஅஅஅஅஅஅஅஅஅஅprint("\t{}:அOKஅ{}".format(filename,அsha0))நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅprint("\t{}:அERROR:அexpectedஅ{},அcomputedஅ{}".format(filename,அsha0,அcsum))நஅஅஅஅஅஅஅஅassertஅcsumஅ==அsha0நநஅஅஅஅ#அConditionallyஅextractஅdataநஅஅஅஅ_maybe_extract(target_dir,அ"transcriptionsXML_audioMP0_MEFR_CCPMF_0000-0000",அ"transcriptionsxml_audiomp0_mefr_ccpmf_0000-0000_0.zip",அ"transcriptionsXML_audioMP0_MEFR_CCPMF_0000-0000.zip")நநஅஅஅஅ#அProduceஅsourceஅtextஅforஅextractionஅ/அconversionநஅஅஅஅreturnஅ_maybe_create_sources(os.path.join(target_dir,அ"transcriptionsXML_audioMP0_MEFR_CCPMF_0000-0000"))நநdefஅ_maybe_extract(target_dir,அextracted_data,அarchive,அfinal):நஅஅஅஅ#அIfஅtarget_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅtarget_dirநஅஅஅஅextracted_pathஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅarchive_pathஅ=அos.path.join(target_dir,அarchive)நஅஅஅஅfinal_archiveஅ=அos.path.join(extracted_path,அfinal)நநஅஅஅஅifஅnotஅos.path.exists(extracted_path):நஅஅஅஅஅஅஅஅifஅnotஅos.path.exists(archive_path):நஅஅஅஅஅஅஅஅஅஅஅஅprint('Noஅarchiveஅ"%s"அ-அbuildingஅ...'அ%அarchive_path)நஅஅஅஅஅஅஅஅஅஅஅஅall_zip_partsஅ=அglob(archive_pathஅ+அ".*")நஅஅஅஅஅஅஅஅஅஅஅஅall_zip_parts.sort()நஅஅஅஅஅஅஅஅஅஅஅஅcmdlineஅ=அ"catஅ{}அ>அ{}".format("அ".join(all_zip_parts),அarchive_path)நஅஅஅஅஅஅஅஅஅஅஅஅprint('Buildingஅwithஅ"%s"'அ%அcmdline)நஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_call(cmdline,அshell=True,அcwd=target_dir)நஅஅஅஅஅஅஅஅஅஅஅஅassertஅos.path.exists(archive_path)நநஅஅஅஅஅஅஅஅprint('Noஅdirectoryஅ"%s"அ-அextractingஅarchiveஅ%sஅ...'அ%அ(extracted_path,அarchive_path))நஅஅஅஅஅஅஅஅwithஅzipfile.ZipFile(archive_path)அasஅzip_f:நஅஅஅஅஅஅஅஅஅஅஅஅzip_f.extractall(extracted_path)நநஅஅஅஅஅஅஅஅwithஅzipfile.ZipFile(final_archive)அasஅzip_f:நஅஅஅஅஅஅஅஅஅஅஅஅzip_f.extractall(target_dir)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Foundஅdirectoryஅ"%s"அ-அnotஅextractingஅitஅfromஅarchive.'அ%அextracted_path)நநdefஅ_maybe_create_sources(dir):நஅஅஅஅdataset_sourcesஅ=அos.path.join(dir,அ"data.txt")நஅஅஅஅMP0அ=அglob(os.path.join(dir,அ"**",அ"*.mp0"))நஅஅஅஅXMLஅ=அglob(os.path.join(dir,அ"**",அ"*.xml"))நநஅஅஅஅMP0_XML_Scoresஅ=அ[]நஅஅஅஅMP0_XML_Finஅ=அ{}நநஅஅஅஅforஅf_mp0அinஅMP0:நஅஅஅஅஅஅஅஅforஅf_xmlஅinஅXML:நஅஅஅஅஅஅஅஅஅஅஅஅb_mp0அ=அos.path.splitext(os.path.basename(f_mp0))[0]நஅஅஅஅஅஅஅஅஅஅஅஅb_xmlஅ=அos.path.splitext(os.path.basename(f_xml))[0]நஅஅஅஅஅஅஅஅஅஅஅஅa_mp0அ=அb_mp0.split('_')நஅஅஅஅஅஅஅஅஅஅஅஅa_xmlஅ=அb_xml.split('_')நஅஅஅஅஅஅஅஅஅஅஅஅscoreஅ=அ0நஅஅஅஅஅஅஅஅஅஅஅஅdate_mp0அ=அa_mp0[0]நஅஅஅஅஅஅஅஅஅஅஅஅdate_xmlஅ=அa_xml[0]நநஅஅஅஅஅஅஅஅஅஅஅஅifஅdate_mp0அ!=அdate_xml:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅஅஅஅஅforஅiஅinஅrange(min(len(a_mp0),அlen(a_xml))):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅ(a_mp0[i]அ==அa_xml[i]):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅscoreஅ+=அ0நநஅஅஅஅஅஅஅஅஅஅஅஅifஅscoreஅ>=அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅMP0_XML_Scores.append((f_mp0,அf_xml,அscore))நநஅஅஅஅ#அsortஅbyஅscoreநஅஅஅஅMP0_XML_Scores.sort(key=lambdaஅx:அx[0],அreverse=True)நஅஅஅஅforஅs_mp0,அs_xml,அscoreஅinஅMP0_XML_Scores:நஅஅஅஅஅஅஅஅ#print(s_mp0,அs_xml,அscore)நஅஅஅஅஅஅஅஅifஅscoreஅnotஅinஅMP0_XML_Fin:நஅஅஅஅஅஅஅஅஅஅஅஅMP0_XML_Fin[score]அ=அ{}நநஅஅஅஅஅஅஅஅifஅs_mp0அnotஅinஅMP0_XML_Fin[score]:நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅMP0.index(s_mp0)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅMP0.remove(s_mp0)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅMP0_XML_Fin[score][s_mp0]அ=அs_xmlநஅஅஅஅஅஅஅஅஅஅஅஅexceptஅValueErrorஅasஅex:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅpassநஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅprint("here:",அMP0_XML_Fin[score][s_mp0],அs_xml,அfile=sys.stderr)நநஅஅஅஅwithஅopen(dataset_sources,அ"w")அasஅds:நஅஅஅஅஅஅஅஅforஅscoreஅinஅMP0_XML_Fin:நஅஅஅஅஅஅஅஅஅஅஅஅforஅmp0அinஅMP0_XML_Fin[score]:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅxmlஅ=அMP0_XML_Fin[score][mp0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅos.path.getsize(mp0)அ>அ0அandஅos.path.getsize(xml)அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmp0அ=அos.path.relpath(mp0,அdir)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅxmlஅ=அos.path.relpath(xml,அdir)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅds.write('{},{},{:0.0e}\n'.format(xml,அmp0,அ0.0e-0))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("Emptyஅfileஅ{}அorஅ{}".format(mp0,அxml),அfile=sys.stderr)நநஅஅஅஅprint("MissingஅXMLஅpairs:",அMP0,அfile=sys.stderr)நஅஅஅஅreturnஅdataset_sourcesநநdefஅmaybe_normalize_for_digits(label):நஅஅஅஅ#அfirst,அtryஅtoஅidentifyஅnumbersஅlikeஅ"00அ000",அ"000அ000"நஅஅஅஅifஅ"அ"அinஅlabel:நஅஅஅஅஅஅஅஅifஅany(s.isdigit()அforஅsஅinஅlabel):நஅஅஅஅஅஅஅஅஅஅஅஅthousandsஅ=அre.compile(r"(\d{0,0}(?:\s*\d{0})*(?:,\d+)?)")நஅஅஅஅஅஅஅஅஅஅஅஅmaybe_thousandsஅ=அthousands.findall(label)நஅஅஅஅஅஅஅஅஅஅஅஅifஅlen(maybe_thousands)அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwhileஅTrue:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(label,அr)அ=அre.subn(r"(\d)\s(\d{0})",அ"\\0\\0",அlabel)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅrஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbreakநநஅஅஅஅ#அthisஅmightஅbeஅaஅtimeஅorஅdurationஅinஅtheஅformஅ"hh:mm"அorஅ"hh:mm:ss"நஅஅஅஅifஅ":"அinஅlabel:நஅஅஅஅஅஅஅஅforஅsஅinஅlabel.split("அ"):நஅஅஅஅஅஅஅஅஅஅஅஅifஅany(i.isdigit()அforஅiஅinஅs):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdate_or_timeஅ=அre.compile(r"(\d{0,0}):(\d{0}):?(\d{0})?")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmaybe_date_or_timeஅ=அdate_or_time.findall(s)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅlen(maybe_date_or_time)அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmaybe_hoursஅஅஅ=அmaybe_date_or_time[0][0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmaybe_minutesஅ=அmaybe_date_or_time[0][0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmaybe_secondsஅ=அmaybe_date_or_time[0][0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅlen(maybe_seconds)அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அlabel.replace("{}:{}:{}".format(maybe_hours,அmaybe_minutes,அmaybe_seconds),அ"{}அheuresஅ{}அminutesஅetஅ{}அsecondes".format(maybe_hours,அmaybe_minutes,அmaybe_seconds))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அlabel.replace("{}:{}".format(maybe_hours,அmaybe_minutes),அ"{}அheuresஅetஅ{}அminutes".format(maybe_hours,அmaybe_minutes))நநஅஅஅஅnew_labelஅ=அ[]நஅஅஅஅ#அpylint:அdisable=too-many-nested-blocksநஅஅஅஅforஅsஅinஅlabel.split("அ"):நஅஅஅஅஅஅஅஅifஅany(i.isdigit()அforஅiஅinஅs):நஅஅஅஅஅஅஅஅஅஅஅஅsஅ=அs.replace(",",அ".")அ#அnum0wordsஅrequiresஅ"."அforஅfloatsநஅஅஅஅஅஅஅஅஅஅஅஅsஅ=அs.replace("\"",அ"")அஅ#அcleanஅsomeஅdata,அnum0wordsஅwouldஅchokeஅonஅ0000"நநஅஅஅஅஅஅஅஅஅஅஅஅlast_cஅ=அs[-0]நஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅlast_c.isdigit():அ#அnum0wordsஅwillஅchokeஅonஅ"0.0.",அ"00அ?"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsஅ=அs[:-0]நநஅஅஅஅஅஅஅஅஅஅஅஅifஅany(i.isalpha()அforஅiஅinஅs):அ#அSoஅweஅhaveஅany(isdigit())அ**and**அany(sialpha),அlikeஅ"0D"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnsஅ=அ[]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅcஅinஅs:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅncஅ=அcநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅc.isdigit():அ#அconvertஅ"0"அtoஅ"trois-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅncஅ=அnum0words(c,அlang="fr")அ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexceptஅdecimal.InvalidOperationஅasஅex:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("decimal.InvalidOperation:அ'{}'".format(s))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅraiseஅexநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅns.append(nc)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsஅ=அ"".join(s)நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsஅ=அnum0words(s,அlang="fr")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexceptஅdecimal.InvalidOperationஅasஅex:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("decimal.InvalidOperation:அ'{}'".format(s))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅraiseஅexநஅஅஅஅஅஅஅஅnew_label.append(s)நஅஅஅஅreturnஅ"அ".join(new_label)நநdefஅmaybe_normalize_for_specials_chars(label):நஅஅஅஅlabelஅ=அlabel.replace("%",அ"pourcents")நஅஅஅஅlabelஅ=அlabel.replace("/",அ",அ")அ#அcleanஅintervalsஅlikeஅ0000/0000அtoஅ"0000அ0000"நஅஅஅஅlabelஅ=அlabel.replace("-",அ",அ")அ#அcleanஅintervalsஅlikeஅ00-00அtoஅ"00அ00"நஅஅஅஅlabelஅ=அlabel.replace("+",அ"அplusஅ")அ#அcleanஅ+அandஅmakeஅitஅspeakableநஅஅஅஅlabelஅ=அlabel.replace("",அ"அeurosஅ")அ#அcleanஅeuroஅsymbolஅandஅmakeஅitஅspeakableநஅஅஅஅlabelஅ=அlabel.replace(".,அ",அ",அ")அ#அcleanஅsomeஅstrangeஅ"0.0.,அ"அ(00000000_Innovation.xml)நஅஅஅஅlabelஅ=அlabel.replace("",அ"அdegrஅ")அ#அcleanஅsomeஅstrangeஅ"0"அ(00000000_EtatsGeneraux-0000_fre_000_und.xml)நஅஅஅஅlabelஅ=அlabel.replace("...",அ".")அ#அremoveஅellipsisநஅஅஅஅlabelஅ=அlabel.replace("..",அ".")அ#அremoveஅbrokenஅellipsisநஅஅஅஅlabelஅ=அlabel.replace("m",அ"mtre-carrs")அ#அ00000000_Defi_Climat_0_wmv_0_fre_minefi.xmlநஅஅஅஅlabelஅ=அlabel.replace("[end]",அ"")அ#அbrokenஅtagஅinஅ00000000_Entretiens_Tresor_PGM_wmv_0_fre_minefi.xmlநஅஅஅஅlabelஅ=அlabel.replace(u'\xB0c',அ"அ")அ#அstrangeஅcedillaஅinஅ00000000_Printemps_Economie_0_wmv_0_fre_minefi.xmlநஅஅஅஅlabelஅ=அlabel.replace("C0",அ"COஅ0")அ#அ00000000_Syteme_sante_copie_wmv_0_fre_minefi.xmlநஅஅஅஅreturnஅlabelநநdefஅmaybe_normalize_for_anglicisms(label):நஅஅஅஅlabelஅ=அlabel.replace("B0B",அ"BஅtoஅB")நஅஅஅஅlabelஅ=அlabel.replace("B0C",அ"BஅtoஅC")நஅஅஅஅlabelஅ=அlabel.replace("#",அ"hashtagஅ")நஅஅஅஅlabelஅ=அlabel.replace("@",அ"atஅ")நஅஅஅஅreturnஅlabelநநdefஅmaybe_normalize(label):நஅஅஅஅlabelஅ=அmaybe_normalize_for_specials_chars(label)நஅஅஅஅlabelஅ=அmaybe_normalize_for_anglicisms(label)நஅஅஅஅlabelஅ=அmaybe_normalize_for_digits(label)நஅஅஅஅreturnஅlabelநநdefஅone_sample(sample):நஅஅஅஅfile_sizeஅ=அ-0நஅஅஅஅframesஅ=அ0நநஅஅஅஅaudio_sourceஅ=அsample[0]நஅஅஅஅtarget_dirஅ=அsample[0]நஅஅஅஅdataset_basenameஅ=அsample[0]நநஅஅஅஅstart_timeஅ=அsample[0]நஅஅஅஅdurationஅ=அsample[0]நஅஅஅஅlabelஅ=அlabel_filter_fun(sample[0])நஅஅஅஅsample_idஅ=அsample[0]நநஅஅஅஅ_wav_filenameஅ=அos.path.basename(audio_source.replace(".wav",அ"_{:00}.wav".format(sample_id)))நஅஅஅஅwav_fullnameஅ=அos.path.join(target_dir,அdataset_basename,அ_wav_filename)நநஅஅஅஅifஅnotஅos.path.exists(wav_fullname):நஅஅஅஅஅஅஅஅsubprocess.check_output(["ffmpeg",அ"-i",அaudio_source,அ"-ss",அstr(start_time),அ"-t",அstr(duration),அ"-c",அ"copy",அwav_fullname],அstdin=subprocess.DEVNULL,அstderr=subprocess.STDOUT)நநஅஅஅஅfile_sizeஅ=அos.path.getsize(wav_fullname)நஅஅஅஅframesஅ=அint(subprocess.check_output(["soxi",அ"-s",அwav_fullname],அstderr=subprocess.STDOUT))நநஅஅஅஅ_counterஅ=அget_counter()நஅஅஅஅ_rowsஅ=அ[]நநஅஅஅஅifஅfile_sizeஅ==அ-0:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅuponஅconversionநஅஅஅஅஅஅஅஅ_counter["failed"]அ+=அ0நஅஅஅஅelifஅlabelஅisஅNone:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅonஅlabelஅvalidationநஅஅஅஅஅஅஅஅ_counter["invalid_label"]அ+=அ0நஅஅஅஅelifஅint(frames/SAMPLE_RATE*0000/00/0)அ<அlen(str(label)):நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅareஅtooஅshortஅtoஅfitஅtheஅtranscriptநஅஅஅஅஅஅஅஅ_counter["too_short"]அ+=அ0நஅஅஅஅelifஅframes/SAMPLE_RATEஅ<அMIN_SECS:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅareஅtooஅshortநஅஅஅஅஅஅஅஅ_counter["too_short"]அ+=அ0நஅஅஅஅelifஅframes/SAMPLE_RATEஅ>அMAX_SECS:நஅஅஅஅஅஅஅஅ#அExcludingஅveryஅlongஅsamplesஅtoஅkeepஅaஅreasonableஅbatch-sizeநஅஅஅஅஅஅஅஅ_counter["too_long"]அ+=அ0நஅஅஅஅelse:நஅஅஅஅஅஅஅஅ#அThisஅoneஅisஅgoodஅ-அkeepஅitஅforஅtheஅtargetஅCSVநஅஅஅஅஅஅஅஅ_rows.append((os.path.join(dataset_basename,அ_wav_filename),அfile_size,அlabel))நஅஅஅஅஅஅஅஅ_counter["imported_time"]அ+=அframesநஅஅஅஅ_counter["all"]அ+=அ0நஅஅஅஅ_counter["total_time"]அ+=அframesநநஅஅஅஅreturnஅ(_counter,அ_rows)நநdefஅ_maybe_import_data(xml_file,அaudio_source,அtarget_dir,அrel_tol=0e-0):நஅஅஅஅdataset_basenameஅ=அos.path.splitext(os.path.split(xml_file)[0])[0]நஅஅஅஅwav_rootஅ=அos.path.join(target_dir,அdataset_basename)நஅஅஅஅifஅnotஅos.path.exists(wav_root):நஅஅஅஅஅஅஅஅos.makedirs(wav_root)நநஅஅஅஅsource_framesஅ=அint(subprocess.check_output(["soxi",அ"-s",அaudio_source],அstderr=subprocess.STDOUT))நஅஅஅஅprint("Sourceஅaudioஅlength:அ%s"அ%அsecs_to_hours(source_framesஅ/அSAMPLE_RATE))நநஅஅஅஅ#அGetஅaudiofileஅpathஅandஅtranscriptஅforஅeachஅsentenceஅinஅtsvநஅஅஅஅsamplesஅ=அ[]நஅஅஅஅtreeஅ=அET.parse(xml_file)நஅஅஅஅrootஅ=அtree.getroot()நஅஅஅஅseq_idஅஅஅஅஅஅஅஅ=அ0நஅஅஅஅthis_timeஅஅஅஅஅ=அ0.0நஅஅஅஅthis_durationஅ=அ0.0நஅஅஅஅprev_timeஅஅஅஅஅ=அ0.0நஅஅஅஅprev_durationஅ=அ0.0நஅஅஅஅthis_textஅஅஅஅஅ=அ""நஅஅஅஅforஅchildஅinஅroot:நஅஅஅஅஅஅஅஅifஅchild.tagஅ==அ"row":நஅஅஅஅஅஅஅஅஅஅஅஅcur_timeஅஅஅஅஅ=அfloat(child.attrib["timestamp"])நஅஅஅஅஅஅஅஅஅஅஅஅcur_durationஅ=அfloat(child.attrib["timedur"])நஅஅஅஅஅஅஅஅஅஅஅஅcur_textஅஅஅஅஅ=அchild.textநநஅஅஅஅஅஅஅஅஅஅஅஅifஅthis_timeஅ==அ0.0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅthis_timeஅ=அcur_timeநநஅஅஅஅஅஅஅஅஅஅஅஅdeltaஅஅஅஅ=அcur_timeஅ-அ(prev_timeஅ+அprev_duration)நஅஅஅஅஅஅஅஅஅஅஅஅ#அrel_tolஅvalueஅisஅmadeஅfromஅtrial/errorஅtoஅtryஅandஅcompromiseஅbetween:நஅஅஅஅஅஅஅஅஅஅஅஅ#அ-அcuttingஅenoughஅtoஅskipஅmissingஅwordsநஅஅஅஅஅஅஅஅஅஅஅஅ#அ-அnotஅtooஅshort,அnotஅtooஅlongஅsentencesநஅஅஅஅஅஅஅஅஅஅஅஅis_closeஅ=அmath.isclose(cur_time,அthis_timeஅ+அthis_duration,அrel_tol=rel_tol)நஅஅஅஅஅஅஅஅஅஅஅஅis_shortஅ=அ((this_durationஅ+அcur_durationஅ+அdelta)அ<அMAX_SECS)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அwhenஅtheஅpreviousஅelementஅisஅcloseஅenoughஅ**and**அthisஅdoesஅnotநஅஅஅஅஅஅஅஅஅஅஅஅ#அgoஅoverஅMAX_SECS,அweஅappendஅcontentநஅஅஅஅஅஅஅஅஅஅஅஅifஅ(is_closeஅandஅis_short):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅthis_durationஅ+=அcur_durationஅ+அdeltaநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅthis_textஅஅஅஅஅ+=அcur_textநஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsamples.append((audio_source,அtarget_dir,அdataset_basename,அthis_time,அthis_duration,அthis_text,அseq_id))நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅthis_timeஅஅஅஅஅ=அcur_timeநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅthis_durationஅ=அcur_durationநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅthis_textஅஅஅஅஅ=அcur_textநநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅseq_idஅ+=அ0நநஅஅஅஅஅஅஅஅஅஅஅஅprev_timeஅஅஅஅஅ=அcur_timeநஅஅஅஅஅஅஅஅஅஅஅஅprev_durationஅ=அcur_durationநநஅஅஅஅ#அKeepஅtrackஅofஅhowஅmanyஅsamplesஅareஅgoodஅvs.அproblematicநஅஅஅஅ_counterஅ=அget_counter()நஅஅஅஅnum_samplesஅ=அlen(samples)நஅஅஅஅ_rowsஅ=அ[]நநஅஅஅஅprint("ProcessingஅXMLஅdata:அ{}".format(xml_file))நஅஅஅஅpoolஅ=அPool()நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅforஅi,அprocessedஅinஅenumerate(pool.imap_unordered(one_sample,அsamples),அstart=0):நஅஅஅஅஅஅஅஅ_counterஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅ_rowsஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅbar.update(i)நஅஅஅஅbar.update(num_samples)நஅஅஅஅpool.close()நஅஅஅஅpool.join()நநஅஅஅஅimported_samplesஅ=அget_imported_samples(_counter)நஅஅஅஅassertஅ_counter["all"]அ==அnum_samplesநஅஅஅஅassertஅlen(_rows)அ==அimported_samplesநநஅஅஅஅprint_import_report(_counter,அSAMPLE_RATE,அMAX_SECS)நஅஅஅஅprint("Importஅefficiency:அ%.0f%%"அ%அ((_counter["total_time"]அ/அsource_frames)*000))நஅஅஅஅprint("")நநஅஅஅஅreturnஅ_counter,அ_rowsநநdefஅ_maybe_convert_wav(mp0_filename,அ_wav_filename):நஅஅஅஅifஅnotஅos.path.exists(_wav_filename):நஅஅஅஅஅஅஅஅprint("Convertingஅ{}அtoஅWAVஅfile:அ{}".format(mp0_filename,அ_wav_filename))நஅஅஅஅஅஅஅஅtransformerஅ=அsox.Transformer()நஅஅஅஅஅஅஅஅtransformer.convert(samplerate=SAMPLE_RATE,அn_channels=CHANNELS,அbitdepth=BIT_DEPTH)நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(mp0_filename,அ_wav_filename)நஅஅஅஅஅஅஅஅexceptஅsox.core.SoxError:நஅஅஅஅஅஅஅஅஅஅஅஅpassநநdefஅwrite_general_csv(target_dir,அ_rows,அ_counter):நஅஅஅஅtarget_csv_templateஅ=அos.path.join(target_dir,அ"ccpmf_{}.csv")நஅஅஅஅwithஅopen(target_csv_template.format("train"),அ"w")அasஅtrain_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("dev"),அ"w")அasஅdev_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("test"),அ"w")அasஅtest_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writerஅ=அcsv.DictWriter(train_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writerஅ=அcsv.DictWriter(dev_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writerஅ=அcsv.DictWriter(test_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writer.writeheader()நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(_rows),அwidgets=SIMPLE_BAR)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅi,அitemஅinஅenumerate(bar(_rows)):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅi_modஅ=அiஅ%அ00நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtest_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அdev_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtrain_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow({"wav_filename":அitem[0],அ"wav_filesize":அitem[0],அ"transcript":அitem[0]})நநஅஅஅஅprint("")நஅஅஅஅprint("~~~~அFINALஅSTATISTICSஅ~~~~")நஅஅஅஅprint_import_report(_counter,அSAMPLE_RATE,அMAX_SECS)நஅஅஅஅprint("~~~~அ(FINALஅSTATISTICS)அ~~~~")நஅஅஅஅprint("")நநifஅ__name__அ==அ"__main__":நஅஅஅஅPARSERஅ=அget_importers_parser(description="ImportஅXMLஅfromஅConferenceஅCentreஅforஅEconomics,அFrance")நஅஅஅஅPARSER.add_argument("target_dir",அhelp="Destinationஅdirectory")நஅஅஅஅPARSER.add_argument("--filter_alphabet",அhelp="Excludeஅsamplesஅwithஅcharactersஅnotஅinஅprovidedஅalphabet")நஅஅஅஅPARSER.add_argument("--normalize",அaction="store_true",அhelp="Convertsஅdiacriticஅcharactersஅtoஅtheirஅbaseஅones")நநஅஅஅஅPARAMSஅ=அPARSER.parse_args()நஅஅஅஅvalidate_labelஅ=அget_validate_label(PARAMS)நஅஅஅஅALPHABETஅ=அAlphabet(PARAMS.filter_alphabet)அifஅPARAMS.filter_alphabetஅelseஅNoneநநஅஅஅஅdefஅlabel_filter_fun(label):நஅஅஅஅஅஅஅஅifஅPARAMS.normalize:நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அunicodedata.normalize("NFKD",அlabel.strip())அ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")அ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅlabelஅ=அmaybe_normalize(label)நஅஅஅஅஅஅஅஅlabelஅ=அvalidate_label(label)நஅஅஅஅஅஅஅஅifஅALPHABETஅandஅlabel:நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅALPHABET.encode(label)நஅஅஅஅஅஅஅஅஅஅஅஅexceptஅKeyError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அNoneநஅஅஅஅஅஅஅஅreturnஅlabelநநஅஅஅஅdataset_sourcesஅ=அ_download_and_preprocess_data(csv_url=DATASET_RELEASE_CSV,அtarget_dir=PARAMS.target_dir)நஅஅஅஅsources_root_dirஅ=அos.path.dirname(dataset_sources)நஅஅஅஅall_counterஅ=அget_counter()நஅஅஅஅall_rowsஅ=அ[]நஅஅஅஅwithஅopen(dataset_sources,அ"r")அasஅsources:நஅஅஅஅஅஅஅஅforஅlineஅinஅsources.readlines():நஅஅஅஅஅஅஅஅஅஅஅஅdஅ=அline.split(",")நஅஅஅஅஅஅஅஅஅஅஅஅthis_xmlஅ=அos.path.join(sources_root_dir,அd[0])நஅஅஅஅஅஅஅஅஅஅஅஅthis_mp0அ=அos.path.join(sources_root_dir,அd[0])நஅஅஅஅஅஅஅஅஅஅஅஅthis_relஅ=அfloat(d[0])நநஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அos.path.join(sources_root_dir,அos.path.splitext(os.path.basename(this_mp0))[0]அ+அ".wav")நஅஅஅஅஅஅஅஅஅஅஅஅ_maybe_convert_wav(this_mp0,அwav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅcounter,அrowsஅ=அ_maybe_import_data(this_xml,அwav_filename,அsources_root_dir,அthis_rel)நநஅஅஅஅஅஅஅஅஅஅஅஅall_counterஅ+=அcounterநஅஅஅஅஅஅஅஅஅஅஅஅall_rowsஅ+=அrowsநஅஅஅஅwrite_general_csv(sources_root_dir,அ_counter=all_counter,அ_rows=all_rows)ந#!/usr/bin/envஅpythonந"""நDownloadsஅandஅpreparesஅ(partsஅof)அtheஅ"GermanஅDistantஅSpeech"அcorpusஅ(TUDA)அforஅDeepSpeech.pyநUseஅ"python0அimport_tuda.pyஅ-h"அforஅhelpந"""நimportஅargparseநimportஅcsvநimportஅosநimportஅtarfileநimportஅunicodedataநimportஅwaveநimportஅxml.etree.ElementTreeஅasஅETநfromஅcollectionsஅimportஅCounterநநimportஅprogressbarநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.importersஅimportஅvalidate_label_engஅasஅvalidate_labelநfromஅds_ctcdecoderஅimportஅAlphabetநநTUDA_VERSIONஅ=அ"v0"நTUDA_PACKAGEஅ=அ"german-speechdata-package-{}".format(TUDA_VERSION)நTUDA_URLஅ=அ"http://ltdata0.informatik.uni-hamburg.de/kaldi_tuda_de/{}.tar.gz".format(நஅஅஅஅTUDA_PACKAGEந)நTUDA_ARCHIVEஅ=அ"{}.tar.gz".format(TUDA_PACKAGE)நநCHANNELSஅ=அ0நSAMPLE_WIDTHஅ=அ0நSAMPLE_RATEஅ=அ00000நநFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நநநdefஅmaybe_extract(archive):நஅஅஅஅextractedஅ=அos.path.join(CLI_ARGS.base_dir,அTUDA_PACKAGE)நஅஅஅஅifஅos.path.isdir(extracted):நஅஅஅஅஅஅஅஅprint('Foundஅdirectoryஅ"{}"அ-அnotஅextracting.'.format(extracted))நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Extractingஅ"{}"...'.format(archive))நஅஅஅஅஅஅஅஅwithஅtarfile.open(archive)அasஅtar:நஅஅஅஅஅஅஅஅஅஅஅஅmembersஅ=அtar.getmembers()நஅஅஅஅஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(members),அwidgets=SIMPLE_BAR)நஅஅஅஅஅஅஅஅஅஅஅஅforஅmemberஅinஅbar(members):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtar.extract(member=member,அpath=CLI_ARGS.base_dir)நஅஅஅஅreturnஅextractedநநநdefஅin_alphabet(c):நஅஅஅஅreturnஅALPHABET.CanEncode(c)அifஅALPHABETஅelseஅTrueநநநdefஅcheck_and_prepare_sentence(sentence):நஅஅஅஅsentenceஅ=அsentence.lower().replace("co0",அ"cஅoஅzwei")நஅஅஅஅcharsஅ=அ[]நஅஅஅஅforஅcஅinஅsentence:நஅஅஅஅஅஅஅஅifஅCLI_ARGS.normalizeஅandஅcஅnotஅinஅ""அandஅnotஅin_alphabet(c):நஅஅஅஅஅஅஅஅஅஅஅஅcஅ=அunicodedata.normalize("NFKD",அc).encode("ascii",அ"ignore").decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅforஅscஅinஅc:நஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅin_alphabet(c):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅchars.append(sc)நஅஅஅஅreturnஅvalidate_label("".join(chars))நநநdefஅcheck_wav_file(wav_path,அsentence):அஅ#அpylint:அdisable=too-many-return-statementsநஅஅஅஅtry:நஅஅஅஅஅஅஅஅwithஅwave.open(wav_path,அ"r")அasஅsrc_wav_file:நஅஅஅஅஅஅஅஅஅஅஅஅrateஅ=அsrc_wav_file.getframerate()நஅஅஅஅஅஅஅஅஅஅஅஅchannelsஅ=அsrc_wav_file.getnchannels()நஅஅஅஅஅஅஅஅஅஅஅஅsample_widthஅ=அsrc_wav_file.getsampwidth()நஅஅஅஅஅஅஅஅஅஅஅஅmillisecondsஅ=அint(src_wav_file.getnframes()அ*அ0000அ/அrate)நஅஅஅஅஅஅஅஅifஅrateஅ!=அSAMPLE_RATE:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅFalse,அ"wrongஅsampleஅrate"நஅஅஅஅஅஅஅஅifஅchannelsஅ!=அCHANNELS:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅFalse,அ"wrongஅnumberஅofஅchannels"நஅஅஅஅஅஅஅஅifஅsample_widthஅ!=அSAMPLE_WIDTH:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅFalse,அ"wrongஅsampleஅwidth"நஅஅஅஅஅஅஅஅifஅmillisecondsஅ/அlen(sentence)அ<அ00:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅFalse,அ"tooஅshort"நஅஅஅஅஅஅஅஅifஅmillisecondsஅ>அCLI_ARGS.max_durationஅ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅFalse,அ"tooஅlong"நஅஅஅஅexceptஅwave.Error:நஅஅஅஅஅஅஅஅreturnஅFalse,அ"invalidஅwavஅfile"நஅஅஅஅexceptஅEOFError:நஅஅஅஅஅஅஅஅreturnஅFalse,அ"prematureஅEOF"நஅஅஅஅreturnஅTrue,அ"OK"நநநdefஅwrite_csvs(extracted):நஅஅஅஅsample_counterஅ=அ0நஅஅஅஅreasonsஅ=அCounter()நஅஅஅஅforஅsub_setஅinஅ["train",அ"dev",அ"test"]:நஅஅஅஅஅஅஅஅset_pathஅ=அos.path.join(extracted,அsub_set)நஅஅஅஅஅஅஅஅset_filesஅ=அos.listdir(set_path)நஅஅஅஅஅஅஅஅrecordingsஅ=அ{}நஅஅஅஅஅஅஅஅforஅfileஅinஅset_files:நஅஅஅஅஅஅஅஅஅஅஅஅifஅfile.endswith(".xml"):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrecordings[file[:-0]]அ=அ[]நஅஅஅஅஅஅஅஅforஅfileஅinஅset_files:நஅஅஅஅஅஅஅஅஅஅஅஅifஅfile.endswith(".wav")அandஅ"_"அinஅfile:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprefixஅ=அfile.split("_")[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅprefixஅinஅrecordings:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrecordings[prefix].append(file)நஅஅஅஅஅஅஅஅrecordingsஅ=அrecordings.items()நஅஅஅஅஅஅஅஅcsv_pathஅ=அos.path.join(நஅஅஅஅஅஅஅஅஅஅஅஅCLI_ARGS.base_dir,அ"tuda-{}-{}.csv".format(TUDA_VERSION,அsub_set)நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅprint('Writingஅ"{}"...'.format(csv_path))நஅஅஅஅஅஅஅஅwithஅopen(csv_path,அ"w",அencoding="utf-0",அnewline="")அasஅcsv_file:நஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அcsv.DictWriter(csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅwriter.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅset_dirஅ=அos.path.join(extracted,அsub_set)நஅஅஅஅஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=len(recordings),அwidgets=SIMPLE_BAR)நஅஅஅஅஅஅஅஅஅஅஅஅforஅprefix,அwav_namesஅinஅbar(recordings):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅxml_pathஅ=அos.path.join(set_dir,அprefixஅ+அ".xml")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmetaஅ=அET.parse(xml_path).getroot()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsentenceஅ=அlist(meta.iter("cleaned_sentence"))[0].textநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsentenceஅ=அcheck_and_prepare_sentence(sentence)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅsentenceஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreasons['alphabetஅfilter']அ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅwav_nameஅinஅwav_names:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_counterஅ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_pathஅ=அos.path.join(set_path,அwav_name)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅkeep,அreasonஅ=அcheck_wav_file(wav_path,அsentence)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅkeep:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filename":அos.path.relpath(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_path,அCLI_ARGS.base_dirநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"wav_filesize":அos.path.getsize(wav_path),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"transcript":அsentence.lower(),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreasons[reason]அ+=அ0நஅஅஅஅifஅlen(reasons.keys())அ>அ0:நஅஅஅஅஅஅஅஅprint("Excludedஅsamples:")நஅஅஅஅஅஅஅஅforஅreason,அnஅinஅreasons.most_common():நஅஅஅஅஅஅஅஅஅஅஅஅprint('அ-அ"{}":அ{}அ({:.0f}%)'.format(reason,அn,அnஅ*அ000அ/அsample_counter))நநநdefஅcleanup(archive):நஅஅஅஅifஅnotஅCLI_ARGS.keep_archive:நஅஅஅஅஅஅஅஅprint('Removingஅarchiveஅ"{}"...'.format(archive))நஅஅஅஅஅஅஅஅos.remove(archive)நநநdefஅdownload_and_prepare():நஅஅஅஅarchiveஅ=அmaybe_download(TUDA_ARCHIVE,அCLI_ARGS.base_dir,அTUDA_URL)நஅஅஅஅextractedஅ=அmaybe_extract(archive)நஅஅஅஅwrite_csvs(extracted)நஅஅஅஅcleanup(archive)நநநdefஅhandle_args():நஅஅஅஅparserஅ=அargparse.ArgumentParser(description="ImportஅGermanஅDistantஅSpeechஅ(TUDA)")நஅஅஅஅparser.add_argument("base_dir",அhelp="Directoryஅcontainingஅallஅdata")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--max_duration",நஅஅஅஅஅஅஅஅtype=int,நஅஅஅஅஅஅஅஅdefault=00000,நஅஅஅஅஅஅஅஅhelp="Maximumஅsampleஅdurationஅinஅmilliseconds",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--normalize",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Convertsஅdiacriticஅcharactersஅtoஅtheirஅbaseஅones",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--alphabet",நஅஅஅஅஅஅஅஅhelp="Excludeஅsamplesஅwithஅcharactersஅnotஅinஅprovidedஅalphabetஅfile",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--keep_archive",நஅஅஅஅஅஅஅஅtype=bool,நஅஅஅஅஅஅஅஅdefault=True,நஅஅஅஅஅஅஅஅhelp="Ifஅdownloadedஅarchivesஅshouldஅbeஅkept",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅCLI_ARGSஅ=அhandle_args()நஅஅஅஅALPHABETஅ=அAlphabet(CLI_ARGS.alphabet)அifஅCLI_ARGS.alphabetஅelseஅNoneநஅஅஅஅdownload_and_prepare()ந#!/usr/bin/envஅpythonநimportஅglobநimportஅosநimportஅtarfileநimportஅwaveநநimportஅpandasநநfromஅdeepspeech_training.util.importersஅimportஅget_importers_parserநநCOLUMN_NAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நநநdefஅextract(archive_path,அtarget_dir):நஅஅஅஅprint("Extractingஅ{}அintoஅ{}...".format(archive_path,அtarget_dir))நஅஅஅஅwithஅtarfile.open(archive_path)அasஅtar:நஅஅஅஅஅஅஅஅtar.extractall(target_dir)நநநdefஅis_file_truncated(wav_filename,அwav_filesize):நஅஅஅஅwithஅwave.open(wav_filename,அmode="rb")அasஅfin:நஅஅஅஅஅஅஅஅassertஅfin.getframerate()அ==அ00000நஅஅஅஅஅஅஅஅassertஅfin.getsampwidth()அ==அ0நஅஅஅஅஅஅஅஅassertஅfin.getnchannels()அ==அ0நநஅஅஅஅஅஅஅஅheader_durationஅ=அfin.getnframes()அ/அfin.getframerate()நஅஅஅஅஅஅஅஅfilesize_durationஅ=அ(wav_filesizeஅ-அ00)அ/அ00000அ/அ0நநஅஅஅஅreturnஅheader_durationஅ!=அfilesize_durationநநநdefஅpreprocess_data(folder_with_archives,அtarget_dir):நஅஅஅஅ#அFirstஅextractஅsubsetஅarchivesநஅஅஅஅforஅsubsetஅinஅ("train",அ"dev",அ"test"):நஅஅஅஅஅஅஅஅextract(நஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfolder_with_archives,அ"magicdata_{}_set.tar.gz".format(subset)நஅஅஅஅஅஅஅஅஅஅஅஅ),நஅஅஅஅஅஅஅஅஅஅஅஅtarget_dir,நஅஅஅஅஅஅஅஅ)நநஅஅஅஅ#அFolderஅstructureஅisஅnow:நஅஅஅஅ#அ-அmagicdata_{train,dev,test}.tar.gzநஅஅஅஅ#அ-அmagicdata/நஅஅஅஅ#அஅஅ-அtrain/*.wavநஅஅஅஅ#அஅஅ-அtrain/TRANS.txtநஅஅஅஅ#அஅஅ-அdev/*.wavநஅஅஅஅ#அஅஅ-அdev/TRANS.txtநஅஅஅஅ#அஅஅ-அtest/*.wavநஅஅஅஅ#அஅஅ-அtest/TRANS.txtநநஅஅஅஅ#அTheஅTRANSஅfilesஅareஅCSVsஅwithஅthreeஅcolumns,அoneஅcontainingஅtheஅWAVஅfileநஅஅஅஅ#அname,அoneஅcontainingஅtheஅspeakerஅID,அandஅoneஅcontainingஅtheஅtranscriptionநநஅஅஅஅdefஅload_set(set_path):நஅஅஅஅஅஅஅஅtranscriptsஅ=அpandas.read_csv(நஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(set_path,அ"TRANS.txt"),அsep="\t",அindex_col=0நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅglob_pathஅ=அos.path.join(set_path,அ"*",அ"*.wav")நஅஅஅஅஅஅஅஅset_filesஅ=அ[]நஅஅஅஅஅஅஅஅforஅwavஅinஅglob.glob(glob_path):நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அwavநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அos.path.getsize(wav)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript_keyஅ=அos.path.basename(wav)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அtranscripts.loc[transcript_key,அ"Transcription"]நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அSomeஅfilesஅinஅthisஅdatasetஅareஅtruncated,அtheஅheaderஅdurationநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அdoesn'tஅmatchஅtheஅfileஅsize.அThisஅcausesஅerrorsஅatஅtrainingநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அtime,அsoஅcheckஅhereஅifஅthingsஅareஅfineஅbeforeஅincludingஅaஅfileநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅis_file_truncated(wav_filename,அwav_filesize):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"Warning:அFileஅ{}அisஅcorrupted,அheaderஅdurationஅdoesஅ"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"notஅmatchஅfileஅsize.அIgnoring.".format(wav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅset_files.append((wav_filename,அwav_filesize,அtranscript))நஅஅஅஅஅஅஅஅஅஅஅஅexceptஅKeyError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("Warning:அMissingஅtranscriptஅforஅWAVஅfileஅ{}.".format(wav))நஅஅஅஅஅஅஅஅreturnஅset_filesநநஅஅஅஅforஅsubsetஅinஅ("train",அ"dev",அ"test"):நஅஅஅஅஅஅஅஅprint("Loadingஅ{}அsetஅsamples...".format(subset))நஅஅஅஅஅஅஅஅsubset_filesஅ=அload_set(os.path.join(target_dir,அsubset))நஅஅஅஅஅஅஅஅdfஅ=அpandas.DataFrame(data=subset_files,அcolumns=COLUMN_NAMES)நநஅஅஅஅஅஅஅஅ#அTrimஅtrainஅsetஅtoஅunderஅ00sநஅஅஅஅஅஅஅஅifஅsubsetஅ==அ"train":நஅஅஅஅஅஅஅஅஅஅஅஅdurationsஅ=அ(df["wav_filesize"]அ-அ00)அ/அ00000அ/அ0நஅஅஅஅஅஅஅஅஅஅஅஅdfஅ=அdf[durationsஅ<=அ00.0]நஅஅஅஅஅஅஅஅஅஅஅஅprint("Trimmingஅ{}அsamplesஅ>அ00அseconds".format((durationsஅ>அ00.0).sum()))நநஅஅஅஅஅஅஅஅஅஅஅஅwith_noiseஅ=அdf["transcript"].str.contains(r"\[(FIL|SPK)\]")நஅஅஅஅஅஅஅஅஅஅஅஅdfஅ=அdf[~with_noise]நஅஅஅஅஅஅஅஅஅஅஅஅprint(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"Trimmingஅ{}அsamplesஅwithஅnoiseஅ([FIL]அorஅ[SPK])".format(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsum(with_noise)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"magicdata_{}.csv".format(subset))நஅஅஅஅஅஅஅஅprint("Savingஅ{}அsetஅintoஅ{}...".format(subset,அdest_csv))நஅஅஅஅஅஅஅஅdf.to_csv(dest_csv,அindex=False)நநநdefஅmain():நஅஅஅஅ#அhttps://openslr.org/00/நஅஅஅஅparserஅ=அget_importers_parser(description="ImportஅMAGICDATAஅcorpus")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"folder_with_archives",நஅஅஅஅஅஅஅஅhelp="Pathஅtoஅfolderஅcontainingஅmagicdata_{train,dev,test}.tar.gz",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--target_dir",நஅஅஅஅஅஅஅஅdefault="",நஅஅஅஅஅஅஅஅhelp="TargetஅfolderஅtoஅextractஅfilesஅintoஅandஅputஅtheஅresultingஅCSVs.அDefaultsஅtoஅaஅfolderஅcalledஅmagicdataஅnextஅtoஅtheஅarchives",நஅஅஅஅ)நஅஅஅஅparamsஅ=அparser.parse_args()நநஅஅஅஅifஅnotஅparams.target_dir:நஅஅஅஅஅஅஅஅparams.target_dirஅ=அos.path.join(params.folder_with_archives,அ"magicdata")நநஅஅஅஅpreprocess_data(params.folder_with_archives,அparams.target_dir)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅmain()ந#!/usr/bin/envஅpython0ந#அpylint:அdisable=invalid-nameநimportஅcsvநimportஅosநimportஅsubprocessநimportஅtarfileநimportஅunicodedataநfromஅglobஅimportஅglobநfromஅmultiprocessingஅimportஅPoolநநimportஅprogressbarநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.importersஅimportஅ(நஅஅஅஅget_counter,நஅஅஅஅget_imported_samples,நஅஅஅஅget_importers_parser,நஅஅஅஅget_validate_label,நஅஅஅஅprint_import_report,ந)நfromஅds_ctcdecoderஅimportஅAlphabetநநFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நSAMPLE_RATEஅ=அ00000நMAX_SECSஅ=அ00நநARCHIVE_DIR_NAMEஅ=அ"{language}"நARCHIVE_NAMEஅ=அ"{language}.tgz"நARCHIVE_URLஅ=அ"https://data.solak.de/data/Training/stt_tts/"அ+அARCHIVE_NAMEநநநdefஅ_download_and_preprocess_data(target_dir):நஅஅஅஅ#அMakingஅpathஅabsoluteநஅஅஅஅtarget_dirஅ=அos.path.abspath(target_dir)நஅஅஅஅ#அConditionallyஅdownloadஅdataநஅஅஅஅarchive_pathஅ=அmaybe_download(ARCHIVE_NAME,அtarget_dir,அARCHIVE_URL)நஅஅஅஅ#அConditionallyஅextractஅdataநஅஅஅஅ_maybe_extract(target_dir,அARCHIVE_DIR_NAME,அarchive_path)நஅஅஅஅ#அProduceஅCSVஅfilesநஅஅஅஅ_maybe_convert_sets(target_dir,அARCHIVE_DIR_NAME)நநநdefஅ_maybe_extract(target_dir,அextracted_data,அarchive_path):நஅஅஅஅ#அIfஅtarget_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅtarget_dirநஅஅஅஅextracted_pathஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅifஅnotஅos.path.exists(extracted_path):நஅஅஅஅஅஅஅஅprint('Noஅdirectoryஅ"%s"அ-அextractingஅarchive...'அ%அextracted_path)நஅஅஅஅஅஅஅஅifஅnotஅos.path.isdir(extracted_path):நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(extracted_path)நஅஅஅஅஅஅஅஅtarஅ=அtarfile.open(archive_path)நஅஅஅஅஅஅஅஅtar.extractall(extracted_path)நஅஅஅஅஅஅஅஅtar.close()நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Foundஅdirectoryஅ"%s"அ-அnotஅextractingஅitஅfromஅarchive.'அ%அarchive_path)நநநdefஅone_sample(sample):நஅஅஅஅ"""அTakeஅaஅaudioஅfile,அandஅoptionallyஅconvertஅitஅtoஅ00kHzஅWAVஅ"""நஅஅஅஅwav_filenameஅ=அsample[0]நஅஅஅஅfile_sizeஅ=அ-0நஅஅஅஅframesஅ=அ0நஅஅஅஅifஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅtmp_filenameஅ=அos.path.splitext(wav_filename)[0]+'.tmp.wav'நஅஅஅஅஅஅஅஅsubprocess.check_call(நஅஅஅஅஅஅஅஅஅஅஅஅ['sox',அwav_filename,அ'-r',அstr(SAMPLE_RATE),அ'-c',அ'0',அ'-b',அ'00',அtmp_filename],அstderr=subprocess.STDOUTநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅos.rename(tmp_filename,அwav_filename)நஅஅஅஅஅஅஅஅfile_sizeஅ=அos.path.getsize(wav_filename)நஅஅஅஅஅஅஅஅframesஅ=அint(நஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_output(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ["soxi",அ"-s",அwav_filename],அstderr=subprocess.STDOUTநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅ)நஅஅஅஅlabelஅ=அlabel_filter(sample[0])நஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅrowsஅ=அ[]நநஅஅஅஅifஅfile_sizeஅ==அ-0:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅuponஅconversionநஅஅஅஅஅஅஅஅprint("conversionஅfailure",அwav_filename)நஅஅஅஅஅஅஅஅcounter["failed"]அ+=அ0நஅஅஅஅelifஅlabelஅisஅNone:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅonஅlabelஅvalidationநஅஅஅஅஅஅஅஅcounter["invalid_label"]அ+=அ0நஅஅஅஅelifஅint(framesஅ/அSAMPLE_RATEஅ*அ0000அ/அ00அ/அ0)அ<அlen(str(label)):நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅareஅtooஅshortஅtoஅfitஅtheஅtranscriptநஅஅஅஅஅஅஅஅcounter["too_short"]அ+=அ0நஅஅஅஅelifஅframesஅ/அSAMPLE_RATEஅ>அMAX_SECS:நஅஅஅஅஅஅஅஅ#அExcludingஅveryஅlongஅsamplesஅtoஅkeepஅaஅreasonableஅbatch-sizeநஅஅஅஅஅஅஅஅcounter["too_long"]அ+=அ0நஅஅஅஅelse:நஅஅஅஅஅஅஅஅ#அThisஅoneஅisஅgoodஅ-அkeepஅitஅforஅtheஅtargetஅCSVநஅஅஅஅஅஅஅஅrows.append((wav_filename,அfile_size,அlabel))நஅஅஅஅஅஅஅஅcounter["imported_time"]அ+=அframesநஅஅஅஅcounter["all"]அ+=அ0நஅஅஅஅcounter["total_time"]அ+=அframesநஅஅஅஅreturnஅ(counter,அrows)நநநdefஅ_maybe_convert_sets(target_dir,அextracted_data):நஅஅஅஅextracted_dirஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅ#அoverrideஅexistingஅCSVஅwithஅnormalizedஅoneநஅஅஅஅtarget_csv_templateஅ=அos.path.join(நஅஅஅஅஅஅஅஅtarget_dir,அARCHIVE_DIR_NAME,அARCHIVE_NAME.replace(".tgz",அ"_{}.csv")நஅஅஅஅ)நஅஅஅஅifஅos.path.isfile(target_csv_template):நஅஅஅஅஅஅஅஅreturnநநஅஅஅஅwav_root_dirஅ=அos.path.join(extracted_dir)நநஅஅஅஅ#அGetஅaudiofileஅpathஅandஅtranscriptஅforஅeachஅsentenceஅinஅtsvநஅஅஅஅsamplesஅ=அ[]நஅஅஅஅglob_dirஅ=அos.path.join(wav_root_dir,அ"**/metadata.csv")நஅஅஅஅforஅrecordஅinஅglob(glob_dir,அrecursive=True):நஅஅஅஅஅஅஅஅifஅany(நஅஅஅஅஅஅஅஅஅஅஅஅmap(lambdaஅsk:அskஅinஅrecord,அSKIP_LIST)நஅஅஅஅஅஅஅஅ):அஅ#அpylint:அdisable=cell-var-from-loopநஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅwithஅopen(record,அ"r")அasஅrec:நஅஅஅஅஅஅஅஅஅஅஅஅforஅreஅinஅrec.readlines():நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreஅ=அre.strip().split("|")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudioஅ=அos.path.join(os.path.dirname(record),அ"wavs",அre[0]அ+அ".wav")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அre[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsamples.append((audio,அtranscript))நநஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅnum_samplesஅ=அlen(samples)நஅஅஅஅrowsஅ=அ[]நநஅஅஅஅprint("ImportingஅWAVஅfiles...")நஅஅஅஅpoolஅ=அPool()நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅforஅi,அprocessedஅinஅenumerate(pool.imap_unordered(one_sample,அsamples),அstart=0):நஅஅஅஅஅஅஅஅcounterஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅrowsஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅbar.update(i)நஅஅஅஅbar.update(num_samples)நஅஅஅஅpool.close()நஅஅஅஅpool.join()நநஅஅஅஅwithஅopen(target_csv_template.format("train"),அ"w",அencoding="utf-0",அnewline="")அasஅtrain_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("dev"),அ"w",அencoding="utf-0",அnewline="")அasஅdev_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("test"),அ"w",அencoding="utf-0",அnewline="")அasஅtest_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writerஅ=அcsv.DictWriter(train_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writerஅ=அcsv.DictWriter(dev_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writerஅ=அcsv.DictWriter(test_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writer.writeheader()நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅi,அitemஅinஅenumerate(rows):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அvalidate_label(item[0])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅtranscript:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அitem[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅi_modஅ=அiஅ%அ00நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtest_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அdev_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtrain_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdict(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filename=os.path.relpath(wav_filename,அextracted_dir),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesize=os.path.getsize(wav_filename),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript=transcript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅimported_samplesஅ=அget_imported_samples(counter)நஅஅஅஅassertஅcounter["all"]அ==அnum_samplesநஅஅஅஅassertஅlen(rows)அ==அimported_samplesநநஅஅஅஅprint_import_report(counter,அSAMPLE_RATE,அMAX_SECS)நநநdefஅhandle_args():நஅஅஅஅparserஅ=அget_importers_parser(நஅஅஅஅஅஅஅஅdescription="ImporterஅforஅM-AILABSஅdataset.அhttps://www.caito.de/0000/00/the-m-ailabs-speech-dataset/."நஅஅஅஅ)நஅஅஅஅparser.add_argument(dest="target_dir")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--filter_alphabet",நஅஅஅஅஅஅஅஅhelp="Excludeஅsamplesஅwithஅcharactersஅnotஅinஅprovidedஅalphabet",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--normalize",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Convertsஅdiacriticஅcharactersஅtoஅtheirஅbaseஅones",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--skiplist",நஅஅஅஅஅஅஅஅtype=str,நஅஅஅஅஅஅஅஅdefault="",நஅஅஅஅஅஅஅஅhelp="Directoriesஅ/அbooksஅtoஅskip,அcommaஅseparated",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--language",அrequired=True,அtype=str,அhelp="Datasetஅlanguageஅtoஅuse"நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅCLI_ARGSஅ=அhandle_args()நஅஅஅஅALPHABETஅ=அAlphabet(CLI_ARGS.filter_alphabet)அifஅCLI_ARGS.filter_alphabetஅelseஅNoneநஅஅஅஅSKIP_LISTஅ=அfilter(None,அCLI_ARGS.skiplist.split(","))நஅஅஅஅvalidate_labelஅ=அget_validate_label(CLI_ARGS)நநஅஅஅஅdefஅlabel_filter(label):நஅஅஅஅஅஅஅஅifஅCLI_ARGS.normalize:நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅunicodedata.normalize("NFKD",அlabel.strip())நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅlabelஅ=அvalidate_label(label)நஅஅஅஅஅஅஅஅifஅALPHABETஅandஅlabelஅandஅnotஅALPHABET.CanEncode(label):நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அNoneநஅஅஅஅஅஅஅஅreturnஅlabelநநஅஅஅஅARCHIVE_DIR_NAMEஅ=அARCHIVE_DIR_NAME.format(language=CLI_ARGS.language)நஅஅஅஅARCHIVE_NAMEஅ=அARCHIVE_NAME.format(language=CLI_ARGS.language)நஅஅஅஅARCHIVE_URLஅ=அARCHIVE_URL.format(language=CLI_ARGS.language)நநஅஅஅஅ_download_and_preprocess_data(target_dir=CLI_ARGS.target_dir)ந#!/usr/bin/envஅpythonநimportஅsysநimportஅtarfileநimportஅunicodedataநimportஅwaveநfromஅglobஅimportஅglobநfromஅosஅimportஅmakedirs,அpath,அremove,அrmdirநநimportஅpandasநfromஅsoxஅimportஅTransformerநfromஅtensorflow.python.platformஅimportஅgfileநநfromஅdeepspeech_training.util.downloaderஅimportஅmaybe_downloadநfromஅdeepspeech_training.util.stmஅimportஅparse_stm_fileநநநdefஅ_download_and_preprocess_data(data_dir):நஅஅஅஅ#அConditionallyஅdownloadஅdataநஅஅஅஅTED_DATAஅ=அ"TEDLIUM_release0.tar.gz"நஅஅஅஅTED_DATA_URLஅ=அ"http://www.openslr.org/resources/00/TEDLIUM_release0.tar.gz"நஅஅஅஅlocal_fileஅ=அmaybe_download(TED_DATA,அdata_dir,அTED_DATA_URL)நநஅஅஅஅ#அConditionallyஅextractஅTEDஅdataநஅஅஅஅTED_DIRஅ=அ"TEDLIUM_release0"நஅஅஅஅ_maybe_extract(data_dir,அTED_DIR,அlocal_file)நநஅஅஅஅ#அConditionallyஅconvertஅTEDஅsphஅdataஅtoஅwavநஅஅஅஅ_maybe_convert_wav(data_dir,அTED_DIR)நநஅஅஅஅ#அConditionallyஅsplitஅTEDஅwavஅandஅtextஅdataஅintoஅsentencesநஅஅஅஅtrain_files,அdev_files,அtest_filesஅ=அ_maybe_split_sentences(data_dir,அTED_DIR)நநஅஅஅஅ#அWriteஅsetsஅtoஅdiskஅasஅCSVஅfilesநஅஅஅஅtrain_files.to_csv(path.join(data_dir,அ"ted-train.csv"),அindex=False)நஅஅஅஅdev_files.to_csv(path.join(data_dir,அ"ted-dev.csv"),அindex=False)நஅஅஅஅtest_files.to_csv(path.join(data_dir,அ"ted-test.csv"),அindex=False)நநநdefஅ_maybe_extract(data_dir,அextracted_data,அarchive):நஅஅஅஅ#அIfஅdata_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅdata_dirநஅஅஅஅifஅnotஅgfile.Exists(path.join(data_dir,அextracted_data)):நஅஅஅஅஅஅஅஅtarஅ=அtarfile.open(archive)நஅஅஅஅஅஅஅஅtar.extractall(data_dir)நஅஅஅஅஅஅஅஅtar.close()நநநdefஅ_maybe_convert_wav(data_dir,அextracted_data):நஅஅஅஅ#அCreateஅextracted_dataஅdirநஅஅஅஅextracted_dirஅ=அpath.join(data_dir,அextracted_data)நநஅஅஅஅ#அConditionallyஅconvertஅdevஅsphஅtoஅwavநஅஅஅஅ_maybe_convert_wav_dataset(extracted_dir,அ"dev")நநஅஅஅஅ#அConditionallyஅconvertஅtrainஅsphஅtoஅwavநஅஅஅஅ_maybe_convert_wav_dataset(extracted_dir,அ"train")நநஅஅஅஅ#அConditionallyஅconvertஅtestஅsphஅtoஅwavநஅஅஅஅ_maybe_convert_wav_dataset(extracted_dir,அ"test")நநநdefஅ_maybe_convert_wav_dataset(extracted_dir,அdata_set):நஅஅஅஅ#அCreateஅsourceஅdirநஅஅஅஅsource_dirஅ=அpath.join(extracted_dir,அdata_set,அ"sph")நநஅஅஅஅ#அCreateஅtargetஅdirநஅஅஅஅtarget_dirஅ=அpath.join(extracted_dir,அdata_set,அ"wav")நநஅஅஅஅ#அConditionallyஅconvertஅsphஅfilesஅtoஅwavஅfilesநஅஅஅஅifஅnotஅgfile.Exists(target_dir):நஅஅஅஅஅஅஅஅ#அCreateஅtarget_dirநஅஅஅஅஅஅஅஅmakedirs(target_dir)நநஅஅஅஅஅஅஅஅ#அLoopஅoverஅsphஅfilesஅinஅsource_dirஅandஅconvertஅeachஅtoஅwavநஅஅஅஅஅஅஅஅforஅsph_fileஅinஅglob(path.join(source_dir,அ"*.sph")):நஅஅஅஅஅஅஅஅஅஅஅஅtransformerஅ=அTransformer()நஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அpath.splitext(path.basename(sph_file))[0]அ+அ".wav"நஅஅஅஅஅஅஅஅஅஅஅஅwav_fileஅ=அpath.join(target_dir,அwav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(sph_file,அwav_file)நஅஅஅஅஅஅஅஅஅஅஅஅremove(sph_file)நநஅஅஅஅஅஅஅஅ#அRemoveஅsource_dirநஅஅஅஅஅஅஅஅrmdir(source_dir)நநநdefஅ_maybe_split_sentences(data_dir,அextracted_data):நஅஅஅஅ#அCreateஅextracted_dataஅdirநஅஅஅஅextracted_dirஅ=அpath.join(data_dir,அextracted_data)நநஅஅஅஅ#அConditionallyஅsplitஅdevஅwavநஅஅஅஅdev_filesஅ=அ_maybe_split_dataset(extracted_dir,அ"dev")நநஅஅஅஅ#அConditionallyஅsplitஅtrainஅwavநஅஅஅஅtrain_filesஅ=அ_maybe_split_dataset(extracted_dir,அ"train")நநஅஅஅஅ#அConditionallyஅsplitஅtestஅwavநஅஅஅஅtest_filesஅ=அ_maybe_split_dataset(extracted_dir,அ"test")நநஅஅஅஅreturnஅtrain_files,அdev_files,அtest_filesநநநdefஅ_maybe_split_dataset(extracted_dir,அdata_set):நஅஅஅஅ#அCreateஅstmஅdirநஅஅஅஅstm_dirஅ=அpath.join(extracted_dir,அdata_set,அ"stm")நநஅஅஅஅ#அCreateஅwavஅdirநஅஅஅஅwav_dirஅ=அpath.join(extracted_dir,அdata_set,அ"wav")நநஅஅஅஅfilesஅ=அ[]நநஅஅஅஅ#அLoopஅoverஅstmஅfilesஅandஅsplitஅcorrespondingஅwavநஅஅஅஅforஅstm_fileஅinஅglob(path.join(stm_dir,அ"*.stm")):நஅஅஅஅஅஅஅஅ#அParseஅstmஅfileநஅஅஅஅஅஅஅஅstm_segmentsஅ=அparse_stm_file(stm_file)நநஅஅஅஅஅஅஅஅ#அOpenஅwavஅcorrespondingஅtoஅstm_fileநஅஅஅஅஅஅஅஅwav_filenameஅ=அpath.splitext(path.basename(stm_file))[0]அ+அ".wav"நஅஅஅஅஅஅஅஅwav_fileஅ=அpath.join(wav_dir,அwav_filename)நஅஅஅஅஅஅஅஅorigAudioஅ=அwave.open(wav_file,அ"r")நநஅஅஅஅஅஅஅஅ#அLoopஅoverஅstm_segmentsஅandஅsplitஅwav_fileஅforஅeachஅsegmentநஅஅஅஅஅஅஅஅforஅstm_segmentஅinஅstm_segments:நஅஅஅஅஅஅஅஅஅஅஅஅ#அCreateஅwavஅsegmentஅfilenameநஅஅஅஅஅஅஅஅஅஅஅஅstart_timeஅ=அstm_segment.start_timeநஅஅஅஅஅஅஅஅஅஅஅஅstop_timeஅ=அstm_segment.stop_timeநஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_filenameஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅpath.splitext(path.basename(stm_file))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அstr(start_time)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ"-"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அstr(stop_time)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ+அ".wav"நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_fileஅ=அpath.join(wav_dir,அnew_wav_filename)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அIfஅtheஅwavஅsegmentஅfilenameஅdoesஅnotஅexistஅcreateஅitநஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅgfile.Exists(new_wav_file):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ_split_wav(origAudio,அstart_time,அstop_time,அnew_wav_file)நநஅஅஅஅஅஅஅஅஅஅஅஅnew_wav_filesizeஅ=அpath.getsize(new_wav_file)நஅஅஅஅஅஅஅஅஅஅஅஅfiles.append(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(path.abspath(new_wav_file),அnew_wav_filesize,அstm_segment.transcript)நஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅ#அCloseஅorigAudioநஅஅஅஅஅஅஅஅorigAudio.close()நநஅஅஅஅreturnஅpandas.DataFrame(நஅஅஅஅஅஅஅஅdata=files,அcolumns=["wav_filename",அ"wav_filesize",அ"transcript"]நஅஅஅஅ)நநநdefஅ_split_wav(origAudio,அstart_time,அstop_time,அnew_wav_file):நஅஅஅஅframeRateஅ=அorigAudio.getframerate()நஅஅஅஅorigAudio.setpos(int(start_timeஅ*அframeRate))நஅஅஅஅchunkDataஅ=அorigAudio.readframes(int((stop_timeஅ-அstart_time)அ*அframeRate))நஅஅஅஅchunkAudioஅ=அwave.open(new_wav_file,அ"w")நஅஅஅஅchunkAudio.setnchannels(origAudio.getnchannels())நஅஅஅஅchunkAudio.setsampwidth(origAudio.getsampwidth())நஅஅஅஅchunkAudio.setframerate(frameRate)நஅஅஅஅchunkAudio.writeframes(chunkData)நஅஅஅஅchunkAudio.close()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅ_download_and_preprocess_data(sys.argv[0])ந#!/usr/bin/envஅpythonந#அ-*-அcoding:அutf-0அ-*-நநimportஅsysநநimportஅtensorflow.compat.v0அasஅtfv0நநநdefஅmain():நஅஅஅஅwithஅtfv0.gfile.FastGFile(sys.argv[0],அ"rb")அasஅfin:நஅஅஅஅஅஅஅஅgraph_defஅ=அtfv0.GraphDef()நஅஅஅஅஅஅஅஅgraph_def.ParseFromString(fin.read())நநஅஅஅஅஅஅஅஅprint("\n".join(sorted(set(n.opஅforஅnஅinஅgraph_def.node))))நநநifஅ__name__அ==அ"__main__":நஅஅஅஅmain()ந#!/usr/bin/envஅpython0நimportஅargparseநimportஅcsvநimportஅosநimportஅreநimportஅsubprocessநimportஅunicodedataநimportஅzipfileநfromஅglobஅimportஅglobநfromஅmultiprocessingஅimportஅPoolநநimportஅprogressbarநimportஅsoxநநfromஅdeepspeech_training.util.downloaderஅimportஅSIMPLE_BAR,அmaybe_downloadநfromஅdeepspeech_training.util.importersஅimportஅ(நஅஅஅஅget_counter,நஅஅஅஅget_imported_samples,நஅஅஅஅget_importers_parser,நஅஅஅஅget_validate_label,நஅஅஅஅprint_import_report,ந)நfromஅds_ctcdecoderஅimportஅAlphabetநநFIELDNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நSAMPLE_RATEஅ=அ00000நBITDEPTHஅ=அ00நN_CHANNELSஅ=அ0நMAX_SECSஅ=அ00நநARCHIVE_DIR_NAMEஅ=அ"lingua_libre"நARCHIVE_NAMEஅ=அ"Q{qId}-{iso000_0}-{language_English_name}.zip"நARCHIVE_URLஅ=அ"https://lingualibre.fr/datasets/"அ+அARCHIVE_NAMEநநநdefஅ_download_and_preprocess_data(target_dir):நஅஅஅஅ#அMakingஅpathஅabsoluteநஅஅஅஅtarget_dirஅ=அos.path.abspath(target_dir)நஅஅஅஅ#அConditionallyஅdownloadஅdataநஅஅஅஅarchive_pathஅ=அmaybe_download(ARCHIVE_NAME,அtarget_dir,அARCHIVE_URL)நஅஅஅஅ#அConditionallyஅextractஅdataநஅஅஅஅ_maybe_extract(target_dir,அARCHIVE_DIR_NAME,அarchive_path)நஅஅஅஅ#அProduceஅCSVஅfilesஅandஅconvertஅoggஅdataஅtoஅwavநஅஅஅஅ_maybe_convert_sets(target_dir,அARCHIVE_DIR_NAME)நநநdefஅ_maybe_extract(target_dir,அextracted_data,அarchive_path):நஅஅஅஅ#அIfஅtarget_dir/extracted_dataஅdoesஅnotஅexist,அextractஅarchiveஅinஅtarget_dirநஅஅஅஅextracted_pathஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅifஅnotஅos.path.exists(extracted_path):நஅஅஅஅஅஅஅஅprint('Noஅdirectoryஅ"%s"அ-அextractingஅarchive...'அ%அextracted_path)நஅஅஅஅஅஅஅஅifஅnotஅos.path.isdir(extracted_path):நஅஅஅஅஅஅஅஅஅஅஅஅos.mkdir(extracted_path)நஅஅஅஅஅஅஅஅwithஅzipfile.ZipFile(archive_path)அasஅzip_f:நஅஅஅஅஅஅஅஅஅஅஅஅzip_f.extractall(extracted_path)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Foundஅdirectoryஅ"%s"அ-அnotஅextractingஅitஅfromஅarchive.'அ%அarchive_path)நநநdefஅone_sample(sample):நஅஅஅஅ"""அTakeஅaஅaudioஅfile,அandஅoptionallyஅconvertஅitஅtoஅ00kHzஅWAVஅ"""நஅஅஅஅogg_filenameஅ=அsample[0]நஅஅஅஅ#அStoringஅwavஅfilesஅnextஅtoஅtheஅoggஅonesஅ-அjustஅwithஅaஅdifferentஅsuffixநஅஅஅஅwav_filenameஅ=அos.path.splitext(ogg_filename)[0]அ+அ".wav"நஅஅஅஅ_maybe_convert_wav(ogg_filename,அwav_filename)நஅஅஅஅfile_sizeஅ=அ-0நஅஅஅஅframesஅ=அ0நஅஅஅஅifஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅfile_sizeஅ=அos.path.getsize(wav_filename)நஅஅஅஅஅஅஅஅframesஅ=அint(நஅஅஅஅஅஅஅஅஅஅஅஅsubprocess.check_output(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ["soxi",அ"-s",அwav_filename],அstderr=subprocess.STDOUTநஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅ)நஅஅஅஅlabelஅ=அlabel_filter(sample[0])நஅஅஅஅrowsஅ=அ[]நஅஅஅஅcounterஅ=அget_counter()நநஅஅஅஅifஅfile_sizeஅ==அ-0:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅuponஅconversionநஅஅஅஅஅஅஅஅcounter["failed"]அ+=அ0நஅஅஅஅelifஅlabelஅisஅNone:நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅfailedஅonஅlabelஅvalidationநஅஅஅஅஅஅஅஅcounter["invalid_label"]அ+=அ0நஅஅஅஅelifஅint(framesஅ/அSAMPLE_RATEஅ*அ0000அ/அ00அ/அ0)அ<அlen(str(label)):நஅஅஅஅஅஅஅஅ#அExcludingஅsamplesஅthatஅareஅtooஅshortஅtoஅfitஅtheஅtranscriptநஅஅஅஅஅஅஅஅcounter["too_short"]அ+=அ0நஅஅஅஅelifஅframesஅ/அSAMPLE_RATEஅ>அMAX_SECS:நஅஅஅஅஅஅஅஅ#அExcludingஅveryஅlongஅsamplesஅtoஅkeepஅaஅreasonableஅbatch-sizeநஅஅஅஅஅஅஅஅcounter["too_long"]அ+=அ0நஅஅஅஅelse:நஅஅஅஅஅஅஅஅ#அThisஅoneஅisஅgoodஅ-அkeepஅitஅforஅtheஅtargetஅCSVநஅஅஅஅஅஅஅஅrows.append((wav_filename,அfile_size,அlabel))நஅஅஅஅஅஅஅஅcounter["imported_time"]அ+=அframesநஅஅஅஅcounter["all"]அ+=அ0நஅஅஅஅcounter["total_time"]அ+=அframesநநஅஅஅஅreturnஅ(counter,அrows)நநநdefஅ_maybe_convert_sets(target_dir,அextracted_data):நஅஅஅஅextracted_dirஅ=அos.path.join(target_dir,அextracted_data)நஅஅஅஅ#அoverrideஅexistingஅCSVஅwithஅnormalizedஅoneநஅஅஅஅtarget_csv_templateஅ=அos.path.join(நஅஅஅஅஅஅஅஅtarget_dir,அARCHIVE_DIR_NAMEஅ+அ"_"அ+அARCHIVE_NAME.replace(".zip",அ"_{}.csv")நஅஅஅஅ)நஅஅஅஅifஅos.path.isfile(target_csv_template):நஅஅஅஅஅஅஅஅreturnநநஅஅஅஅogg_root_dirஅ=அos.path.join(extracted_dir,அARCHIVE_NAME.replace(".zip",அ""))நநஅஅஅஅ#அGetஅaudiofileஅpathஅandஅtranscriptஅforஅeachஅsentenceஅinஅtsvநஅஅஅஅsamplesஅ=அ[]நஅஅஅஅglob_dirஅ=அos.path.join(ogg_root_dir,அ"**/*.ogg")நஅஅஅஅforஅrecordஅinஅglob(glob_dir,அrecursive=True):நஅஅஅஅஅஅஅஅrecord_fileஅ=அrecord.replace(ogg_root_dirஅ+அos.path.sep,அ"")நஅஅஅஅஅஅஅஅifஅrecord_filter(record_file):நஅஅஅஅஅஅஅஅஅஅஅஅsamples.append(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(ogg_root_dir,அrecord_file),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.splitext(os.path.basename(record_file))[0],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅcounterஅ=அget_counter()நஅஅஅஅnum_samplesஅ=அlen(samples)நஅஅஅஅrowsஅ=அ[]நநஅஅஅஅprint("Importingஅoggஅfiles...")நஅஅஅஅpoolஅ=அPool()நஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=num_samples,அwidgets=SIMPLE_BAR)நஅஅஅஅforஅi,அprocessedஅinஅenumerate(pool.imap_unordered(one_sample,அsamples),அstart=0):நஅஅஅஅஅஅஅஅcounterஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅrowsஅ+=அprocessed[0]நஅஅஅஅஅஅஅஅbar.update(i)நஅஅஅஅbar.update(num_samples)நஅஅஅஅpool.close()நஅஅஅஅpool.join()நநஅஅஅஅwithஅopen(target_csv_template.format("train"),அ"w",அencoding="utf-0",அnewline="")அasஅtrain_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("dev"),அ"w",அencoding="utf-0",அnewline="")அasஅdev_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen(target_csv_template.format("test"),அ"w",அencoding="utf-0",அnewline="")அasஅtest_csv_file:அஅ#அ00%நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writerஅ=அcsv.DictWriter(train_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writerஅ=அcsv.DictWriter(dev_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_writer.writeheader()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writerஅ=அcsv.DictWriter(test_csv_file,அfieldnames=FIELDNAMES)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtest_writer.writeheader()நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅi,அitemஅinஅenumerate(rows):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அvalidate_label(item[0])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅtranscript:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcontinueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அos.path.join(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅogg_root_dir,அitem[0].replace(".ogg",அ".wav")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅi_modஅ=அiஅ%அ00நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtest_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelifஅi_modஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அdev_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriterஅ=அtrain_writerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwriter.writerow(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdict(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filename=wav_filename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesize=os.path.getsize(wav_filename),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript=transcript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅimported_samplesஅ=அget_imported_samples(counter)நஅஅஅஅassertஅcounter["all"]அ==அnum_samplesநஅஅஅஅassertஅlen(rows)அ==அimported_samplesநநஅஅஅஅprint_import_report(counter,அSAMPLE_RATE,அMAX_SECS)நநநdefஅ_maybe_convert_wav(ogg_filename,அwav_filename):நஅஅஅஅifஅnotஅos.path.exists(wav_filename):நஅஅஅஅஅஅஅஅtransformerஅ=அsox.Transformer()நஅஅஅஅஅஅஅஅtransformer.convert(samplerate=SAMPLE_RATE,அn_channels=N_CHANNELS,அbitdepth=BITDEPTH)நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅtransformer.build(ogg_filename,அwav_filename)நஅஅஅஅஅஅஅஅexceptஅsox.core.SoxErrorஅasஅex:நஅஅஅஅஅஅஅஅஅஅஅஅprint("SoXஅprocessingஅerror",அex,அogg_filename,அwav_filename)நநநdefஅhandle_args():நஅஅஅஅparserஅ=அget_importers_parser(நஅஅஅஅஅஅஅஅdescription="ImporterஅforஅLinguaLibreஅdataset.அCheckஅhttps://lingualibre.fr/wiki/Help:Download_from_LinguaLibreஅforஅdetails."நஅஅஅஅ)நஅஅஅஅparser.add_argument(dest="target_dir")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--qId",அtype=int,அrequired=True,அhelp="LinguaLibreஅlanguageஅqId"நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--iso000-0",அtype=str,அrequired=True,அhelp="ISO000-0அlanguageஅcode"நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--english-name",அtype=str,அrequired=True,அhelp="Englishஅnameஅofஅtheஅlanguage"நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--filter_alphabet",நஅஅஅஅஅஅஅஅhelp="Excludeஅsamplesஅwithஅcharactersஅnotஅinஅprovidedஅalphabet",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--normalize",நஅஅஅஅஅஅஅஅaction="store_true",நஅஅஅஅஅஅஅஅhelp="Convertsஅdiacriticஅcharactersஅtoஅtheirஅbaseஅones",நஅஅஅஅ)நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--bogus-records",நஅஅஅஅஅஅஅஅtype=argparse.FileType("r"),நஅஅஅஅஅஅஅஅrequired=False,நஅஅஅஅஅஅஅஅhelp="Textஅfileஅlistingஅwell-knownஅbogusஅrecordஅtoஅskipஅfromஅimporting,அfromஅhttps://lingualibre.fr/wiki/LinguaLibre:Misleading_items",நஅஅஅஅ)நஅஅஅஅreturnஅparser.parse_args()நநநifஅ__name__அ==அ"__main__":நஅஅஅஅCLI_ARGSஅ=அhandle_args()நஅஅஅஅALPHABETஅ=அAlphabet(CLI_ARGS.filter_alphabet)அifஅCLI_ARGS.filter_alphabetஅelseஅNoneநஅஅஅஅvalidate_labelஅ=அget_validate_label(CLI_ARGS)நநஅஅஅஅbogus_regexesஅ=அ[]நஅஅஅஅifஅCLI_ARGS.bogus_records:நஅஅஅஅஅஅஅஅforஅlineஅinஅCLI_ARGS.bogus_records:நஅஅஅஅஅஅஅஅஅஅஅஅbogus_regexes.append(re.compile(line.strip()))நநஅஅஅஅdefஅrecord_filter(path):நஅஅஅஅஅஅஅஅifஅany(regex.match(path)அforஅregexஅinஅbogus_regexes):நஅஅஅஅஅஅஅஅஅஅஅஅprint("Reject",அpath)நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅFalseநஅஅஅஅஅஅஅஅreturnஅTrueநநஅஅஅஅdefஅlabel_filter(label):நஅஅஅஅஅஅஅஅifஅCLI_ARGS.normalize:நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅunicodedata.normalize("NFKD",அlabel.strip())நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நஅஅஅஅஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅlabelஅ=அvalidate_label(label)நஅஅஅஅஅஅஅஅifஅALPHABETஅandஅlabelஅandஅnotஅALPHABET.CanEncode(label):நஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அNoneநஅஅஅஅஅஅஅஅreturnஅlabelநநஅஅஅஅARCHIVE_NAMEஅ=அARCHIVE_NAME.format(நஅஅஅஅஅஅஅஅqId=CLI_ARGS.qId,நஅஅஅஅஅஅஅஅiso000_0=CLI_ARGS.iso000_0,நஅஅஅஅஅஅஅஅlanguage_English_name=CLI_ARGS.english_name,நஅஅஅஅ)நஅஅஅஅARCHIVE_URLஅ=அARCHIVE_URL.format(நஅஅஅஅஅஅஅஅqId=CLI_ARGS.qId,நஅஅஅஅஅஅஅஅiso000_0=CLI_ARGS.iso000_0,நஅஅஅஅஅஅஅஅlanguage_English_name=CLI_ARGS.english_name,நஅஅஅஅ)நஅஅஅஅ_download_and_preprocess_data(target_dir=CLI_ARGS.target_dir)ந#!/usr/bin/envஅpythonநimportஅglobநimportஅosநimportஅtarfileநநimportஅpandasநநfromஅdeepspeech_training.util.importersஅimportஅget_importers_parserநநCOLUMNNAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நநநdefஅextract(archive_path,அtarget_dir):நஅஅஅஅprint("Extractingஅ{}அintoஅ{}...".format(archive_path,அtarget_dir))நஅஅஅஅwithஅtarfile.open(archive_path)அasஅtar:நஅஅஅஅஅஅஅஅtar.extractall(target_dir)நநநdefஅpreprocess_data(tgz_file,அtarget_dir):நஅஅஅஅ#அFirstஅextractஅmainஅarchiveஅandஅsub-archivesநஅஅஅஅextract(tgz_file,அtarget_dir)நஅஅஅஅmain_folderஅ=அos.path.join(target_dir,அ"data_aishell")நநஅஅஅஅwav_archives_folderஅ=அos.path.join(main_folder,அ"wav")நஅஅஅஅforஅtargzஅinஅglob.glob(os.path.join(wav_archives_folder,அ"*.tar.gz")):நஅஅஅஅஅஅஅஅextract(targz,அmain_folder)நநஅஅஅஅ#அFolderஅstructureஅisஅnow:நஅஅஅஅ#அ-அdata_aishell/நஅஅஅஅ#அஅஅ-அtrain/S****/*.wavநஅஅஅஅ#அஅஅ-அdev/S****/*.wavநஅஅஅஅ#அஅஅ-அtest/S****/*.wavநஅஅஅஅ#அஅஅ-அwav/S****.tar.gzநஅஅஅஅ#அஅஅ-அtranscript/aishell_transcript_v0.0.txtநநஅஅஅஅ#அTranscriptsஅfileஅhasஅoneஅlineஅperஅWAVஅfile,அwhereஅeachஅlineஅconsistsஅofநஅஅஅஅ#அtheஅWAVஅfileஅnameஅwithoutஅextensionஅfollowedஅbyஅaஅsingleஅspaceஅfollowedநஅஅஅஅ#அbyஅtheஅtranscript.நநஅஅஅஅ#அSinceஅtheஅtranscriptsஅthemselvesஅcanஅcontainஅspaces,அweஅsplitஅonஅspaceஅbutநஅஅஅஅ#அonlyஅonce,அthenஅbuildஅaஅmappingஅfromஅfileஅnameஅtoஅtranscriptநஅஅஅஅtranscripts_pathஅ=அos.path.join(நஅஅஅஅஅஅஅஅmain_folder,அ"transcript",அ"aishell_transcript_v0.0.txt"நஅஅஅஅ)நஅஅஅஅwithஅopen(transcripts_path)அasஅfin:நஅஅஅஅஅஅஅஅtranscriptsஅ=அdict((line.split("அ",அmaxsplit=0)அforஅlineஅinஅfin))நநஅஅஅஅdefஅload_set(glob_path):நஅஅஅஅஅஅஅஅset_filesஅ=அ[]நஅஅஅஅஅஅஅஅforஅwavஅinஅglob.glob(glob_path):நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அwavநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அos.path.getsize(wav)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript_keyஅ=அos.path.splitext(os.path.basename(wav))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அtranscripts[transcript_key].strip("\n")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅset_files.append((wav_filename,அwav_filesize,அtranscript))நஅஅஅஅஅஅஅஅஅஅஅஅexceptஅKeyError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("Warning:அMissingஅtranscriptஅforஅWAVஅfileஅ{}.".format(wav))நஅஅஅஅஅஅஅஅreturnஅset_filesநநஅஅஅஅforஅsubsetஅinஅ("train",அ"dev",அ"test"):நஅஅஅஅஅஅஅஅprint("Loadingஅ{}அsetஅsamples...".format(subset))நஅஅஅஅஅஅஅஅsubset_filesஅ=அload_set(os.path.join(main_folder,அsubset,அ"S*",அ"*.wav"))நஅஅஅஅஅஅஅஅdfஅ=அpandas.DataFrame(data=subset_files,அcolumns=COLUMNNAMES)நநஅஅஅஅஅஅஅஅ#அTrimஅtrainஅsetஅtoஅunderஅ00sஅbyஅremovingஅtheஅlastஅcoupleஅhundredஅsamplesநஅஅஅஅஅஅஅஅifஅsubsetஅ==அ"train":நஅஅஅஅஅஅஅஅஅஅஅஅdurationsஅ=அ(df["wav_filesize"]அ-அ00)அ/அ00000அ/அ0நஅஅஅஅஅஅஅஅஅஅஅஅdfஅ=அdf[durationsஅ<=அ00.0]நஅஅஅஅஅஅஅஅஅஅஅஅprint("Trimmingஅ{}அsamplesஅ>அ00அseconds".format((durationsஅ>அ00.0).sum()))நநஅஅஅஅஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"aishell_{}.csv".format(subset))நஅஅஅஅஅஅஅஅprint("Savingஅ{}அsetஅintoஅ{}...".format(subset,அdest_csv))நஅஅஅஅஅஅஅஅdf.to_csv(dest_csv,அindex=False)நநநdefஅmain():நஅஅஅஅ#அhttp://www.openslr.org/00/நஅஅஅஅparserஅ=அget_importers_parser(description="ImportஅAISHELLஅcorpus")நஅஅஅஅparser.add_argument("aishell_tgz_file",அhelp="Pathஅtoஅdata_aishell.tgz")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--target_dir",நஅஅஅஅஅஅஅஅdefault="",நஅஅஅஅஅஅஅஅhelp="TargetஅfolderஅtoஅextractஅfilesஅintoஅandஅputஅtheஅresultingஅCSVs.அDefaultsஅtoஅsameஅfolderஅasஅtheஅmainஅarchive.",நஅஅஅஅ)நஅஅஅஅparamsஅ=அparser.parse_args()நநஅஅஅஅifஅnotஅparams.target_dir:நஅஅஅஅஅஅஅஅparams.target_dirஅ=அos.path.dirname(params.aishell_tgz_file)நநஅஅஅஅpreprocess_data(params.aishell_tgz_file,அparams.target_dir)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅmain()ந#!/usr/bin/envஅpythonநimportஅglobநimportஅosநimportஅtarfileநநimportஅpandasநநfromஅdeepspeech_training.util.importersஅimportஅget_importers_parserநநCOLUMN_NAMESஅ=அ["wav_filename",அ"wav_filesize",அ"transcript"]நநநdefஅextract(archive_path,அtarget_dir):நஅஅஅஅprint("Extractingஅ{}அintoஅ{}...".format(archive_path,அtarget_dir))நஅஅஅஅwithஅtarfile.open(archive_path)அasஅtar:நஅஅஅஅஅஅஅஅtar.extractall(target_dir)நநநdefஅpreprocess_data(tgz_file,அtarget_dir):நஅஅஅஅ#அFirstஅextractஅmainஅarchiveஅandஅsub-archivesநஅஅஅஅextract(tgz_file,அtarget_dir)நஅஅஅஅmain_folderஅ=அos.path.join(target_dir,அ"aidatatang_000zh")நநஅஅஅஅforஅtargzஅinஅglob.glob(os.path.join(main_folder,அ"corpus",அ"*",அ"*.tar.gz")):நஅஅஅஅஅஅஅஅextract(targz,அos.path.dirname(targz))நநஅஅஅஅ#அFolderஅstructureஅisஅnow:நஅஅஅஅ#அ-அaidatatang_000zh/நஅஅஅஅ#அஅஅ-அtranscript/aidatatang_000_zh_transcript.txtநஅஅஅஅ#அஅஅ-அcorpus/train/*.tar.gzநஅஅஅஅ#அஅஅ-அcorpus/train/*/*.{wav,txt,trn,metadata}நஅஅஅஅ#அஅஅ-அcorpus/dev/*.tar.gzநஅஅஅஅ#அஅஅ-அcorpus/dev/*/*.{wav,txt,trn,metadata}நஅஅஅஅ#அஅஅ-அcorpus/test/*.tar.gzநஅஅஅஅ#அஅஅ-அcorpus/test/*/*.{wav,txt,trn,metadata}நநஅஅஅஅ#அTranscriptsஅfileஅhasஅoneஅlineஅperஅWAVஅfile,அwhereஅeachஅlineஅconsistsஅofநஅஅஅஅ#அtheஅWAVஅfileஅnameஅwithoutஅextensionஅfollowedஅbyஅaஅsingleஅspaceஅfollowedநஅஅஅஅ#அbyஅtheஅtranscript.நநஅஅஅஅ#அSinceஅtheஅtranscriptsஅthemselvesஅcanஅcontainஅspaces,அweஅsplitஅonஅspaceஅbutநஅஅஅஅ#அonlyஅonce,அthenஅbuildஅaஅmappingஅfromஅfileஅnameஅtoஅtranscriptநஅஅஅஅtranscripts_pathஅ=அos.path.join(நஅஅஅஅஅஅஅஅmain_folder,அ"transcript",அ"aidatatang_000_zh_transcript.txt"நஅஅஅஅ)நஅஅஅஅwithஅopen(transcripts_path)அasஅfin:நஅஅஅஅஅஅஅஅtranscriptsஅ=அdict((line.split("அ",அmaxsplit=0)அforஅlineஅinஅfin))நநஅஅஅஅdefஅload_set(glob_path):நஅஅஅஅஅஅஅஅset_filesஅ=அ[]நஅஅஅஅஅஅஅஅforஅwavஅinஅglob.glob(glob_path):நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அwavநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அos.path.getsize(wav)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript_keyஅ=அos.path.splitext(os.path.basename(wav))[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அtranscripts[transcript_key].strip("\n")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅset_files.append((wav_filename,அwav_filesize,அtranscript))நஅஅஅஅஅஅஅஅஅஅஅஅexceptஅKeyError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("Warning:அMissingஅtranscriptஅforஅWAVஅfileஅ{}.".format(wav))நஅஅஅஅஅஅஅஅreturnஅset_filesநநஅஅஅஅforஅsubsetஅinஅ("train",அ"dev",அ"test"):நஅஅஅஅஅஅஅஅprint("Loadingஅ{}அsetஅsamples...".format(subset))நஅஅஅஅஅஅஅஅsubset_filesஅ=அload_set(நஅஅஅஅஅஅஅஅஅஅஅஅos.path.join(main_folder,அ"corpus",அsubset,அ"*",அ"*.wav")நஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅdfஅ=அpandas.DataFrame(data=subset_files,அcolumns=COLUMN_NAMES)நநஅஅஅஅஅஅஅஅ#அTrimஅtrainஅsetஅtoஅunderஅ00sஅbyஅremovingஅtheஅlastஅcoupleஅhundredஅsamplesநஅஅஅஅஅஅஅஅifஅsubsetஅ==அ"train":நஅஅஅஅஅஅஅஅஅஅஅஅdurationsஅ=அ(df["wav_filesize"]அ-அ00)அ/அ00000அ/அ0நஅஅஅஅஅஅஅஅஅஅஅஅdfஅ=அdf[durationsஅ<=அ00.0]நஅஅஅஅஅஅஅஅஅஅஅஅprint("Trimmingஅ{}அsamplesஅ>அ00அseconds".format((durationsஅ>அ00.0).sum()))நநஅஅஅஅஅஅஅஅdest_csvஅ=அos.path.join(target_dir,அ"aidatatang_{}.csv".format(subset))நஅஅஅஅஅஅஅஅprint("Savingஅ{}அsetஅintoஅ{}...".format(subset,அdest_csv))நஅஅஅஅஅஅஅஅdf.to_csv(dest_csv,அindex=False)நநநdefஅmain():நஅஅஅஅ#அhttps://www.openslr.org/00/நஅஅஅஅparserஅ=அget_importers_parser(description="Importஅaidatatang_000zhஅcorpus")நஅஅஅஅparser.add_argument("tgz_file",அhelp="Pathஅtoஅaidatatang_000zh.tgz")நஅஅஅஅparser.add_argument(நஅஅஅஅஅஅஅஅ"--target_dir",நஅஅஅஅஅஅஅஅdefault="",நஅஅஅஅஅஅஅஅhelp="TargetஅfolderஅtoஅextractஅfilesஅintoஅandஅputஅtheஅresultingஅCSVs.அDefaultsஅtoஅsameஅfolderஅasஅtheஅmainஅarchive.",நஅஅஅஅ)நஅஅஅஅparamsஅ=அparser.parse_args()நநஅஅஅஅifஅnotஅparams.target_dir:நஅஅஅஅஅஅஅஅparams.target_dirஅ=அos.path.dirname(params.tgz_file)நநஅஅஅஅpreprocess_data(params.tgz_file,அparams.target_dir)நநநifஅ__name__அ==அ"__main__":நஅஅஅஅmain()நfromஅ__future__அimportஅprint_functionநநimportஅprogressbarநimportஅsysநநfromஅ.flagsஅimportஅFLAGSநநந#அLoggingஅfunctionsந#அ=================நநdefஅprefix_print(prefix,அmessage):நஅஅஅஅprint(prefixஅ+அ('\n'அ+அprefix).join(message.split('\n')))நநநdefஅlog_debug(message):நஅஅஅஅifஅFLAGS.log_levelஅ==அ0:நஅஅஅஅஅஅஅஅprefix_print('Dஅ',அmessage)நநநdefஅlog_info(message):நஅஅஅஅifஅFLAGS.log_levelஅ<=அ0:நஅஅஅஅஅஅஅஅprefix_print('Iஅ',அmessage)நநநdefஅlog_warn(message):நஅஅஅஅifஅFLAGS.log_levelஅ<=அ0:நஅஅஅஅஅஅஅஅprefix_print('Wஅ',அmessage)நநநdefஅlog_error(message):நஅஅஅஅifஅFLAGS.log_levelஅ<=அ0:நஅஅஅஅஅஅஅஅprefix_print('Eஅ',அmessage)நநநdefஅcreate_progressbar(*args,அ**kwargs):நஅஅஅஅ#அProgressஅbarsஅinஅstdoutஅbyஅdefaultநஅஅஅஅifஅ'fd'அnotஅinஅkwargs:நஅஅஅஅஅஅஅஅkwargs['fd']அ=அsys.stdoutநநஅஅஅஅifஅFLAGS.show_progressbar:நஅஅஅஅஅஅஅஅreturnஅprogressbar.ProgressBar(*args,அ**kwargs)நநஅஅஅஅreturnஅprogressbar.NullBar(*args,அ**kwargs)நநநdefஅlog_progress(message):நஅஅஅஅifஅnotஅFLAGS.show_progressbar:நஅஅஅஅஅஅஅஅlog_info(message)ந#அ-*-அcoding:அutf-0அ-*-நfromஅ__future__அimportஅabsolute_import,அdivision,அprint_functionநநfromஅcollectionsஅimportஅCounterநfromஅfunctoolsஅimportஅpartialநநimportஅnumpyஅasஅnpநimportஅtensorflowஅasஅtfநநfromஅtensorflow.python.opsஅimportஅgen_audio_opsஅasஅcontrib_audioநநfromஅ.configஅimportஅConfigநfromஅ.textஅimportஅtext_to_char_arrayநfromஅ.flagsஅimportஅFLAGSநfromஅ.augmentationsஅimportஅapply_sample_augmentations,அapply_graph_augmentationsநfromஅ.audioஅimportஅread_frames_from_file,அvad_split,அpcm_to_np,அDEFAULT_FORMATநfromஅ.sample_collectionsஅimportஅsamples_from_sourcesநfromஅ.helpersஅimportஅremember_exception,அMEGABYTEநநநdefஅaudio_to_features(audio,அsample_rate,அtranscript=None,அclock=0.0,அtrain_phase=False,அaugmentations=None,அsample_id=None):நஅஅஅஅifஅtrain_phase:நஅஅஅஅஅஅஅஅ#அWeஅneedஅtheஅlambdasஅtoஅmakeஅTensorFlowஅhappy.நஅஅஅஅஅஅஅஅ#அpylint:அdisable=unnecessary-lambdaநஅஅஅஅஅஅஅஅtf.cond(tf.math.not_equal(sample_rate,அFLAGS.audio_sample_rate),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambda:அtf.print('WARNING:அsampleஅrateஅofஅsample',அsample_id,அ'(',அsample_rate,அ')அ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'doesஅnotஅmatchஅFLAGS.audio_sample_rate.அThisஅcanஅleadஅtoஅincorrectஅresults.'),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambda:அtf.no_op(),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅname='matching_sample_rate')நநஅஅஅஅifஅtrain_phaseஅandஅaugmentations:நஅஅஅஅஅஅஅஅaudioஅ=அapply_graph_augmentations('signal',அaudio,அaugmentations,அtranscript=transcript,அclock=clock)நநஅஅஅஅspectrogramஅ=அcontrib_audio.audio_spectrogram(audio,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwindow_size=Config.audio_window_samples,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstride=Config.audio_step_samples,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmagnitude_squared=True)நநஅஅஅஅifஅtrain_phaseஅandஅaugmentations:நஅஅஅஅஅஅஅஅspectrogramஅ=அapply_graph_augmentations('spectrogram',அspectrogram,அaugmentations,அtranscript=transcript,அclock=clock)நநஅஅஅஅfeaturesஅ=அcontrib_audio.mfcc(spectrogram=spectrogram,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_rate=sample_rate,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdct_coefficient_count=Config.n_input,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅupper_frequency_limit=FLAGS.audio_sample_rateஅ/அ0)நஅஅஅஅfeaturesஅ=அtf.reshape(features,அ[-0,அConfig.n_input])நநஅஅஅஅifஅtrain_phaseஅandஅaugmentations:நஅஅஅஅஅஅஅஅfeaturesஅ=அapply_graph_augmentations('features',அfeatures,அaugmentations,அtranscript=transcript,அclock=clock)நநஅஅஅஅreturnஅfeatures,அtf.shape(input=features)[0]நநநdefஅaudiofile_to_features(wav_filename,அclock=0.0,அtrain_phase=False,அaugmentations=None):நஅஅஅஅsamplesஅ=அtf.io.read_file(wav_filename)நஅஅஅஅdecodedஅ=அcontrib_audio.decode_wav(samples,அdesired_channels=0)நஅஅஅஅreturnஅaudio_to_features(decoded.audio,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdecoded.sample_rate,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅclock=clock,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_phase=train_phase,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaugmentations=augmentations,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_id=wav_filename)நநநdefஅentry_to_features(sample_id,அaudio,அsample_rate,அtranscript,அclock,அtrain_phase=False,அaugmentations=None):நஅஅஅஅ#அhttps://bugs.python.org/issue00000நஅஅஅஅsparse_transcriptஅ=அtf.SparseTensor(*transcript)நஅஅஅஅfeatures,அfeatures_lenஅ=அaudio_to_features(audio,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_rate,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtranscript=sparse_transcript,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅclock=clock,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_phase=train_phase,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaugmentations=augmentations,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_id=sample_id)நஅஅஅஅreturnஅsample_id,அfeatures,அfeatures_len,அsparse_transcriptநநநdefஅto_sparse_tuple(sequence):நஅஅஅஅr"""Createsஅaஅsparseஅrepresententionஅofஅ``sequence``.நஅஅஅஅஅஅஅஅReturnsஅaஅtupleஅwithஅ(indices,அvalues,அshape)நஅஅஅஅ"""நஅஅஅஅindicesஅ=அnp.asarray(list(zip([0]*len(sequence),அrange(len(sequence)))),அdtype=np.int00)நஅஅஅஅshapeஅ=அnp.asarray([0,அlen(sequence)],அdtype=np.int00)நஅஅஅஅreturnஅindices,அsequence,அshapeநநநdefஅcreate_dataset(sources,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbatch_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅepochs=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaugmentations=None,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcache_path=None,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_phase=False,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreverse=False,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlimit=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexception_box=None,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprocess_ahead=None,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbuffering=0அ*அMEGABYTE,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsplit_dataset=False):நஅஅஅஅepoch_counterஅ=அCounter()அஅ#அsurvivesஅrestartsஅofஅtheஅdatasetஅandஅitsஅgeneratorநநஅஅஅஅdefஅgenerate_values():நஅஅஅஅஅஅஅஅepochஅ=அepoch_counter['epoch']நஅஅஅஅஅஅஅஅifஅtrain_phase:நஅஅஅஅஅஅஅஅஅஅஅஅepoch_counter['epoch']அ+=அ0நஅஅஅஅஅஅஅஅsamplesஅ=அsamples_from_sources(sources,அbuffering=buffering,அlabeled=True,அreverse=reverse)நஅஅஅஅஅஅஅஅnum_samplesஅ=அlen(samples)நஅஅஅஅஅஅஅஅifஅlimitஅ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅnum_samplesஅ=அmin(limit,அnum_samples)நஅஅஅஅஅஅஅஅsamplesஅ=அapply_sample_augmentations(samples,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaugmentations,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbuffering=buffering,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprocess_ahead=0அ*அbatch_sizeஅifஅprocess_aheadஅisஅNoneஅelseஅprocess_ahead,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅclock=epochஅ/அepochs,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfinal_clock=(epochஅ+அ0)அ/அepochs)நஅஅஅஅஅஅஅஅforஅsample_index,அsampleஅinஅenumerate(samples):நஅஅஅஅஅஅஅஅஅஅஅஅifஅsample_indexஅ>=அnum_samples:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbreakநஅஅஅஅஅஅஅஅஅஅஅஅclockஅ=அ(epochஅ*அnum_samplesஅ+அsample_index)அ/அ(epochsஅ*அnum_samples)அifஅtrain_phaseஅandஅepochsஅ>அ0அelseஅ0.0நஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அtext_to_char_array(sample.transcript,அConfig.alphabet,அcontext=sample.sample_id)நஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அto_sparse_tuple(transcript)நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅsample.sample_id,அsample.audio,அsample.audio_format.rate,அtranscript,அclockநநஅஅஅஅ#அBatchingஅaஅdatasetஅofஅ0DஅSparseTensorsஅcreatesஅ0Dஅbatches,அwhichஅfailநஅஅஅஅ#அwhenஅpassedஅtoஅtf.nn.ctc_loss,அsoஅweஅreshapeஅthemஅtoஅremoveஅtheஅextraநஅஅஅஅ#அdimensionஅhere.நஅஅஅஅdefஅsparse_reshape(sparse):நஅஅஅஅஅஅஅஅshapeஅ=அsparse.dense_shapeநஅஅஅஅஅஅஅஅreturnஅtf.sparse.reshape(sparse,அ[shape[0],அshape[0]])நநஅஅஅஅdefஅbatch_fn(sample_ids,அfeatures,அfeatures_len,அtranscripts):நஅஅஅஅஅஅஅஅfeaturesஅ=அtf.data.Dataset.zip((features,அfeatures_len))நஅஅஅஅஅஅஅஅfeaturesஅ=அfeatures.padded_batch(batch_size,அpadded_shapes=([None,அConfig.n_input],அ[]))நஅஅஅஅஅஅஅஅtranscriptsஅ=அtranscripts.batch(batch_size).map(sparse_reshape)நஅஅஅஅஅஅஅஅsample_idsஅ=அsample_ids.batch(batch_size)நஅஅஅஅஅஅஅஅreturnஅtf.data.Dataset.zip((sample_ids,அfeatures,அtranscripts))நநஅஅஅஅprocess_fnஅ=அpartial(entry_to_features,அtrain_phase=train_phase,அaugmentations=augmentations)நநஅஅஅஅdatasetஅ=அtf.data.Dataset.from_generator(remember_exception(generate_values,அexception_box),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoutput_types=(tf.string,அtf.float00,அtf.int00,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(tf.int00,அtf.int00,அtf.int00),அtf.float00))நஅஅஅஅifஅsplit_dataset:நஅஅஅஅஅஅஅஅ#அUsingஅhorovodஅIterator.get_next()அisஅnotஅawareஅofஅdifferentஅdevices.நஅஅஅஅஅஅஅஅ#அA.shard(n,அi)அwillஅcontainஅallஅelementsஅofஅAஅwhoseஅindexஅmodஅnஅ=அi.நஅஅஅஅஅஅஅஅimportஅhorovod.tensorflowஅasஅhvdநஅஅஅஅஅஅஅஅdatasetஅ=அdataset.shard(hvd.size(),அhvd.rank())நஅஅஅஅdatasetஅ=அdataset.map(process_fn,அnum_parallel_calls=tf.data.experimental.AUTOTUNE)நஅஅஅஅifஅcache_path:நஅஅஅஅஅஅஅஅdatasetஅ=அdataset.cache(cache_path)நஅஅஅஅdatasetஅ=அ(dataset.window(batch_size,அdrop_remainder=train_phase).flat_map(batch_fn))நஅஅஅஅifஅsplit_dataset:நஅஅஅஅஅஅஅஅ#TODOஅisஅthereஅaஅwayஅtoஅgetஅaஅproperஅvalue?நஅஅஅஅஅஅஅஅdatasetஅ=அdataset.prefetch(0)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅdatasetஅ=அdataset.prefetch(Config.num_devices)நஅஅஅஅreturnஅdatasetநநdefஅsplit_audio_file(audio_path,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudio_format=DEFAULT_FORMAT,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbatch_size=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaggressiveness=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoutlier_duration_ms=00000,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoutlier_batch_size=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexception_box=None):நஅஅஅஅdefஅgenerate_values():நஅஅஅஅஅஅஅஅframesஅ=அread_frames_from_file(audio_path)நஅஅஅஅஅஅஅஅsegmentsஅ=அvad_split(frames,அaggressiveness=aggressiveness)நஅஅஅஅஅஅஅஅforஅsegmentஅinஅsegments:நஅஅஅஅஅஅஅஅஅஅஅஅsegment_buffer,அtime_start,அtime_endஅ=அsegmentநஅஅஅஅஅஅஅஅஅஅஅஅsamplesஅ=அpcm_to_np(segment_buffer,அaudio_format)நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅtime_start,அtime_end,அsamplesநநஅஅஅஅdefஅto_mfccs(time_start,அtime_end,அsamples):நஅஅஅஅஅஅஅஅfeatures,அfeatures_lenஅ=அaudio_to_features(samples,அaudio_format.rate)நஅஅஅஅஅஅஅஅreturnஅtime_start,அtime_end,அfeatures,அfeatures_lenநநஅஅஅஅdefஅcreate_batch_set(bs,அcriteria):நஅஅஅஅஅஅஅஅreturnஅ(tf.data.Datasetநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.from_generator(remember_exception(generate_values,அexception_box),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoutput_types=(tf.int00,அtf.int00,அtf.float00))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.map(to_mfccs,அnum_parallel_calls=tf.data.experimental.AUTOTUNE)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.filter(criteria)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.padded_batch(bs,அpadded_shapes=([],அ[],அ[None,அConfig.n_input],அ[])))நநஅஅஅஅndsஅ=அcreate_batch_set(batch_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambdaஅstart,அend,அf,அfl:அendஅ-அstartஅ<=அint(outlier_duration_ms))நஅஅஅஅodsஅ=அcreate_batch_set(outlier_batch_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambdaஅstart,அend,அf,அfl:அendஅ-அstartஅ>அint(outlier_duration_ms))நஅஅஅஅdatasetஅ=அnds.concatenate(ods)நஅஅஅஅdatasetஅ=அdataset.prefetch(Config.num_devices)நஅஅஅஅreturnஅdatasetநfromஅ__future__அimportஅabsolute_import,அdivision,அprint_functionநநimportஅosநimportஅsysநimportஅtensorflow.compat.v0அasஅtfv0நநfromஅattrdictஅimportஅAttrDictநfromஅxdgஅimportஅBaseDirectoryஅasஅxdgநfromஅds_ctcdecoderஅimportஅAlphabet,அUTF0Alphabetநநfromஅ.flagsஅimportஅFLAGSநfromஅ.gpuஅimportஅget_available_gpusநfromஅ.loggingஅimportஅlog_error,அlog_warnநfromஅ.helpersஅimportஅparse_file_sizeநfromஅ.augmentationsஅimportஅparse_augmentations,அNormalizeSampleRateநfromஅ.ioஅimportஅpath_exists_remoteநநclassஅConfigSingleton:நஅஅஅஅ_configஅ=அNoneநநஅஅஅஅdefஅ__getattr__(self,அname):நஅஅஅஅஅஅஅஅifஅnotஅConfigSingleton._config:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError("Globalஅconfigurationஅnotஅyetஅinitialized.")நஅஅஅஅஅஅஅஅifஅnotஅhasattr(ConfigSingleton._config,அname):நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError("Configurationஅoptionஅ{}அnotஅfoundஅinஅconfig.".format(name))நஅஅஅஅஅஅஅஅreturnஅConfigSingleton._config[name]நநநConfigஅ=அConfigSingleton()அ#அpylint:அdisable=invalid-nameநநdefஅinitialize_globals():நஅஅஅஅcஅ=அAttrDict()நநஅஅஅஅ#அAugmentationsநஅஅஅஅc.augmentationsஅ=அparse_augmentations(FLAGS.augment)நஅஅஅஅifஅc.augmentationsஅandஅFLAGS.feature_cacheஅandஅFLAGS.cache_for_epochsஅ==அ0:நஅஅஅஅஅஅஅஅlog_warn('Dueஅtoஅcurrentஅfeature-cacheஅsettingsஅtheஅexactஅsameஅsampleஅaugmentationsஅofஅtheஅfirstஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'epochஅwillஅbeஅrepeatedஅonஅallஅfollowingஅepochs.அThisஅcouldஅleadஅtoஅunintendedஅover-fitting.அ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'Youஅcouldஅuseஅ--cache_for_epochsஅ<n_epochs>அtoஅinvalidateஅtheஅcacheஅafterஅaஅgivenஅnumberஅofஅepochs.')நநஅஅஅஅifஅFLAGS.normalize_sample_rate:நஅஅஅஅஅஅஅஅc.augmentationsஅ=அ[NormalizeSampleRate(FLAGS.audio_sample_rate)]அ+அc['augmentations']நநஅஅஅஅ#அCachingநஅஅஅஅifஅFLAGS.cache_for_epochsஅ==அ0:நஅஅஅஅஅஅஅஅlog_warn('--cache_for_epochsஅ==அ0அisஅ(re-)creatingஅtheஅfeatureஅcacheஅonஅeveryஅepochஅbutஅwillஅneverஅuseஅit.')நநஅஅஅஅ#அRead-bufferநஅஅஅஅFLAGS.read_bufferஅ=அparse_file_size(FLAGS.read_buffer)நநஅஅஅஅ#அSetஅdefaultஅdropoutஅratesநஅஅஅஅifஅFLAGS.dropout_rate0அ<அ0:நஅஅஅஅஅஅஅஅFLAGS.dropout_rate0அ=அFLAGS.dropout_rateநஅஅஅஅifஅFLAGS.dropout_rate0அ<அ0:நஅஅஅஅஅஅஅஅFLAGS.dropout_rate0அ=அFLAGS.dropout_rateநஅஅஅஅifஅFLAGS.dropout_rate0அ<அ0:நஅஅஅஅஅஅஅஅFLAGS.dropout_rate0அ=அFLAGS.dropout_rateநநஅஅஅஅ#அSetஅdefaultஅcheckpointஅdirநஅஅஅஅifஅnotஅFLAGS.checkpoint_dir:நஅஅஅஅஅஅஅஅFLAGS.checkpoint_dirஅ=அxdg.save_data_path(os.path.join('deepspeech',அ'checkpoints'))நநஅஅஅஅifஅFLAGS.load_trainஅnotஅinஅ['last',அ'best',அ'init',அ'auto']:நஅஅஅஅஅஅஅஅFLAGS.load_trainஅ=அ'auto'நநஅஅஅஅifஅFLAGS.load_evaluateஅnotஅinஅ['last',அ'best',அ'auto']:நஅஅஅஅஅஅஅஅFLAGS.load_evaluateஅ=அ'auto'நநஅஅஅஅ#அSetஅdefaultஅsummaryஅdirநஅஅஅஅifஅnotஅFLAGS.summary_dir:நஅஅஅஅஅஅஅஅFLAGS.summary_dirஅ=அxdg.save_data_path(os.path.join('deepspeech',அ'summaries'))நநஅஅஅஅ#அStandardஅsessionஅconfigurationஅthat'llஅbeஅusedஅforஅallஅnewஅsessions.நஅஅஅஅc.session_configஅ=அtfv0.ConfigProto(allow_soft_placement=True,அlog_device_placement=FLAGS.log_placement,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinter_op_parallelism_threads=FLAGS.inter_op_parallelism_threads,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅintra_op_parallelism_threads=FLAGS.intra_op_parallelism_threads,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅgpu_options=tfv0.GPUOptions(allow_growth=FLAGS.use_allow_growth))நநஅஅஅஅ#அCPUஅdeviceநஅஅஅஅc.cpu_deviceஅ=அ'/cpu:0'நநஅஅஅஅifஅFLAGS.horovod:நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅimportஅhorovod.tensorflowஅasஅhvdநஅஅஅஅஅஅஅஅexceptஅImportErrorஅasஅe:நஅஅஅஅஅஅஅஅஅஅஅஅprint(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"ErrorஅimportingஅHorovod.அDidஅyouஅinstalledஅDeepSpeechஅwithஅ-DNOHOROVOD?அ"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"Ifஅyouஅdoஅnotஅwantஅtoஅuseஅhorovod,அuseஅ'fromஅdeepspeech_trainingஅimportஅtrain'")நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅeநநஅஅஅஅஅஅஅஅhvd.init()நநஅஅஅஅஅஅஅஅ#அPinஅGPUஅtoஅbeஅusedஅtoஅprocessஅlocalஅrankஅ(oneஅGPUஅperஅprocess)நஅஅஅஅஅஅஅஅc.session_config.gpu_options.visible_device_listஅ=அstr(hvd.local_rank())நஅஅஅஅஅஅஅஅc.num_devicesஅ=அhvd.size()நஅஅஅஅஅஅஅஅc.is_master_processஅ=அTrueஅifஅhvd.rank()அ==அ0அelseஅFalseநஅஅஅஅelse:நஅஅஅஅ#அ#அAvailableஅGPUஅdevicesநஅஅஅஅஅஅஅஅc.available_devicesஅ=அget_available_gpus(c.session_config)நநஅஅஅஅஅஅஅஅ#அIfஅthereஅisஅnoஅGPUஅavailable,அweஅfallஅbackஅtoஅCPUஅbasedஅoperationநஅஅஅஅஅஅஅஅifஅnotஅc.available_devices:நஅஅஅஅஅஅஅஅஅஅஅஅc.available_devicesஅ=அ[c.cpu_device]நநஅஅஅஅஅஅஅஅc.num_devicesஅ=அlen(c.available_devices)நநஅஅஅஅஅஅஅஅ#அIfஅthereஅareஅnoஅhorovodஅprocessesஅtheஅonlyஅoneஅshouldஅhandledஅlikeஅhorovodஅmasterநஅஅஅஅஅஅஅஅc.is_master_processஅ=அTrueநநஅஅஅஅifஅFLAGS.bytes_output_mode:நஅஅஅஅஅஅஅஅc.alphabetஅ=அUTF0Alphabet()நஅஅஅஅelse:நஅஅஅஅஅஅஅஅc.alphabetஅ=அAlphabet(os.path.abspath(FLAGS.alphabet_config_path))நநஅஅஅஅ#அGeometricஅConstantsநஅஅஅஅ#அ===================நநஅஅஅஅ#அForஅanஅexplanationஅofஅtheஅmeaningஅofஅtheஅgeometricஅconstants,அpleaseஅreferஅtoநஅஅஅஅ#அdoc/Geometry.mdநநஅஅஅஅ#அNumberஅofஅMFCCஅfeaturesநஅஅஅஅc.n_inputஅ=அ00அ#அTODO:அDetermineஅthisஅprogrammaticallyஅfromஅtheஅsampleஅrateநநஅஅஅஅ#அTheஅnumberஅofஅframesஅinஅtheஅcontextநஅஅஅஅc.n_contextஅ=அ0அ#அTODO:அDetermineஅtheஅoptimalஅvalueஅusingஅaஅvalidationஅdataஅsetநநஅஅஅஅ#அNumberஅofஅunitsஅinஅhiddenஅlayersநஅஅஅஅc.n_hiddenஅ=அFLAGS.n_hiddenநநஅஅஅஅc.n_hidden_0அ=அc.n_hiddenநநஅஅஅஅc.n_hidden_0அ=அc.n_hiddenநநஅஅஅஅc.n_hidden_0அ=அc.n_hiddenநநஅஅஅஅ#அLSTMஅcellஅstateஅdimensionநஅஅஅஅc.n_cell_dimஅ=அc.n_hiddenநநஅஅஅஅ#அTheஅnumberஅofஅunitsஅinஅtheஅthirdஅlayer,அwhichஅfeedsஅinஅtoஅtheஅLSTMநஅஅஅஅc.n_hidden_0அ=அc.n_cell_dimநநஅஅஅஅ#அUnitsஅinஅtheஅsixthஅlayerஅ=அnumberஅofஅcharactersஅinஅtheஅtargetஅlanguageஅplusஅoneநஅஅஅஅc.n_hidden_0அ=அc.alphabet.GetSize()அ+அ0அ#அ+0அforஅCTCஅblankஅlabelநநஅஅஅஅ#அSizeஅofஅaudioஅwindowஅinஅsamplesநஅஅஅஅifஅ(FLAGS.feature_win_lenஅ*அFLAGS.audio_sample_rate)அ%அ0000அ!=அ0:நஅஅஅஅஅஅஅஅlog_error('--feature_win_lenஅvalueஅ({})அinஅmillisecondsஅ({})அmultipliedஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'byஅ--audio_sample_rateஅvalueஅ({})அmustஅbeஅanஅintegerஅvalue.அAdjustஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'yourஅ--feature_win_lenஅvalueஅorஅresampleஅyourஅaudioஅaccordingly.'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ''.format(FLAGS.feature_win_len,அFLAGS.feature_win_lenஅ/அ0000,அFLAGS.audio_sample_rate))நஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅc.audio_window_samplesஅ=அFLAGS.audio_sample_rateஅ*அ(FLAGS.feature_win_lenஅ/அ0000)நநஅஅஅஅ#அStrideஅforஅfeatureஅcomputationsஅinஅsamplesநஅஅஅஅifஅ(FLAGS.feature_win_stepஅ*அFLAGS.audio_sample_rate)அ%அ0000அ!=அ0:நஅஅஅஅஅஅஅஅlog_error('--feature_win_stepஅvalueஅ({})அinஅmillisecondsஅ({})அmultipliedஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'byஅ--audio_sample_rateஅvalueஅ({})அmustஅbeஅanஅintegerஅvalue.அAdjustஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'yourஅ--feature_win_stepஅvalueஅorஅresampleஅyourஅaudioஅaccordingly.'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ''.format(FLAGS.feature_win_step,அFLAGS.feature_win_stepஅ/அ0000,அFLAGS.audio_sample_rate))நஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅc.audio_step_samplesஅ=அFLAGS.audio_sample_rateஅ*அ(FLAGS.feature_win_stepஅ/அ0000)நநஅஅஅஅifஅFLAGS.one_shot_infer:நஅஅஅஅஅஅஅஅifஅnotஅpath_exists_remote(FLAGS.one_shot_infer):நஅஅஅஅஅஅஅஅஅஅஅஅlog_error('Pathஅspecifiedஅinஅ--one_shot_inferஅisஅnotஅaஅvalidஅfile.')நஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅifஅFLAGS.train_cudnnஅandஅFLAGS.load_cudnn:நஅஅஅஅஅஅஅஅlog_error('Tryingஅtoஅuseஅ--train_cudnn,அbutஅ--load_cudnnஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'wasஅalsoஅspecified.அTheஅ--load_cudnnஅflagஅisஅonlyஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'neededஅwhenஅconvertingஅaஅCuDNNஅRNNஅcheckpointஅtoஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'aஅCPU-capableஅgraph.அIfஅyourஅsystemஅisஅcapableஅofஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'usingஅCuDNNஅRNN,அyouஅcanஅjustஅspecifyஅtheஅCuDNNஅRNNஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'checkpointஅnormallyஅwithஅ--save_checkpoint_dir.')நஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅ#அIfஅseparateஅsaveஅandஅloadஅflagsஅwereஅnotஅspecified,அdefaultஅtoஅloadஅandஅsaveநஅஅஅஅ#அfromஅtheஅsameஅdir.நஅஅஅஅifஅnotஅFLAGS.save_checkpoint_dir:நஅஅஅஅஅஅஅஅFLAGS.save_checkpoint_dirஅ=அFLAGS.checkpoint_dirநநஅஅஅஅifஅnotஅFLAGS.load_checkpoint_dir:நஅஅஅஅஅஅஅஅFLAGS.load_checkpoint_dirஅ=அFLAGS.checkpoint_dirநநஅஅஅஅConfigSingleton._configஅ=அcஅ#அpylint:அdisable=protected-accessநimportஅrequestsநimportஅprogressbarநநfromஅosஅimportஅpath,அmakedirsநfromஅ.ioஅimportஅopen_remote,அpath_exists_remote,அis_remote_pathநநSIMPLE_BARஅ=அ['Progressஅ',அprogressbar.Bar(),அ'அ',அprogressbar.Percentage(),அ'அcompleted']நநdefஅmaybe_download(archive_name,அtarget_dir,அarchive_url):நஅஅஅஅ#அIfஅarchiveஅfileஅdoesஅnotஅexist,அdownloadஅit...நஅஅஅஅarchive_pathஅ=அpath.join(target_dir,அarchive_name)நநஅஅஅஅifஅnotஅis_remote_path(target_dir)அandஅnotஅpath.exists(target_dir):நஅஅஅஅஅஅஅஅprint('Noஅpathஅ"%s"அ-அcreatingஅ...'அ%அtarget_dir)நஅஅஅஅஅஅஅஅmakedirs(target_dir)நநஅஅஅஅifஅnotஅpath_exists_remote(archive_path):நஅஅஅஅஅஅஅஅprint('Noஅarchiveஅ"%s"அ-அdownloading...'அ%அarchive_path)நஅஅஅஅஅஅஅஅreqஅ=அrequests.get(archive_url,அstream=True)நஅஅஅஅஅஅஅஅtotal_sizeஅ=அint(req.headers.get('content-length',அ0))நஅஅஅஅஅஅஅஅdoneஅ=அ0நஅஅஅஅஅஅஅஅwithஅopen_remote(archive_path,அ'wb')அasஅf:நஅஅஅஅஅஅஅஅஅஅஅஅbarஅ=அprogressbar.ProgressBar(max_value=total_sizeஅifஅtotal_sizeஅ>அ0அelseஅprogressbar.UnknownLength,அwidgets=SIMPLE_BAR)நநஅஅஅஅஅஅஅஅஅஅஅஅforஅdataஅinஅreq.iter_content(0000*0000):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdoneஅ+=அlen(data)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅf.write(data)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbar.update(done)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint('Foundஅarchiveஅ"%s"அ-அnotஅdownloading.'அ%அarchive_path)நஅஅஅஅreturnஅarchive_pathந#அ-*-அcoding:அutf-0அ-*-நimportஅosநimportஅioநimportஅcsvநimportஅjsonநimportஅtarfileநநfromஅpathlibஅimportஅPathநfromஅfunctoolsஅimportஅpartialநநfromஅ.helpersஅimportஅKILOBYTE,அMEGABYTE,அGIGABYTE,அInterleaved,அLenMapநfromஅ.audioஅimportஅ(நஅஅஅஅSample,நஅஅஅஅAUDIO_TYPE_PCM,நஅஅஅஅAUDIO_TYPE_OPUS,நஅஅஅஅSERIALIZABLE_AUDIO_TYPES,நஅஅஅஅget_loadable_audio_type_from_extension,நஅஅஅஅwrite_wavந)நfromஅ.ioஅimportஅopen_remote,அis_remote_pathநநBIG_ENDIANஅ=அ'big'நINT_SIZEஅ=அ0நBIGINT_SIZEஅ=அ0அ*அINT_SIZEநMAGICஅ=அb'SAMPLEDB'நநBUFFER_SIZEஅ=அ0அ*அMEGABYTEநREVERSE_BUFFER_SIZEஅ=அ00அ*அKILOBYTEநCACHE_SIZEஅ=அ0அ*அGIGABYTEநநSCHEMA_KEYஅ=அ'schema'நCONTENT_KEYஅ=அ'content'நMIME_TYPE_KEYஅ=அ'mime-type'நMIME_TYPE_TEXTஅ=அ'text/plain'நCONTENT_TYPE_SPEECHஅ=அ'speech'நCONTENT_TYPE_TRANSCRIPTஅ=அ'transcript'நநநclassஅLabeledSample(Sample):நஅஅஅஅ"""In-memoryஅlabeledஅaudioஅsampleஅrepresentingஅanஅutterance.நஅஅஅஅDerivedஅfromஅutil.audio.Sampleஅandஅusedஅbyஅsampleஅcollectionஅreadersஅandஅwriters."""நஅஅஅஅdefஅ__init__(self,அaudio_type,அraw_data,அtranscript,அaudio_format=None,அsample_id=None):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅaudio_typeஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅSeeஅutil.audio.Sample.__init__அ.நஅஅஅஅஅஅஅஅraw_dataஅ:அbinaryநஅஅஅஅஅஅஅஅஅஅஅஅSeeஅutil.audio.Sample.__init__அ.நஅஅஅஅஅஅஅஅtranscriptஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅTranscriptஅofஅtheஅsample'sஅutteranceநஅஅஅஅஅஅஅஅaudio_formatஅ:அtupleநஅஅஅஅஅஅஅஅஅஅஅஅSeeஅutil.audio.Sample.__init__அ.நஅஅஅஅஅஅஅஅsample_idஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅTrackingஅIDஅ-அshouldஅindicateஅsample'sஅoriginஅasஅpreciselyஅasஅpossible.நஅஅஅஅஅஅஅஅஅஅஅஅItஅisஅtypicallyஅassignedஅbyஅcollectionஅreaders.நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅsuper().__init__(audio_type,அraw_data,அaudio_format=audio_format,அsample_id=sample_id)நஅஅஅஅஅஅஅஅself.transcriptஅ=அtranscriptநநநclassஅPackedSample:நஅஅஅஅ"""நஅஅஅஅAஅwrapperஅthatஅweஅcanஅcarryஅaroundஅinஅanஅiteratorஅandஅpassஅtoஅaஅchildஅprocessஅinஅorderஅtoநஅஅஅஅhaveஅtheஅchildஅprocessஅdoஅtheஅloading/unpackingஅofஅtheஅsample,அallowingஅforஅparallelஅfileநஅஅஅஅI/O.நஅஅஅஅ"""நஅஅஅஅdefஅ__init__(self,அfilename,அaudio_type,அlabel):நஅஅஅஅஅஅஅஅself.filenameஅ=அfilenameநஅஅஅஅஅஅஅஅself.audio_typeஅ=அaudio_typeநஅஅஅஅஅஅஅஅself.labelஅ=அlabelநநஅஅஅஅdefஅunpack(self):நஅஅஅஅஅஅஅஅwithஅopen_remote(self.filename,அ'rb')அasஅaudio_file:நஅஅஅஅஅஅஅஅஅஅஅஅdataஅ=அaudio_file.read()நஅஅஅஅஅஅஅஅifஅself.labelஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅsஅ=அSample(self.audio_type,அdata,அsample_id=self.filename)நஅஅஅஅஅஅஅஅsஅ=அLabeledSample(self.audio_type,அdata,அself.label,அsample_id=self.filename)நஅஅஅஅஅஅஅஅreturnஅsநநநdefஅunpack_maybe(sample):நஅஅஅஅ"""நஅஅஅஅLoadsஅtheஅsuppliedஅsampleஅfromஅdiskஅ(orஅtheஅnetwork)அifஅtheஅaudioஅisn'tஅloadedஅinஅtoஅmemoryஅalready.நஅஅஅஅ"""நஅஅஅஅifஅhasattr(sample,அ'unpack'):நஅஅஅஅஅஅஅஅrealized_sampleஅ=அsample.unpack()நஅஅஅஅelse:நஅஅஅஅஅஅஅஅrealized_sampleஅ=அsampleநஅஅஅஅreturnஅrealized_sampleநநநdefஅload_sample(filename,அlabel=None):நஅஅஅஅ"""நஅஅஅஅLoadsஅaudio-fileஅasஅaஅ(labeledஅorஅunlabeled)அsampleநநஅஅஅஅParametersநஅஅஅஅ----------நஅஅஅஅfilenameஅ:அstrநஅஅஅஅஅஅஅஅFilenameஅofஅtheஅaudio-fileஅtoஅloadஅasஅsampleநஅஅஅஅlabelஅ:அstrநஅஅஅஅஅஅஅஅLabelஅ(transcript)அofஅtheஅsample.நஅஅஅஅஅஅஅஅIfஅNone:அreturnedஅresult.unpack()அwillஅreturnஅutil.audio.SampleஅinstanceநஅஅஅஅஅஅஅஅOtherwise:அreturnedஅresult.unpack()அஅutil.sample_collections.LabeledSampleஅinstanceநநஅஅஅஅReturnsநஅஅஅஅ-------நஅஅஅஅutil.sample_collections.PackedSample,அaஅwrapperஅobject,அonஅwhichஅcallingஅunpack()அwillஅreturnநஅஅஅஅஅஅஅஅutil.audio.SampleஅinstanceஅifஅlabelஅisஅNone,அelseஅutil.sample_collections.LabeledSampleஅinstanceநஅஅஅஅ"""நஅஅஅஅextஅ=அos.path.splitext(filename)[0].lower()நஅஅஅஅaudio_typeஅ=அget_loadable_audio_type_from_extension(ext)நஅஅஅஅifஅaudio_typeஅisஅNone:நஅஅஅஅஅஅஅஅraiseஅValueError('Unknownஅaudioஅtypeஅextensionஅ"{}"'.format(ext))நஅஅஅஅreturnஅPackedSample(filename,அaudio_type,அlabel)நநநclassஅDirectSDBWriter:நஅஅஅஅ"""SampleஅcollectionஅwriterஅforஅcreatingஅaஅSampleஅDBஅ(SDB)அfile"""நஅஅஅஅdefஅ__init__(self,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsdb_filename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbuffering=BUFFER_SIZE,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudio_type=AUDIO_TYPE_OPUS,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbitrate=None,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅid_prefix=None,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabeled=True):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅsdb_filenameஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅPathஅtoஅtheஅSDBஅfileஅtoஅwriteநஅஅஅஅஅஅஅஅbufferingஅ:அintநஅஅஅஅஅஅஅஅஅஅஅஅWrite-bufferஅsizeஅtoஅuseஅwhileஅwritingஅtheஅSDBஅfileநஅஅஅஅஅஅஅஅaudio_typeஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅSeeஅutil.audio.Sample.__init__அ.நஅஅஅஅஅஅஅஅbitrateஅ:அintநஅஅஅஅஅஅஅஅஅஅஅஅBitrateஅforஅsample-compressionஅinஅcaseஅofஅlossyஅaudio_typeஅ(e.g.அAUDIO_TYPE_OPUS)நஅஅஅஅஅஅஅஅid_prefixஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅPrefixஅforஅIDsஅofஅwrittenஅsamplesஅ-அdefaultsஅtoஅsdb_filenameநஅஅஅஅஅஅஅஅlabeledஅ:அboolஅorஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅIfஅTrue:அWritesஅlabeledஅsamplesஅ(util.sample_collections.LabeledSample)அonly.நஅஅஅஅஅஅஅஅஅஅஅஅIfஅFalse:அIgnoresஅtranscriptsஅ(ifஅavailable)அandஅwritesஅ(unlabeled)அutil.audio.Sampleஅinstances.நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅself.sdb_filenameஅ=அsdb_filenameநஅஅஅஅஅஅஅஅself.id_prefixஅ=அsdb_filenameஅifஅid_prefixஅisஅNoneஅelseஅid_prefixநஅஅஅஅஅஅஅஅself.labeledஅ=அlabeledநஅஅஅஅஅஅஅஅifஅaudio_typeஅnotஅinஅSERIALIZABLE_AUDIO_TYPES:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Audioஅtypeஅ"{}"அnotஅsupported'.format(audio_type))நஅஅஅஅஅஅஅஅself.audio_typeஅ=அaudio_typeநஅஅஅஅஅஅஅஅself.bitrateஅ=அbitrateநஅஅஅஅஅஅஅஅself.sdb_fileஅ=அopen_remote(sdb_filename,அ'wb',அbuffering=buffering)நஅஅஅஅஅஅஅஅself.offsetsஅ=அ[]நஅஅஅஅஅஅஅஅself.num_samplesஅ=அ0நநஅஅஅஅஅஅஅஅself.sdb_file.write(MAGIC)நநஅஅஅஅஅஅஅஅschema_entriesஅ=அ[{CONTENT_KEY:அCONTENT_TYPE_SPEECH,அMIME_TYPE_KEY:அaudio_type}]நஅஅஅஅஅஅஅஅifஅself.labeled:நஅஅஅஅஅஅஅஅஅஅஅஅschema_entries.append({CONTENT_KEY:அCONTENT_TYPE_TRANSCRIPT,அMIME_TYPE_KEY:அMIME_TYPE_TEXT})நஅஅஅஅஅஅஅஅmeta_dataஅ=அ{SCHEMA_KEY:அschema_entries}நஅஅஅஅஅஅஅஅmeta_dataஅ=அjson.dumps(meta_data).encode()நஅஅஅஅஅஅஅஅself.write_big_int(len(meta_data))நஅஅஅஅஅஅஅஅself.sdb_file.write(meta_data)நநஅஅஅஅஅஅஅஅself.offset_samplesஅ=அself.sdb_file.tell()நஅஅஅஅஅஅஅஅself.sdb_file.seek(0அ*அBIGINT_SIZE,அ0)நநஅஅஅஅdefஅwrite_int(self,அn):நஅஅஅஅஅஅஅஅreturnஅself.sdb_file.write(n.to_bytes(INT_SIZE,அBIG_ENDIAN))நநஅஅஅஅdefஅwrite_big_int(self,அn):நஅஅஅஅஅஅஅஅreturnஅself.sdb_file.write(n.to_bytes(BIGINT_SIZE,அBIG_ENDIAN))நநஅஅஅஅdefஅ__enter__(self):நஅஅஅஅஅஅஅஅreturnஅselfநநஅஅஅஅdefஅadd(self,அsample):நஅஅஅஅஅஅஅஅdefஅto_bytes(n):நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅn.to_bytes(INT_SIZE,அBIG_ENDIAN)நஅஅஅஅஅஅஅஅsample.change_audio_type(self.audio_type,அbitrate=self.bitrate)நஅஅஅஅஅஅஅஅopusஅ=அsample.audio.getbuffer()நஅஅஅஅஅஅஅஅopus_lenஅ=அto_bytes(len(opus))நஅஅஅஅஅஅஅஅifஅself.labeled:நஅஅஅஅஅஅஅஅஅஅஅஅtranscriptஅ=அsample.transcript.encode()நஅஅஅஅஅஅஅஅஅஅஅஅtranscript_lenஅ=அto_bytes(len(transcript))நஅஅஅஅஅஅஅஅஅஅஅஅentry_lenஅ=அto_bytes(len(opus_len)அ+அlen(opus)அ+அlen(transcript_len)அ+அlen(transcript))நஅஅஅஅஅஅஅஅஅஅஅஅbufferஅ=அb''.join([entry_len,அopus_len,அopus,அtranscript_len,அtranscript])நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅentry_lenஅ=அto_bytes(len(opus_len)அ+அlen(opus))நஅஅஅஅஅஅஅஅஅஅஅஅbufferஅ=அb''.join([entry_len,அopus_len,அopus])நஅஅஅஅஅஅஅஅself.offsets.append(self.sdb_file.tell())நஅஅஅஅஅஅஅஅself.sdb_file.write(buffer)நஅஅஅஅஅஅஅஅsample.sample_idஅ=அ'{}:{}'.format(self.id_prefix,அself.num_samples)நஅஅஅஅஅஅஅஅself.num_samplesஅ+=அ0நஅஅஅஅஅஅஅஅreturnஅsample.sample_idநநஅஅஅஅdefஅclose(self):நஅஅஅஅஅஅஅஅifஅself.sdb_fileஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅreturnநஅஅஅஅஅஅஅஅoffset_indexஅ=அself.sdb_file.tell()நஅஅஅஅஅஅஅஅself.sdb_file.seek(self.offset_samples)நஅஅஅஅஅஅஅஅself.write_big_int(offset_indexஅ-அself.offset_samplesஅ-அBIGINT_SIZE)நஅஅஅஅஅஅஅஅself.write_big_int(self.num_samples)நநஅஅஅஅஅஅஅஅself.sdb_file.seek(offset_indexஅ+அBIGINT_SIZE)நஅஅஅஅஅஅஅஅself.write_big_int(self.num_samples)நஅஅஅஅஅஅஅஅforஅoffsetஅinஅself.offsets:நஅஅஅஅஅஅஅஅஅஅஅஅself.write_big_int(offset)நஅஅஅஅஅஅஅஅoffset_endஅ=அself.sdb_file.tell()நஅஅஅஅஅஅஅஅself.sdb_file.seek(offset_index)நஅஅஅஅஅஅஅஅself.write_big_int(offset_endஅ-அoffset_indexஅ-அBIGINT_SIZE)நஅஅஅஅஅஅஅஅself.sdb_file.close()நஅஅஅஅஅஅஅஅself.sdb_fileஅ=அNoneநநஅஅஅஅdefஅ__len__(self):நஅஅஅஅஅஅஅஅreturnஅlen(self.offsets)நநஅஅஅஅdefஅ__exit__(self,அexc_type,அexc_val,அexc_tb):நஅஅஅஅஅஅஅஅself.close()நநநclassஅSDB:அஅ#அpylint:அdisable=too-many-instance-attributesநஅஅஅஅ"""SampleஅcollectionஅreaderஅforஅreadingஅaஅSampleஅDBஅ(SDB)அfile"""நஅஅஅஅdefஅ__init__(self,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsdb_filename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbuffering=BUFFER_SIZE,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅid_prefix=None,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabeled=True,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreverse=False):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅsdb_filenameஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅPathஅtoஅtheஅSDBஅfileஅtoஅreadஅsamplesஅfromநஅஅஅஅஅஅஅஅbufferingஅ:அintநஅஅஅஅஅஅஅஅஅஅஅஅRead-aheadஅbufferஅsizeஅtoஅuseஅwhileஅreadingஅtheஅSDBஅfileஅinஅnormalஅorder.அFixedஅtoஅ00kBஅifஅinஅreverse-mode.நஅஅஅஅஅஅஅஅid_prefixஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅPrefixஅforஅIDsஅofஅreadஅsamplesஅ-அdefaultsஅtoஅsdb_filenameநஅஅஅஅஅஅஅஅlabeledஅ:அboolஅorஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅIfஅTrue:அReadsஅutil.sample_collections.LabeledSampleஅinstances.அFails,அifஅSDBஅfileஅprovidesஅnoஅtranscripts.நஅஅஅஅஅஅஅஅஅஅஅஅIfஅFalse:அIgnoresஅtranscriptsஅ(ifஅavailable)அandஅreadsஅ(unlabeled)அutil.audio.Sampleஅinstances.நஅஅஅஅஅஅஅஅஅஅஅஅIfஅNone:அAutomaticallyஅdeterminesஅifஅSDBஅschemaஅhasஅtranscriptsநஅஅஅஅஅஅஅஅஅஅஅஅ(readingஅutil.sample_collections.LabeledSampleஅinstances)அorஅnotஅ(readingஅutil.audio.Sampleஅinstances).நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅself.sdb_filenameஅ=அsdb_filenameநஅஅஅஅஅஅஅஅself.id_prefixஅ=அsdb_filenameஅifஅid_prefixஅisஅNoneஅelseஅid_prefixநஅஅஅஅஅஅஅஅself.sdb_fileஅ=அopen_remote(sdb_filename,அ'rb',அbuffering=REVERSE_BUFFER_SIZEஅifஅreverseஅelseஅbuffering)நஅஅஅஅஅஅஅஅself.offsetsஅ=அ[]நஅஅஅஅஅஅஅஅifஅself.sdb_file.read(len(MAGIC))அ!=அMAGIC:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError('NoஅSampleஅDatabase')நஅஅஅஅஅஅஅஅmeta_chunk_lenஅ=அself.read_big_int()நஅஅஅஅஅஅஅஅself.metaஅ=அjson.loads(self.sdb_file.read(meta_chunk_len).decode())நஅஅஅஅஅஅஅஅifஅSCHEMA_KEYஅnotஅinஅself.meta:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError('Missingஅschema')நஅஅஅஅஅஅஅஅself.schemaஅ=அself.meta[SCHEMA_KEY]நநஅஅஅஅஅஅஅஅspeech_columnsஅ=அself.find_columns(content=CONTENT_TYPE_SPEECH,அmime_type=SERIALIZABLE_AUDIO_TYPES)நஅஅஅஅஅஅஅஅifஅnotஅspeech_columns:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError('Noஅspeechஅdataஅ(missingஅinஅschema)')நஅஅஅஅஅஅஅஅself.speech_indexஅ=அspeech_columns[0]நஅஅஅஅஅஅஅஅself.audio_typeஅ=அself.schema[self.speech_index][MIME_TYPE_KEY]நநஅஅஅஅஅஅஅஅself.transcript_indexஅ=அNoneநஅஅஅஅஅஅஅஅifஅlabeledஅisஅnotஅFalse:நஅஅஅஅஅஅஅஅஅஅஅஅtranscript_columnsஅ=அself.find_columns(content=CONTENT_TYPE_TRANSCRIPT,அmime_type=MIME_TYPE_TEXT)நஅஅஅஅஅஅஅஅஅஅஅஅifஅtranscript_columns:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.transcript_indexஅ=அtranscript_columns[0]நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅlabeledஅisஅTrue:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError('Noஅtranscriptஅdataஅ(missingஅinஅschema)')நநஅஅஅஅஅஅஅஅsample_chunk_lenஅ=அself.read_big_int()நஅஅஅஅஅஅஅஅself.sdb_file.seek(sample_chunk_lenஅ+அBIGINT_SIZE,அ0)நஅஅஅஅஅஅஅஅnum_samplesஅ=அself.read_big_int()நஅஅஅஅஅஅஅஅforஅ_அinஅrange(num_samples):நஅஅஅஅஅஅஅஅஅஅஅஅself.offsets.append(self.read_big_int())நஅஅஅஅஅஅஅஅifஅreverse:நஅஅஅஅஅஅஅஅஅஅஅஅself.offsets.reverse()நநஅஅஅஅdefஅread_int(self):நஅஅஅஅஅஅஅஅreturnஅint.from_bytes(self.sdb_file.read(INT_SIZE),அBIG_ENDIAN)நநஅஅஅஅdefஅread_big_int(self):நஅஅஅஅஅஅஅஅreturnஅint.from_bytes(self.sdb_file.read(BIGINT_SIZE),அBIG_ENDIAN)நநஅஅஅஅdefஅfind_columns(self,அcontent=None,அmime_type=None):நஅஅஅஅஅஅஅஅcriteriaஅ=அ[]நஅஅஅஅஅஅஅஅifஅcontentஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅcriteria.append((CONTENT_KEY,அcontent))நஅஅஅஅஅஅஅஅifஅmime_typeஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅcriteria.append((MIME_TYPE_KEY,அmime_type))நஅஅஅஅஅஅஅஅifஅlen(criteria)அ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Atஅleastஅoneஅofஅ"content"அorஅ"mime-type"அhasஅtoஅbeஅprovided')நஅஅஅஅஅஅஅஅmatchesஅ=அ[]நஅஅஅஅஅஅஅஅforஅindex,அcolumnஅinஅenumerate(self.schema):நஅஅஅஅஅஅஅஅஅஅஅஅmatchedஅ=அ0நஅஅஅஅஅஅஅஅஅஅஅஅforஅfield,அvalueஅinஅcriteria:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅcolumn[field]அ==அvalueஅorஅ(isinstance(value,அlist)அandஅcolumn[field]அinஅvalue):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmatchedஅ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅifஅmatchedஅ==அlen(criteria):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmatches.append(index)நஅஅஅஅஅஅஅஅreturnஅmatchesநநஅஅஅஅdefஅread_row(self,அrow_index,அ*columns):நஅஅஅஅஅஅஅஅcolumnsஅ=அlist(columns)நஅஅஅஅஅஅஅஅcolumn_dataஅ=அ[None]அ*அlen(columns)நஅஅஅஅஅஅஅஅfoundஅ=அ0நஅஅஅஅஅஅஅஅifஅnotஅ0அ<=அrow_indexஅ<அlen(self.offsets):நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Wrongஅsampleஅindex:அ{}அ-அhasஅtoஅbeஅbetweenஅ0அandஅ{}'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.format(row_index,அlen(self.offsets)அ-அ0))நஅஅஅஅஅஅஅஅself.sdb_file.seek(self.offsets[row_index]அ+அINT_SIZE)நஅஅஅஅஅஅஅஅforஅindexஅinஅrange(len(self.schema)):நஅஅஅஅஅஅஅஅஅஅஅஅchunk_lenஅ=அself.read_int()நஅஅஅஅஅஅஅஅஅஅஅஅifஅindexஅinஅcolumns:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcolumn_data[columns.index(index)]அ=அself.sdb_file.read(chunk_len)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfoundஅ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅfoundஅ==அlen(columns):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅtuple(column_data)நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.sdb_file.seek(chunk_len,அ0)நஅஅஅஅஅஅஅஅreturnஅtuple(column_data)நநஅஅஅஅdefஅ__getitem__(self,அi):நஅஅஅஅஅஅஅஅsample_idஅ=அ'{}:{}'.format(self.id_prefix,அi)நஅஅஅஅஅஅஅஅifஅself.transcript_indexஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅ[audio_data]அ=அself.read_row(i,அself.speech_index)நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅSample(self.audio_type,அaudio_data,அsample_id=sample_id)நஅஅஅஅஅஅஅஅaudio_data,அtranscriptஅ=அself.read_row(i,அself.speech_index,அself.transcript_index)நஅஅஅஅஅஅஅஅtranscriptஅ=அtranscript.decode()நஅஅஅஅஅஅஅஅreturnஅLabeledSample(self.audio_type,அaudio_data,அtranscript,அsample_id=sample_id)நநஅஅஅஅdefஅ__iter__(self):நஅஅஅஅஅஅஅஅforஅiஅinஅrange(len(self.offsets)):நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅself[i]நநஅஅஅஅdefஅ__len__(self):நஅஅஅஅஅஅஅஅreturnஅlen(self.offsets)நநஅஅஅஅdefஅclose(self):நஅஅஅஅஅஅஅஅifஅself.sdb_fileஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅself.sdb_file.close()நநஅஅஅஅdefஅ__del__(self):நஅஅஅஅஅஅஅஅself.close()நநநclassஅCSVWriter:அஅ#அpylint:அdisable=too-many-instance-attributesநஅஅஅஅ"""SampleஅcollectionஅwriterஅforஅwritingஅaஅCSVஅdata-setஅandஅallஅitsஅreferencedஅWAVஅsamples"""நஅஅஅஅdefஅ__init__(self,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcsv_filename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅabsolute_paths=False,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabeled=True):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅcsv_filenameஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅPathஅtoஅtheஅCSVஅfileஅtoஅwrite.நஅஅஅஅஅஅஅஅஅஅஅஅWillஅcreateஅaஅdirectoryஅ(CSV-filenameஅwithoutஅextension)அnextஅtoஅitஅandஅfailஅifஅitஅalreadyஅexists.நஅஅஅஅஅஅஅஅabsolute_pathsஅ:அboolநஅஅஅஅஅஅஅஅஅஅஅஅIfஅpathsஅinஅCSVஅfileஅshouldஅbeஅabsoluteஅinsteadஅofஅrelativeஅtoஅtheஅCSVஅfile'sஅparentஅdirectory.நஅஅஅஅஅஅஅஅlabeledஅ:அboolஅorஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅIfஅTrue:அWritesஅlabeledஅsamplesஅ(util.sample_collections.LabeledSample)அonly.நஅஅஅஅஅஅஅஅஅஅஅஅIfஅFalse:அIgnoresஅtranscriptsஅ(ifஅavailable)அandஅwritesஅ(unlabeled)அutil.audio.Sampleஅinstances.நஅஅஅஅஅஅஅஅநஅஅஅஅஅஅஅஅCurrentlyஅonlyஅworksஅwithஅlocalஅfilesஅ(notஅgs://அorஅhdfs://...)நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅself.csv_filenameஅ=அPath(csv_filename)நஅஅஅஅஅஅஅஅself.csv_base_dirஅ=அself.csv_filename.parent.resolve().absolute()நஅஅஅஅஅஅஅஅself.set_nameஅ=அself.csv_filename.stemநஅஅஅஅஅஅஅஅself.csv_dirஅ=அself.csv_base_dirஅ/அself.set_nameநஅஅஅஅஅஅஅஅifஅself.csv_dir.exists():நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError('"{}"அalreadyஅexisting'.format(self.csv_dir))நஅஅஅஅஅஅஅஅos.mkdir(str(self.csv_dir))நஅஅஅஅஅஅஅஅself.absolute_pathsஅ=அabsolute_pathsநஅஅஅஅஅஅஅஅfieldnamesஅ=அ['wav_filename',அ'wav_filesize']நஅஅஅஅஅஅஅஅself.labeledஅ=அlabeledநஅஅஅஅஅஅஅஅifஅlabeled:நஅஅஅஅஅஅஅஅஅஅஅஅfieldnames.append('transcript')நஅஅஅஅஅஅஅஅself.csv_fileஅ=அopen_remote(csv_filename,அ'w',அencoding='utf-0',அnewline='')நஅஅஅஅஅஅஅஅself.csv_writerஅ=அcsv.DictWriter(self.csv_file,அfieldnames=fieldnames)நஅஅஅஅஅஅஅஅself.csv_writer.writeheader()நஅஅஅஅஅஅஅஅself.counterஅ=அ0நநஅஅஅஅdefஅ__enter__(self):நஅஅஅஅஅஅஅஅreturnஅselfநநஅஅஅஅdefஅadd(self,அsample):நஅஅஅஅஅஅஅஅsample_filenameஅ=அself.csv_dirஅ/அ'sample{0:00d}.wav'.format(self.counter)நஅஅஅஅஅஅஅஅself.counterஅ+=அ0நஅஅஅஅஅஅஅஅsample.change_audio_type(AUDIO_TYPE_PCM)நஅஅஅஅஅஅஅஅwrite_wav(str(sample_filename),அsample.audio,அaudio_format=sample.audio_format)நஅஅஅஅஅஅஅஅsample.sample_idஅ=அstr(sample_filename.relative_to(self.csv_base_dir))நஅஅஅஅஅஅஅஅrowஅ=அ{நஅஅஅஅஅஅஅஅஅஅஅஅ'wav_filename':அstr(sample_filename.absolute())அifஅself.absolute_pathsஅelseஅsample.sample_id,நஅஅஅஅஅஅஅஅஅஅஅஅ'wav_filesize':அsample_filename.stat().st_sizeநஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅifஅself.labeled:நஅஅஅஅஅஅஅஅஅஅஅஅrow['transcript']அ=அsample.transcriptநஅஅஅஅஅஅஅஅself.csv_writer.writerow(row)நஅஅஅஅஅஅஅஅreturnஅsample.sample_idநநஅஅஅஅdefஅclose(self):நஅஅஅஅஅஅஅஅifஅself.csv_file:நஅஅஅஅஅஅஅஅஅஅஅஅself.csv_file.close()நநஅஅஅஅdefஅ__len__(self):நஅஅஅஅஅஅஅஅreturnஅself.counterநநஅஅஅஅdefஅ__exit__(self,அexc_type,அexc_val,அexc_tb):நஅஅஅஅஅஅஅஅself.close()நநநclassஅTarWriter:அஅ#அpylint:அdisable=too-many-instance-attributesநஅஅஅஅ"""SampleஅcollectionஅwriterஅforஅwritingஅaஅCSVஅdata-setஅandஅallஅitsஅreferencedஅWAVஅsamplesஅtoஅaஅtarஅfile."""நஅஅஅஅdefஅ__init__(self,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtar_filename,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅgz=False,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabeled=True,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinclude=None):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅtar_filenameஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅPathஅtoஅtheஅtarஅfileஅtoஅwrite.நஅஅஅஅஅஅஅஅgzஅ:அboolநஅஅஅஅஅஅஅஅஅஅஅஅIfஅtoஅcompressஅtarஅfileஅwithஅgzip.நஅஅஅஅஅஅஅஅlabeledஅ:அboolஅorஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅIfஅTrue:அWritesஅlabeledஅsamplesஅ(util.sample_collections.LabeledSample)அonly.நஅஅஅஅஅஅஅஅஅஅஅஅIfஅFalse:அIgnoresஅtranscriptsஅ(ifஅavailable)அandஅwritesஅ(unlabeled)அutil.audio.Sampleஅinstances.நஅஅஅஅஅஅஅஅincludeஅ:அstr[]நஅஅஅஅஅஅஅஅஅஅஅஅListஅofஅfilesஅtoஅincludeஅintoஅtarஅroot.நநஅஅஅஅஅஅஅஅCurrentlyஅonlyஅworksஅwithஅlocalஅfilesஅ(notஅgs://அorஅhdfs://...)நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅself.tarஅ=அtarfile.open(tar_filename,அ'w:gz'அifஅgzஅelseஅ'w')நஅஅஅஅஅஅஅஅsamples_dirஅ=அtarfile.TarInfo('samples')நஅஅஅஅஅஅஅஅsamples_dir.typeஅ=அtarfile.DIRTYPEநஅஅஅஅஅஅஅஅself.tar.addfile(samples_dir)நஅஅஅஅஅஅஅஅifஅinclude:நஅஅஅஅஅஅஅஅஅஅஅஅforஅinclude_pathஅinஅinclude:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.tar.add(include_path,அrecursive=False,அarcname=Path(include_path).name)நஅஅஅஅஅஅஅஅfieldnamesஅ=அ['wav_filename',அ'wav_filesize']நஅஅஅஅஅஅஅஅself.labeledஅ=அlabeledநஅஅஅஅஅஅஅஅifஅlabeled:நஅஅஅஅஅஅஅஅஅஅஅஅfieldnames.append('transcript')நஅஅஅஅஅஅஅஅself.csv_fileஅ=அio.StringIO()நஅஅஅஅஅஅஅஅself.csv_writerஅ=அcsv.DictWriter(self.csv_file,அfieldnames=fieldnames)நஅஅஅஅஅஅஅஅself.csv_writer.writeheader()நஅஅஅஅஅஅஅஅself.counterஅ=அ0நநஅஅஅஅdefஅ__enter__(self):நஅஅஅஅஅஅஅஅreturnஅselfநநஅஅஅஅdefஅadd(self,அsample):நஅஅஅஅஅஅஅஅsample_filenameஅ=அ'samples/sample{0:00d}.wav'.format(self.counter)நஅஅஅஅஅஅஅஅself.counterஅ+=அ0நஅஅஅஅஅஅஅஅsample.change_audio_type(AUDIO_TYPE_PCM)நஅஅஅஅஅஅஅஅsample_fileஅ=அio.BytesIO()நஅஅஅஅஅஅஅஅwrite_wav(sample_file,அsample.audio,அaudio_format=sample.audio_format)நஅஅஅஅஅஅஅஅsample_sizeஅ=அsample_file.tell()நஅஅஅஅஅஅஅஅsample_file.seek(0)நஅஅஅஅஅஅஅஅsample_tarஅ=அtarfile.TarInfo(sample_filename)நஅஅஅஅஅஅஅஅsample_tar.sizeஅ=அsample_sizeநஅஅஅஅஅஅஅஅself.tar.addfile(sample_tar,அsample_file)நஅஅஅஅஅஅஅஅrowஅ=அ{நஅஅஅஅஅஅஅஅஅஅஅஅ'wav_filename':அsample_filename,நஅஅஅஅஅஅஅஅஅஅஅஅ'wav_filesize':அsample_sizeநஅஅஅஅஅஅஅஅ}நஅஅஅஅஅஅஅஅifஅself.labeled:நஅஅஅஅஅஅஅஅஅஅஅஅrow['transcript']அ=அsample.transcriptநஅஅஅஅஅஅஅஅself.csv_writer.writerow(row)நஅஅஅஅஅஅஅஅreturnஅsample_filenameநநஅஅஅஅdefஅclose(self):நஅஅஅஅஅஅஅஅifஅself.csv_fileஅandஅself.tar:நஅஅஅஅஅஅஅஅஅஅஅஅcsv_tarஅ=அtarfile.TarInfo('samples.csv')நஅஅஅஅஅஅஅஅஅஅஅஅcsv_tar.sizeஅ=அself.csv_file.tell()நஅஅஅஅஅஅஅஅஅஅஅஅself.csv_file.seek(0)நஅஅஅஅஅஅஅஅஅஅஅஅself.tar.addfile(csv_tar,அio.BytesIO(self.csv_file.read().encode('utf0')))நஅஅஅஅஅஅஅஅifஅself.tar:நஅஅஅஅஅஅஅஅஅஅஅஅself.tar.close()நநஅஅஅஅdefஅ__len__(self):நஅஅஅஅஅஅஅஅreturnஅself.counterநநஅஅஅஅdefஅ__exit__(self,அexc_type,அexc_val,அexc_tb):நஅஅஅஅஅஅஅஅself.close()நநநclassஅSampleList:நஅஅஅஅ"""Sampleஅcollectionஅbaseஅclassஅwithஅsamplesஅloadedஅfromஅaஅlistஅofஅin-memoryஅpaths."""நஅஅஅஅdefஅ__init__(self,அsamples,அlabeled=True,அreverse=False):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅsamplesஅ:அiterableஅofஅtuplesஅofஅtheஅformஅ(sample_filename,அfilesizeஅ[,அtranscript])நஅஅஅஅஅஅஅஅஅஅஅஅFile-sizeஅisஅusedஅforஅorderingஅtheஅsamples;அtranscriptஅhasஅtoஅbeஅprovidedஅifஅlabeled=Trueநஅஅஅஅஅஅஅஅlabeledஅ:அboolஅorஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅIfஅTrue:அReadsஅLabeledSampleஅinstances.நஅஅஅஅஅஅஅஅஅஅஅஅIfஅFalse:அIgnoresஅtranscriptsஅ(ifஅavailable)அandஅreadsஅ(unlabeled)அutil.audio.Sampleஅinstances.நஅஅஅஅஅஅஅஅreverseஅ:அboolநஅஅஅஅஅஅஅஅஅஅஅஅIfஅtheஅorderஅofஅtheஅsamplesஅshouldஅbeஅreversedநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅself.labeledஅ=அlabeledநஅஅஅஅஅஅஅஅself.samplesஅ=அlist(samples)நஅஅஅஅஅஅஅஅself.samples.sort(key=lambdaஅr:அr[0],அreverse=reverse)நநஅஅஅஅdefஅ__getitem__(self,அi):நஅஅஅஅஅஅஅஅsample_specஅ=அself.samples[i]நஅஅஅஅஅஅஅஅreturnஅload_sample(sample_spec[0],அlabel=sample_spec[0]அifஅself.labeledஅelseஅNone)நநஅஅஅஅdefஅ__len__(self):நஅஅஅஅஅஅஅஅreturnஅlen(self.samples)நநநclassஅCSV(SampleList):நஅஅஅஅ"""SampleஅcollectionஅreaderஅforஅreadingஅaஅDeepSpeechஅCSVஅfileநஅஅஅஅAutomaticallyஅordersஅsamplesஅbyஅCSVஅcolumnஅwav_filesizeஅ(ifஅavailable)."""நஅஅஅஅdefஅ__init__(self,அcsv_filename,அlabeled=None,அreverse=False):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅcsv_filenameஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅPathஅtoஅtheஅCSVஅfileஅcontainingஅsampleஅaudioஅpathsஅandஅtranscriptsநஅஅஅஅஅஅஅஅlabeledஅ:அboolஅorஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅIfஅTrue:அReadsஅLabeledSampleஅinstances.அFails,அifஅCSVஅfileஅhasஅnoஅtranscriptஅcolumn.நஅஅஅஅஅஅஅஅஅஅஅஅIfஅFalse:அIgnoresஅtranscriptsஅ(ifஅavailable)அandஅreadsஅ(unlabeled)அutil.audio.Sampleஅinstances.நஅஅஅஅஅஅஅஅஅஅஅஅIfஅNone:அAutomaticallyஅdeterminesஅifஅCSVஅfileஅhasஅaஅtranscriptஅcolumnநஅஅஅஅஅஅஅஅஅஅஅஅ(readingஅutil.sample_collections.LabeledSampleஅinstances)அorஅnotஅ(readingஅutil.audio.Sampleஅinstances).நஅஅஅஅஅஅஅஅreverseஅ:அboolநஅஅஅஅஅஅஅஅஅஅஅஅIfஅtheஅorderஅofஅtheஅsamplesஅshouldஅbeஅreversedநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅrowsஅ=அ[]நஅஅஅஅஅஅஅஅwithஅopen_remote(csv_filename,அ'r',அencoding='utf0')அasஅcsv_file:நஅஅஅஅஅஅஅஅஅஅஅஅreaderஅ=அcsv.DictReader(csv_file)நஅஅஅஅஅஅஅஅஅஅஅஅifஅ'transcript'அinஅreader.fieldnames:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅlabeledஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabeledஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅelifஅlabeled:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError('Noஅtranscriptஅdataஅ(missingஅCSVஅcolumn)')நஅஅஅஅஅஅஅஅஅஅஅஅforஅrowஅinஅreader:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அPath(row['wav_filename'])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅwav_filename.is_absolute()அandஅnotஅis_remote_path(row['wav_filename']):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அPath(csv_filename).parentஅ/அwav_filenameநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அstr(wav_filename)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அPathlibஅotherwiseஅremovesஅaஅ/அfromஅfilenamesஅlikeஅhdfs://நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenameஅ=அrow['wav_filename']நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filesizeஅ=அint(row['wav_filesize'])அifஅ'wav_filesize'அinஅrowஅelseஅ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅlabeled:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrows.append((wav_filename,அwav_filesize,அrow['transcript']))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrows.append((wav_filename,அwav_filesize))நஅஅஅஅஅஅஅஅsuper(CSV,அself).__init__(rows,அlabeled=labeled,அreverse=reverse)நநநdefஅsamples_from_source(sample_source,அbuffering=BUFFER_SIZE,அlabeled=None,அreverse=False):நஅஅஅஅ"""நஅஅஅஅLoadsஅsamplesஅfromஅaஅsampleஅsourceஅfile.நநஅஅஅஅParametersநஅஅஅஅ----------நஅஅஅஅsample_sourceஅ:அstrநஅஅஅஅஅஅஅஅPathஅtoஅtheஅsampleஅsourceஅfileஅ(SDBஅorஅCSV)நஅஅஅஅbufferingஅ:அintநஅஅஅஅஅஅஅஅRead-bufferஅsizeஅtoஅuseஅwhileஅreadingஅfilesநஅஅஅஅlabeledஅ:அboolஅorஅNoneநஅஅஅஅஅஅஅஅIfஅTrue:அReadsஅLabeledSampleஅinstances.அFails,அifஅsourceஅprovidesஅnoஅtranscripts.நஅஅஅஅஅஅஅஅIfஅFalse:அIgnoresஅtranscriptsஅ(ifஅavailable)அandஅreadsஅ(unlabeled)அutil.audio.Sampleஅinstances.நஅஅஅஅஅஅஅஅIfஅNone:அAutomaticallyஅdeterminesஅifஅsourceஅprovidesஅtranscriptsநஅஅஅஅஅஅஅஅ(readingஅutil.sample_collections.LabeledSampleஅinstances)அorஅnotஅ(readingஅutil.audio.Sampleஅinstances).நஅஅஅஅreverseஅ:அboolநஅஅஅஅஅஅஅஅIfஅtheஅorderஅofஅtheஅsamplesஅshouldஅbeஅreversedநநஅஅஅஅReturnsநஅஅஅஅ-------நஅஅஅஅiterableஅofஅutil.sample_collections.LabeledSampleஅorஅutil.audio.Sampleஅinstancesஅsupportingஅlen.நஅஅஅஅ"""நஅஅஅஅextஅ=அos.path.splitext(sample_source)[0].lower()நஅஅஅஅifஅextஅ==அ'.sdb':நஅஅஅஅஅஅஅஅreturnஅSDB(sample_source,அbuffering=buffering,அlabeled=labeled,அreverse=reverse)நஅஅஅஅifஅextஅ==அ'.csv':நஅஅஅஅஅஅஅஅreturnஅCSV(sample_source,அlabeled=labeled,அreverse=reverse)நஅஅஅஅraiseஅValueError('Unknownஅfileஅtype:அ"{}"'.format(ext))நநநdefஅsamples_from_sources(sample_sources,அbuffering=BUFFER_SIZE,அlabeled=None,அreverse=False):நஅஅஅஅ"""நஅஅஅஅLoadsஅandஅcombinesஅsamplesஅfromஅaஅlistஅofஅsourceஅfiles.அSourcesஅareஅcombinedஅinஅanஅinterleavingஅwayஅtoநஅஅஅஅkeepஅdefaultஅsampleஅorderஅfromஅshortestஅtoஅlongest.நநஅஅஅஅNoteஅthatஅwhenஅusingஅdistributedஅtraining,அitஅisஅmuchஅfasterஅtoஅcallஅthisஅfunctionஅwithஅsingleஅpre-நஅஅஅஅsortedஅsampleஅsource,அbecauseஅthisஅallowsஅforஅparallelizationஅofஅtheஅfileஅI/O.அ(Ifஅthisஅfunctionஅisநஅஅஅஅcalledஅwithஅmultipleஅsources,அtheஅsamplesஅhaveஅtoஅbeஅunpackedஅonஅaஅsingleஅparentஅprocessஅtoஅallowநஅஅஅஅforஅreadingஅtheirஅdurations.)நநஅஅஅஅParametersநஅஅஅஅ----------நஅஅஅஅsample_sourcesஅ:அlistஅofஅstrநஅஅஅஅஅஅஅஅPathsஅtoஅsampleஅsourceஅfilesஅ(SDBsஅorஅCSVs)நஅஅஅஅbufferingஅ:அintநஅஅஅஅஅஅஅஅRead-bufferஅsizeஅtoஅuseஅwhileஅreadingஅfilesநஅஅஅஅlabeledஅ:அboolஅorஅNoneநஅஅஅஅஅஅஅஅIfஅTrue:அReadsஅLabeledSampleஅinstances.அFails,அifஅnotஅallஅsourcesஅprovideஅtranscripts.நஅஅஅஅஅஅஅஅIfஅFalse:அIgnoresஅtranscriptsஅ(ifஅavailable)அandஅalwaysஅreadsஅ(unlabeled)அutil.audio.Sampleஅinstances.நஅஅஅஅஅஅஅஅIfஅNone:அReadsஅutil.sample_collections.LabeledSampleஅinstancesஅfromஅsourcesஅwithஅtranscriptsஅandநஅஅஅஅஅஅஅஅutil.audio.Sampleஅinstancesஅfromஅsourcesஅwithஅnoஅtranscripts.நஅஅஅஅreverseஅ:அboolநஅஅஅஅஅஅஅஅIfஅtheஅorderஅofஅtheஅsamplesஅshouldஅbeஅreversedநநஅஅஅஅReturnsநஅஅஅஅ-------நஅஅஅஅiterableஅofஅutil.sample_collections.PackedSampleஅifஅaஅsingleஅcollectionஅisஅprovided,அwrappingநஅஅஅஅஅஅஅஅLabeledSampleஅ(labeled=True)அorஅutil.audio.Sampleஅ(labeled=False)அsupportingஅlenநஅஅஅஅorஅLabeledSampleஅ/அutil.audio.Sampleஅdirectly,அifஅmultipleஅcollectionsஅareஅprovidedநஅஅஅஅ"""நஅஅஅஅsample_sourcesஅ=அlist(sample_sources)நஅஅஅஅifஅlen(sample_sources)அ==அ0:நஅஅஅஅஅஅஅஅraiseஅValueError('Noஅfiles')நஅஅஅஅifஅlen(sample_sources)அ==அ0:நஅஅஅஅஅஅஅஅreturnஅsamples_from_source(sample_sources[0],அbuffering=buffering,அlabeled=labeled,அreverse=reverse)நநஅஅஅஅ#அIfஅweஅwishஅtoஅinterleaveஅbasedஅonஅduration,அweஅhaveஅtoஅunpackஅtheஅaudio.அNoteஅthatஅthisஅunpackingஅshouldநஅஅஅஅ#அbeஅdoneஅlazilyஅonnஅtheஅflyஅsoஅthatஅitஅrespectsஅtheஅLimitingPoolஅlogicஅusedஅinஅtheஅfeedingஅcode.நஅஅஅஅcolsஅ=அ[LenMap(நஅஅஅஅஅஅஅஅunpack_maybe,அsamples_from_source(source,அbuffering=buffering,அlabeled=labeled,அreverse=reverse))நஅஅஅஅஅஅஅஅforஅsourceஅinஅsample_sources]நநஅஅஅஅreturnஅInterleaved(*cols,அkey=lambdaஅs:அs.duration,அreverse=reverse)நfromஅ__future__அimportஅabsolute_import,அdivision,அprint_functionநநimportஅosநimportஅabsl.flagsநநFLAGSஅ=அabsl.flags.FLAGSநந#அsphinx-doc:அtraining_ref_flags_startநdefஅcreate_flags():நஅஅஅஅ#அImporterநஅஅஅஅ#அ========நநஅஅஅஅfஅ=அabsl.flagsநநஅஅஅஅf.DEFINE_string('train_files',அ'',அ'commaஅseparatedஅlistஅofஅfilesஅspecifyingஅtheஅdatasetஅusedஅforஅtraining.அMultipleஅfilesஅwillஅgetஅmerged.அIfஅempty,அtrainingஅwillஅnotஅbeஅrun.')நஅஅஅஅf.DEFINE_string('dev_files',அ'',அ'commaஅseparatedஅlistஅofஅfilesஅspecifyingஅtheஅdatasetsஅusedஅforஅvalidation.அMultipleஅfilesஅwillஅgetஅreportedஅseparately.அIfஅempty,அvalidationஅwillஅnotஅbeஅrun.')நஅஅஅஅf.DEFINE_string('test_files',அ'',அ'commaஅseparatedஅlistஅofஅfilesஅspecifyingஅtheஅdatasetsஅusedஅforஅtesting.அMultipleஅfilesஅwillஅgetஅreportedஅseparately.அIfஅempty,அtheஅmodelஅwillஅnotஅbeஅtested.')நஅஅஅஅf.DEFINE_string('metrics_files',அ'',அ'commaஅseparatedஅlistஅofஅfilesஅspecifyingஅtheஅdatasetsஅusedஅforஅtrackingஅofஅmetricsஅ(afterஅvalidationஅstep).அCurrentlyஅtheஅonlyஅmetricஅisஅtheஅCTCஅlossஅbutஅwithoutஅaffectingஅtheஅtrackingஅofஅbestஅvalidationஅloss.அMultipleஅfilesஅwillஅgetஅreportedஅseparately.அIfஅempty,அmetricsஅwillஅnotஅbeஅcomputed.')நநஅஅஅஅf.DEFINE_string('read_buffer',அ'0MB',அ'buffer-sizeஅforஅreadingஅsamplesஅfromஅdatasetsஅ(supportsஅfile-sizeஅsuffixesஅKB,அMB,அGB,அTB)')நஅஅஅஅf.DEFINE_string('feature_cache',அ'',அ'cacheஅMFCCஅfeaturesஅtoஅdiskஅtoஅspeedஅupஅfutureஅtrainingஅrunsஅonஅtheஅsameஅdata.அThisஅflagஅspecifiesஅtheஅpathஅwhereஅcachedஅfeaturesஅextractedஅfromஅ--train_filesஅwillஅbeஅsaved.அIfஅempty,அorஅifஅonlineஅaugmentationஅflagsஅareஅenabled,அcachingஅwillஅbeஅdisabled.')நஅஅஅஅf.DEFINE_integer('cache_for_epochs',அ0,அ'afterஅhowஅmanyஅepochsஅtheஅfeatureஅcacheஅisஅinvalidatedஅagainஅ-அ0அforஅ"never"')நநஅஅஅஅf.DEFINE_integer('feature_win_len',அ00,அ'featureஅextractionஅaudioஅwindowஅlengthஅinஅmilliseconds')நஅஅஅஅf.DEFINE_integer('feature_win_step',அ00,அ'featureஅextractionஅwindowஅstepஅlengthஅinஅmilliseconds')நஅஅஅஅf.DEFINE_integer('audio_sample_rate',அ00000,அ'sampleஅrateஅvalueஅexpectedஅbyஅmodel')நஅஅஅஅf.DEFINE_boolean('normalize_sample_rate',அTrue,அ'normalizeஅsampleஅrateஅofஅallஅtrain_filesஅtoஅ--audio_sample_rate')நநஅஅஅஅ#அDataஅAugmentationநஅஅஅஅ#அ================நநஅஅஅஅf.DEFINE_multi_string('augment',அNone,அ'specifiesஅanஅaugmentationஅofஅtheஅtrainingஅsamples.அFormatஅisஅ"--augmentஅoperation[param0=value0,அ...]"')நநஅஅஅஅ#அGlobalஅConstantsநஅஅஅஅ#அ================நநஅஅஅஅf.DEFINE_integer('epochs',அ00,அ'howஅmanyஅepochsஅ(completeஅrunsஅthroughஅtheஅtrainஅfiles)அtoஅtrainஅfor')நநஅஅஅஅf.DEFINE_float('dropout_rate',அ0.00,அ'dropoutஅrateஅforஅfeedforwardஅlayers')நஅஅஅஅf.DEFINE_float('dropout_rate0',அ-0.0,அ'dropoutஅrateஅforஅlayerஅ0அ-அdefaultsஅtoஅdropout_rate')நஅஅஅஅf.DEFINE_float('dropout_rate0',அ-0.0,அ'dropoutஅrateஅforஅlayerஅ0அ-அdefaultsஅtoஅdropout_rate')நஅஅஅஅf.DEFINE_float('dropout_rate0',அ0.0,அ'dropoutஅrateஅforஅlayerஅ0அ-அdefaultsஅtoஅ0.0')நஅஅஅஅf.DEFINE_float('dropout_rate0',அ0.0,அ'dropoutஅrateஅforஅlayerஅ0அ-அdefaultsஅtoஅ0.0')நஅஅஅஅf.DEFINE_float('dropout_rate0',அ-0.0,அ'dropoutஅrateஅforஅlayerஅ0அ-அdefaultsஅtoஅdropout_rate')நநஅஅஅஅf.DEFINE_float('relu_clip',அ00.0,அ'ReLUஅclippingஅvalueஅforஅnon-recurrentஅlayers')நநஅஅஅஅ#அAdamஅoptimizer(http://arxiv.org/abs/0000.0000)அparametersநநஅஅஅஅf.DEFINE_float('beta0',அ0.0,அ'betaஅ0அparameterஅofஅAdamஅoptimizer')நஅஅஅஅf.DEFINE_float('beta0',அ0.000,அ'betaஅ0அparameterஅofஅAdamஅoptimizer')நஅஅஅஅf.DEFINE_float('epsilon',அ0e-0,அ'epsilonஅparameterஅofஅAdamஅoptimizer')நஅஅஅஅf.DEFINE_float('learning_rate',அ0.000,அ'learningஅrateஅofஅAdamஅoptimizer')நநஅஅஅஅ#அBatchஅsizesநநஅஅஅஅf.DEFINE_integer('train_batch_size',அ0,அ'numberஅofஅelementsஅinஅaஅtrainingஅbatch')நஅஅஅஅf.DEFINE_integer('dev_batch_size',அ0,அ'numberஅofஅelementsஅinஅaஅvalidationஅbatch')நஅஅஅஅf.DEFINE_integer('test_batch_size',அ0,அ'numberஅofஅelementsஅinஅaஅtestஅbatch')நநஅஅஅஅf.DEFINE_integer('export_batch_size',அ0,அ'numberஅofஅelementsஅperஅbatchஅonஅtheஅexportedஅgraph')நநஅஅஅஅ#அPerformanceநநஅஅஅஅf.DEFINE_integer('inter_op_parallelism_threads',அ0,அ'numberஅofஅinter-opஅparallelismஅthreadsஅ-அseeஅtf.ConfigProtoஅforஅmoreஅdetails.அUSEஅOFஅTHISஅFLAGஅISஅUNSUPPORTED')நஅஅஅஅf.DEFINE_integer('intra_op_parallelism_threads',அ0,அ'numberஅofஅintra-opஅparallelismஅthreadsஅ-அseeஅtf.ConfigProtoஅforஅmoreஅdetails.அUSEஅOFஅTHISஅFLAGஅISஅUNSUPPORTED')நஅஅஅஅf.DEFINE_boolean('use_allow_growth',அFalse,அ'useஅAllowஅGrowthஅflagஅwhichஅwillஅallocateஅonlyஅrequiredஅamountஅofஅGPUஅmemoryஅandஅpreventஅfullஅallocationஅofஅavailableஅGPUஅmemory')நஅஅஅஅf.DEFINE_boolean('load_cudnn',அFalse,அ'SpecifyingஅthisஅflagஅallowsஅoneஅtoஅconvertஅaஅCuDNNஅRNNஅcheckpointஅtoஅaஅcheckpointஅcapableஅofஅrunningஅonஅaஅCPUஅgraph.')நஅஅஅஅf.DEFINE_boolean('train_cudnn',அFalse,அ'useஅCuDNNஅRNNஅbackendஅforஅtrainingஅonஅGPU.அNoteஅthatஅcheckpointsஅcreatedஅwithஅthisஅflagஅcanஅonlyஅbeஅusedஅwithஅCuDNNஅRNN,அi.e.அfineஅtuningஅonஅaஅCPUஅdeviceஅwillஅnotஅwork')நஅஅஅஅf.DEFINE_boolean('automatic_mixed_precision',அFalse,அ'whetherஅtoஅallowஅautomaticஅmixedஅprecisionஅtraining.அUSEஅOFஅTHISஅFLAGஅISஅUNSUPPORTED.அCheckpointsஅcreatedஅwithஅautomaticஅmixedஅprecisionஅtrainingஅwillஅnotஅbeஅusableஅwithoutஅmixedஅprecision.')நநஅஅஅஅf.DEFINE_boolean('horovod',அFalse,அ'useஅhorovodஅforஅtrainingஅonஅmultipleஅgpus')நநஅஅஅஅ#அSampleஅlimitsநநஅஅஅஅf.DEFINE_integer('limit_train',அ0,அ'maximumஅnumberஅofஅelementsஅtoஅuseஅfromஅtrainஅsetஅ-அ0அmeansஅnoஅlimit')நஅஅஅஅf.DEFINE_integer('limit_dev',அ0,அ'maximumஅnumberஅofஅelementsஅtoஅuseஅfromஅvalidationஅsetஅ-அ0அmeansஅnoஅlimit')நஅஅஅஅf.DEFINE_integer('limit_test',அ0,அ'maximumஅnumberஅofஅelementsஅtoஅuseஅfromஅtestஅsetஅ-அ0அmeansஅnoஅlimit')நநஅஅஅஅ#அSampleஅorderநநஅஅஅஅf.DEFINE_boolean('reverse_train',அFalse,அ'ifஅtoஅreverseஅsampleஅorderஅofஅtheஅtrainஅset')நஅஅஅஅf.DEFINE_boolean('reverse_dev',அFalse,அ'ifஅtoஅreverseஅsampleஅorderஅofஅtheஅdevஅset')நஅஅஅஅf.DEFINE_boolean('reverse_test',அFalse,அ'ifஅtoஅreverseஅsampleஅorderஅofஅtheஅtestஅset')நநஅஅஅஅ#அCheckpointingநநஅஅஅஅf.DEFINE_string('checkpoint_dir',அ'',அ'directoryஅfromஅwhichஅcheckpointsஅareஅloadedஅandஅtoஅwhichஅtheyஅareஅsavedஅ-அdefaultsஅtoஅdirectoryஅ"deepspeech/checkpoints"அwithinஅuser\'sஅdataஅhomeஅspecifiedஅbyஅtheஅXDGஅBaseஅDirectoryஅSpecification')நஅஅஅஅf.DEFINE_string('load_checkpoint_dir',அ'',அ'directoryஅinஅwhichஅcheckpointsஅareஅstoredஅ-அdefaultsஅtoஅdirectoryஅ"deepspeech/checkpoints"அwithinஅuser\'sஅdataஅhomeஅspecifiedஅbyஅtheஅXDGஅBaseஅDirectoryஅSpecification')நஅஅஅஅf.DEFINE_string('save_checkpoint_dir',அ'',அ'directoryஅtoஅwhichஅcheckpointsஅareஅsavedஅ-அdefaultsஅtoஅdirectoryஅ"deepspeech/checkpoints"அwithinஅuser\'sஅdataஅhomeஅspecifiedஅbyஅtheஅXDGஅBaseஅDirectoryஅSpecification')நஅஅஅஅf.DEFINE_integer('checkpoint_secs',அ000,அ'checkpointஅsavingஅintervalஅinஅseconds')நஅஅஅஅf.DEFINE_integer('max_to_keep',அ0,அ'numberஅofஅcheckpointஅfilesஅtoஅkeepஅ-அdefaultஅvalueஅisஅ0')நஅஅஅஅf.DEFINE_string('load_train',அ'auto',அ'whatஅcheckpointஅtoஅloadஅbeforeஅstartingஅtheஅtrainingஅprocess.அ"last"அforஅloadingஅmostஅrecentஅepochஅcheckpoint,அ"best"அforஅloadingஅbestஅvalidationஅlossஅcheckpoint,அ"init"அforஅinitializingஅaஅnewஅcheckpoint,அ"auto"அforஅtryingஅseveralஅoptions.')நஅஅஅஅf.DEFINE_string('load_evaluate',அ'auto',அ'whatஅcheckpointஅtoஅloadஅforஅevaluationஅtasksஅ(testஅepochs,அmodelஅexport,அsingleஅfileஅinference,அetc).அ"last"அforஅloadingஅmostஅrecentஅepochஅcheckpoint,அ"best"அforஅloadingஅbestஅvalidationஅlossஅcheckpoint,அ"auto"அforஅtryingஅseveralஅoptions.')நநஅஅஅஅ#அTransferஅLearningநநஅஅஅஅf.DEFINE_integer('drop_source_layers',அ0,அ'singleஅintegerஅforஅhowஅmanyஅlayersஅtoஅdropஅfromஅsourceஅmodelஅ(toஅdropஅjustஅoutputஅ==அ0,அdropஅpenultimateஅandஅoutputஅ==0,அetc)')நநஅஅஅஅ#அExportingநநஅஅஅஅf.DEFINE_string('export_dir',அ'',அ'directoryஅinஅwhichஅexportedஅmodelsஅareஅstoredஅ-அifஅomitted,அtheஅmodelஅwon\'tஅgetஅexported')நஅஅஅஅf.DEFINE_boolean('remove_export',அFalse,அ'whetherஅtoஅremoveஅoldஅexportedஅmodels')நஅஅஅஅf.DEFINE_boolean('export_tflite',அFalse,அ'exportஅaஅgraphஅreadyஅforஅTFஅLiteஅengine')நஅஅஅஅf.DEFINE_integer('n_steps',அ00,அ'howஅmanyஅtimestepsஅtoஅprocessஅatஅonceஅbyஅtheஅexportஅgraph,அhigherஅvaluesஅmeanஅmoreஅlatency')நஅஅஅஅf.DEFINE_boolean('export_zip',அFalse,அ'exportஅaஅTFLiteஅmodelஅandஅpackageஅwithஅLMஅandஅinfo.json')நஅஅஅஅf.DEFINE_string('export_file_name',அ'output_graph',அ'nameஅforஅtheஅexportedஅmodelஅfileஅname')நஅஅஅஅf.DEFINE_integer('export_beam_width',அ000,அ'defaultஅbeamஅwidthஅtoஅembedஅintoஅexportedஅgraph')நநஅஅஅஅ#அModelஅmetadataநநஅஅஅஅf.DEFINE_string('export_author_id',அ'author',அ'authorஅofஅtheஅexportedஅmodel.அGitHubஅuserஅorஅorganizationஅnameஅusedஅtoஅuniquelyஅidentifyஅtheஅauthorஅofஅthisஅmodel')நஅஅஅஅf.DEFINE_string('export_model_name',அ'model',அ'nameஅofஅtheஅexportedஅmodel.அMustஅnotஅcontainஅforwardஅslashes.')நஅஅஅஅf.DEFINE_string('export_model_version',அ'0.0.0',அ'semanticஅversionஅofஅtheஅexportedஅmodel.அSeeஅhttps://semver.org/.அThisஅisஅfullyஅcontrolledஅbyஅyouஅasஅauthorஅofஅtheஅmodelஅandஅhasஅnoஅrequiredஅconnectionஅwithஅDeepSpeechஅversions')நநஅஅஅஅdefஅstr_val_equals_help(name,அval_desc):நஅஅஅஅஅஅஅஅf.DEFINE_string(name,அ'<{}>'.format(val_desc),அval_desc)நநஅஅஅஅstr_val_equals_help('export_contact_info',அ'publicஅcontactஅinformationஅofஅtheஅauthor.அCanஅbeஅanஅemailஅaddress,அorஅaஅlinkஅtoஅaஅcontactஅform,அissueஅtracker,அorஅdiscussionஅforum.அMustஅprovideஅaஅwayஅtoஅreachஅtheஅmodelஅauthors')நஅஅஅஅstr_val_equals_help('export_license',அ'SPDXஅidentifierஅofஅtheஅlicenseஅofஅtheஅexportedஅmodel.அSeeஅhttps://spdx.org/licenses/.அIfஅtheஅlicenseஅdoesஅnotஅhaveஅanஅSPDXஅidentifier,அuseஅtheஅlicenseஅname.')நஅஅஅஅstr_val_equals_help('export_language',அ'languageஅtheஅmodelஅwasஅtrainedஅonஅ-அIETFஅBCPஅ00அlanguageஅtagஅincludingஅatஅleastஅlanguage,அscriptஅandஅregionஅsubtags.அE.g.அ"en-Latn-UK"அorஅ"de-Latn-DE"அorஅ"cmn-Hans-CN".அIncludeஅasஅmuchஅinfoஅasஅyouஅcanஅwithoutஅlossஅofஅprecision.அForஅexample,அifஅaஅmodelஅisஅtrainedஅonஅScottishஅEnglish,அincludeஅtheஅvariantஅsubtag:அ"en-Latn-GB-Scotland".')நஅஅஅஅstr_val_equals_help('export_min_ds_version',அ'minimumஅDeepSpeechஅversionஅ(inclusive)அtheஅexportedஅmodelஅisஅcompatibleஅwith')நஅஅஅஅstr_val_equals_help('export_max_ds_version',அ'maximumஅDeepSpeechஅversionஅ(inclusive)அtheஅexportedஅmodelஅisஅcompatibleஅwith')நஅஅஅஅstr_val_equals_help('export_description',அ'Freeformஅdescriptionஅofஅtheஅmodelஅbeingஅexported.அMarkdownஅaccepted.அYouஅcanஅalsoஅleaveஅthisஅflagஅunchangedஅandஅeditஅtheஅgeneratedஅ.mdஅfileஅdirectly.அUsefulஅthingsஅtoஅdescribeஅareஅdemographicஅandஅacousticஅcharacteristicsஅofஅtheஅdataஅusedஅtoஅtrainஅtheஅmodel,அanyஅarchitecturalஅchanges,அnamesஅofஅpublicஅdatasetsஅthatஅwereஅusedஅwhenஅapplicable,அhyperparametersஅusedஅforஅtraining,அevaluationஅresultsஅonஅstandardஅbenchmarkஅdatasets,அetc.')நநஅஅஅஅ#அReportingநநஅஅஅஅf.DEFINE_integer('log_level',அ0,அ'logஅlevelஅforஅconsoleஅlogsஅ-அ0:அDEBUG,அ0:அINFO,அ0:அWARN,அ0:அERROR')நஅஅஅஅf.DEFINE_boolean('show_progressbar',அTrue,அ'Showஅprogressஅforஅtraining,அvalidationஅandஅtestingஅprocesses.அLogஅlevelஅshouldஅbeஅ>அ0.')நநஅஅஅஅf.DEFINE_boolean('log_placement',அFalse,அ'whetherஅtoஅlogஅdeviceஅplacementஅofஅtheஅoperatorsஅtoஅtheஅconsole')நஅஅஅஅf.DEFINE_integer('report_count',அ0,அ'numberஅofஅphrasesஅforஅeachஅofஅbestஅWER,அmedianஅWERஅandஅworstஅWERஅtoஅprintஅoutஅduringஅaஅWERஅreport')நநஅஅஅஅf.DEFINE_string('summary_dir',அ'',அ'targetஅdirectoryஅforஅTensorBoardஅsummariesஅ-அdefaultsஅtoஅdirectoryஅ"deepspeech/summaries"அwithinஅuser\'sஅdataஅhomeஅspecifiedஅbyஅtheஅXDGஅBaseஅDirectoryஅSpecification')நநஅஅஅஅf.DEFINE_string('test_output_file',அ'',அ'pathஅtoஅaஅfileஅtoஅsaveஅallஅsrc/decoded/distance/lossஅtuplesஅgeneratedஅduringஅaஅtestஅepoch')நநஅஅஅஅ#அGeometryநநஅஅஅஅf.DEFINE_integer('n_hidden',அ0000,அ'layerஅwidthஅtoஅuseஅwhenஅinitialisingஅlayers')நஅஅஅஅf.DEFINE_boolean('layer_norm',அFalse,அ'wetherஅtoஅuseஅlayer-normalizationஅafterஅeachஅfully-connectedஅlayerஅ(exceptஅtheஅlastஅone)')நநஅஅஅஅ#அInitializationநநஅஅஅஅf.DEFINE_integer('random_seed',அ0000,அ'defaultஅrandomஅseedஅthatஅisஅusedஅtoஅinitializeஅvariables')நநஅஅஅஅ#அEarlyஅStoppingநநஅஅஅஅf.DEFINE_boolean('early_stop',அFalse,அ'Enableஅearlyஅstoppingஅmechanismஅoverஅvalidationஅdataset.அIfஅvalidationஅisஅnotஅbeingஅrun,அearlyஅstoppingஅisஅdisabled.')நஅஅஅஅf.DEFINE_integer('es_epochs',அ00,அ'Numberஅofஅepochsஅwithஅnoஅimprovementஅafterஅwhichஅtrainingஅwillஅbeஅstopped.அLossஅisஅnotஅstoredஅinஅtheஅcheckpointஅsoஅwhenஅcheckpointஅisஅrevivedஅitஅstartsஅtheஅlossஅcalculationஅfromஅstartஅatஅthatஅpoint')நஅஅஅஅf.DEFINE_float('es_min_delta',அ0.00,அ'Minimumஅchangeஅinஅlossஅtoஅqualifyஅasஅanஅimprovement.அThisஅvalueஅwillஅalsoஅbeஅusedஅinஅReduceஅlearningஅrateஅonஅplateau')நநஅஅஅஅ#அReduceஅlearningஅrateஅonஅplateauநநஅஅஅஅf.DEFINE_boolean('reduce_lr_on_plateau',அFalse,அ'Enableஅreducingஅtheஅlearningஅrateஅifஅaஅplateauஅisஅreached.அThisஅisஅtheஅcaseஅifஅtheஅvalidationஅlossஅdidஅnotஅimproveஅforஅsomeஅepochs.')நஅஅஅஅf.DEFINE_integer('plateau_epochs',அ00,அ'NumberஅofஅepochsஅtoஅconsiderஅforஅRLROP.அHasஅtoஅbeஅsmallerஅthanஅes_epochsஅfromஅearlyஅstopping')நஅஅஅஅf.DEFINE_float('plateau_reduction',அ0.0,அ'Multiplicativeஅfactorஅtoஅapplyஅtoஅtheஅcurrentஅlearningஅrateஅifஅaஅplateauஅhasஅoccurred.')நஅஅஅஅf.DEFINE_boolean('force_initialize_learning_rate',அFalse,அ'Forceஅre-initializationஅofஅlearningஅrateஅwhichஅwasஅpreviouslyஅreduced.')நநஅஅஅஅ#அDecoderநநஅஅஅஅf.DEFINE_boolean('bytes_output_mode',அFalse,அ'enableஅBytesஅOutputஅModeஅmode.அWhenஅthisஅisஅusedஅtheஅmodelஅoutputsஅUTF-0அbyteஅvaluesஅdirectlyஅratherஅthanஅusingஅanஅalphabetஅmapping.அTheஅ--alphabet_config_pathஅoptionஅwillஅbeஅignored.அSeeஅtheஅtrainingஅdocumentationஅforஅmoreஅdetails.')நஅஅஅஅf.DEFINE_string('alphabet_config_path',அ'data/alphabet.txt',அ'pathஅtoஅtheஅconfigurationஅfileஅspecifyingஅtheஅalphabetஅusedஅbyஅtheஅnetwork.அSeeஅtheஅcommentஅinஅdata/alphabet.txtஅforஅaஅdescriptionஅofஅtheஅformat.')நஅஅஅஅf.DEFINE_string('scorer_path',அ'',அ'pathஅtoஅtheஅexternalஅscorerஅfile.')நஅஅஅஅf.DEFINE_alias('scorer',அ'scorer_path')நஅஅஅஅf.DEFINE_integer('beam_width',அ0000,அ'beamஅwidthஅusedஅinஅtheஅCTCஅdecoderஅwhenஅbuildingஅcandidateஅtranscriptions')நஅஅஅஅf.DEFINE_float('lm_alpha',அ0.000000000000000,அ'theஅalphaஅhyperparameterஅofஅtheஅCTCஅdecoder.அLanguageஅModelஅweight.')நஅஅஅஅf.DEFINE_float('lm_beta',அ0.0000000000000000,அ'theஅbetaஅhyperparameterஅofஅtheஅCTCஅdecoder.அWordஅinsertionஅweight.')நஅஅஅஅf.DEFINE_float('cutoff_prob',அ0.0,அ'onlyஅconsiderஅcharactersஅuntilஅthisஅprobabilityஅmassஅisஅreached.அ0.0அ=அdisabled.')நஅஅஅஅf.DEFINE_integer('cutoff_top_n',அ000,அ'onlyஅprocessஅthisஅnumberஅofஅcharactersஅsortedஅbyஅprobabilityஅmassஅforஅeachஅtimeஅstep.அIfஅbiggerஅthanஅalphabetஅsize,அdisabled.')நநஅஅஅஅ#அInferenceஅmodeநநஅஅஅஅf.DEFINE_string('one_shot_infer',அ'',அ'one-shotஅinferenceஅmode:அspecifyஅaஅwavஅfileஅandஅtheஅscriptஅwillஅloadஅtheஅcheckpointஅandஅperformஅinferenceஅonஅit.')நநஅஅஅஅ#அOptimizerஅmodeநநஅஅஅஅf.DEFINE_float('lm_alpha_max',அ0,அ'theஅmaximumஅofஅtheஅalphaஅhyperparameterஅofஅtheஅCTCஅdecoderஅexploredஅduringஅhyperparameterஅoptimization.அLanguageஅModelஅweight.')நஅஅஅஅf.DEFINE_float('lm_beta_max',அ0,அ'theஅmaximumஅbetaஅhyperparameterஅofஅtheஅCTCஅdecoderஅexploredஅduringஅhyperparameterஅoptimization.அWordஅinsertionஅweight.')நஅஅஅஅf.DEFINE_integer('n_trials',அ0000,அ'theஅnumberஅofஅtrialsஅtoஅrunஅduringஅhyperparameterஅoptimization.')நநஅஅஅஅ#அRegisterஅvalidatorsஅforஅpathsஅwhichஅrequireஅaஅfileஅtoஅbeஅspecifiedநநஅஅஅஅf.register_validator('alphabet_config_path',நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅos.path.isfile,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmessage='Theஅfileஅpointedஅtoஅbyஅ--alphabet_config_pathஅmustஅexistஅandஅbeஅreadable.')நநஅஅஅஅf.register_validator('one_shot_infer',நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambdaஅvalue:அnotஅvalueஅorஅos.path.isfile(value),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmessage='Theஅfileஅpointedஅtoஅbyஅ--one_shot_inferஅmustஅexistஅandஅbeஅreadable.')நந#அsphinx-doc:அtraining_ref_flags_endந"""நAஅsetஅofஅI/OஅutilsஅthatஅallowஅusஅtoஅopenஅfilesஅonஅremoteஅstorageஅasஅifஅtheyஅwereஅpresentஅlocallyஅandஅaccessநintoஅHDFSஅstorageஅusingஅTensorflow'sஅC++அFileStreamஅAPI.நCurrentlyஅonlyஅincludesஅwrappersஅforஅGoogle'sஅGCS,அbutஅthisஅcanஅeasilyஅbeஅexpandedஅforஅAWSஅS0அbuckets.ந"""நimportஅosநfromஅtensorflow.ioஅimportஅgfileநநநdefஅis_remote_path(path):நஅஅஅஅ"""நஅஅஅஅReturnsஅTrueஅiffஅtheஅpathஅisஅoneஅofஅtheஅremoteஅformatsஅthatஅthisநஅஅஅஅmoduleஅsupportsநஅஅஅஅ"""நஅஅஅஅreturnஅpath.startswith('gs://')அorஅpath.startswith('hdfs://')நநநdefஅpath_exists_remote(path):நஅஅஅஅ"""நஅஅஅஅWrapperஅthatஅallowsஅexistanceஅcheckஅofஅlocalஅandஅremoteஅpathsஅlikeநஅஅஅஅ`gs://...`நஅஅஅஅ"""நஅஅஅஅifஅis_remote_path(path):நஅஅஅஅஅஅஅஅreturnஅgfile.exists(path)நஅஅஅஅreturnஅos.path.exists(path)நநநdefஅcopy_remote(src,அdst,அoverwrite=False):நஅஅஅஅ"""நஅஅஅஅAllowsஅusஅtoஅcopyஅaஅfileஅfromஅlocalஅtoஅremoteஅorஅviceஅversaநஅஅஅஅ"""நஅஅஅஅreturnஅgfile.copy(src,அdst,அoverwrite)நநநdefஅopen_remote(path,அmode='r',அbuffering=-0,அencoding=None,அnewline=None,அclosefd=True,அopener=None):நஅஅஅஅ"""நஅஅஅஅWrapperஅaroundஅopen()அmethodஅthatஅcanஅhandleஅremoteஅpathsஅlikeஅ`gs://...`நஅஅஅஅoffஅGoogleஅCloudஅusingஅTensorflow'sஅIOஅhelpers.நநஅஅஅஅbuffering,அencoding,அnewline,அclosefd,அandஅopenerஅareஅignoredஅforஅremoteஅfilesநநஅஅஅஅThisஅenablesஅusஅtoஅdo:நஅஅஅஅwithஅopen_remote('gs://.....',அmode='w+')அasஅf:நஅஅஅஅஅஅஅஅdoஅsomethingஅwithஅtheஅfileஅf,அwhetherஅorஅnotஅweஅhaveஅlocalஅaccessஅtoஅitநஅஅஅஅ"""நஅஅஅஅifஅis_remote_path(path):நஅஅஅஅஅஅஅஅreturnஅgfile.GFile(path,அmode=mode)நஅஅஅஅreturnஅopen(path,அmode,அbuffering=buffering,அencoding=encoding,அnewline=newline,அclosefd=closefd,அopener=opener)நநநdefஅisdir_remote(path):நஅஅஅஅ"""நஅஅஅஅWrapperஅtoஅcheckஅifஅremoteஅandஅlocalஅpathsஅareஅdirectoriesநஅஅஅஅ"""நஅஅஅஅifஅis_remote_path(path):நஅஅஅஅஅஅஅஅreturnஅgfile.isdir(path)நஅஅஅஅreturnஅos.path.isdir(path)நநநdefஅlistdir_remote(path):நஅஅஅஅ"""நஅஅஅஅWrapperஅtoஅlistஅpathsஅinஅlocalஅdirsஅ(alternativeஅtoஅusingஅaஅglob,அIஅsuppose)நஅஅஅஅ"""நஅஅஅஅifஅis_remote_path(path):நஅஅஅஅஅஅஅஅreturnஅgfile.listdir(path)நஅஅஅஅreturnஅos.listdir(path)நநநdefஅglob_remote(filename):நஅஅஅஅ"""நஅஅஅஅWrapperஅthatஅprovidesஅglobsஅonஅlocalஅandஅremoteஅpathsஅlikeஅ`gs://...`நஅஅஅஅ"""நஅஅஅஅreturnஅgfile.glob(filename)நநநdefஅremove_remote(filename):நஅஅஅஅ"""நஅஅஅஅWrapperஅthatஅcanஅremoveஅlocalஅandஅremoteஅfilesஅlikeஅ`gs://...`நஅஅஅஅ"""நஅஅஅஅ#அConditionalஅimportநஅஅஅஅreturnஅgfile.remove(filename)நimportஅargparseநimportஅimportlibநimportஅosநimportஅreநimportஅsysநநfromஅ.helpersஅimportஅsecs_to_hoursநfromஅcollectionsஅimportஅCounterநநdefஅget_counter():நஅஅஅஅreturnஅCounter({'all':அ0,அ'failed':அ0,அ'invalid_label':அ0,அ'too_short':அ0,அ'too_long':அ0,அ'imported_time':அ0,அ'total_time':அ0})நநdefஅget_imported_samples(counter):நஅஅஅஅreturnஅcounter['all']அ-அcounter['failed']அ-அcounter['too_short']அ-அcounter['too_long']அ-அcounter['invalid_label']நநdefஅprint_import_report(counter,அsample_rate,அmax_secs):நஅஅஅஅprint('Importedஅ%dஅsamples.'அ%அ(get_imported_samples(counter)))நஅஅஅஅifஅcounter['failed']அ>அ0:நஅஅஅஅஅஅஅஅprint('Skippedஅ%dஅsamplesஅthatஅfailedஅuponஅconversion.'அ%அcounter['failed'])நஅஅஅஅifஅcounter['invalid_label']அ>அ0:நஅஅஅஅஅஅஅஅprint('Skippedஅ%dஅsamplesஅthatஅfailedஅonஅtranscriptஅvalidation.'அ%அcounter['invalid_label'])நஅஅஅஅifஅcounter['too_short']அ>அ0:நஅஅஅஅஅஅஅஅprint('Skippedஅ%dஅsamplesஅthatஅwereஅtooஅshortஅtoஅmatchஅtheஅtranscript.'அ%அcounter['too_short'])நஅஅஅஅifஅcounter['too_long']அ>அ0:நஅஅஅஅஅஅஅஅprint('Skippedஅ%dஅsamplesஅthatஅwereஅlongerஅthanஅ%dஅseconds.'அ%அ(counter['too_long'],அmax_secs))நஅஅஅஅprint('Finalஅamountஅofஅimportedஅaudio:அ%sஅfromஅ%s.'அ%அ(secs_to_hours(counter['imported_time']அ/அsample_rate),அsecs_to_hours(counter['total_time']அ/அsample_rate)))நநdefஅget_importers_parser(description):நஅஅஅஅparserஅ=அargparse.ArgumentParser(description=description)நஅஅஅஅparser.add_argument('--validate_label_locale',அhelp='PathஅtoஅaஅPythonஅfileஅdefiningஅaஅ|validate_label|அfunctionஅforஅyourஅlocale.அWARNING:அTHISஅWILLஅADDஅTHISஅFILE\'sஅDIRECTORYஅINTOஅPYTHONPATH.')நஅஅஅஅreturnஅparserநநdefஅget_validate_label(args):நஅஅஅஅ"""நஅஅஅஅExpectsஅanஅargparse.Namespaceஅargumentஅtoஅsearchஅforஅvalidate_label_localeஅparameter.நஅஅஅஅIfஅfound,அthisஅwillஅmodifyஅPython'sஅlibraryஅsearchஅpathஅandஅaddஅtheஅdirectoryஅofஅtheநஅஅஅஅfileஅpointedஅbyஅtheஅvalidate_label_localeஅargument.நநஅஅஅஅ:paramஅargs:அTheஅimporter'sஅCLIஅargumentஅobjectநஅஅஅஅ:typeஅargs:அargparse.Namespaceநநஅஅஅஅ:return:அTheஅuser-suppliedஅvalidate_labelஅfunctionநஅஅஅஅ:type:அfunctionநஅஅஅஅ"""நஅஅஅஅ#அPythonஅ0.0அdoesஅnotஅsupportஅpassingஅaஅpathlib.Pathஅtoஅos.path.*அmethodsநஅஅஅஅifஅ'validate_label_locale'அnotஅinஅargsஅorஅ(args.validate_label_localeஅisஅNone):நஅஅஅஅஅஅஅஅprint('WARNING:அNoஅ--validate_label_localeஅspecified,அyourஅmightஅendஅwithஅinconsistentஅdataset.')நஅஅஅஅஅஅஅஅreturnஅvalidate_label_engநஅஅஅஅvalidate_label_localeஅ=அstr(args.validate_label_locale)நஅஅஅஅifஅnotஅos.path.exists(os.path.abspath(validate_label_locale)):நஅஅஅஅஅஅஅஅprint('ERROR:அInexistentஅ--validate_label_localeஅspecified.அPleaseஅcheck.')நஅஅஅஅஅஅஅஅreturnஅNoneநஅஅஅஅmodule_dirஅ=அos.path.abspath(os.path.dirname(validate_label_locale))நஅஅஅஅsys.path.insert(0,அmodule_dir)நஅஅஅஅfnameஅ=அos.path.basename(validate_label_locale).replace('.py',அ'')நஅஅஅஅlocale_moduleஅ=அimportlib.import_module(fname,அpackage=None)நஅஅஅஅreturnஅlocale_module.validate_labelநந#அValidateஅandஅnormalizeஅtranscriptions.அReturnsஅaஅcleanedஅversionஅofஅtheஅlabelந#அorஅNoneஅifஅit'sஅinvalid.நdefஅvalidate_label_eng(label):நஅஅஅஅ#அForஅnowஅweஅcanஅonlyஅhandleஅ[a-zஅ']நஅஅஅஅifஅre.search(r"[0-0]|[(<\[\]&*{]",அlabel)அisஅnotஅNone:நஅஅஅஅஅஅஅஅreturnஅNoneநநஅஅஅஅlabelஅ=அlabel.replace("-",அ"அ")நஅஅஅஅlabelஅ=அlabel.replace("_",அ"அ")நஅஅஅஅlabelஅ=அre.sub("[அ]{0,}",அ"அ",அlabel)நஅஅஅஅlabelஅ=அlabel.replace(".",அ"")நஅஅஅஅlabelஅ=அlabel.replace(",",அ"")நஅஅஅஅlabelஅ=அlabel.replace(";",அ"")நஅஅஅஅlabelஅ=அlabel.replace("?",அ"")நஅஅஅஅlabelஅ=அlabel.replace("!",அ"")நஅஅஅஅlabelஅ=அlabel.replace(":",அ"")நஅஅஅஅlabelஅ=அlabel.replace("\"",அ"")நஅஅஅஅlabelஅ=அlabel.strip()நஅஅஅஅlabelஅ=அlabel.lower()நநஅஅஅஅreturnஅlabelஅifஅlabelஅelseஅNoneநimportஅsysநimportஅtensorflowஅasஅtfநimportஅtensorflow.compat.v0அasஅtfv0நநfromஅ.flagsஅimportஅFLAGSநfromஅ.loggingஅimportஅlog_info,அlog_error,அlog_warnநநநdefஅ_load_checkpoint(session,அcheckpoint_path,அallow_drop_layers,அallow_lr_init=True):நஅஅஅஅ#அLoadஅtheஅcheckpointஅandஅputஅallஅvariablesஅintoஅloadingஅlistநஅஅஅஅ#அweஅwillஅexcludeஅvariablesஅweஅdoஅnotஅwishஅtoஅloadஅandஅthenநஅஅஅஅ#அweஅwillஅinitializeஅthemஅinsteadநஅஅஅஅckptஅ=அtfv0.train.load_checkpoint(checkpoint_path)நஅஅஅஅvars_in_ckptஅ=அfrozenset(ckpt.get_variable_to_shape_map().keys())நஅஅஅஅload_varsஅ=அset(tfv0.global_variables())நஅஅஅஅinit_varsஅ=அset()நநஅஅஅஅ#அWeஅexplicitlyஅallowஅtheஅlearningஅrateஅvariableஅtoஅbeஅmissingஅforஅbackwardsநஅஅஅஅ#அcompatibilityஅwithஅolderஅcheckpoints.நஅஅஅஅlr_varஅ=அset(vஅforஅvஅinஅload_varsஅifஅv.op.nameஅ==அ'learning_rate')நஅஅஅஅifஅlr_varஅandஅ('learning_rate'அnotஅinஅvars_in_ckptஅorநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(FLAGS.force_initialize_learning_rateஅandஅallow_lr_init)):நஅஅஅஅஅஅஅஅassertஅlen(lr_var)அ<=அ0நஅஅஅஅஅஅஅஅload_varsஅ-=அlr_varநஅஅஅஅஅஅஅஅinit_varsஅ|=அlr_varநநஅஅஅஅifஅFLAGS.load_cudnn:நஅஅஅஅஅஅஅஅ#அInitializeஅtrainingஅfromஅaஅCuDNNஅRNNஅcheckpointநஅஅஅஅஅஅஅஅ#அIdentifyஅtheஅvariablesஅwhichஅweஅcannotஅload,அandஅsetஅthemநஅஅஅஅஅஅஅஅ#அforஅinitializationநஅஅஅஅஅஅஅஅmissing_varsஅ=அset()நஅஅஅஅஅஅஅஅforஅvஅinஅload_vars:நஅஅஅஅஅஅஅஅஅஅஅஅifஅv.op.nameஅnotஅinஅvars_in_ckpt:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_warn('CUDNNஅvariableஅnotஅfound:அ%s'அ%அ(v.op.name))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmissing_vars.add(v)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinit_vars.add(v)நநஅஅஅஅஅஅஅஅload_varsஅ-=அinit_varsநநஅஅஅஅஅஅஅஅ#அCheckஅthatஅtheஅonlyஅmissingஅvariablesஅ(i.e.அthoseஅtoஅbeஅinitialised)நஅஅஅஅஅஅஅஅ#அareஅtheஅAdamஅmomentஅtensors,அifஅtheyஅaren'tஅthenஅweஅhaveஅanஅissueநஅஅஅஅஅஅஅஅmissing_var_namesஅ=அ[v.op.nameஅforஅvஅinஅmissing_vars]நஅஅஅஅஅஅஅஅifஅany('Adam'அnotஅinஅvஅforஅvஅinஅmissing_var_names):நஅஅஅஅஅஅஅஅஅஅஅஅlog_error('TriedஅtoஅloadஅaஅCuDNNஅRNNஅcheckpointஅbutஅthereஅwereஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'moreஅmissingஅvariablesஅthanஅjustஅtheஅAdamஅmomentஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'tensors.அMissingஅvariables:அ{}'.format(missing_var_names))நஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅifஅallow_drop_layersஅandஅFLAGS.drop_source_layersஅ>அ0:நஅஅஅஅஅஅஅஅ#அThisஅtransferஅlearningஅapproachஅrequiresஅsupplyingநஅஅஅஅஅஅஅஅ#அtheஅlayersஅwhichஅweஅexcludeஅfromஅtheஅsourceஅmodel.நஅஅஅஅஅஅஅஅ#அSayஅweஅwantஅtoஅexcludeஅallஅlayersஅexceptஅforஅtheஅfirstஅone,நஅஅஅஅஅஅஅஅ#அthenஅweஅareஅdroppingஅfiveஅlayersஅtotal,அso:அdrop_source_layers=0நஅஅஅஅஅஅஅஅ#அIfஅweஅwantஅtoஅuseஅallஅlayersஅfromஅtheஅsourceஅmodelஅexceptநஅஅஅஅஅஅஅஅ#அtheஅlastஅone,அweஅuseஅthis:அdrop_source_layers=0நஅஅஅஅஅஅஅஅifஅFLAGS.drop_source_layersஅ>=அ0:நஅஅஅஅஅஅஅஅஅஅஅஅlog_warn('Theஅcheckpointஅonlyஅhasஅ0அlayers,அbutஅyouஅareஅtryingஅtoஅdropஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'allஅofஅthemஅorஅmoreஅthanஅallஅofஅthem.அContinuingஅandஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'droppingஅonlyஅ0அlayers.')நஅஅஅஅஅஅஅஅஅஅஅஅFLAGS.drop_source_layersஅ=அ0நநஅஅஅஅஅஅஅஅdropped_layersஅ=அ['0',அ'0',அ'lstm',அ'0',அ'0'][-0அ*அint(FLAGS.drop_source_layers):]நஅஅஅஅஅஅஅஅ#அInitializeஅallஅvariablesஅneededஅforஅDS,அbutஅnotஅloadedஅfromஅckptநஅஅஅஅஅஅஅஅforஅvஅinஅload_vars:நஅஅஅஅஅஅஅஅஅஅஅஅifஅany(layerஅinஅv.op.nameஅforஅlayerஅinஅdropped_layers):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinit_vars.add(v)நஅஅஅஅஅஅஅஅload_varsஅ-=அinit_varsநநஅஅஅஅforஅvஅinஅsorted(load_vars,அkey=lambdaஅv:அv.op.name):நஅஅஅஅஅஅஅஅlog_info('Loadingஅvariableஅfromஅcheckpoint:அ%s'அ%அ(v.op.name))நஅஅஅஅஅஅஅஅv.load(ckpt.get_tensor(v.op.name),அsession=session)நநஅஅஅஅforஅvஅinஅsorted(init_vars,அkey=lambdaஅv:அv.op.name):நஅஅஅஅஅஅஅஅlog_info('Initializingஅvariable:அ%s'அ%அ(v.op.name))நஅஅஅஅஅஅஅஅsession.run(v.initializer)நநநdefஅ_checkpoint_path_or_none(checkpoint_filename):நஅஅஅஅcheckpointஅ=அtfv0.train.get_checkpoint_state(FLAGS.load_checkpoint_dir,அcheckpoint_filename)நஅஅஅஅifஅnotஅcheckpoint:நஅஅஅஅஅஅஅஅreturnஅNoneநஅஅஅஅreturnஅcheckpoint.model_checkpoint_pathநநநdefஅ_initialize_all_variables(session):நஅஅஅஅinit_varsஅ=அtfv0.global_variables()நஅஅஅஅforஅvஅinஅinit_vars:நஅஅஅஅஅஅஅஅsession.run(v.initializer)நநநdefஅ_load_or_init_impl(session,அmethod_order,அallow_drop_layers,அallow_lr_init=True):நஅஅஅஅforஅmethodஅinஅmethod_order:நஅஅஅஅஅஅஅஅ#அLoadஅbestஅvalidatingஅcheckpoint,அsavedஅinஅcheckpointஅfileஅ'best_dev_checkpoint'நஅஅஅஅஅஅஅஅifஅmethodஅ==அ'best':நஅஅஅஅஅஅஅஅஅஅஅஅckpt_pathஅ=அ_checkpoint_path_or_none('best_dev_checkpoint')நஅஅஅஅஅஅஅஅஅஅஅஅifஅckpt_path:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Loadingஅbestஅvalidatingஅcheckpointஅfromஅ{}'.format(ckpt_path))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅ_load_checkpoint(session,அckpt_path,அallow_drop_layers,அallow_lr_init=allow_lr_init)நஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Couldஅnotஅfindஅbestஅvalidatingஅcheckpoint.')நநஅஅஅஅஅஅஅஅ#அLoadஅmostஅrecentஅcheckpoint,அsavedஅinஅcheckpointஅfileஅ'checkpoint'நஅஅஅஅஅஅஅஅelifஅmethodஅ==அ'last':நஅஅஅஅஅஅஅஅஅஅஅஅckpt_pathஅ=அ_checkpoint_path_or_none('checkpoint')நஅஅஅஅஅஅஅஅஅஅஅஅifஅckpt_path:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Loadingஅmostஅrecentஅcheckpointஅfromஅ{}'.format(ckpt_path))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅ_load_checkpoint(session,அckpt_path,அallow_drop_layers,அallow_lr_init=allow_lr_init)நஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Couldஅnotஅfindஅmostஅrecentஅcheckpoint.')நநஅஅஅஅஅஅஅஅ#அInitializeஅallஅvariablesநஅஅஅஅஅஅஅஅelifஅmethodஅ==அ'init':நஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Initializingஅallஅvariables.')நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅ_initialize_all_variables(session)நநஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅlog_error('Unknownஅinitializationஅmethod:அ{}'.format(method))நஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅlog_error('Allஅinitializationஅmethodsஅfailedஅ({}).'.format(method_order))நஅஅஅஅsys.exit(0)நநநdefஅreload_best_checkpoint(session):நஅஅஅஅ_load_or_init_impl(session,அ['best'],அallow_drop_layers=False,அallow_lr_init=False)நநநdefஅload_or_init_graph_for_training(session):நஅஅஅஅ'''நஅஅஅஅLoadஅvariablesஅfromஅcheckpointஅorஅinitializeஅvariables.அByஅdefaultஅthisஅwillநஅஅஅஅtryஅtoஅloadஅtheஅbestஅvalidatingஅcheckpoint,அthenஅtryஅtheஅlastஅcheckpoint,நஅஅஅஅandஅfinallyஅinitializeஅtheஅweightsஅfromஅscratch.அThisஅcanஅbeஅoverridenஅwithநஅஅஅஅtheஅ`--load_train`அflag.அSeeஅitsஅdocumentationஅforஅmoreஅinfo.நஅஅஅஅ'''நஅஅஅஅifஅFLAGS.load_trainஅ==அ'auto':நஅஅஅஅஅஅஅஅmethodsஅ=அ['best',அ'last',அ'init']நஅஅஅஅelse:நஅஅஅஅஅஅஅஅmethodsஅ=அ[FLAGS.load_train]நஅஅஅஅ_load_or_init_impl(session,அmethods,அallow_drop_layers=True)நநநdefஅload_graph_for_evaluation(session):நஅஅஅஅ'''நஅஅஅஅLoadஅvariablesஅfromஅcheckpoint.அInitializationஅisஅnotஅallowed.அByஅdefaultநஅஅஅஅthisஅwillஅtryஅtoஅloadஅtheஅbestஅvalidatingஅcheckpoint,அthenஅtryஅtheஅlastநஅஅஅஅcheckpoint.அThisஅcanஅbeஅoverridenஅwithஅtheஅ`--load_evaluate`அflag.அSeeஅitsநஅஅஅஅdocumentationஅforஅmoreஅinfo.நஅஅஅஅ'''நஅஅஅஅifஅFLAGS.load_evaluateஅ==அ'auto':நஅஅஅஅஅஅஅஅmethodsஅ=அ['best',அ'last']நஅஅஅஅelse:நஅஅஅஅஅஅஅஅmethodsஅ=அ[FLAGS.load_evaluate]நஅஅஅஅ_load_or_init_impl(session,அmethods,அallow_drop_layers=False)நfromஅ__future__அimportஅabsolute_import,அdivision,அprint_functionநநimportஅnumpyஅasஅnpநimportஅstructநநdefஅtext_to_char_array(transcript,அalphabet,அcontext=''):நஅஅஅஅr"""நஅஅஅஅGivenஅaஅtranscriptஅstring,அmapஅcharactersஅtoநஅஅஅஅintegersஅandஅreturnஅaஅnumpyஅarrayஅrepresentingஅtheஅprocessedஅstring.நஅஅஅஅUseஅaஅstringஅinஅ`context`அforஅaddingஅtextஅtoஅraisedஅexceptions.நஅஅஅஅ"""நஅஅஅஅifஅnotஅalphabet.CanEncode(transcript):நஅஅஅஅஅஅஅஅ#அProvideஅtheஅrowஅcontextஅ(especiallyஅwav_filename)அforஅalphabetஅerrorsநஅஅஅஅஅஅஅஅraiseஅValueError(நஅஅஅஅஅஅஅஅஅஅஅஅ'Alphabetஅcannotஅencodeஅtranscriptஅ"{}"அwhileஅprocessingஅsampleஅ"{}",அ'நஅஅஅஅஅஅஅஅஅஅஅஅ'checkஅthatஅyourஅalphabetஅcontainsஅallஅcharactersஅinஅtheஅtrainingஅcorpus.அ'நஅஅஅஅஅஅஅஅஅஅஅஅ'Missingஅcharactersஅare:அ{}.'நஅஅஅஅஅஅஅஅஅஅஅஅ.format(transcript,அcontext,அlist(chஅforஅchஅinஅtranscriptஅifஅnotஅalphabet.CanEncodeSingle(ch))))நநஅஅஅஅencodedஅ=அalphabet.Encode(transcript)நஅஅஅஅifஅlen(encoded)அ==அ0:நஅஅஅஅஅஅஅஅraiseஅValueError('Whileஅprocessingஅ{}:அFoundஅanஅemptyஅtranscript!அ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'Youஅmustஅincludeஅaஅtranscriptஅforஅallஅtrainingஅdata.'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.format(context))நஅஅஅஅreturnஅencodedநநந#அTheஅfollowingஅcodeஅisஅfrom:அhttp://hetland.org/coding/python/levenshtein.pyநந#அThisஅisஅaஅstraightforwardஅimplementationஅofஅaஅwell-knownஅalgorithm,அandஅthusந#அprobablyஅshouldn'tஅbeஅcoveredஅbyஅcopyrightஅtoஅbeginஅwith.அButஅinஅcaseஅitஅis,ந#அtheஅauthorஅ(MagnusஅLieஅHetland)அhas,அtoஅtheஅextentஅpossibleஅunderஅlaw,ந#அdedicatedஅallஅcopyrightஅandஅrelatedஅandஅneighboringஅrightsஅtoஅthisஅsoftwareந#அtoஅtheஅpublicஅdomainஅworldwide,அbyஅdistributingஅitஅunderஅtheஅCC0அlicense,ந#அversionஅ0.0.அThisஅsoftwareஅisஅdistributedஅwithoutஅanyஅwarranty.அForஅmoreந#அinformation,அseeஅ<http://creativecommons.org/publicdomain/zero/0.0>நநdefஅlevenshtein(a,அb):நஅஅஅஅ"CalculatesஅtheஅLevenshteinஅdistanceஅbetweenஅaஅandஅb."நஅஅஅஅn,அmஅ=அlen(a),அlen(b)நஅஅஅஅifஅnஅ>அm:நஅஅஅஅஅஅஅஅ#அMakeஅsureஅnஅ<=அm,அtoஅuseஅO(min(n,m))அspaceநஅஅஅஅஅஅஅஅa,அbஅ=அb,அaநஅஅஅஅஅஅஅஅn,அmஅ=அm,அnநநஅஅஅஅcurrentஅ=அlist(range(n+0))நஅஅஅஅforஅiஅinஅrange(0,அm+0):நஅஅஅஅஅஅஅஅprevious,அcurrentஅ=அcurrent,அ[i]+[0]*nநஅஅஅஅஅஅஅஅforஅjஅinஅrange(0,அn+0):நஅஅஅஅஅஅஅஅஅஅஅஅadd,அdeleteஅ=அprevious[j]+0,அcurrent[j-0]+0நஅஅஅஅஅஅஅஅஅஅஅஅchangeஅ=அprevious[j-0]நஅஅஅஅஅஅஅஅஅஅஅஅifஅa[j-0]அ!=அb[i-0]:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅchangeஅ=அchangeஅ+அ0நஅஅஅஅஅஅஅஅஅஅஅஅcurrent[j]அ=அmin(add,அdelete,அchange)நநஅஅஅஅreturnஅcurrent[n]ந"""நUsage:நஅFromஅwithinஅtheஅtraining/அdirectory,அcallஅthisஅscriptஅasஅaஅmodule:நநஅஅஅஅஅஅஅ$அpython0அ-mஅdeepspeech_training.util.check_charactersஅ"INFILE"நஅe.g.அஅ$அpython0அ-mஅdeepspeech_training.util.check_charactersஅ-csvஅ/home/data/french.csvநஅe.g.அஅ$அpython0அ-mஅdeepspeech_training.util.check_charactersஅ-csvஅ../train.csv,../test.csvநஅe.g.அஅ$அpython0அ-mஅdeepspeech_training.util.check_charactersஅ-alphaஅ-csvஅ../train.csvநநPointஅthisஅscriptஅtoஅyourஅtranscripts,அandஅitஅreturnsநtoஅtheஅterminalஅtheஅuniqueஅsetஅofஅcharactersஅinஅthoseநfilesஅ(combined).நநTheseஅfilesஅareஅassumedஅtoஅbeஅcsv,அwithஅtheஅtranscriptஅbeingஅtheஅthirdஅfield.நநTheஅscriptஅsimplyஅreadsஅallஅtheஅtextஅfromஅallஅtheஅfiles,நstoringஅaஅsetஅofஅuniqueஅcharactersஅthatஅwereஅseenநalongஅtheஅway.ந"""நimportஅargparseநimportஅcsvநimportஅosநimportஅsysநimportஅunicodedataநfromஅ.ioஅimportஅopen_remoteநநdefஅmain():நஅஅஅஅparserஅ=அargparse.ArgumentParser()நநஅஅஅஅparser.add_argument("-csv",அ"--csv-files",அhelp="Str.அFilenamesஅasஅaஅcommaஅseparatedஅlist",அrequired=True)நஅஅஅஅparser.add_argument("-alpha",அ"--alphabet-format",அhelp="Bool.அPrintஅinஅformatஅforஅalphabet.txt",அaction="store_true")நஅஅஅஅparser.add_argument("-unicode",அ"--disable-unicode-variants",அhelp="Bool.அDISABLEஅcheckஅforஅunicodeஅconsistencyஅ(useஅwithஅ--alphabet-format)",அaction="store_true")நஅஅஅஅargsஅ=அparser.parse_args()நஅஅஅஅin_filesஅ=அargs.csv_files.split(",")நநஅஅஅஅprint("###அReadingஅinஅtheஅfollowingஅtranscriptஅfiles:அ###")நஅஅஅஅprint("###அ{}அ###".format(in_files))நநஅஅஅஅall_textஅ=அset()நஅஅஅஅforஅin_fileஅinஅin_files:நஅஅஅஅஅஅஅஅwithஅopen_remote(in_file,அ"r")அasஅcsv_file:நஅஅஅஅஅஅஅஅஅஅஅஅreaderஅ=அcsv.reader(csv_file)நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnext(reader,அNone)அஅ#அskipஅtheஅfileஅheaderஅ(i.e.அ"transcript")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅrowஅinஅreader:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅargs.disable_unicode_variants:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅunicode_transcriptஅ=அunicodedata.normalize("NFKC",அrow[0])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅrow[0]அ!=அunicode_transcript:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("Yourஅinputஅfile",அin_file,அ"containsஅatஅleastஅoneஅtransriptஅwithஅunicodeஅcharsஅonஅmoreஅthanஅoneஅcode-point:அ'{}'.அConsiderஅusingஅNFKCஅnormalization:அunicodedata.normalize('NFKC',அstr).".format(row[0]))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(-0)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅall_textஅ|=அset(row[0])நஅஅஅஅஅஅஅஅஅஅஅஅexceptஅIndexError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint("Yourஅinputஅfile",அin_file,அ"isஅnotஅformattedஅproperly.அCheckஅifஅthereஅareஅ0அcolumnsஅwithஅtheஅ0rdஅcontainingஅtheஅtranscript")நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(-0)நஅஅஅஅஅஅஅஅஅஅஅஅfinally:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcsv_file.close()நநஅஅஅஅprint("###அTheஅfollowingஅuniqueஅcharactersஅwereஅfoundஅinஅyourஅtranscripts:அ###")நஅஅஅஅifஅargs.alphabet_format:நஅஅஅஅஅஅஅஅforஅcharஅinஅlist(all_text):நஅஅஅஅஅஅஅஅஅஅஅஅprint(char)நஅஅஅஅஅஅஅஅprint("###அ^^^அYouஅcanஅcopy-pasteஅtheseஅintoஅdata/alphabet.txtஅ###")நஅஅஅஅelse:நஅஅஅஅஅஅஅஅprint(list(all_text))நநifஅ__name__அ==அ'__main__':நஅஅஅஅmain()நimportஅcollectionsநimportஅctypesநimportஅioநimportஅmathநimportஅnumpyஅasஅnpநimportஅosநimportஅpyoggநimportஅtempfileநimportஅwaveநநfromஅ.helpersஅimportஅLimitingPoolநfromஅcollectionsஅimportஅnamedtupleநfromஅ.ioஅimportஅopen_remote,அremove_remote,அcopy_remote,அis_remote_pathநநAudioFormatஅ=அnamedtuple('AudioFormat',அ'rateஅchannelsஅwidth')நநDEFAULT_RATEஅ=அ00000நDEFAULT_CHANNELSஅ=அ0நDEFAULT_WIDTHஅ=அ0நDEFAULT_FORMATஅ=அAudioFormat(DEFAULT_RATE,அDEFAULT_CHANNELS,அDEFAULT_WIDTH)நநAUDIO_TYPE_NPஅ=அ'application/vnd.mozilla.np'நAUDIO_TYPE_PCMஅ=அ'application/vnd.mozilla.pcm'நAUDIO_TYPE_WAVஅ=அ'audio/wav'நAUDIO_TYPE_OPUSஅ=அ'application/vnd.mozilla.opus'நAUDIO_TYPE_OGG_OPUSஅ=அ'application/vnd.deepspeech.ogg_opus'நநSERIALIZABLE_AUDIO_TYPESஅ=அ[AUDIO_TYPE_WAV,அAUDIO_TYPE_OPUS,அAUDIO_TYPE_OGG_OPUS]நநOPUS_PCM_LEN_SIZEஅ=அ0நOPUS_RATE_SIZEஅ=அ0நOPUS_CHANNELS_SIZEஅ=அ0நOPUS_WIDTH_SIZEஅ=அ0நOPUS_CHUNK_LEN_SIZEஅ=அ0நநநclassஅSample:நஅஅஅஅ"""நஅஅஅஅRepresentsஅin-memoryஅaudioஅdataஅofஅaஅcertainஅ(convertible)அrepresentation.நநஅஅஅஅAttributesநஅஅஅஅ----------நஅஅஅஅaudio_typeஅ:அstrநஅஅஅஅஅஅஅஅSeeஅ`__init__`.நஅஅஅஅaudio_formatஅ:அutil.audio.AudioFormatநஅஅஅஅஅஅஅஅSeeஅ`__init__`.நஅஅஅஅaudioஅ:அbinaryநஅஅஅஅஅஅஅஅAudioஅdataஅrepresentedஅasஅindicatedஅbyஅ`audio_type`நஅஅஅஅdurationஅ:அfloatநஅஅஅஅஅஅஅஅAudioஅdurationஅofஅtheஅsampleஅinஅsecondsநஅஅஅஅ"""நஅஅஅஅdefஅ__init__(self,அaudio_type,அraw_data,அaudio_format=None,அsample_id=None):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅaudio_typeஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅAudioஅdataஅrepresentationஅtypeநஅஅஅஅஅஅஅஅஅஅஅஅSupportedஅtypes:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ-அutil.audio.AUDIO_TYPE_OPUS:அMemoryஅfileஅrepresentationஅ(BytesIO)அofஅOpusஅencodedஅaudioநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwrappedஅbyஅaஅcustomஅcontainerஅformatஅ(usedஅinஅSDBs)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ-அutil.audio.AUDIO_TYPE_WAV:அMemoryஅfileஅrepresentationஅ(BytesIO)அofஅaஅWaveஅfileநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ-அutil.audio.AUDIO_TYPE_PCM:அBinaryஅrepresentationஅ(bytearray)அofஅPCMஅencodedஅaudioஅdataஅ(Waveஅfileஅwithoutஅheader)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ-அutil.audio.AUDIO_TYPE_NP:அNumPyஅrepresentationஅofஅaudioஅdataஅ(np.float00)அ-அtypicallyஅusedஅforஅGPUஅfeedingநஅஅஅஅஅஅஅஅraw_dataஅ:அbinaryநஅஅஅஅஅஅஅஅஅஅஅஅAudioஅdataஅinஅtheஅformஅofஅtheஅprovidedஅrepresentationஅtypeஅ(seeஅaudio_type).நஅஅஅஅஅஅஅஅஅஅஅஅForஅtypesஅutil.audio.AUDIO_TYPE_OPUSஅorஅutil.audio.AUDIO_TYPE_WAVஅdataஅcanஅalsoஅbeஅpassedஅasஅaஅbytearray.நஅஅஅஅஅஅஅஅaudio_formatஅ:அutil.audio.AudioFormatநஅஅஅஅஅஅஅஅஅஅஅஅRequiredஅinஅcaseஅofஅaudio_typeஅ=அutil.audio.AUDIO_TYPE_PCMஅorஅutil.audio.AUDIO_TYPE_NP,நஅஅஅஅஅஅஅஅஅஅஅஅasஅthisஅinformationஅcannotஅbeஅderivedஅfromஅrawஅaudioஅdata.நஅஅஅஅஅஅஅஅsample_idஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅTrackingஅIDஅ-அshouldஅindicateஅsample'sஅoriginஅasஅpreciselyஅasஅpossibleநஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅself.audio_typeஅ=அaudio_typeநஅஅஅஅஅஅஅஅself.audio_formatஅ=அaudio_formatநஅஅஅஅஅஅஅஅself.sample_idஅ=அsample_idநஅஅஅஅஅஅஅஅifஅaudio_typeஅinஅSERIALIZABLE_AUDIO_TYPES:நஅஅஅஅஅஅஅஅஅஅஅஅself.audioஅ=அraw_dataஅifஅisinstance(raw_data,அio.BytesIO)அelseஅio.BytesIO(raw_data)நஅஅஅஅஅஅஅஅஅஅஅஅself.durationஅ=அread_duration(audio_type,அself.audio)நஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅself.audio_format:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.audio_formatஅ=அread_format(audio_type,அself.audio)நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅself.audioஅ=அraw_dataநஅஅஅஅஅஅஅஅஅஅஅஅifஅself.audio_formatஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Forஅaudioஅtypeஅ"{}"அparameterஅ"audio_format"அisஅmandatory'.format(self.audio_type))நஅஅஅஅஅஅஅஅஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_PCM:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.durationஅ=அget_pcm_duration(len(self.audio),அself.audio_format)நஅஅஅஅஅஅஅஅஅஅஅஅelifஅaudio_typeஅ==அAUDIO_TYPE_NP:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.durationஅ=அget_np_duration(len(self.audio),அself.audio_format)நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Unsupportedஅaudioஅtype:அ{}'.format(self.audio_type))நநஅஅஅஅdefஅchange_audio_type(self,அnew_audio_type,அbitrate=None):நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅIn-placeஅconversionஅofஅaudioஅdataஅintoஅaஅdifferentஅrepresentation.நநஅஅஅஅஅஅஅஅParametersநஅஅஅஅஅஅஅஅ----------நஅஅஅஅஅஅஅஅnew_audio_typeஅ:அstrநஅஅஅஅஅஅஅஅஅஅஅஅNewஅaudio-typeஅ-அseeஅ`__init__`.நஅஅஅஅஅஅஅஅbitrateஅ:அintநஅஅஅஅஅஅஅஅஅஅஅஅBitrateஅtoஅuseஅinஅcaseஅofஅconvertingஅtoஅaஅlossyஅaudio-type.நஅஅஅஅஅஅஅஅ"""நஅஅஅஅஅஅஅஅifஅself.audio_typeஅ==அnew_audio_type:நஅஅஅஅஅஅஅஅஅஅஅஅreturnநஅஅஅஅஅஅஅஅifஅnew_audio_typeஅ==அAUDIO_TYPE_PCMஅandஅself.audio_typeஅinஅSERIALIZABLE_AUDIO_TYPES:நஅஅஅஅஅஅஅஅஅஅஅஅself.audio_format,அaudioஅ=அread_audio(self.audio_type,அself.audio)நஅஅஅஅஅஅஅஅஅஅஅஅself.audio.close()நஅஅஅஅஅஅஅஅஅஅஅஅself.audioஅ=அaudioநஅஅஅஅஅஅஅஅelifஅnew_audio_typeஅ==அAUDIO_TYPE_PCMஅandஅself.audio_typeஅ==அAUDIO_TYPE_NP:நஅஅஅஅஅஅஅஅஅஅஅஅself.audioஅ=அnp_to_pcm(self.audio,அself.audio_format)நஅஅஅஅஅஅஅஅelifஅnew_audio_typeஅ==அAUDIO_TYPE_NP:நஅஅஅஅஅஅஅஅஅஅஅஅself.change_audio_type(AUDIO_TYPE_PCM)நஅஅஅஅஅஅஅஅஅஅஅஅself.audioஅ=அpcm_to_np(self.audio,அself.audio_format)நஅஅஅஅஅஅஅஅelifஅnew_audio_typeஅinஅSERIALIZABLE_AUDIO_TYPES:நஅஅஅஅஅஅஅஅஅஅஅஅself.change_audio_type(AUDIO_TYPE_PCM)நஅஅஅஅஅஅஅஅஅஅஅஅaudio_bytesஅ=அio.BytesIO()நஅஅஅஅஅஅஅஅஅஅஅஅwrite_audio(new_audio_type,அaudio_bytes,அself.audio,அaudio_format=self.audio_format,அbitrate=bitrate)நஅஅஅஅஅஅஅஅஅஅஅஅaudio_bytes.seek(0)நஅஅஅஅஅஅஅஅஅஅஅஅself.audioஅ=அaudio_bytesநஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅRuntimeError('Changingஅaudioஅrepresentationஅtypeஅfromஅ"{}"அtoஅ"{}"அnotஅsupported'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.format(self.audio_type,அnew_audio_type))நஅஅஅஅஅஅஅஅself.audio_typeஅ=அnew_audio_typeநநநdefஅ_unpack_and_change_audio_type(sample_and_audio_type):நஅஅஅஅpacked_sample,அaudio_type,அbitrateஅ=அsample_and_audio_typeநஅஅஅஅifஅhasattr(packed_sample,அ'unpack'):நஅஅஅஅஅஅஅஅsampleஅ=அpacked_sample.unpack()நஅஅஅஅelse:நஅஅஅஅஅஅஅஅsampleஅ=அpacked_sampleநஅஅஅஅsample.change_audio_type(audio_type,அbitrate=bitrate)நஅஅஅஅreturnஅsampleநநநdefஅchange_audio_types(packed_samples,அaudio_type=AUDIO_TYPE_PCM,அbitrate=None,அprocesses=None,அprocess_ahead=None):நஅஅஅஅwithஅLimitingPool(processes=processes,அprocess_ahead=process_ahead)அasஅpool:நஅஅஅஅஅஅஅஅyieldஅfromஅpool.imap(_unpack_and_change_audio_type,அmap(lambdaஅs:அ(s,அaudio_type,அbitrate),அpacked_samples))நநநdefஅget_loadable_audio_type_from_extension(ext):நஅஅஅஅreturnஅ{நஅஅஅஅஅஅஅஅ'.wav':அAUDIO_TYPE_WAV,நஅஅஅஅஅஅஅஅ'.opus':அAUDIO_TYPE_OGG_OPUS,நஅஅஅஅ}.get(ext,அNone)நநநdefஅread_audio_format_from_wav_file(wav_file):நஅஅஅஅreturnஅAudioFormat(wav_file.getframerate(),அwav_file.getnchannels(),அwav_file.getsampwidth())நநநdefஅget_num_samples(pcm_buffer_size,அaudio_format=DEFAULT_FORMAT):நஅஅஅஅreturnஅpcm_buffer_sizeஅ//அ(audio_format.channelsஅ*அaudio_format.width)நநநdefஅget_pcm_duration(pcm_buffer_size,அaudio_format=DEFAULT_FORMAT):நஅஅஅஅ"""CalculatesஅdurationஅinஅsecondsஅofஅaஅbinaryஅPCMஅbufferஅ(typicallyஅreadஅfromஅaஅWAVஅfile)"""நஅஅஅஅreturnஅget_num_samples(pcm_buffer_size,அaudio_format)அ/அaudio_format.rateநநநdefஅget_np_duration(np_len,அaudio_format=DEFAULT_FORMAT):நஅஅஅஅ"""CalculatesஅdurationஅinஅsecondsஅofஅNumPyஅaudioஅdata"""நஅஅஅஅreturnஅnp_lenஅ/அaudio_format.rateநநநdefஅconvert_audio(src_audio_path,அdst_audio_path,அfile_type=None,அaudio_format=DEFAULT_FORMAT):நஅஅஅஅimportஅsoxநஅஅஅஅtransformerஅ=அsox.Transformer()நஅஅஅஅtransformer.set_output_format(file_type=file_type,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrate=audio_format.rate,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅchannels=audio_format.channels,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbits=audio_format.widthஅ*அ0)நஅஅஅஅtransformer.build(src_audio_path,அdst_audio_path)நநநclassஅAudioFile:நஅஅஅஅ"""நஅஅஅஅAudioஅdataஅfileஅwrapperஅthatஅensuresஅthatஅtheஅfileஅisஅloadedஅwithஅtheஅcorrectஅsampleஅrate,அchannels,நஅஅஅஅandஅwidth,அandஅconvertsஅtheஅfileஅonஅtheஅflyஅotherwise.நஅஅஅஅ"""நஅஅஅஅdefஅ__init__(self,அaudio_path,அas_path=False,அaudio_format=DEFAULT_FORMAT):நஅஅஅஅஅஅஅஅself.audio_pathஅ=அaudio_pathநஅஅஅஅஅஅஅஅself.audio_formatஅ=அaudio_formatநஅஅஅஅஅஅஅஅself.as_pathஅ=அas_pathநஅஅஅஅஅஅஅஅself.open_fileஅ=அNoneநஅஅஅஅஅஅஅஅself.open_wavஅ=அNoneநஅஅஅஅஅஅஅஅself.tmp_file_pathஅ=அNoneநஅஅஅஅஅஅஅஅself.tmp_src_file_pathஅ=அNoneநநஅஅஅஅdefஅ__enter__(self):நஅஅஅஅஅஅஅஅifஅself.audio_path.endswith('.wav'):நஅஅஅஅஅஅஅஅஅஅஅஅself.open_fileஅ=அopen_remote(self.audio_path,அ'rb')நஅஅஅஅஅஅஅஅஅஅஅஅself.open_wavஅ=அwave.open(self.open_file)நஅஅஅஅஅஅஅஅஅஅஅஅifஅread_audio_format_from_wav_file(self.open_wav)அ==அself.audio_format:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅself.as_path:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.open_wav.close()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.open_file.close()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅself.audio_pathநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅself.open_wavநஅஅஅஅஅஅஅஅஅஅஅஅself.open_wav.close()நஅஅஅஅஅஅஅஅஅஅஅஅself.open_file.close()நநஅஅஅஅஅஅஅஅ#அIfஅtheஅformatஅisn'tஅright,அcopyஅtheஅfileஅtoஅlocalஅtmpஅdirஅandஅdoஅtheஅconversionஅonஅdiskநஅஅஅஅஅஅஅஅifஅis_remote_path(self.audio_path):நஅஅஅஅஅஅஅஅஅஅஅஅ_,அself.tmp_src_file_pathஅ=அtempfile.mkstemp(suffix='.wav')நஅஅஅஅஅஅஅஅஅஅஅஅcopy_remote(self.audio_path,அself.tmp_src_file_path,அTrue)நஅஅஅஅஅஅஅஅஅஅஅஅself.audio_pathஅ=அself.tmp_src_file_pathநநஅஅஅஅஅஅஅஅ_,அself.tmp_file_pathஅ=அtempfile.mkstemp(suffix='.wav')நஅஅஅஅஅஅஅஅconvert_audio(self.audio_path,அself.tmp_file_path,அfile_type='wav',அaudio_format=self.audio_format)நஅஅஅஅஅஅஅஅifஅself.as_path:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅself.tmp_file_pathநஅஅஅஅஅஅஅஅself.open_wavஅ=அwave.open(self.tmp_file_path,அ'rb')நஅஅஅஅஅஅஅஅreturnஅself.open_wavநநஅஅஅஅdefஅ__exit__(self,அ*args):நஅஅஅஅஅஅஅஅifஅnotஅself.as_path:நஅஅஅஅஅஅஅஅஅஅஅஅself.open_wav.close()நஅஅஅஅஅஅஅஅஅஅஅஅifஅself.open_file:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.open_file.close()நஅஅஅஅஅஅஅஅifஅself.tmp_file_pathஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅos.remove(self.tmp_file_path)நஅஅஅஅஅஅஅஅifஅself.tmp_src_file_pathஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅos.remove(self.tmp_src_file_path)நநநdefஅread_frames(wav_file,அframe_duration_ms=00,அyield_remainder=False):நஅஅஅஅaudio_formatஅ=அread_audio_format_from_wav_file(wav_file)நஅஅஅஅframe_sizeஅ=அint(audio_format.rateஅ*அ(frame_duration_msஅ/அ0000.0))நஅஅஅஅwhileஅTrue:நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅdataஅ=அwav_file.readframes(frame_size)நஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅyield_remainderஅandஅget_pcm_duration(len(data),அaudio_format)அ*அ0000அ<அframe_duration_ms:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbreakநஅஅஅஅஅஅஅஅஅஅஅஅyieldஅdataநஅஅஅஅஅஅஅஅexceptஅEOFError:நஅஅஅஅஅஅஅஅஅஅஅஅbreakநநநdefஅread_frames_from_file(audio_path,அaudio_format=DEFAULT_FORMAT,அframe_duration_ms=00,அyield_remainder=False):நஅஅஅஅwithஅAudioFile(audio_path,அaudio_format=audio_format)அasஅwav_file:நஅஅஅஅஅஅஅஅforஅframeஅinஅread_frames(wav_file,அframe_duration_ms=frame_duration_ms,அyield_remainder=yield_remainder):நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅframeநநநdefஅvad_split(audio_frames,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudio_format=DEFAULT_FORMAT,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅnum_padding_frames=00,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅthreshold=0.0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅaggressiveness=0):நஅஅஅஅfromஅwebrtcvadஅimportஅVadஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅifஅaudio_format.channelsஅ!=அ0:நஅஅஅஅஅஅஅஅraiseஅValueError('VAD-splittingஅrequiresஅmonoஅsamples')நஅஅஅஅifஅaudio_format.widthஅ!=அ0:நஅஅஅஅஅஅஅஅraiseஅValueError('VAD-splittingஅrequiresஅ00அbitஅsamples')நஅஅஅஅifஅaudio_format.rateஅnotஅinஅ[0000,அ00000,அ00000,அ00000]:நஅஅஅஅஅஅஅஅraiseஅValueError('VAD-splittingஅonlyஅsupportedஅforஅsampleஅratesஅ0000,அ00000,அ00000,அorஅ00000')நஅஅஅஅifஅaggressivenessஅnotஅinஅ[0,அ0,அ0,அ0]:நஅஅஅஅஅஅஅஅraiseஅValueError('VAD-splittingஅaggressivenessஅmodeஅhasஅtoஅbeஅoneஅofஅ0,அ0,அ0,அorஅ0')நஅஅஅஅring_bufferஅ=அcollections.deque(maxlen=num_padding_frames)நஅஅஅஅtriggeredஅ=அFalseநஅஅஅஅvadஅ=அVad(int(aggressiveness))நஅஅஅஅvoiced_framesஅ=அ[]நஅஅஅஅframe_duration_msஅ=அ0நஅஅஅஅframe_indexஅ=அ0நஅஅஅஅforஅframe_index,அframeஅinஅenumerate(audio_frames):நஅஅஅஅஅஅஅஅframe_duration_msஅ=அget_pcm_duration(len(frame),அaudio_format)அ*அ0000நஅஅஅஅஅஅஅஅifஅint(frame_duration_ms)அnotஅinஅ[00,அ00,அ00]:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('VAD-splittingஅonlyஅsupportedஅforஅframeஅdurationsஅ00,அ00,அorஅ00அms')நஅஅஅஅஅஅஅஅis_speechஅ=அvad.is_speech(frame,அaudio_format.rate)நஅஅஅஅஅஅஅஅifஅnotஅtriggered:நஅஅஅஅஅஅஅஅஅஅஅஅring_buffer.append((frame,அis_speech))நஅஅஅஅஅஅஅஅஅஅஅஅnum_voicedஅ=அlen([fஅforஅf,அspeechஅinஅring_bufferஅifஅspeech])நஅஅஅஅஅஅஅஅஅஅஅஅifஅnum_voicedஅ>அthresholdஅ*அring_buffer.maxlen:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtriggeredஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅf,அsஅinஅring_buffer:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅvoiced_frames.append(f)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅring_buffer.clear()நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅvoiced_frames.append(frame)நஅஅஅஅஅஅஅஅஅஅஅஅring_buffer.append((frame,அis_speech))நஅஅஅஅஅஅஅஅஅஅஅஅnum_unvoicedஅ=அlen([fஅforஅf,அspeechஅinஅring_bufferஅifஅnotஅspeech])நஅஅஅஅஅஅஅஅஅஅஅஅifஅnum_unvoicedஅ>அthresholdஅ*அring_buffer.maxlen:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtriggeredஅ=அFalseநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅyieldஅb''.join(voiced_frames),அ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅframe_duration_msஅ*அmax(0,அframe_indexஅ-அlen(voiced_frames)),அ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅframe_duration_msஅ*அframe_indexநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅring_buffer.clear()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅvoiced_framesஅ=அ[]நஅஅஅஅifஅlen(voiced_frames)அ>அ0:நஅஅஅஅஅஅஅஅyieldஅb''.join(voiced_frames),அ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅframe_duration_msஅ*அ(frame_indexஅ-அlen(voiced_frames)),அ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅframe_duration_msஅ*அ(frame_indexஅ+அ0)நநநdefஅpack_number(n,அnum_bytes):நஅஅஅஅreturnஅn.to_bytes(num_bytes,அ'big',அsigned=False)நநநdefஅunpack_number(data):நஅஅஅஅreturnஅint.from_bytes(data,அ'big',அsigned=False)நநநdefஅget_opus_frame_size(rate):நஅஅஅஅreturnஅ00அ*அrateஅ//அ0000நநநdefஅwrite_opus(opus_file,அaudio_data,அaudio_format=DEFAULT_FORMAT,அbitrate=None):நஅஅஅஅframe_sizeஅ=அget_opus_frame_size(audio_format.rate)நஅஅஅஅimportஅopuslibஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅencoderஅ=அopuslib.Encoder(audio_format.rate,அaudio_format.channels,அ'audio')நஅஅஅஅifஅbitrateஅisஅnotஅNone:நஅஅஅஅஅஅஅஅencoder.bitrateஅ=அbitrateநஅஅஅஅchunk_sizeஅ=அframe_sizeஅ*அaudio_format.channelsஅ*அaudio_format.widthநஅஅஅஅopus_file.write(pack_number(len(audio_data),அOPUS_PCM_LEN_SIZE))நஅஅஅஅopus_file.write(pack_number(audio_format.rate,அOPUS_RATE_SIZE))நஅஅஅஅopus_file.write(pack_number(audio_format.channels,அOPUS_CHANNELS_SIZE))நஅஅஅஅopus_file.write(pack_number(audio_format.width,அOPUS_WIDTH_SIZE))நஅஅஅஅforஅiஅinஅrange(0,அlen(audio_data),அchunk_size):நஅஅஅஅஅஅஅஅchunkஅ=அaudio_data[i:iஅ+அchunk_size]நஅஅஅஅஅஅஅஅ#அPreventingஅnon-deterministicஅencodingஅresultsஅfromஅuninitializedஅremainderஅofஅtheஅencoderஅbufferநஅஅஅஅஅஅஅஅifஅlen(chunk)அ<அchunk_size:நஅஅஅஅஅஅஅஅஅஅஅஅchunkஅ=அchunkஅ+அb'\0'அ*அ(chunk_sizeஅ-அlen(chunk))நஅஅஅஅஅஅஅஅencodedஅ=அencoder.encode(chunk,அframe_size)நஅஅஅஅஅஅஅஅopus_file.write(pack_number(len(encoded),அOPUS_CHUNK_LEN_SIZE))நஅஅஅஅஅஅஅஅopus_file.write(encoded)நநநdefஅread_opus_header(opus_file):நஅஅஅஅopus_file.seek(0)நஅஅஅஅpcm_buffer_sizeஅ=அunpack_number(opus_file.read(OPUS_PCM_LEN_SIZE))நஅஅஅஅrateஅ=அunpack_number(opus_file.read(OPUS_RATE_SIZE))நஅஅஅஅchannelsஅ=அunpack_number(opus_file.read(OPUS_CHANNELS_SIZE))நஅஅஅஅwidthஅ=அunpack_number(opus_file.read(OPUS_WIDTH_SIZE))நஅஅஅஅreturnஅpcm_buffer_size,அAudioFormat(rate,அchannels,அwidth)நநநdefஅread_opus(opus_file):நஅஅஅஅpcm_buffer_size,அaudio_formatஅ=அread_opus_header(opus_file)நஅஅஅஅframe_sizeஅ=அget_opus_frame_size(audio_format.rate)நஅஅஅஅimportஅopuslibஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅdecoderஅ=அopuslib.Decoder(audio_format.rate,அaudio_format.channels)நஅஅஅஅaudio_dataஅ=அbytearray()நஅஅஅஅwhileஅlen(audio_data)அ<அpcm_buffer_size:நஅஅஅஅஅஅஅஅchunk_lenஅ=அunpack_number(opus_file.read(OPUS_CHUNK_LEN_SIZE))நஅஅஅஅஅஅஅஅchunkஅ=அopus_file.read(chunk_len)நஅஅஅஅஅஅஅஅdecodedஅ=அdecoder.decode(chunk,அframe_size)நஅஅஅஅஅஅஅஅaudio_data.extend(decoded)நஅஅஅஅaudio_dataஅ=அaudio_data[:pcm_buffer_size]நஅஅஅஅreturnஅaudio_format,அbytes(audio_data)நநநdefஅread_ogg_opus(ogg_file):நஅஅஅஅerrorஅ=அctypes.c_int()நஅஅஅஅogg_file_bufferஅ=அogg_file.getbuffer()நஅஅஅஅubyte_arrayஅ=அctypes.c_ubyteஅ*அlen(ogg_file_buffer)நஅஅஅஅopusfileஅ=அpyogg.opus.op_open_memory(நஅஅஅஅஅஅஅஅubyte_array.from_buffer(ogg_file_buffer),நஅஅஅஅஅஅஅஅlen(ogg_file_buffer),நஅஅஅஅஅஅஅஅctypes.pointer(error)நஅஅஅஅ)நநஅஅஅஅifஅerror.valueஅ!=அ0:நஅஅஅஅஅஅஅஅraiseஅValueError(நஅஅஅஅஅஅஅஅஅஅஅஅ("Ogg/Opusஅbufferஅcouldஅnotஅbeஅread."நஅஅஅஅஅஅஅஅஅஅஅஅஅ"Errorஅcode:அ{}").format(error.value)நஅஅஅஅஅஅஅஅ)நநஅஅஅஅchannel_countஅ=அpyogg.opus.op_channel_count(opusfile,அ-0)நஅஅஅஅsample_rateஅ=அ00000அ#அopusஅfilesஅareஅalwaysஅ00kHzநஅஅஅஅsample_widthஅ=அ0அ#அalwaysஅ00-bitநஅஅஅஅaudio_formatஅ=அAudioFormat(sample_rate,அchannel_count,அsample_width)நநஅஅஅஅ#அAllocateஅsufficientஅmemoryஅtoஅstoreஅtheஅentireஅPCMநஅஅஅஅpcm_sizeஅ=அpyogg.opus.op_pcm_total(opusfile,அ-0)நஅஅஅஅBufஅ=அpyogg.opus.opus_int00*(pcm_size*channel_count)நஅஅஅஅbufஅ=அBuf()நநஅஅஅஅ#அCreateஅaஅpointerஅtoஅtheஅnewlyஅallocatedஅmemory.அஅItநஅஅஅஅ#அseemsஅweஅcanஅonlyஅdoஅpointerஅarithmeticஅonஅvoidநஅஅஅஅ#அpointers.அஅSeeநஅஅஅஅ#அhttps://mattgwwalker.wordpress.com/0000/00/00/pointer-manipulation-in-python/நஅஅஅஅbuf_ptrஅ=அctypes.cast(நஅஅஅஅஅஅஅஅctypes.pointer(buf),நஅஅஅஅஅஅஅஅctypes.c_void_pநஅஅஅஅ)நஅஅஅஅassertஅbuf_ptr.valueஅisஅnotஅNoneஅ#அforஅmypyநஅஅஅஅbuf_ptr_zeroஅ=அbuf_ptr.valueநநஅஅஅஅ#:அBytesஅperஅsampleநஅஅஅஅbytes_per_sampleஅ=அctypes.sizeof(pyogg.opus.opus_int00)நநஅஅஅஅ#அReadஅthroughஅtheஅentireஅfile,அcopyingஅtheஅPCMஅintoஅtheநஅஅஅஅ#அbufferநஅஅஅஅsamplesஅ=அ0நஅஅஅஅwhileஅTrue:நஅஅஅஅஅஅஅஅ#அCalculateஅremainingஅbufferஅsizeநஅஅஅஅஅஅஅஅremaining_bufferஅ=அ(நஅஅஅஅஅஅஅஅஅஅஅஅlen(buf)அ#அintநஅஅஅஅஅஅஅஅஅஅஅஅ-அ(buf_ptr.valueஅ-அbuf_ptr_zero)அ//அbytes_per_sampleநஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅ#அConvertஅbufferஅpointerஅtoஅtheஅdesiredஅtypeநஅஅஅஅஅஅஅஅptrஅ=அctypes.cast(நஅஅஅஅஅஅஅஅஅஅஅஅbuf_ptr,நஅஅஅஅஅஅஅஅஅஅஅஅctypes.POINTER(pyogg.opus.opus_int00)நஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅ#அReadஅtheஅnextஅsectionஅofஅPCMநஅஅஅஅஅஅஅஅnsஅ=அpyogg.opus.op_read(நஅஅஅஅஅஅஅஅஅஅஅஅopusfile,நஅஅஅஅஅஅஅஅஅஅஅஅptr,நஅஅஅஅஅஅஅஅஅஅஅஅremaining_buffer,நஅஅஅஅஅஅஅஅஅஅஅஅpyogg.ogg.c_int_p()நஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅ#அCheckஅforஅerrorsநஅஅஅஅஅஅஅஅifஅnsஅ<அ0:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"ErrorஅwhileஅreadingஅOggOpusஅbuffer.அ"+நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"Errorஅcode:அ{}".format(ns)நஅஅஅஅஅஅஅஅஅஅஅஅ)நநஅஅஅஅஅஅஅஅ#அIncrementஅtheஅpointerநஅஅஅஅஅஅஅஅbuf_ptr.valueஅ+=அ(நஅஅஅஅஅஅஅஅஅஅஅஅnsநஅஅஅஅஅஅஅஅஅஅஅஅ*அbytes_per_sampleநஅஅஅஅஅஅஅஅஅஅஅஅ*அchannel_countநஅஅஅஅஅஅஅஅ)நஅஅஅஅஅஅஅஅassertஅbuf_ptr.valueஅisஅnotஅNoneஅ#அforஅmypyநநஅஅஅஅஅஅஅஅsamplesஅ+=அnsநநஅஅஅஅஅஅஅஅ#அCheckஅifஅwe'veஅfinishedநஅஅஅஅஅஅஅஅifஅnsஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅbreakநநஅஅஅஅ#அCloseஅtheஅopenஅfileநஅஅஅஅpyogg.opus.op_free(opusfile)நநஅஅஅஅ#அCastஅbufferஅtoஅaஅone-dimensionalஅarrayஅofஅcharsநஅஅஅஅ#:அRawஅPCMஅdataஅfromஅaudioஅfile.நஅஅஅஅCharBufferஅ=அctypes.c_byteஅ*அ(bytes_per_sampleஅ*அchannel_countஅ*அpcm_size)நஅஅஅஅaudio_dataஅ=அCharBuffer.from_buffer(buf)நநஅஅஅஅreturnஅaudio_format,அaudio_dataநநநdefஅwrite_wav(wav_file,அpcm_data,அaudio_format=DEFAULT_FORMAT):நஅஅஅஅ#அwav_fileஅisஅalreadyஅaஅfile-pointerஅhereநஅஅஅஅwithஅwave.open(wav_file,அ'wb')அasஅwav_file_writer:நஅஅஅஅஅஅஅஅwav_file_writer.setframerate(audio_format.rate)நஅஅஅஅஅஅஅஅwav_file_writer.setnchannels(audio_format.channels)நஅஅஅஅஅஅஅஅwav_file_writer.setsampwidth(audio_format.width)நஅஅஅஅஅஅஅஅwav_file_writer.writeframes(pcm_data)நநநdefஅread_wav(wav_file):நஅஅஅஅwav_file.seek(0)நஅஅஅஅwithஅwave.open(wav_file,அ'rb')அasஅwav_file_reader:நஅஅஅஅஅஅஅஅaudio_formatஅ=அread_audio_format_from_wav_file(wav_file_reader)நஅஅஅஅஅஅஅஅpcm_dataஅ=அwav_file_reader.readframes(wav_file_reader.getnframes())நஅஅஅஅஅஅஅஅreturnஅaudio_format,அpcm_dataநநநdefஅread_audio(audio_type,அaudio_file):நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_WAV:நஅஅஅஅஅஅஅஅreturnஅread_wav(audio_file)நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_OPUS:நஅஅஅஅஅஅஅஅreturnஅread_opus(audio_file)நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_OGG_OPUS:நஅஅஅஅஅஅஅஅreturnஅread_ogg_opus(audio_file)நஅஅஅஅraiseஅValueError('Unsupportedஅaudioஅtype:அ{}'.format(audio_type))நநநdefஅwrite_audio(audio_type,அaudio_file,அpcm_data,அaudio_format=DEFAULT_FORMAT,அbitrate=None):நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_WAV:நஅஅஅஅஅஅஅஅreturnஅwrite_wav(audio_file,அpcm_data,அaudio_format=audio_format)நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_OPUS:நஅஅஅஅஅஅஅஅreturnஅwrite_opus(audio_file,அpcm_data,அaudio_format=audio_format,அbitrate=bitrate)நஅஅஅஅraiseஅValueError('Unsupportedஅaudioஅtype:அ{}'.format(audio_type))நநநdefஅread_wav_duration(wav_file):நஅஅஅஅwav_file.seek(0)நஅஅஅஅwithஅwave.open(wav_file,அ'rb')அasஅwav_file_reader:நஅஅஅஅஅஅஅஅreturnஅwav_file_reader.getnframes()அ/அwav_file_reader.getframerate()நநநdefஅread_opus_duration(opus_file):நஅஅஅஅpcm_buffer_size,அaudio_formatஅ=அread_opus_header(opus_file)நஅஅஅஅreturnஅget_pcm_duration(pcm_buffer_size,அaudio_format)நநநdefஅread_ogg_opus_duration(ogg_file):நஅஅஅஅerrorஅ=அctypes.c_int()நஅஅஅஅogg_file_bufferஅ=அogg_file.getbuffer()நஅஅஅஅubyte_arrayஅ=அctypes.c_ubyteஅ*அlen(ogg_file_buffer)நஅஅஅஅopusfileஅ=அpyogg.opus.op_open_memory(நஅஅஅஅஅஅஅஅubyte_array.from_buffer(ogg_file_buffer),நஅஅஅஅஅஅஅஅlen(ogg_file_buffer),நஅஅஅஅஅஅஅஅctypes.pointer(error)நஅஅஅஅ)நநஅஅஅஅifஅerror.valueஅ!=அ0:நஅஅஅஅஅஅஅஅraiseஅValueError(நஅஅஅஅஅஅஅஅஅஅஅஅ("Ogg/Opusஅbufferஅcouldஅnotஅbeஅread."நஅஅஅஅஅஅஅஅஅஅஅஅஅ"Errorஅcode:அ{}").format(error.value)நஅஅஅஅஅஅஅஅ)நநஅஅஅஅpcm_buffer_sizeஅ=அpyogg.opus.op_pcm_total(opusfile,அ-0)நஅஅஅஅchannel_countஅ=அpyogg.opus.op_channel_count(opusfile,அ-0)நஅஅஅஅsample_rateஅ=அ00000அ#அopusஅfilesஅareஅalwaysஅ00kHzநஅஅஅஅsample_widthஅ=அ0அ#அalwaysஅ00-bitநஅஅஅஅaudio_formatஅ=அAudioFormat(sample_rate,அchannel_count,அsample_width)நஅஅஅஅpyogg.opus.op_free(opusfile)நஅஅஅஅreturnஅget_pcm_duration(pcm_buffer_size,அaudio_format)நநநdefஅread_duration(audio_type,அaudio_file):நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_WAV:நஅஅஅஅஅஅஅஅreturnஅread_wav_duration(audio_file)நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_OPUS:நஅஅஅஅஅஅஅஅreturnஅread_opus_duration(audio_file)நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_OGG_OPUS:நஅஅஅஅஅஅஅஅreturnஅread_ogg_opus_duration(audio_file)நஅஅஅஅraiseஅValueError('Unsupportedஅaudioஅtype:அ{}'.format(audio_type))நநநdefஅread_wav_format(wav_file):நஅஅஅஅwav_file.seek(0)நஅஅஅஅwithஅwave.open(wav_file,அ'rb')அasஅwav_file_reader:நஅஅஅஅஅஅஅஅreturnஅread_audio_format_from_wav_file(wav_file_reader)நநநdefஅread_opus_format(opus_file):நஅஅஅஅ_,அaudio_formatஅ=அread_opus_header(opus_file)நஅஅஅஅreturnஅaudio_formatநநநdefஅread_ogg_opus_format(ogg_file):நஅஅஅஅerrorஅ=அctypes.c_int()நஅஅஅஅogg_file_bufferஅ=அogg_file.getbuffer()நஅஅஅஅubyte_arrayஅ=அctypes.c_ubyteஅ*அlen(ogg_file_buffer)நஅஅஅஅopusfileஅ=அpyogg.opus.op_open_memory(நஅஅஅஅஅஅஅஅubyte_array.from_buffer(ogg_file_buffer),நஅஅஅஅஅஅஅஅlen(ogg_file_buffer),நஅஅஅஅஅஅஅஅctypes.pointer(error)நஅஅஅஅ)நநஅஅஅஅifஅerror.valueஅ!=அ0:நஅஅஅஅஅஅஅஅraiseஅValueError(நஅஅஅஅஅஅஅஅஅஅஅஅ("Ogg/Opusஅbufferஅcouldஅnotஅbeஅread."நஅஅஅஅஅஅஅஅஅஅஅஅஅ"Errorஅcode:அ{}").format(error.value)நஅஅஅஅஅஅஅஅ)நநஅஅஅஅchannel_countஅ=அpyogg.opus.op_channel_count(opusfile,அ-0)நஅஅஅஅpyogg.opus.op_free(opusfile)நநஅஅஅஅsample_rateஅ=அ00000அ#அopusஅfilesஅareஅalwaysஅ00kHzநஅஅஅஅsample_widthஅ=அ0அ#அalwaysஅ00-bitநஅஅஅஅreturnஅAudioFormat(sample_rate,அchannel_count,அsample_width)நநநdefஅread_format(audio_type,அaudio_file):நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_WAV:நஅஅஅஅஅஅஅஅreturnஅread_wav_format(audio_file)நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_OPUS:நஅஅஅஅஅஅஅஅreturnஅread_opus_format(audio_file)நஅஅஅஅifஅaudio_typeஅ==அAUDIO_TYPE_OGG_OPUS:நஅஅஅஅஅஅஅஅreturnஅread_ogg_opus_format(audio_file)நஅஅஅஅraiseஅValueError('Unsupportedஅaudioஅtype:அ{}'.format(audio_type))நநநdefஅget_dtype(audio_format):நஅஅஅஅifஅaudio_format.widthஅnotஅinஅ[0,அ0,அ0]:நஅஅஅஅஅஅஅஅraiseஅValueError('Unsupportedஅsampleஅwidth:அ{}'.format(audio_format.width))நஅஅஅஅreturnஅ[None,அnp.int0,அnp.int00,அNone,அnp.int00][audio_format.width]நநநdefஅpcm_to_np(pcm_data,அaudio_format=DEFAULT_FORMAT):நஅஅஅஅ"""நஅஅஅஅConvertsஅPCMஅdataஅ(e.g.அreadஅfromஅaஅwavfile)அintoஅaஅmonoஅnumpyஅcolumnஅvectorநஅஅஅஅwithஅvaluesஅinஅtheஅrangeஅ[0.0,அ0.0].நஅஅஅஅ"""நஅஅஅஅ#அHandlesஅbothஅmonoஅandஅsteroஅaudioநஅஅஅஅdtypeஅ=அget_dtype(audio_format)நஅஅஅஅsamplesஅ=அnp.frombuffer(pcm_data,அdtype=dtype)நநஅஅஅஅ#அReadஅinterleavedஅchannelsநஅஅஅஅnchannelsஅ=அaudio_format.channelsநஅஅஅஅsamplesஅ=அsamples.reshape((int(len(samples)/nchannels),அnchannels))நஅஅஅஅநஅஅஅஅ#அConvertஅtoஅ0.0-0.0அrangeநஅஅஅஅsamplesஅ=அsamples.astype(np.float00)அ/அnp.iinfo(dtype).maxநநஅஅஅஅ#அAverageஅmulti-channelஅclipsஅintoஅmonoஅandஅturnஅintoஅcolumnஅvectorநஅஅஅஅreturnஅnp.expand_dims(np.mean(samples,அaxis=0),அaxis=0)நநநdefஅnp_to_pcm(np_data,அaudio_format=DEFAULT_FORMAT):நஅஅஅஅdtypeஅ=அget_dtype(audio_format)நஅஅஅஅnp_dataஅ=அnp_data.squeeze()நஅஅஅஅnp_dataஅ=அnp_dataஅ*அnp.iinfo(dtype).maxநஅஅஅஅnp_dataஅ=அnp_data.astype(dtype)நஅஅஅஅreturnஅnp_data.tobytes()நநநdefஅrms_to_dbfs(rms):நஅஅஅஅreturnஅ00.0அ*அmath.log00(max(0e-00,அrms))அ+அ0.0000நநநdefஅmax_dbfs(sample_data):நஅஅஅஅ#அPeakஅdBFSஅbasedஅonஅtheஅmaximumஅenergyஅsample.அWillஅpreventஅoverdriveஅifஅusedஅforஅnormalization.நஅஅஅஅreturnஅrms_to_dbfs(max(abs(np.min(sample_data)),அabs(np.max(sample_data))))நநநdefஅmean_dbfs(sample_data):நஅஅஅஅreturnஅrms_to_dbfs(math.sqrt(np.mean(np.square(sample_data,அdtype=np.float00))))நநநdefஅgain_db_to_ratio(gain_db):நஅஅஅஅreturnஅmath.pow(00.0,அgain_dbஅ/அ00.0)நநநdefஅnormalize_audio(sample_data,அdbfs=0.0000):நஅஅஅஅreturnஅnp.maximum(np.minimum(sample_dataஅ*அgain_db_to_ratio(dbfsஅ-அmax_dbfs(sample_data)),அ0.0),அ-0.0)நimportஅcodecsநimportஅunicodedataநநclassஅSTMSegment(object):நஅஅஅஅr"""நஅஅஅஅRepresentationஅofஅanஅindividualஅsegmentஅinஅanஅSTMஅfile.நஅஅஅஅ"""நஅஅஅஅdefஅ__init__(self,அstm_line):நஅஅஅஅஅஅஅஅtokensஅ=அstm_line.split()நஅஅஅஅஅஅஅஅself._filenameஅஅஅஅ=அtokens[0]நஅஅஅஅஅஅஅஅself._channelஅஅஅஅஅ=அtokens[0]நஅஅஅஅஅஅஅஅself._speaker_idஅஅ=அtokens[0]நஅஅஅஅஅஅஅஅself._start_timeஅஅ=அfloat(tokens[0])நஅஅஅஅஅஅஅஅself._stop_timeஅஅஅ=அfloat(tokens[0])நஅஅஅஅஅஅஅஅself._labelsஅஅஅஅஅஅ=அtokens[0]நஅஅஅஅஅஅஅஅself._transcriptஅஅ=அ""நஅஅஅஅஅஅஅஅforஅtokenஅinஅtokens[0:]:நஅஅஅஅஅஅஅஅஅஅself._transcriptஅ+=அtokenஅ+அ"அ"நஅஅஅஅஅஅஅஅ#அWeஅneedஅtoஅdoஅtheஅencode-decodeஅdanceஅhereஅbecauseஅencodeநஅஅஅஅஅஅஅஅ#அreturnsஅaஅbytes()அobjectஅonஅPythonஅ0,அandஅtext_to_char_arrayநஅஅஅஅஅஅஅஅ#அexpectsஅaஅstring.நஅஅஅஅஅஅஅஅself._transcriptஅ=அunicodedata.normalize("NFKD",அself._transcript.strip())அஅ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.encode("ascii",அ"ignore")அஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.decode("ascii",அ"ignore")நநஅஅஅஅ@propertyநஅஅஅஅdefஅfilename(self):நஅஅஅஅஅஅஅஅreturnஅself._filenameநநஅஅஅஅ@propertyநஅஅஅஅdefஅchannel(self):நஅஅஅஅஅஅஅஅreturnஅself._channelநநஅஅஅஅ@propertyநஅஅஅஅdefஅspeaker_id(self):நஅஅஅஅஅஅஅஅreturnஅself._speaker_idநநஅஅஅஅ@propertyநஅஅஅஅdefஅstart_time(self):நஅஅஅஅஅஅஅஅreturnஅself._start_timeநநஅஅஅஅ@propertyநஅஅஅஅdefஅstop_time(self):நஅஅஅஅஅஅஅஅreturnஅself._stop_timeநநஅஅஅஅ@propertyநஅஅஅஅdefஅlabels(self):நஅஅஅஅஅஅஅஅreturnஅself._labelsநநஅஅஅஅ@propertyநஅஅஅஅdefஅtranscript(self):நஅஅஅஅஅஅஅஅreturnஅself._transcriptநநdefஅparse_stm_file(stm_file):நஅஅஅஅr"""நஅஅஅஅParsesஅanஅSTMஅfileஅatஅ``stm_file``அintoஅaஅlistஅofஅ:class:`STMSegment`.நஅஅஅஅ"""நஅஅஅஅstm_segmentsஅ=அ[]நஅஅஅஅwithஅcodecs.open(stm_file,அencoding="utf-0")அasஅstm_lines:நஅஅஅஅஅஅஅஅforஅstm_lineஅinஅstm_lines:நஅஅஅஅஅஅஅஅஅஅஅஅstmSegmentஅ=அSTMSegment(stm_line)நஅஅஅஅஅஅஅஅஅஅஅஅifஅnotஅ"ignore_time_segment_in_scoring"அ==அstmSegment.transcript:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstm_segments.append(stmSegment)நஅஅஅஅreturnஅstm_segmentsநfromஅtensorflow.python.clientஅimportஅdevice_libநநநdefஅget_available_gpus(config):நஅஅஅஅr"""நஅஅஅஅReturnsஅtheஅnumberஅofஅGPUsஅavailableஅonஅthisஅsystem.நஅஅஅஅ"""நஅஅஅஅlocal_device_protosஅ=அdevice_lib.list_local_devices(session_config=config)நஅஅஅஅreturnஅ[x.nameஅforஅxஅinஅlocal_device_protosஅifஅx.device_typeஅ==அ'GPU']ந#!/usr/bin/envஅpythonந#அ-*-அcoding:அutf-0அ-*-நfromஅ__future__அimportஅabsolute_import,அdivision,அprint_functionநநimportஅjsonநfromஅmultiprocessing.dummyஅimportஅPoolநநimportஅnumpyஅasஅnpநfromஅattrdictஅimportஅAttrDictநநfromஅ.flagsஅimportஅFLAGSநfromஅ.textஅimportஅlevenshteinநfromஅ.ioஅimportஅopen_remoteநநdefஅpmap(fun,அiterable):நஅஅஅஅpoolஅ=அPool()நஅஅஅஅresultsஅ=அpool.map(fun,அiterable)நஅஅஅஅpool.close()நஅஅஅஅreturnஅresultsநநநdefஅwer_cer_batch(samples):நஅஅஅஅr"""நஅஅஅஅTheஅWERஅisஅdefinedஅasஅtheஅedit/Levenshteinஅdistanceஅonஅwordஅlevelஅdividedஅbyநஅஅஅஅtheஅamountஅofஅwordsஅinஅtheஅoriginalஅtext.நஅஅஅஅInஅcaseஅofஅtheஅoriginalஅhavingஅmoreஅwordsஅ(N)அthanஅtheஅresultஅandஅbothநஅஅஅஅbeingஅtotallyஅdifferentஅ(allஅNஅwordsஅresultingஅinஅ0அeditஅoperationஅeach),நஅஅஅஅtheஅWERஅwillஅalwaysஅbeஅ0அ(Nஅ/அNஅ=அ0).நஅஅஅஅ"""நஅஅஅஅwerஅ=அsum(s.word_distanceஅforஅsஅinஅsamples)அ/அsum(s.word_lengthஅforஅsஅinஅsamples)நஅஅஅஅcerஅ=அsum(s.char_distanceஅforஅsஅinஅsamples)அ/அsum(s.char_lengthஅforஅsஅinஅsamples)நநஅஅஅஅwerஅ=அmin(wer,அ0.0)நஅஅஅஅcerஅ=அmin(cer,அ0.0)நநஅஅஅஅreturnஅwer,அcerநநநdefஅprocess_decode_result(item):நஅஅஅஅwav_filename,அground_truth,அprediction,அlossஅ=அitemநஅஅஅஅchar_distanceஅ=அlevenshtein(ground_truth,அprediction)நஅஅஅஅchar_lengthஅ=அlen(ground_truth)நஅஅஅஅword_distanceஅ=அlevenshtein(ground_truth.split(),அprediction.split())நஅஅஅஅword_lengthஅ=அlen(ground_truth.split())நஅஅஅஅreturnஅAttrDict({நஅஅஅஅஅஅஅஅ'wav_filename':அwav_filename,நஅஅஅஅஅஅஅஅ'src':அground_truth,நஅஅஅஅஅஅஅஅ'res':அprediction,நஅஅஅஅஅஅஅஅ'loss':அloss,நஅஅஅஅஅஅஅஅ'char_distance':அchar_distance,நஅஅஅஅஅஅஅஅ'char_length':அchar_length,நஅஅஅஅஅஅஅஅ'word_distance':அword_distance,நஅஅஅஅஅஅஅஅ'word_length':அword_length,நஅஅஅஅஅஅஅஅ'cer':அchar_distanceஅ/அchar_length,நஅஅஅஅஅஅஅஅ'wer':அword_distanceஅ/அword_length,நஅஅஅஅ})நநநdefஅcalculate_and_print_report(wav_filenames,அlabels,அdecodings,அlosses,அdataset_name):நஅஅஅஅr'''நஅஅஅஅThisஅroutineஅwillஅcalculateஅandஅprintஅaஅWERஅreport.நஅஅஅஅIt'llஅcomputeஅtheஅ`mean`அWERஅandஅcreateஅ``Sample``அobjectsஅofஅtheஅ``report_count``அtopஅlowestநஅஅஅஅlossஅitemsஅfromஅtheஅprovidedஅWERஅresultsஅtupleஅ(onlyஅitemsஅwithஅWER!=0அandஅorderedஅbyஅtheirஅWER).நஅஅஅஅ'''நஅஅஅஅsamplesஅ=அpmap(process_decode_result,அzip(wav_filenames,அlabels,அdecodings,அlosses))நநஅஅஅஅ#அGettingஅtheஅWERஅandஅCERஅfromஅtheஅaccumulatedஅeditஅdistancesஅandஅlengthsநஅஅஅஅsamples_wer,அsamples_cerஅ=அwer_cer_batch(samples)நநஅஅஅஅ#அReversedஅbecauseஅtheஅworstஅWERஅwithஅtheஅbestஅlossஅisஅtoஅidentifyஅsystemicஅissues,அwhereஅtheஅacousticஅmodelஅisஅconfident,நஅஅஅஅ#அyetஅtheஅresultஅisஅcompletelyஅoffஅtheஅmark.அThisஅcanஅpointஅtoஅtranscriptionஅerrorsஅandஅstuffஅlikeஅthat.நஅஅஅஅsamples.sort(key=lambdaஅs:அs.loss,அreverse=True)நநஅஅஅஅ#அThenஅorderஅbyஅascendingஅWER/CERநஅஅஅஅifஅFLAGS.bytes_output_mode:நஅஅஅஅஅஅஅஅsamples.sort(key=lambdaஅs:அs.cer)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅsamples.sort(key=lambdaஅs:அs.wer)நநஅஅஅஅ#அPrintஅtheஅreportநஅஅஅஅprint_report(samples,அlosses,அsamples_wer,அsamples_cer,அdataset_name)நநஅஅஅஅreturnஅsamplesநநநdefஅprint_report(samples,அlosses,அwer,அcer,அdataset_name):நஅஅஅஅ"""அPrintஅaஅreportஅsummaryஅandஅsamplesஅofஅbest,அmedianஅandஅworstஅresultsஅ"""நநஅஅஅஅ#அPrintஅsummaryநஅஅஅஅmean_lossஅ=அnp.mean(losses)நஅஅஅஅprint('Testஅonஅ%sஅ-அWER:அ%f,அCER:அ%f,அloss:அ%f'அ%அ(dataset_name,அwer,அcer,அmean_loss))நஅஅஅஅprint('-'அ*அ00)நநஅஅஅஅbest_samplesஅ=அsamples[:FLAGS.report_count]நஅஅஅஅworst_samplesஅ=அsamples[-FLAGS.report_count:]நஅஅஅஅmedian_indexஅ=அint(len(samples)அ/அ0)நஅஅஅஅmedian_leftஅ=அint(FLAGS.report_countஅ/அ0)நஅஅஅஅmedian_rightஅ=அFLAGS.report_countஅ-அmedian_leftநஅஅஅஅmedian_samplesஅ=அsamples[median_indexஅ-அmedian_left:median_indexஅ+அmedian_right]நநஅஅஅஅdefஅprint_single_sample(sample):நஅஅஅஅஅஅஅஅprint('WER:அ%f,அCER:அ%f,அloss:அ%f'அ%அ(sample.wer,அsample.cer,அsample.loss))நஅஅஅஅஅஅஅஅprint('அ-அwav:அfile://%s'அ%அsample.wav_filename)நஅஅஅஅஅஅஅஅprint('அ-அsrc:அ"%s"'அ%அsample.src)நஅஅஅஅஅஅஅஅprint('அ-அres:அ"%s"'அ%அsample.res)நஅஅஅஅஅஅஅஅprint('-'அ*அ00)நநஅஅஅஅprint('BestஅWER:',அ'\n'அ+அ'-'அ*அ00)நஅஅஅஅforஅsஅinஅbest_samples:நஅஅஅஅஅஅஅஅprint_single_sample(s)நநஅஅஅஅprint('MedianஅWER:',அ'\n'அ+அ'-'அ*அ00)நஅஅஅஅforஅsஅinஅmedian_samples:நஅஅஅஅஅஅஅஅprint_single_sample(s)நநஅஅஅஅprint('WorstஅWER:',அ'\n'அ+அ'-'அ*அ00)நஅஅஅஅforஅsஅinஅworst_samples:நஅஅஅஅஅஅஅஅprint_single_sample(s)நநநdefஅsave_samples_json(samples,அoutput_path):நஅஅஅஅ'''அSaveஅdecodedஅtuplesஅasஅJSON,அconvertingஅNumPyஅfloatsஅtoஅPythonஅfloats.நநஅஅஅஅஅஅஅஅWeஅsetஅensure_ascii=Trueஅtoஅpreventஅjsonஅfromஅescapingஅnon-ASCIIஅcharsநஅஅஅஅஅஅஅஅinஅtheஅtexts.நஅஅஅஅ'''நஅஅஅஅwithஅopen_remote(output_path,அ'w')அasஅfout:நஅஅஅஅஅஅஅஅjson.dump(samples,அfout,அdefault=float,அensure_ascii=False,அindent=0)நimportஅosநimportஅsysநimportஅtimeநimportஅheapqநimportஅsemverநimportஅrandomநநfromஅmultiprocessingஅimportஅPoolநfromஅcollectionsஅimportஅnamedtupleநநKILOஅ=அ0000நKILOBYTEஅ=அ0அ*அKILOநMEGABYTEஅ=அKILOஅ*அKILOBYTEநGIGABYTEஅ=அKILOஅ*அMEGABYTEநTERABYTEஅ=அKILOஅ*அGIGABYTEநSIZE_PREFIX_LOOKUPஅ=அ{'k':அKILOBYTE,அ'm':அMEGABYTE,அ'g':அGIGABYTE,அ't':அTERABYTE}நநValueRangeஅ=அnamedtuple('ValueRange',அ'startஅendஅr')நநநdefஅparse_file_size(file_size):நஅஅஅஅfile_sizeஅ=அfile_size.lower().strip()நஅஅஅஅifஅlen(file_size)அ==அ0:நஅஅஅஅஅஅஅஅreturnஅ0நஅஅஅஅnஅ=அint(keep_only_digits(file_size))நஅஅஅஅifஅfile_size[-0]அ==அ'b':நஅஅஅஅஅஅஅஅfile_sizeஅ=அfile_size[:-0]நஅஅஅஅeஅ=அfile_size[-0]நஅஅஅஅreturnஅSIZE_PREFIX_LOOKUP[e]அ*அnஅifஅeஅinஅSIZE_PREFIX_LOOKUPஅelseஅnநநநdefஅkeep_only_digits(txt):நஅஅஅஅreturnஅ''.join(filter(str.isdigit,அtxt))நநநdefஅsecs_to_hours(secs):நஅஅஅஅhours,அremainderஅ=அdivmod(secs,அ0000)நஅஅஅஅminutes,அsecondsஅ=அdivmod(remainder,அ00)நஅஅஅஅreturnஅ'%d:%00d:%00d'அ%அ(hours,அminutes,அseconds)நநநdefஅcheck_ctcdecoder_version():நஅஅஅஅds_version_sஅ=அopen(os.path.join(os.path.dirname(__file__),அ'../VERSION')).read().strip()நநஅஅஅஅtry:நஅஅஅஅஅஅஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅfromஅds_ctcdecoderஅimportஅ__version__அasஅdecoder_versionநஅஅஅஅexceptஅImportErrorஅasஅe:நஅஅஅஅஅஅஅஅifஅe.msg.find('__version__')அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅprint("DeepSpeechஅversionஅ({ds_version})அrequiresஅCTCஅdecoderஅtoஅexposeஅ__version__.அ"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"Pleaseஅupgradeஅtheஅds_ctcdecoderஅpackageஅtoஅversionஅ{ds_version}".format(ds_version=ds_version_s))நஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(0)நஅஅஅஅஅஅஅஅraiseஅeநநஅஅஅஅrvஅ=அsemver.compare(ds_version_s,அdecoder_version)நஅஅஅஅifஅrvஅ!=அ0:நஅஅஅஅஅஅஅஅprint("DeepSpeechஅversionஅ({})அandஅCTCஅdecoderஅversionஅ({})அdoஅnotஅmatch.அ"நஅஅஅஅஅஅஅஅஅஅஅஅஅஅ"Pleaseஅensureஅmatchingஅversionsஅareஅinஅuse.".format(ds_version_s,அdecoder_version))நஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅreturnஅrvநநநclassஅInterleaved:நஅஅஅஅ"""Collectionஅthatஅlazilyஅcombinesஅsortedஅcollectionsஅinஅanஅinterleavingஅfashion.நஅஅஅஅDuringஅiterationஅtheஅnextஅsmallestஅelementஅfromஅallஅtheஅsortedஅcollectionsஅisஅalwaysஅpicked.நஅஅஅஅTheஅcollectionsஅmustஅsupportஅiter()அandஅlen()."""நஅஅஅஅdefஅ__init__(self,அ*iterables,அkey=lambdaஅobj:அobj,அreverse=False):நஅஅஅஅஅஅஅஅself.iterablesஅ=அiterablesநஅஅஅஅஅஅஅஅself.keyஅ=அkeyநஅஅஅஅஅஅஅஅself.reverseஅ=அreverseநஅஅஅஅஅஅஅஅself.lenஅ=அsum(map(len,அiterables))நநஅஅஅஅdefஅ__iter__(self):நஅஅஅஅஅஅஅஅreturnஅheapq.merge(*self.iterables,அkey=self.key,அreverse=self.reverse)நநஅஅஅஅdefஅ__len__(self):நஅஅஅஅஅஅஅஅreturnஅself.lenநநநclassஅLenMap:நஅஅஅஅ"""நஅஅஅஅWrapperஅaroundஅpythonஅmap()அoutputஅobjectஅthatஅpreservesஅtheஅoriginalஅcollectionஅlengthநஅஅஅஅbyஅimplementingஅ__len__.நஅஅஅஅ"""நஅஅஅஅdefஅ__init__(self,அfn,அiterable):நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅself.lengthஅ=அlen(iterable)நஅஅஅஅஅஅஅஅexceptஅTypeError:நஅஅஅஅஅஅஅஅஅஅஅஅself.lengthஅ=அNoneநஅஅஅஅஅஅஅஅself.mapobjஅ=அmap(fn,அiterable)நநஅஅஅஅdefஅ__iter__(self):நஅஅஅஅஅஅஅஅself.mapobjஅ=அself.mapobj.__iter__()நஅஅஅஅஅஅஅஅreturnஅselfநநஅஅஅஅdefஅ__next__(self):நஅஅஅஅஅஅஅஅreturnஅself.mapobj.__next__()நநஅஅஅஅdefஅ__getitem__(self,அkey):நஅஅஅஅஅஅஅஅreturnஅself.mapobj.__getitem__(key)நநஅஅஅஅdefஅ__len__(self):நஅஅஅஅஅஅஅஅreturnஅself.lengthநநநclassஅLimitingPool:நஅஅஅஅ"""Limitsஅunboundஅahead-processingஅofஅmultiprocessing.Pool'sஅimapஅmethodநஅஅஅஅbeforeஅitemsஅgetஅconsumedஅbyஅtheஅiterationஅcaller.நஅஅஅஅThisஅpreventsஅOOMஅissuesஅinஅsituationsஅwhereஅitemsஅrepresentஅlargerஅmemoryஅallocations."""நஅஅஅஅdefஅ__init__(self,அprocesses=None,அinitializer=None,அinitargs=None,அprocess_ahead=None,அsleeping_for=0.0):நஅஅஅஅஅஅஅஅself.process_aheadஅ=அos.cpu_count()அifஅprocess_aheadஅisஅNoneஅelseஅprocess_aheadநஅஅஅஅஅஅஅஅself.sleeping_forஅ=அsleeping_forநஅஅஅஅஅஅஅஅself.processedஅ=அ0நஅஅஅஅஅஅஅஅself.poolஅ=அPool(processes=processes,அinitializer=initializer,அinitargs=initargs)நநஅஅஅஅdefஅ__enter__(self):நஅஅஅஅஅஅஅஅreturnஅselfநநஅஅஅஅdefஅ_limit(self,அit):நஅஅஅஅஅஅஅஅforஅobjஅinஅit:நஅஅஅஅஅஅஅஅஅஅஅஅwhileஅself.processedஅ>=அself.process_ahead:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtime.sleep(self.sleeping_for)நஅஅஅஅஅஅஅஅஅஅஅஅself.processedஅ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅobjநநஅஅஅஅdefஅimap(self,அfun,அit):நஅஅஅஅஅஅஅஅforஅobjஅinஅself.pool.imap(fun,அself._limit(it)):நஅஅஅஅஅஅஅஅஅஅஅஅself.processedஅ-=அ0நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅobjநநஅஅஅஅdefஅterminate(self):நஅஅஅஅஅஅஅஅself.pool.terminate()நநஅஅஅஅdefஅ__exit__(self,அexc_type,அexc_value,அtraceback):நஅஅஅஅஅஅஅஅself.pool.close()நநநclassஅExceptionBox:நஅஅஅஅ"""Helperஅclassஅforஅpassing-backஅandஅre-raisingஅanஅexceptionஅfromஅinsideஅaஅTensorFlowஅdatasetஅgenerator.நஅஅஅஅUsedஅinஅconjunctionஅwithஅ`remember_exception`."""நஅஅஅஅdefஅ__init__(self):நஅஅஅஅஅஅஅஅself.exceptionஅ=அNoneநநஅஅஅஅdefஅraise_if_set(self):நஅஅஅஅஅஅஅஅifஅself.exceptionஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅexceptionஅ=அself.exceptionநஅஅஅஅஅஅஅஅஅஅஅஅself.exceptionஅ=அNoneநஅஅஅஅஅஅஅஅஅஅஅஅraiseஅexceptionஅஅ#அpylint:அdisableஅ=அraising-bad-typeநநநdefஅremember_exception(iterable,அexception_box=None):நஅஅஅஅ"""WrapsஅaஅTensorFlowஅdatasetஅgeneratorஅforஅcatchingஅitsஅactualஅexceptionsநஅஅஅஅthatஅwouldஅotherwiseஅjustஅinterruptஅiterationஅw/oஅbubblingஅup."""நஅஅஅஅdefஅdo_iterate():நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅyieldஅfromஅiterable()நஅஅஅஅஅஅஅஅexceptஅStopIteration:நஅஅஅஅஅஅஅஅஅஅஅஅreturnநஅஅஅஅஅஅஅஅexceptஅExceptionஅasஅex:அஅ#அpylint:அdisableஅ=அbroad-exceptநஅஅஅஅஅஅஅஅஅஅஅஅexception_box.exceptionஅ=அexநஅஅஅஅreturnஅiterableஅifஅexception_boxஅisஅNoneஅelseஅdo_iterateநநநdefஅget_value_range(value,அtarget_type):நஅஅஅஅifஅisinstance(value,அstr):நஅஅஅஅஅஅஅஅrஅ=அtarget_type(0)நஅஅஅஅஅஅஅஅpartsஅ=அvalue.split('~')நஅஅஅஅஅஅஅஅifஅlen(parts)அ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅvalueஅ=அparts[0]நஅஅஅஅஅஅஅஅஅஅஅஅrஅ=அtarget_type(parts[0])நஅஅஅஅஅஅஅஅelifஅlen(parts)அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Cannotஅparseஅvalueஅrange')நஅஅஅஅஅஅஅஅpartsஅ=அvalue.split(':')நஅஅஅஅஅஅஅஅifஅlen(parts)அ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅparts.append(parts[0])நஅஅஅஅஅஅஅஅelifஅlen(parts)அ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Cannotஅparseஅvalueஅrange')நஅஅஅஅஅஅஅஅreturnஅValueRange(target_type(parts[0]),அtarget_type(parts[0]),அr)நஅஅஅஅifஅisinstance(value,அtuple):நஅஅஅஅஅஅஅஅifஅlen(value)அ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅValueRange(target_type(value[0]),அtarget_type(value[0]),அ0)நஅஅஅஅஅஅஅஅifஅlen(value)அ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅValueRange(target_type(value[0]),அtarget_type(value[0]),அtarget_type(value[0]))நஅஅஅஅஅஅஅஅraiseஅValueError('CannotஅconvertஅtoஅValueRange:அWrongஅtupleஅsize')நஅஅஅஅreturnஅValueRange(target_type(value),அtarget_type(value),அ0)நநநdefஅint_range(value):நஅஅஅஅreturnஅget_value_range(value,அint)நநநdefஅfloat_range(value):நஅஅஅஅreturnஅget_value_range(value,அfloat)நநநdefஅpick_value_from_range(value_range,அclock=None):நஅஅஅஅclockஅ=அrandom.random()அifஅclockஅisஅNoneஅelseஅmax(0.0,அmin(0.0,அfloat(clock)))நஅஅஅஅvalueஅ=அvalue_range.startஅ+அclockஅ*அ(value_range.endஅ-அvalue_range.start)நஅஅஅஅvalueஅ=அrandom.uniform(valueஅ-அvalue_range.r,அvalueஅ+அvalue_range.r)நஅஅஅஅreturnஅround(value)அifஅisinstance(value_range.start,அint)அelseஅvalueநநநdefஅtf_pick_value_from_range(value_range,அclock=None,அdouble_precision=False):நஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅclockஅ=அ(tf.random.stateless_uniform([],அseed=(-0,அ0),அdtype=tf.float00)அifஅclockஅisஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅஅelseஅtf.maximum(tf.constant(0.0,அdtype=tf.float00),அtf.minimum(tf.constant(0.0,அdtype=tf.float00),அclock)))நஅஅஅஅvalueஅ=அvalue_range.startஅ+அclockஅ*அ(value_range.endஅ-அvalue_range.start)நஅஅஅஅvalueஅ=அtf.random.stateless_uniform([],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅminval=valueஅ-அvalue_range.r,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmaxval=valueஅ+அvalue_range.r,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅseed=(clockஅ*அtf.int00.min,அclockஅ*அtf.int00.max),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdtype=tf.float00)நஅஅஅஅifஅisinstance(value_range.start,அint):நஅஅஅஅஅஅஅஅreturnஅtf.cast(tf.math.round(value),அtf.int00அifஅdouble_precisionஅelseஅtf.int00)நஅஅஅஅreturnஅtf.cast(value,அtf.float00அifஅdouble_precisionஅelseஅtf.float00)நநimportஅosநimportஅreநimportஅmathநimportஅrandomநimportஅresampyநimportஅnumpyஅasஅnpநநfromஅmultiprocessingஅimportஅQueue,அProcessநfromஅ.audioஅimportஅgain_db_to_ratio,அmax_dbfs,அnormalize_audio,அAUDIO_TYPE_NP,அAUDIO_TYPE_PCM,அAUDIO_TYPE_OPUSநfromஅ.helpersஅimportஅLimitingPool,அint_range,அfloat_range,அpick_value_from_range,அtf_pick_value_from_range,அMEGABYTEநfromஅ.sample_collectionsஅimportஅsamples_from_source,அunpack_maybeநநBUFFER_SIZEஅ=அ0அ*அMEGABYTEநSPEC_PARSERஅ=அre.compile(r'^(?P<cls>[a-z_]+)(\[(?P<params>.*)\])?$')நநநclassஅAugmentation:நஅஅஅஅdefஅ__init__(self,அp=0.0):நஅஅஅஅஅஅஅஅself.probabilityஅ=அfloat(p)நநநclassஅSampleAugmentation(Augmentation):நஅஅஅஅdefஅstart(self,அbuffering=BUFFER_SIZE):நஅஅஅஅஅஅஅஅpassநநஅஅஅஅdefஅapply(self,அsample,அclock=0.0):நஅஅஅஅஅஅஅஅraiseஅNotImplementedErrorநநஅஅஅஅdefஅstop(self):நஅஅஅஅஅஅஅஅpassநநநclassஅGraphAugmentation(Augmentation):நஅஅஅஅdefஅ__init__(self,அp=0.0,அdomain='spectrogram'):நஅஅஅஅஅஅஅஅsuper(GraphAugmentation,அself).__init__(p)நஅஅஅஅஅஅஅஅifஅdomainஅnotஅinஅ['signal',அ'spectrogram',அ'features']:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Unsupportedஅaugmentationஅdomain:அ{}'.format(domain))நஅஅஅஅஅஅஅஅself.domainஅ=அdomainநநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅraiseஅNotImplementedErrorநநஅஅஅஅdefஅapply_with_probability(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅrvஅ=அtf.random.stateless_uniform([],அseed=(clockஅ*அtf.int00.min,அclockஅ*அtf.int00.max))நஅஅஅஅஅஅஅஅreturnஅtf.cond(tf.less(rv,அself.probability),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambda:அself.apply(tensor,அtranscript=transcript,அclock=clock),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambda:அtensor)நநஅஅஅஅdefஅmaybe_apply(self,அdomain,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅifஅdomainஅ==அself.domain:நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅself.apply_with_probability(tensor,அtranscript=transcript,அclock=clock)நஅஅஅஅஅஅஅஅreturnஅtensorநநஅஅஅஅdefஅunits_per_ms(self):நஅஅஅஅஅஅஅஅfromஅ.flagsஅimportஅFLAGSஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅreturnஅFLAGS.audio_sample_rateஅ/அ0000.0அifஅself.domainஅ==அ'signal'அelseஅ0.0அ/அFLAGS.feature_win_stepநநநdefஅparse_augmentation(augmentation_spec):நஅஅஅஅ"""நஅஅஅஅParsesஅanஅaugmentationஅspecification.நநஅஅஅஅParametersநஅஅஅஅ----------நஅஅஅஅaugmentation_specஅ:அstrநஅஅஅஅஅஅஅஅAugmentationஅspecificationஅlikeஅ"reverb[delay=00.0,decay=0.0]".நநஅஅஅஅReturnsநஅஅஅஅ-------நஅஅஅஅInstanceஅofஅanஅaugmentationஅclassஅfromஅutil.augmentations.*.நஅஅஅஅ"""நஅஅஅஅmatchஅ=அSPEC_PARSER.match(augmentation_spec)நஅஅஅஅifஅnotஅmatch:நஅஅஅஅஅஅஅஅraiseஅValueError('Augmentationஅspecificationஅhasஅwrongஅformat')நஅஅஅஅcls_nameஅ=அ''.join(map(lambdaஅp:அp[0].upper()அ+அp[0:],அmatch.group('cls').split('_')))நஅஅஅஅaugmentation_clsஅ=அglobals()[cls_name]அifஅcls_nameஅinஅglobals()அelseஅNoneநஅஅஅஅifஅaugmentation_clsஅisஅNoneஅorஅnotஅissubclass(augmentation_cls,அAugmentation)அorஅaugmentation_clsஅ==அAugmentation:நஅஅஅஅஅஅஅஅraiseஅValueError('Unknownஅaugmentation:அ{}'.format(cls_name))நஅஅஅஅparametersஅ=அmatch.group('params')நஅஅஅஅparametersஅ=அ[]அifஅparametersஅisஅNoneஅelseஅparameters.split(',')நஅஅஅஅargsஅ=அ[]நஅஅஅஅkwargsஅ=அ{}நஅஅஅஅforஅparameterஅinஅparameters:நஅஅஅஅஅஅஅஅpairஅ=அtuple(list(map(str.strip,அ(parameter.split('=')))))நஅஅஅஅஅஅஅஅifஅlen(pair)அ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅargs.append(pair)நஅஅஅஅஅஅஅஅelifஅlen(pair)அ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅkwargs[pair[0]]அ=அpair[0]நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅValueError('Unableஅtoஅparseஅaugmentationஅvalueஅassignment')நஅஅஅஅreturnஅaugmentation_cls(*args,அ**kwargs)நநநdefஅparse_augmentations(augmentation_specs):நஅஅஅஅ"""நஅஅஅஅParsesஅanஅaugmentationஅspecification.நநஅஅஅஅParametersநஅஅஅஅ----------நஅஅஅஅaugmentation_specsஅ:அlistஅofஅstrநஅஅஅஅஅஅஅஅListஅofஅaugmentationஅspecificationsஅlikeஅ["reverb[delay=00.0,decay=0.0]",அ"volume"].நநஅஅஅஅReturnsநஅஅஅஅ-------நஅஅஅஅListஅofஅaugmentationஅclassஅinstancesஅfromஅutil.augmentations.*.நஅஅஅஅ"""நஅஅஅஅreturnஅ[]அifஅaugmentation_specsஅisஅNoneஅelseஅlist(map(parse_augmentation,அaugmentation_specs))நநநdefஅapply_graph_augmentations(domain,அtensor,அaugmentations,அtranscript=None,அclock=0.0):நஅஅஅஅ"""நஅஅஅஅAugmentsஅtrainingஅsampleஅtensorஅofஅaஅcertainஅdomainஅwithஅmatchingஅaugmentationsஅofஅpassedஅlist.நநஅஅஅஅParametersநஅஅஅஅ----------நஅஅஅஅdomainஅ:அstrநஅஅஅஅஅஅஅஅDomainஅofஅtheஅtensorஅtoஅapplyஅaugmentationsஅto.அOneஅofஅ"signal",அ"spectrogram"அorஅ"features"நஅஅஅஅtensorஅ:அTensorஅofஅtypeஅfloat00நஅஅஅஅஅஅஅஅTensorஅtoஅapplyஅaugmentationsஅto.நஅஅஅஅaugmentationsஅ:அlistஅofஅaugmentationஅclassஅinstancesஅfromஅutil.augmentations.*.நஅஅஅஅஅஅஅஅListஅofஅaugmentationsஅofஅwhichஅonlyஅtheஅspectrogramஅonesஅwillஅgetஅappliedஅtoஅtheஅsamples.நஅஅஅஅtranscriptஅ:அSparseTensorநஅஅஅஅclockஅ:அTensorஅofஅtypeஅfloat00நஅஅஅஅஅஅஅஅTimeஅindicatorஅforஅaugmentationஅvalue-ranges.அRunningஅfromஅ0.0அ(startஅofஅtraining)அtoஅ0.0அ(endஅofஅtraining).நநஅஅஅஅReturnsநஅஅஅஅ-------நஅஅஅஅTensorஅofஅtypeஅfloat00நஅஅஅஅஅஅஅஅTheஅaugmentedஅspectrogramநஅஅஅஅ"""நஅஅஅஅifஅaugmentations:நஅஅஅஅஅஅஅஅforஅaugmentationஅinஅaugmentations:நஅஅஅஅஅஅஅஅஅஅஅஅifஅisinstance(augmentation,அGraphAugmentation):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtensorஅ=அaugmentation.maybe_apply(domain,அtensor,அtranscript=transcript,அclock=clock)நஅஅஅஅreturnஅtensorநநநclassஅAugmentationContext:நஅஅஅஅdefஅ__init__(self,அtarget_audio_type,அaugmentations):நஅஅஅஅஅஅஅஅself.target_audio_typeஅ=அtarget_audio_typeநஅஅஅஅஅஅஅஅself.augmentationsஅ=அaugmentationsநநநAUGMENTATION_CONTEXTஅ=அNoneநநநdefஅ_init_augmentation_worker(preparation_context):நஅஅஅஅglobalஅAUGMENTATION_CONTEXTஅஅ#அpylint:அdisable=global-statementநஅஅஅஅAUGMENTATION_CONTEXTஅ=அpreparation_contextநநநdefஅ_load_and_augment_sample(timed_sample,அcontext=None):நஅஅஅஅsample,அclockஅ=அtimed_sampleநஅஅஅஅrealized_sampleஅ=அunpack_maybe(sample)நஅஅஅஅreturnஅ_augment_sample((realized_sample,அclock),அcontext)நநநdefஅ_augment_sample(timed_sample,அcontext=None):நஅஅஅஅcontextஅ=அAUGMENTATION_CONTEXTஅifஅcontextஅisஅNoneஅelseஅcontextநஅஅஅஅsample,அclockஅ=அtimed_sampleநஅஅஅஅforஅaugmentationஅinஅcontext.augmentations:நஅஅஅஅஅஅஅஅifஅrandom.random()அ<அaugmentation.probability:நஅஅஅஅஅஅஅஅஅஅஅஅaugmentation.apply(sample,அclock)நஅஅஅஅsample.change_audio_type(new_audio_type=context.target_audio_type)நஅஅஅஅreturnஅsampleநநநdefஅapply_sample_augmentations(samples,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaugmentations,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaudio_type=AUDIO_TYPE_NP,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbuffering=BUFFER_SIZE,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprocess_ahead=None,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅclock=0.0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfinal_clock=None):நஅஅஅஅ"""நஅஅஅஅPreparesஅsamplesஅforஅbeingஅusedஅduringஅtraining.நஅஅஅஅThisஅincludesஅparallelஅandஅbufferedஅapplicationஅofஅaugmentationsஅandஅaஅconversionஅtoஅaஅspecifiedஅaudio-type.நநஅஅஅஅParametersநஅஅஅஅ----------நஅஅஅஅsamplesஅ:அSampleஅenumerationநஅஅஅஅஅஅஅஅTypicallyஅproducedஅbyஅutil.sample_collections.samples_from_sources.நஅஅஅஅaugmentationsஅ:அlistஅofஅaugmentationஅclassஅinstancesஅfromஅutil.augmentations.*.நஅஅஅஅஅஅஅஅListஅofஅaugmentationsஅofஅwhichஅonlyஅtheஅsignalஅonesஅwillஅgetஅappliedஅtoஅtheஅsamples.நஅஅஅஅaudio_typeஅ:அstrநஅஅஅஅஅஅஅஅTargetஅaudio-typeஅtoஅconvertஅsamplesஅto.அSeeஅutil.audio.Sample.__init__அ.நஅஅஅஅbufferingஅ:அintநஅஅஅஅஅஅஅஅRead-bufferஅsizeஅtoஅuseஅwhileஅreadingஅfiles.நஅஅஅஅprocess_aheadஅ:அintநஅஅஅஅஅஅஅஅNumberஅofஅsamplesஅtoஅpre-processஅaheadஅofஅtime.நஅஅஅஅclockஅ:அfloatநஅஅஅஅஅஅஅஅStartஅorஅfixedஅclockஅvalueஅbetweenஅ0.0அandஅ0.0அforஅtheஅfirstஅorஅallஅsamples.அHasஅtoஅbeஅ<=அthanஅfinal_clock.நஅஅஅஅfinal_clockஅ:அfloatநஅஅஅஅஅஅஅஅFinalஅclockஅvalueஅbetweenஅ0.0அandஅ0.0அforஅtheஅlastஅsample.அHasஅtoஅbeஅ>=அthanஅclock.நஅஅஅஅஅஅஅஅRequiresஅsamples.__len__அattribute.நநஅஅஅஅReturnsநஅஅஅஅ-------நஅஅஅஅiterableஅofஅutil.sample_collections.LabeledSampleஅorஅutil.audio.Sampleநஅஅஅஅ"""நஅஅஅஅdefஅtimed_samples():நஅஅஅஅஅஅஅஅifஅfinal_clockஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅforஅsampleஅinஅsamples:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅyieldஅsample,அclockநஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅforஅsample_index,அsampleஅinஅenumerate(samples):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsample_clockஅ=அclockஅ+அ(final_clockஅ-அclock)அ*அ(sample_indexஅ/அlen(samples))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅyieldஅsample,அsample_clockநநஅஅஅஅassertஅ0.0அ<=அclockஅ<=அ0.0நஅஅஅஅifஅfinal_clockஅisஅnotஅNone:நஅஅஅஅஅஅஅஅassertஅ0.0அ<=அfinal_clockஅ<=அ0.0நஅஅஅஅஅஅஅஅassertஅclockஅ<=அfinal_clockநஅஅஅஅaugmentationsஅ=அ[augஅforஅaugஅinஅaugmentationsஅifஅisinstance(aug,அSampleAugmentation)]அifஅaugmentationsஅelseஅ[]நஅஅஅஅtry:நஅஅஅஅஅஅஅஅforஅaugmentationஅinஅaugmentations:நஅஅஅஅஅஅஅஅஅஅஅஅaugmentation.start(buffering=buffering)நஅஅஅஅஅஅஅஅcontextஅ=அAugmentationContext(audio_type,அaugmentations)நஅஅஅஅஅஅஅஅifஅprocess_aheadஅ==அ0:நஅஅஅஅஅஅஅஅஅஅஅஅforஅtimed_sampleஅinஅtimed_samples():நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅyieldஅ_load_and_augment_sample(timed_sample,அcontext=context)நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅwithஅLimitingPool(process_ahead=process_ahead,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinitializer=_init_augmentation_worker,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinitargs=(context,))அasஅpool:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅyieldஅfromஅpool.imap(_load_and_augment_sample,அtimed_samples())நஅஅஅஅfinally:நஅஅஅஅஅஅஅஅforஅaugmentationஅinஅaugmentations:நஅஅஅஅஅஅஅஅஅஅஅஅaugmentation.stop()நநநdefஅ_enqueue_overlay_samples(sample_source,அqueue,அbuffering=BUFFER_SIZE):நஅஅஅஅ"""நஅஅஅஅAsஅtheஅcentralஅdistributionஅpointஅforஅoverlayஅsamplesஅthisஅfunctionஅisஅsupposedஅtoஅrunஅinஅoneஅprocessஅonly.நஅஅஅஅThisஅensuresஅthatஅsamplesஅareஅnotஅusedஅtwiceஅifஅnotஅrequired.நஅஅஅஅItஅloadsஅtheஅ(rawஅandஅstillஅcompressed)அdataஅandஅprovidesஅitஅtoஅtheஅactualஅaugmentationஅworkers.நஅஅஅஅTheseஅareஅthenஅdoingஅdecompression,அpotentialஅconversionஅandஅoverlayingஅinஅparallel.நஅஅஅஅ"""நஅஅஅஅsamplesஅ=அsamples_from_source(sample_source,அbuffering=buffering,அlabeled=False)நஅஅஅஅwhileஅTrue:நஅஅஅஅஅஅஅஅforஅsampleஅinஅsamples:நஅஅஅஅஅஅஅஅஅஅஅஅqueue.put(sample)நநநclassஅOverlay(SampleAugmentation):நஅஅஅஅ"""Seeஅ"Overlayஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அsource,அp=0.0,அsnr=0.0,அlayers=0):நஅஅஅஅஅஅஅஅsuper(Overlay,அself).__init__(p)நஅஅஅஅஅஅஅஅself.sourceஅ=அsourceநஅஅஅஅஅஅஅஅself.snrஅ=அfloat_range(snr)நஅஅஅஅஅஅஅஅself.layersஅ=அint_range(layers)நஅஅஅஅஅஅஅஅself.current_sampleஅ=அNoneநஅஅஅஅஅஅஅஅself.queueஅ=அNoneநஅஅஅஅஅஅஅஅself.enqueue_processஅ=அNoneநநஅஅஅஅdefஅstart(self,அbuffering=BUFFER_SIZE):நஅஅஅஅஅஅஅஅself.queueஅ=அQueue(max(0,அmath.floor(self.probabilityஅ*அself.layers[0]அ*அos.cpu_count())))நஅஅஅஅஅஅஅஅself.enqueue_processஅ=அProcess(target=_enqueue_overlay_samples,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅargs=(self.source,அself.queue),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅkwargs={'buffering':அbuffering})நஅஅஅஅஅஅஅஅself.enqueue_process.start()நநஅஅஅஅdefஅapply(self,அsample,அclock=0.0):நஅஅஅஅஅஅஅஅsampleஅ=அunpack_maybe(sample)நஅஅஅஅஅஅஅஅsample.change_audio_type(new_audio_type=AUDIO_TYPE_NP)நஅஅஅஅஅஅஅஅn_layersஅ=அpick_value_from_range(self.layers,அclock=clock)நஅஅஅஅஅஅஅஅaudioஅ=அsample.audioநஅஅஅஅஅஅஅஅoverlay_dataஅ=அnp.zeros_like(audio)நஅஅஅஅஅஅஅஅforஅ_அinஅrange(n_layers):நஅஅஅஅஅஅஅஅஅஅஅஅoverlay_offsetஅ=அ0நஅஅஅஅஅஅஅஅஅஅஅஅwhileஅoverlay_offsetஅ<அlen(audio):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅself.current_sampleஅisஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnext_overlay_sampleஅ=அself.queue.get()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnext_overlay_sampleஅ=அunpack_maybe(next_overlay_sample)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnext_overlay_sample.change_audio_type(new_audio_type=AUDIO_TYPE_NP)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.current_sampleஅ=அnext_overlay_sample.audioநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅn_requiredஅ=அlen(audio)அ-அoverlay_offsetநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅn_currentஅ=அlen(self.current_sample)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅn_requiredஅ>=அn_current:அஅ#அtakeஅitஅcompletelyநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoverlay_data[overlay_offset:overlay_offsetஅ+அn_current]அ+=அself.current_sampleநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoverlay_offsetஅ+=அn_currentநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.current_sampleஅ=அNoneநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:அஅ#அtakeஅrequiredஅsliceஅfromஅheadஅandஅkeepஅtailஅforஅnextஅlayerஅorஅsampleநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoverlay_data[overlay_offset:overlay_offsetஅ+அn_required]அ+=அself.current_sample[0:n_required]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoverlay_offsetஅ+=அn_requiredநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅself.current_sampleஅ=அself.current_sample[n_required:]நஅஅஅஅஅஅஅஅsnr_dbஅ=அpick_value_from_range(self.snr,அclock=clock)நஅஅஅஅஅஅஅஅorig_dbfsஅ=அmax_dbfs(audio)நஅஅஅஅஅஅஅஅoverlay_gainஅ=அorig_dbfsஅ-அmax_dbfs(overlay_data)அ-அsnr_dbநஅஅஅஅஅஅஅஅaudioஅ+=அoverlay_dataஅ*அgain_db_to_ratio(overlay_gain)நஅஅஅஅஅஅஅஅsample.audioஅ=அnormalize_audio(audio,அdbfs=orig_dbfs)நநஅஅஅஅdefஅstop(self):நஅஅஅஅஅஅஅஅifஅself.enqueue_processஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅself.enqueue_process.terminate()நஅஅஅஅஅஅஅஅஅஅஅஅself.enqueue_processஅ=அNoneநஅஅஅஅஅஅஅஅself.current_sampleஅ=அNoneநஅஅஅஅஅஅஅஅself.queueஅ=அNoneநநநclassஅCodec(SampleAugmentation):நஅஅஅஅ"""Seeஅ"Codecஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அbitrate=0000):நஅஅஅஅஅஅஅஅsuper(Codec,அself).__init__(p)நஅஅஅஅஅஅஅஅself.bitrateஅ=அint_range(bitrate)நநஅஅஅஅdefஅapply(self,அsample,அclock=0.0):நஅஅஅஅஅஅஅஅbitrateஅ=அpick_value_from_range(self.bitrate,அclock=clock)நஅஅஅஅஅஅஅஅsample.change_audio_type(new_audio_type=AUDIO_TYPE_PCM)அஅ#அdecodingஅtoஅensureஅitஅhasஅtoஅgetஅencodedஅagainநஅஅஅஅஅஅஅஅsample.change_audio_type(new_audio_type=AUDIO_TYPE_OPUS,அbitrate=bitrate)அஅ#அwillஅgetஅdecodedஅagainஅdownstreamநநநclassஅReverb(SampleAugmentation):நஅஅஅஅ"""Seeஅ"Reverbஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அdelay=00.0,அdecay=00.0):நஅஅஅஅஅஅஅஅsuper(Reverb,அself).__init__(p)நஅஅஅஅஅஅஅஅself.delayஅ=அfloat_range(delay)நஅஅஅஅஅஅஅஅself.decayஅ=அfloat_range(decay)நநஅஅஅஅdefஅapply(self,அsample,அclock=0.0):நஅஅஅஅஅஅஅஅsample.change_audio_type(new_audio_type=AUDIO_TYPE_NP)நஅஅஅஅஅஅஅஅaudioஅ=அnp.array(sample.audio,அdtype=np.float00)நஅஅஅஅஅஅஅஅorig_dbfsஅ=அmax_dbfs(audio)நஅஅஅஅஅஅஅஅdelayஅ=அpick_value_from_range(self.delay,அclock=clock)நஅஅஅஅஅஅஅஅdecayஅ=அpick_value_from_range(self.decay,அclock=clock)நஅஅஅஅஅஅஅஅdecayஅ=அgain_db_to_ratio(-decay)நஅஅஅஅஅஅஅஅresultஅ=அnp.copy(audio)நஅஅஅஅஅஅஅஅprimesஅ=அ[00,அ00,அ00,அ00,அ00]நஅஅஅஅஅஅஅஅforஅdelay_primeஅinஅprimes:அஅ#அprimesஅtoஅminimizeஅcombஅfilterஅinterferenceநஅஅஅஅஅஅஅஅஅஅஅஅlayerஅ=அnp.copy(audio)நஅஅஅஅஅஅஅஅஅஅஅஅn_delayஅ=அmath.floor(delayஅ*அ(delay_primeஅ/அprimes[0])அ*அsample.audio_format.rateஅ/அ0000.0)நஅஅஅஅஅஅஅஅஅஅஅஅn_delayஅ=அmax(00,அn_delay)அஅ#அ00அsamplesஅminimumஅtoஅavoidஅperformanceஅtrapஅandஅriskஅofஅdivisionஅbyஅzeroநஅஅஅஅஅஅஅஅஅஅஅஅforஅw_indexஅinஅrange(0,அmath.floor(len(audio)அ/அn_delay)):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅw0அ=அw_indexஅ*அn_delayநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅw0அ=அ(w_indexஅ+அ0)அ*அn_delayநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwidthஅ=அmin(len(audio)அ-அw0,அn_delay)அஅ#அlastஅwindowஅcouldஅbeஅsmallerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlayer[w0:w0அ+அwidth]அ+=அdecayஅ*அlayer[w0:w0அ+அwidth]நஅஅஅஅஅஅஅஅஅஅஅஅresultஅ+=அlayerநஅஅஅஅஅஅஅஅaudioஅ=அnormalize_audio(result,அdbfs=orig_dbfs)நஅஅஅஅஅஅஅஅsample.audioஅ=அnp.array(audio,அdtype=np.float00)நநநclassஅResample(SampleAugmentation):நஅஅஅஅ"""Seeஅ"Resampleஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அrate=0000):நஅஅஅஅஅஅஅஅsuper(Resample,அself).__init__(p)நஅஅஅஅஅஅஅஅself.rateஅ=அint_range(rate)நநஅஅஅஅdefஅapply(self,அsample,அclock=0.0):நஅஅஅஅஅஅஅஅsample.change_audio_type(new_audio_type=AUDIO_TYPE_NP)நஅஅஅஅஅஅஅஅrateஅ=அpick_value_from_range(self.rate,அclock=clock)நஅஅஅஅஅஅஅஅorig_lenஅ=அlen(sample.audio)நஅஅஅஅஅஅஅஅresampledஅ=அresampy.resample(sample.audio,அsample.audio_format.rate,அrate,அaxis=0,அfilter='kaiser_fast')நஅஅஅஅஅஅஅஅsample.audioஅ=அresampy.resample(resampled,அrate,அsample.audio_format.rate,அaxis=0,அfilter='kaiser_fast')[:orig_len]நநநclassஅNormalizeSampleRate(SampleAugmentation):நஅஅஅஅdefஅ__init__(self,அrate):நஅஅஅஅஅஅஅஅsuper().__init__(p=0.0)நஅஅஅஅஅஅஅஅself.rateஅ=அrateநநஅஅஅஅdefஅapply(self,அsample,அclock=0.0):நஅஅஅஅஅஅஅஅifஅsample.audio_format.rateஅ==அself.rate:நஅஅஅஅஅஅஅஅஅஅஅஅreturnநநஅஅஅஅஅஅஅஅsample.change_audio_type(new_audio_type=AUDIO_TYPE_NP)நஅஅஅஅஅஅஅஅsample.audioஅ=அresampy.resample(sample.audio,அsample.audio_format.rate,அself.rate,அaxis=0,அfilter='kaiser_fast')நஅஅஅஅஅஅஅஅsample.audio_formatஅ=அsample.audio_format._replace(rate=self.rate)நநநclassஅVolume(SampleAugmentation):நஅஅஅஅ"""Seeஅ"Volumeஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அdbfs=0.0000):நஅஅஅஅஅஅஅஅsuper(Volume,அself).__init__(p)நஅஅஅஅஅஅஅஅself.target_dbfsஅ=அfloat_range(dbfs)நநஅஅஅஅdefஅapply(self,அsample,அclock=0.0):நஅஅஅஅஅஅஅஅsample.change_audio_type(new_audio_type=AUDIO_TYPE_NP)நஅஅஅஅஅஅஅஅtarget_dbfsஅ=அpick_value_from_range(self.target_dbfs,அclock=clock)நஅஅஅஅஅஅஅஅsample.audioஅ=அnormalize_audio(sample.audio,அdbfs=target_dbfs)நநநclassஅPitch(GraphAugmentation):நஅஅஅஅ"""Seeஅ"Pitchஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அpitch=(0.000,அ0.000,அ0.000)):நஅஅஅஅஅஅஅஅsuper(Pitch,அself).__init__(p,அdomain='spectrogram')நஅஅஅஅஅஅஅஅself.pitchஅ=அfloat_range(pitch)நநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅoriginal_shapeஅ=அtf.shape(tensor)நஅஅஅஅஅஅஅஅpitchஅ=அtf_pick_value_from_range(self.pitch,அclock=clock)நஅஅஅஅஅஅஅஅnew_freq_sizeஅ=அtf.cast(tf.cast(original_shape[0],அtf.float00)அ*அpitch,அtf.int00)நஅஅஅஅஅஅஅஅspectrogram_augஅ=அtf.image.resize_bilinear(tf.expand_dims(tensor,அ-0),அ[original_shape[0],அnew_freq_size])நஅஅஅஅஅஅஅஅspectrogram_augஅ=அtf.image.crop_to_bounding_box(spectrogram_aug,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoffset_height=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoffset_width=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtarget_height=original_shape[0],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtarget_width=tf.math.minimum(original_shape[0],அnew_freq_size))நஅஅஅஅஅஅஅஅspectrogram_augஅ=அtf.cond(pitchஅ<அ0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambda:அtf.image.pad_to_bounding_box(spectrogram_aug,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoffset_height=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoffset_width=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtarget_height=tf.shape(spectrogram_aug)[0],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtarget_width=original_shape[0]),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlambda:அspectrogram_aug)நஅஅஅஅஅஅஅஅreturnஅspectrogram_aug[:,அ:,அ:,அ0]நநநclassஅTempo(GraphAugmentation):நஅஅஅஅ"""Seeஅ"Tempoஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அfactor=0.0,அmax_time=-0):நஅஅஅஅஅஅஅஅsuper(Tempo,அself).__init__(p,அdomain='spectrogram')நஅஅஅஅஅஅஅஅself.factorஅ=அfloat_range(factor)நஅஅஅஅஅஅஅஅself.max_timeஅ=அfloat(max_time)நநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅfactorஅ=அtf_pick_value_from_range(self.factor,அclock=clock)நஅஅஅஅஅஅஅஅoriginal_shapeஅ=அtf.shape(tensor)நஅஅஅஅஅஅஅஅnew_time_sizeஅ=அtf.cast(tf.cast(original_shape[0],அtf.float00)அ/அfactor,அtf.int00)நஅஅஅஅஅஅஅஅifஅtranscriptஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅnew_time_sizeஅ=அtf.math.maximum(new_time_size,அtf.shape(transcript)[0])நஅஅஅஅஅஅஅஅifஅself.max_timeஅ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅnew_time_sizeஅ=அtf.math.minimum(new_time_size,அtf.cast(self.max_timeஅ*அself.units_per_ms(),அtf.int00))நஅஅஅஅஅஅஅஅspectrogram_augஅ=அtf.image.resize_bilinear(tf.expand_dims(tensor,அ-0),அ[new_time_size,அoriginal_shape[0]])நஅஅஅஅஅஅஅஅreturnஅspectrogram_aug[:,அ:,அ:,அ0]நநநclassஅWarp(GraphAugmentation):நஅஅஅஅ"""Seeஅ"Warpஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அnt=0,அnf=0,அwt=0.0,அwf=0.0):நஅஅஅஅஅஅஅஅsuper(Warp,அself).__init__(p,அdomain='spectrogram')நஅஅஅஅஅஅஅஅself.num_tஅ=அint_range(nt)நஅஅஅஅஅஅஅஅself.num_fஅ=அint_range(nf)நஅஅஅஅஅஅஅஅself.warp_tஅ=அfloat_range(wt)நஅஅஅஅஅஅஅஅself.warp_fஅ=அfloat_range(wf)நநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅoriginal_shapeஅ=அtf.shape(tensor)நஅஅஅஅஅஅஅஅsize_t,அsize_fஅ=அoriginal_shape[0],அoriginal_shape[0]நஅஅஅஅஅஅஅஅseedஅ=அ(clockஅ*அtf.int00.min,அclockஅ*அtf.int00.max)நஅஅஅஅஅஅஅஅnum_tஅ=அtf_pick_value_from_range(self.num_t,அclock=clock)நஅஅஅஅஅஅஅஅnum_fஅ=அtf_pick_value_from_range(self.num_f,அclock=clock)நநஅஅஅஅஅஅஅஅdefஅget_flows(n,அsize,அwarp):நஅஅஅஅஅஅஅஅஅஅஅஅwarpஅ=அtf_pick_value_from_range(warp,அclock=clock)நஅஅஅஅஅஅஅஅஅஅஅஅwarpஅ=அwarpஅ*அtf.cast(size,அdtype=tf.float00)அ/அtf.cast(0அ*அ(nஅ+அ0),அdtype=tf.float00)நஅஅஅஅஅஅஅஅஅஅஅஅfஅ=அtf.random.stateless_normal([num_t,அnum_f],அseed,அmean=0.0,அstddev=warp,அdtype=tf.float00)நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅtf.pad(f,அtf.constant([[0,அ0],அ[0,அ0]]),அ'CONSTANT')அஅ#அzeroஅflowஅatஅallஅedgesநநஅஅஅஅஅஅஅஅflowsஅ=அtf.stack([get_flows(num_t,அsize_t,அself.warp_t),அget_flows(num_f,அsize_f,அself.warp_f)],அaxis=0)நஅஅஅஅஅஅஅஅflowsஅ=அtf.image.resize_bicubic(tf.expand_dims(flows,அ0),அ[size_t,அsize_f])நஅஅஅஅஅஅஅஅspectrogram_augஅ=அtf.contrib.image.dense_image_warp(tf.expand_dims(tensor,அ-0),அflows)நஅஅஅஅஅஅஅஅreturnஅtf.reshape(spectrogram_aug,அshape=(0,அ-0,அsize_f))நநநclassஅFrequencyMask(GraphAugmentation):நஅஅஅஅ"""Seeஅ"Frequencyஅmaskஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அn=0,அsize=0):நஅஅஅஅஅஅஅஅsuper(FrequencyMask,அself).__init__(p,அdomain='spectrogram')நஅஅஅஅஅஅஅஅself.nஅ=அint_range(n)அஅ#அpylint:அdisable=invalid-nameநஅஅஅஅஅஅஅஅself.sizeஅ=அint_range(size)நநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅtime_maxஅ=அtf.shape(tensor)[0]நஅஅஅஅஅஅஅஅfreq_maxஅ=அtf.shape(tensor)[0]நஅஅஅஅஅஅஅஅnஅ=அtf_pick_value_from_range(self.n,அclock=clock)நநஅஅஅஅஅஅஅஅdefஅbody(i,அspectrogram_aug):நஅஅஅஅஅஅஅஅஅஅஅஅsizeஅ=அtf_pick_value_from_range(self.size,அclock=clock)நஅஅஅஅஅஅஅஅஅஅஅஅsizeஅ=அtf.math.maximum(0,அtf.math.minimum(freq_maxஅ-அ0,அsize))நஅஅஅஅஅஅஅஅஅஅஅஅseedஅ=அtf.cast(clockஅ*அtf.int00.max,அtf.int00)அ-அiநஅஅஅஅஅஅஅஅஅஅஅஅf0அ=அtf.random.stateless_uniform((),அ(-seed,அseed),அminval=0,அmaxval=freq_maxஅ-அsize,அdtype=tf.dtypes.int00)நஅஅஅஅஅஅஅஅஅஅஅஅfreq_maskஅ=அtf.concat([tf.ones([0,அtime_max,அf0]),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtf.zeros([0,அtime_max,அsize]),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtf.ones([0,அtime_max,அfreq_maxஅ-அf0அ-அsize])],அaxis=0)நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅiஅ+அ0,அspectrogram_augஅ*அfreq_maskநநஅஅஅஅஅஅஅஅreturnஅtf.while_loop(lambdaஅi,அspectrogram_aug:அiஅ<அn,அbody,அ(0,அtensor))[0]நநநclassஅTimeMask(GraphAugmentation):நஅஅஅஅ"""Seeஅ"Timeஅmaskஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அdomain='spectrogram',அn=0,அsize=00.0):நஅஅஅஅஅஅஅஅsuper(TimeMask,அself).__init__(p,அdomain=domain)நஅஅஅஅஅஅஅஅself.nஅ=அint_range(n)அஅ#அpylint:அdisable=invalid-nameநஅஅஅஅஅஅஅஅself.sizeஅ=அfloat_range(size)நநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅtime_maxஅ=அtf.shape(tensor)[0அifஅself.domainஅ==அ'signal'அelseஅ0]நஅஅஅஅஅஅஅஅnஅ=அtf_pick_value_from_range(self.n,அclock=clock)நநஅஅஅஅஅஅஅஅdefஅbody(i,அaugmented):நஅஅஅஅஅஅஅஅஅஅஅஅsizeஅ=அtf.cast(tf_pick_value_from_range(self.size,அclock=clock)அ*அself.units_per_ms(),அdtype=tf.int00)நஅஅஅஅஅஅஅஅஅஅஅஅsizeஅ=அtf.math.maximum(0,அtf.math.minimum(time_maxஅ-அ0,அsize))நஅஅஅஅஅஅஅஅஅஅஅஅseedஅ=அtf.cast(clockஅ*அtf.int00.max,அtf.int00)அ-அiநஅஅஅஅஅஅஅஅஅஅஅஅt0அ=அtf.random.stateless_uniform((),அ(-seed,அseed),அminval=0,அmaxval=time_maxஅ-அsize,அdtype=tf.dtypes.int00)நஅஅஅஅஅஅஅஅஅஅஅஅrestஅ=அtime_maxஅ-அt0அ-அsizeநஅஅஅஅஅஅஅஅஅஅஅஅifஅself.domainஅ==அ'spectrogram':நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfmஅ=அtf.shape(tensor)[0]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtime_maskஅ=அtf.concat([tf.ones([0,அt0,அfm]),அtf.zeros([0,அsize,அfm]),அtf.ones([0,அrest,அfm])],அaxis=0)நஅஅஅஅஅஅஅஅஅஅஅஅelifஅself.domainஅ==அ'signal':நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtime_maskஅ=அtf.concat([tf.ones([t0,அ0]),அtf.zeros([size,அ0]),அtf.ones([rest,அ0])],அaxis=0)நஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtime_maskஅ=அtf.concat([tf.ones([0,அt0]),அtf.zeros([0,அsize]),அtf.ones([0,அrest])],அaxis=0)நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅiஅ+அ0,அaugmentedஅ*அtime_maskநநஅஅஅஅஅஅஅஅreturnஅtf.while_loop(lambdaஅi,அaugmented:அiஅ<அn,அbody,அ(0,அtensor))[0]நநநclassஅDropout(GraphAugmentation):நஅஅஅஅ"""Seeஅ"Dropoutஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அdomain='spectrogram',அrate=0.00):நஅஅஅஅஅஅஅஅsuper(Dropout,அself).__init__(p,அdomain=domain)நஅஅஅஅஅஅஅஅself.rateஅ=அfloat_range(rate)நநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅrateஅ=அtf_pick_value_from_range(self.rate,அclock=clock)நஅஅஅஅஅஅஅஅrateஅ=அtf.math.maximum(0.0,அrate)நஅஅஅஅஅஅஅஅfactorsஅ=அtf.random.stateless_uniform(tf.shape(tensor),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ(clockஅ*அtf.int00.min,அclockஅ*அtf.int00.max),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅminval=0.0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅmaxval=0.0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdtype=tf.float00)நஅஅஅஅஅஅஅஅreturnஅtensorஅ*அtf.math.sign(tf.math.floor(factorsஅ+அrate))நநநclassஅAdd(GraphAugmentation):நஅஅஅஅ"""Seeஅ"Addஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அdomain='features',அstddev=0):நஅஅஅஅஅஅஅஅsuper(Add,அself).__init__(p,அdomain=domain)நஅஅஅஅஅஅஅஅself.stddevஅ=அfloat_range(stddev)நநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅstddevஅ=அtf_pick_value_from_range(self.stddev,அclock=clock)நஅஅஅஅஅஅஅஅseedஅ=அ(clockஅ*அtf.int00.min,அclockஅ*அtf.int00.max)நஅஅஅஅஅஅஅஅreturnஅtensorஅ+அtf.random.stateless_normal(tf.shape(tensor),அseed,அmean=0.0,அstddev=stddev)நநநclassஅMultiply(GraphAugmentation):நஅஅஅஅ"""Seeஅ"Multiplyஅaugmentation"அinஅtrainingஅdocumentation"""நஅஅஅஅdefஅ__init__(self,அp=0.0,அdomain='features',அstddev=0):நஅஅஅஅஅஅஅஅsuper(Multiply,அself).__init__(p,அdomain=domain)நஅஅஅஅஅஅஅஅself.stddevஅ=அfloat_range(stddev)நநஅஅஅஅdefஅapply(self,அtensor,அtranscript=None,அclock=0.0):நஅஅஅஅஅஅஅஅimportஅtensorflowஅasஅtfஅஅ#அpylint:அdisable=import-outside-toplevelநஅஅஅஅஅஅஅஅstddevஅ=அtf_pick_value_from_range(self.stddev,அclock=clock)நஅஅஅஅஅஅஅஅseedஅ=அ(clockஅ*அtf.int00.min,அclockஅ*அtf.int00.max)நஅஅஅஅஅஅஅஅreturnஅtensorஅ*அtf.random.stateless_normal(tf.shape(tensor),அseed,அmean=0.0,அstddev=stddev)ந#!/usr/bin/envஅpythonந#அ-*-அcoding:அutf-0அ-*-நfromஅ__future__அimportஅabsolute_import,அdivision,அprint_functionநநimportஅosநimportஅsysநநLOG_LEVEL_INDEXஅ=அsys.argv.index('--log_level')அ+அ0அifஅ'--log_level'அinஅsys.argvஅelseஅ0நDESIRED_LOG_LEVELஅ=அsys.argv[LOG_LEVEL_INDEX]அifஅ0அ<அLOG_LEVEL_INDEXஅ<அlen(sys.argv)அelseஅ'0'நos.environ['TF_CPP_MIN_LOG_LEVEL']அ=அDESIRED_LOG_LEVELநநimportஅabsl.appநimportஅnumpyஅasஅnpநimportஅprogressbarநimportஅshutilநimportஅtensorflowஅasஅtfநimportஅtensorflow.compat.v0அasஅtfv0நimportஅtimeநநtfv0.logging.set_verbosity({நஅஅஅஅ'0':அtfv0.logging.DEBUG,நஅஅஅஅ'0':அtfv0.logging.INFO,நஅஅஅஅ'0':அtfv0.logging.WARN,நஅஅஅஅ'0':அtfv0.logging.ERRORந}.get(DESIRED_LOG_LEVEL))நநfromஅdatetimeஅimportஅdatetimeநfromஅds_ctcdecoderஅimportஅctc_beam_search_decoder,அScorerநfromஅ.evaluateஅimportஅevaluateநfromஅsix.movesஅimportஅzip,அrangeநfromஅ.util.configஅimportஅConfig,அinitialize_globalsநfromஅ.util.checkpointsஅimportஅload_or_init_graph_for_training,அload_graph_for_evaluation,அreload_best_checkpointநfromஅ.util.evaluate_toolsஅimportஅsave_samples_jsonநfromஅ.util.feedingஅimportஅcreate_dataset,அaudio_to_features,அaudiofile_to_featuresநfromஅ.util.flagsஅimportஅcreate_flags,அFLAGSநfromஅ.util.helpersஅimportஅcheck_ctcdecoder_version,அExceptionBoxநfromஅ.util.loggingஅimportஅcreate_progressbar,அlog_debug,அlog_error,அlog_info,அlog_progress,அlog_warnநfromஅ.util.ioஅimportஅopen_remote,அremove_remote,அlistdir_remote,அis_remote_path,அisdir_remoteநநcheck_ctcdecoder_version()நந#அGraphஅCreationந#அ==============நநdefஅvariable_on_cpu(name,அshape,அinitializer):நஅஅஅஅr"""நஅஅஅஅNextஅweஅconcernஅourselvesஅwithஅgraphஅcreation.நஅஅஅஅHowever,அbeforeஅweஅdoஅsoஅweஅmustஅintroduceஅaஅutilityஅfunctionஅ``variable_on_cpu()``நஅஅஅஅusedஅtoஅcreateஅaஅvariableஅinஅCPUஅmemory.நஅஅஅஅ"""நஅஅஅஅ#அUseஅtheஅ/cpu:0அdeviceஅforஅscopedஅoperationsநஅஅஅஅwithஅtf.device(Config.cpu_device):நஅஅஅஅஅஅஅஅ#அCreateஅorஅgetஅaproposஅvariableநஅஅஅஅஅஅஅஅvarஅ=அtfv0.get_variable(name=name,அshape=shape,அinitializer=initializer)நஅஅஅஅreturnஅvarநநநdefஅcreate_overlapping_windows(batch_x):நஅஅஅஅbatch_sizeஅ=அtf.shape(input=batch_x)[0]நஅஅஅஅwindow_widthஅ=அ0அ*அConfig.n_contextஅ+அ0நஅஅஅஅnum_channelsஅ=அConfig.n_inputநநஅஅஅஅ#அCreateஅaஅconstantஅconvolutionஅfilterஅusingஅanஅidentityஅmatrix,அsoஅthatஅtheநஅஅஅஅ#அconvolutionஅreturnsஅpatchesஅofஅtheஅinputஅtensorஅasஅis,அandஅweஅcanஅcreateநஅஅஅஅ#அoverlappingஅwindowsஅoverஅtheஅMFCCs.நஅஅஅஅeye_filterஅ=அtf.constant(np.eye(window_widthஅ*அnum_channels)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ.reshape(window_width,அnum_channels,அwindow_widthஅ*அnum_channels),அtf.float00)அ#அpylint:அdisable=bad-continuationநநஅஅஅஅ#அCreateஅoverlappingஅwindowsநஅஅஅஅbatch_xஅ=அtf.nn.conv0d(input=batch_x,அfilters=eye_filter,அstride=0,அpadding='SAME')நநஅஅஅஅ#அRemoveஅdummyஅdepthஅdimensionஅandஅreshapeஅintoஅ[batch_size,அn_windows,அwindow_width,அn_input]நஅஅஅஅbatch_xஅ=அtf.reshape(batch_x,அ[batch_size,அ-0,அwindow_width,அnum_channels])நநஅஅஅஅreturnஅbatch_xநநநdefஅdense(name,அx,அunits,அdropout_rate=None,அrelu=True,அlayer_norm=False):நஅஅஅஅwithஅtfv0.variable_scope(name):நஅஅஅஅஅஅஅஅbiasஅ=அvariable_on_cpu('bias',அ[units],அtfv0.zeros_initializer())நஅஅஅஅஅஅஅஅweightsஅ=அvariable_on_cpu('weights',அ[x.shape[-0],அunits],அtfv0.keras.initializers.VarianceScaling(scale=0.0,அmode="fan_avg",அdistribution="uniform"))நநஅஅஅஅoutputஅ=அtf.nn.bias_add(tf.matmul(x,அweights),அbias)நநஅஅஅஅifஅrelu:நஅஅஅஅஅஅஅஅoutputஅ=அtf.minimum(tf.nn.relu(output),அFLAGS.relu_clip)நநஅஅஅஅifஅlayer_norm:நஅஅஅஅஅஅஅஅwithஅtfv0.variable_scope(name):நஅஅஅஅஅஅஅஅஅஅஅஅoutputஅ=அtf.contrib.layers.layer_norm(output)நநஅஅஅஅifஅdropout_rateஅisஅnotஅNone:நஅஅஅஅஅஅஅஅoutputஅ=அtf.nn.dropout(output,அrate=dropout_rate)நநஅஅஅஅreturnஅoutputநநநdefஅrnn_impl_lstmblockfusedcell(x,அseq_length,அprevious_state,அreuse):நஅஅஅஅwithஅtfv0.variable_scope('cudnn_lstm/rnn/multi_rnn_cell/cell_0'):நஅஅஅஅஅஅஅஅfw_cellஅ=அtf.contrib.rnn.LSTMBlockFusedCell(Config.n_cell_dim,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforget_bias=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreuse=reuse,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅname='cudnn_compatible_lstm_cell')நநஅஅஅஅஅஅஅஅoutput,அoutput_stateஅ=அfw_cell(inputs=x,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdtype=tf.float00,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsequence_length=seq_length,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinitial_state=previous_state)நநஅஅஅஅreturnஅoutput,அoutput_stateநநநdefஅrnn_impl_cudnn_rnn(x,அseq_length,அprevious_state,அ_):நஅஅஅஅassertஅprevious_stateஅisஅNoneஅ#அ'PassingஅpreviousஅstateஅnotஅsupportedஅwithஅCuDNNஅbackend'நநஅஅஅஅ#அHack:அCudnnLSTMஅworksஅsimilarlyஅtoஅKerasஅlayersஅinஅthatஅwhenஅyouஅinstantiateநஅஅஅஅ#அtheஅobjectஅitஅcreatesஅtheஅvariables,அandஅthenஅyouஅjustஅcallஅitஅseveralஅtimesநஅஅஅஅ#அtoஅenableஅvariableஅre-use.அBecauseஅallஅofஅourஅcodeஅisஅstructureஅinஅanஅoldநஅஅஅஅ#அschoolஅTensorFlowஅstructureஅwhereஅyouஅcanஅjustஅcallஅtf.get_variableஅagainஅwithநஅஅஅஅ#அreuse=Trueஅtoஅreuseஅvariables,அweஅcan'tஅeasilyஅmakeஅuseஅofஅtheஅobjectஅorientedநஅஅஅஅ#அwayஅCudnnLSTMஅisஅimplemented,அsoஅweஅsaveஅaஅsingletonஅinstanceஅinஅtheஅfunction,நஅஅஅஅ#அemulatingஅaஅstaticஅfunctionஅvariable.நஅஅஅஅifஅnotஅrnn_impl_cudnn_rnn.cell:நஅஅஅஅஅஅஅஅ#அForwardஅdirectionஅcell:நஅஅஅஅஅஅஅஅfw_cellஅ=அtf.contrib.cudnn_rnn.CudnnLSTM(num_layers=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnum_units=Config.n_cell_dim,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinput_mode='linear_input',நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdirection='unidirectional',நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdtype=tf.float00)நஅஅஅஅஅஅஅஅrnn_impl_cudnn_rnn.cellஅ=அfw_cellநநஅஅஅஅoutput,அoutput_stateஅ=அrnn_impl_cudnn_rnn.cell(inputs=x,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsequence_lengths=seq_length)நநஅஅஅஅreturnஅoutput,அoutput_stateநநrnn_impl_cudnn_rnn.cellஅ=அNoneநநநdefஅrnn_impl_static_rnn(x,அseq_length,அprevious_state,அreuse):நஅஅஅஅwithஅtfv0.variable_scope('cudnn_lstm/rnn/multi_rnn_cell'):நஅஅஅஅஅஅஅஅ#அForwardஅdirectionஅcell:நஅஅஅஅஅஅஅஅfw_cellஅ=அtfv0.nn.rnn_cell.LSTMCell(Config.n_cell_dim,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforget_bias=0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreuse=reuse,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅname='cudnn_compatible_lstm_cell')நநஅஅஅஅஅஅஅஅ#அSplitஅrankஅNஅtensorஅintoஅlistஅofஅrankஅN-0அtensorsநஅஅஅஅஅஅஅஅxஅ=அ[x[l]அforஅlஅinஅrange(x.shape[0])]நநஅஅஅஅஅஅஅஅoutput,அoutput_stateஅ=அtfv0.nn.static_rnn(cell=fw_cell,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinputs=x,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsequence_length=seq_length,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinitial_state=previous_state,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdtype=tf.float00,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅscope='cell_0')நநஅஅஅஅஅஅஅஅoutputஅ=அtf.concat(output,அ0)நநஅஅஅஅreturnஅoutput,அoutput_stateநநநdefஅcreate_model(batch_x,அseq_length,அdropout,அreuse=False,அbatch_size=None,அprevious_state=None,அoverlap=True,அrnn_impl=rnn_impl_lstmblockfusedcell):நஅஅஅஅlayersஅ=அ{}நநஅஅஅஅ#அInputஅshape:அ[batch_size,அn_steps,அn_inputஅ+அ0*n_input*n_context]நஅஅஅஅifஅnotஅbatch_size:நஅஅஅஅஅஅஅஅbatch_sizeஅ=அtf.shape(input=batch_x)[0]நநஅஅஅஅ#அCreateஅoverlappingஅfeatureஅwindowsஅifஅneededநஅஅஅஅifஅoverlap:நஅஅஅஅஅஅஅஅbatch_xஅ=அcreate_overlapping_windows(batch_x)நநஅஅஅஅ#அReshapingஅ`batch_x`அtoஅaஅtensorஅwithஅshapeஅ`[n_steps*batch_size,அn_inputஅ+அ0*n_input*n_context]`.நஅஅஅஅ#அThisஅisஅdoneஅtoஅprepareஅtheஅbatchஅforஅinputஅintoஅtheஅfirstஅlayerஅwhichஅexpectsஅaஅtensorஅofஅrankஅ`0`.நநஅஅஅஅ#அPermuteஅn_stepsஅandஅbatch_sizeநஅஅஅஅbatch_xஅ=அtf.transpose(a=batch_x,அperm=[0,அ0,அ0,அ0])நஅஅஅஅ#அReshapeஅtoஅprepareஅinputஅforஅfirstஅlayerநஅஅஅஅbatch_xஅ=அtf.reshape(batch_x,அ[-0,அConfig.n_inputஅ+அ0*Config.n_input*Config.n_context])அ#அ(n_steps*batch_size,அn_inputஅ+அ0*n_input*n_context)நஅஅஅஅlayers['input_reshaped']அ=அbatch_xநநஅஅஅஅ#அTheஅnextஅthreeஅblocksஅwillஅpassஅ`batch_x`அthroughஅthreeஅhiddenஅlayersஅwithநஅஅஅஅ#அclippedஅRELUஅactivationஅandஅdropout.நஅஅஅஅlayers['layer_0']அ=அlayer_0அ=அdense('layer_0',அbatch_x,அConfig.n_hidden_0,அdropout_rate=dropout[0],அlayer_norm=FLAGS.layer_norm)நஅஅஅஅlayers['layer_0']அ=அlayer_0அ=அdense('layer_0',அlayer_0,அConfig.n_hidden_0,அdropout_rate=dropout[0],அlayer_norm=FLAGS.layer_norm)நஅஅஅஅlayers['layer_0']அ=அlayer_0அ=அdense('layer_0',அlayer_0,அConfig.n_hidden_0,அdropout_rate=dropout[0],அlayer_norm=FLAGS.layer_norm)நநஅஅஅஅ#அ`layer_0`அisஅnowஅreshapedஅintoஅ`[n_steps,அbatch_size,அ0*n_cell_dim]`,நஅஅஅஅ#அasஅtheஅLSTMஅRNNஅexpectsஅitsஅinputஅtoஅbeஅofஅshapeஅ`[max_time,அbatch_size,அinput_size]`.நஅஅஅஅlayer_0அ=அtf.reshape(layer_0,அ[-0,அbatch_size,அConfig.n_hidden_0])நநஅஅஅஅ#அRunஅthroughஅparametrizedஅRNNஅimplementation,அasஅweஅuseஅdifferentஅRNNsநஅஅஅஅ#அforஅtrainingஅandஅinferenceநஅஅஅஅoutput,அoutput_stateஅ=அrnn_impl(layer_0,அseq_length,அprevious_state,அreuse)நநஅஅஅஅ#அReshapeஅoutputஅfromஅaஅtensorஅofஅshapeஅ[n_steps,அbatch_size,அn_cell_dim]நஅஅஅஅ#அtoஅaஅtensorஅofஅshapeஅ[n_steps*batch_size,அn_cell_dim]நஅஅஅஅoutputஅ=அtf.reshape(output,அ[-0,அConfig.n_cell_dim])நஅஅஅஅlayers['rnn_output']அ=அoutputநஅஅஅஅlayers['rnn_output_state']அ=அoutput_stateநநஅஅஅஅ#அNowஅweஅfeedஅ`output`அtoஅtheஅfifthஅhiddenஅlayerஅwithஅclippedஅRELUஅactivationநஅஅஅஅlayers['layer_0']அ=அlayer_0அ=அdense('layer_0',அoutput,அConfig.n_hidden_0,அdropout_rate=dropout[0],அlayer_norm=FLAGS.layer_norm)நநஅஅஅஅ#அNowஅweஅapplyஅaஅfinalஅlinearஅlayerஅcreatingஅ`n_classes`அdimensionalஅvectors,அtheஅlogits.நஅஅஅஅlayers['layer_0']அ=அlayer_0அ=அdense('layer_0',அlayer_0,அConfig.n_hidden_0,அrelu=False)நநஅஅஅஅ#அFinallyஅweஅreshapeஅlayer_0அfromஅaஅtensorஅofஅshapeஅ[n_steps*batch_size,அn_hidden_0]நஅஅஅஅ#அtoஅtheஅslightlyஅmoreஅusefulஅshapeஅ[n_steps,அbatch_size,அn_hidden_0].நஅஅஅஅ#அNote,அthatஅthisஅdiffersஅfromஅtheஅinputஅinஅthatஅitஅisஅtime-major.நஅஅஅஅlayer_0அ=அtf.reshape(layer_0,அ[-0,அbatch_size,அConfig.n_hidden_0],அname='raw_logits')நஅஅஅஅlayers['raw_logits']அ=அlayer_0நநஅஅஅஅ#அOutputஅshape:அ[n_steps,அbatch_size,அn_hidden_0]நஅஅஅஅreturnஅlayer_0,அlayersநநந#அAccuracyஅandஅLossந#அ=================நந#அInஅaccordஅwithஅ'DeepஅSpeech:அScalingஅupஅend-to-endஅspeechஅrecognition'ந#அ(http://arxiv.org/abs/0000.0000),ந#அtheஅlossஅfunctionஅusedஅbyஅourஅnetworkஅshouldஅbeஅtheஅCTCஅlossஅfunctionந#அ(http://www.cs.toronto.edu/~graves/preprint.pdf).ந#அConveniently,அthisஅlossஅfunctionஅisஅimplementedஅinஅTensorFlow.ந#அThus,அweஅcanஅsimplyஅmakeஅuseஅofஅthisஅimplementationஅtoஅdefineஅourஅloss.நநdefஅcalculate_mean_edit_distance_and_loss(iterator,அdropout,அreuse):நஅஅஅஅr'''நஅஅஅஅThisஅroutineஅbeamஅsearchஅdecodesஅaஅmini-batchஅandஅcalculatesஅtheஅlossஅandஅmeanஅeditஅdistance.நஅஅஅஅNextஅtoஅtotalஅandஅaverageஅlossஅitஅreturnsஅtheஅmeanஅeditஅdistance,நஅஅஅஅtheஅdecodedஅresultஅandஅtheஅbatch'sஅoriginalஅY.நஅஅஅஅ'''நஅஅஅஅ#அObtainஅtheஅnextஅbatchஅofஅdataநஅஅஅஅbatch_filenames,அ(batch_x,அbatch_seq_len),அbatch_yஅ=அiterator.get_next()நநஅஅஅஅifஅFLAGS.train_cudnn:நஅஅஅஅஅஅஅஅrnn_implஅ=அrnn_impl_cudnn_rnnநஅஅஅஅelse:நஅஅஅஅஅஅஅஅrnn_implஅ=அrnn_impl_lstmblockfusedcellநநஅஅஅஅ#அCalculateஅtheஅlogitsஅofஅtheஅbatchநஅஅஅஅlogits,அ_அ=அcreate_model(batch_x,அbatch_seq_len,அdropout,அreuse=reuse,அrnn_impl=rnn_impl)நநஅஅஅஅ#அComputeஅtheஅCTCஅlossஅusingஅTensorFlow'sஅ`ctc_loss`நஅஅஅஅtotal_lossஅ=அtfv0.nn.ctc_loss(labels=batch_y,அinputs=logits,அsequence_length=batch_seq_len)நநஅஅஅஅ#அCheckஅifஅanyஅfilesஅleadஅtoஅnonஅfiniteஅlossநஅஅஅஅnon_finite_filesஅ=அtf.gather(batch_filenames,அtfv0.where(~tf.math.is_finite(total_loss)))நநஅஅஅஅ#அCalculateஅtheஅaverageஅlossஅacrossஅtheஅbatchநஅஅஅஅavg_lossஅ=அtf.reduce_mean(input_tensor=total_loss)நநஅஅஅஅ#அFinallyஅweஅreturnஅtheஅaverageஅlossநஅஅஅஅreturnஅavg_loss,அnon_finite_filesநநந#அAdamஅOptimizationந#அ=================நந#அInஅcontrastஅtoஅ'DeepஅSpeech:அScalingஅupஅend-to-endஅspeechஅrecognition'ந#அ(http://arxiv.org/abs/0000.0000),ந#அinஅwhichஅ'Nesterov'sஅAcceleratedஅGradientஅDescent'ந#அ(www.cs.toronto.edu/~fritz/absps/momentum.pdf)அwasஅused,ந#அweஅwillஅuseஅtheஅAdamஅmethodஅforஅoptimizationஅ(http://arxiv.org/abs/0000.0000),ந#அbecause,அgenerally,அitஅrequiresஅlessஅfine-tuning.நdefஅcreate_optimizer(learning_rate_var):நஅஅஅஅoptimizerஅ=அtfv0.train.AdamOptimizer(learning_rate=learning_rate_var,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbeta0=FLAGS.beta0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbeta0=FLAGS.beta0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅepsilon=FLAGS.epsilon)நஅஅஅஅreturnஅoptimizerநநந#அTowersந#அ======நந#அInஅorderஅtoஅproperlyஅmakeஅuseஅofஅmultipleஅGPU's,அoneஅmustஅintroduceஅnewஅabstractions,ந#அnotஅpresentஅwhenஅusingஅaஅsingleஅGPU,அthatஅfacilitateஅtheஅmulti-GPUஅuseஅcase.ந#அInஅparticular,அoneஅmustஅintroduceஅaஅmeansஅtoஅisolateஅtheஅinferenceஅandஅgradientந#அcalculationsஅonஅtheஅvariousஅGPU's.ந#அTheஅabstractionஅweஅintoduceஅforஅthisஅpurposeஅisஅcalledஅaஅ'tower'.ந#அAஅtowerஅisஅspecifiedஅbyஅtwoஅproperties:ந#அ*அ**Scope**அ-அAஅscope,அasஅprovidedஅbyஅ`tf.name_scope()`,ந#அisஅaஅmeansஅtoஅisolateஅtheஅoperationsஅwithinஅaஅtower.ந#அForஅexample,அallஅoperationsஅwithinஅ'towerஅ0'அcouldஅhaveஅtheirஅnameஅprefixedஅwithஅ`tower_0/`.ந#அ*அ**Device**அ-அAஅhardwareஅdevice,அasஅprovidedஅbyஅ`tf.device()`,ந#அonஅwhichஅallஅoperationsஅwithinஅtheஅtowerஅexecute.ந#அForஅexample,அallஅoperationsஅofஅ'towerஅ0'அcouldஅexecuteஅonஅtheஅfirstஅGPUஅ`tf.device('/gpu:0')`.நநdefஅget_tower_results(iterator,அoptimizer,அdropout_rates):நஅஅஅஅr'''நஅஅஅஅWithஅthisஅpreliminaryஅstepஅoutஅofஅtheஅway,அweஅcanஅforஅeachஅGPUஅintroduceஅaநஅஅஅஅtowerஅforஅwhich'sஅbatchஅweஅcalculateஅandஅreturnஅtheஅoptimizationஅgradientsநஅஅஅஅandஅtheஅaverageஅlossஅacrossஅtowers.நஅஅஅஅ'''நஅஅஅஅ#அToஅcalculateஅtheஅmeanஅofஅtheஅlossesநஅஅஅஅtower_avg_lossesஅ=அ[]நநஅஅஅஅ#அTowerஅgradientsஅtoஅreturnநஅஅஅஅtower_gradientsஅ=அ[]நநஅஅஅஅ#அAggregateஅanyஅnonஅfiniteஅfilesஅinஅtheஅbatchesநஅஅஅஅtower_non_finite_filesஅ=அ[]நநஅஅஅஅwithஅtfv0.variable_scope(tfv0.get_variable_scope()):நஅஅஅஅஅஅஅஅ#அLoopஅoverஅavailable_devicesநஅஅஅஅஅஅஅஅforஅiஅinஅrange(len(Config.available_devices)):நஅஅஅஅஅஅஅஅஅஅஅஅ#அExecuteஅoperationsஅofஅtowerஅiஅonஅdeviceஅiநஅஅஅஅஅஅஅஅஅஅஅஅdeviceஅ=அConfig.available_devices[i]நஅஅஅஅஅஅஅஅஅஅஅஅwithஅtf.device(device):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அCreateஅaஅscopeஅforஅallஅoperationsஅofஅtowerஅiநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwithஅtf.name_scope('tower_%d'அ%அi):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அCalculateஅtheஅavg_lossஅandஅmean_edit_distanceஅandஅretrieveஅtheஅdecodedநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அbatchஅalongஅwithஅtheஅoriginalஅbatch'sஅlabelsஅ(Y)அofஅthisஅtowerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅavg_loss,அnon_finite_filesஅ=அcalculate_mean_edit_distance_and_loss(iterator,அdropout_rates,அreuse=iஅ>அ0)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அAllowஅforஅvariablesஅtoஅbeஅre-usedஅbyஅtheஅnextஅtowerநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtfv0.get_variable_scope().reuse_variables()நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அRetainஅtower'sஅavgஅlossesநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtower_avg_losses.append(avg_loss)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அComputeஅgradientsஅforஅmodelஅparametersஅusingஅtower'sஅmini-batchநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅgradientsஅ=அoptimizer.compute_gradients(avg_loss)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அRetainஅtower'sஅgradientsநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtower_gradients.append(gradients)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtower_non_finite_files.append(non_finite_files)நநஅஅஅஅavg_loss_across_towersஅ=அtf.reduce_mean(input_tensor=tower_avg_losses,அaxis=0)நஅஅஅஅtfv0.summary.scalar(name='step_loss',அtensor=avg_loss_across_towers,அcollections=['step_summaries'])நநஅஅஅஅall_non_finite_filesஅ=அtf.concat(tower_non_finite_files,அaxis=0)நநஅஅஅஅ#அReturnஅgradientsஅandஅtheஅaverageஅlossநஅஅஅஅreturnஅtower_gradients,அavg_loss_across_towers,அall_non_finite_filesநநநdefஅaverage_gradients(tower_gradients):நஅஅஅஅr'''நஅஅஅஅAஅroutineஅforஅcomputingஅeachஅvariable'sஅaverageஅofஅtheஅgradientsஅobtainedஅfromஅtheஅGPUs.நஅஅஅஅNoteஅalsoஅthatஅthisஅcodeஅactsஅasஅaஅsynchronizationஅpointஅasஅitஅrequiresஅallநஅஅஅஅGPUsஅtoஅbeஅfinishedஅwithஅtheirஅmini-batchஅbeforeஅitஅcanஅrunஅtoஅcompletion.நஅஅஅஅ'''நஅஅஅஅ#அListஅofஅaverageஅgradientsஅtoஅreturnஅtoஅtheஅcallerநஅஅஅஅaverage_gradsஅ=அ[]நநஅஅஅஅ#அRunஅthisஅonஅcpu_deviceஅtoஅconserveஅGPUஅmemoryநஅஅஅஅwithஅtf.device(Config.cpu_device):நஅஅஅஅஅஅஅஅ#அLoopஅoverஅgradient/variableஅpairsஅfromஅallஅtowersநஅஅஅஅஅஅஅஅforஅgrad_and_varsஅinஅzip(*tower_gradients):நஅஅஅஅஅஅஅஅஅஅஅஅ#அIntroduceஅgradsஅtoஅstoreஅtheஅgradientsஅforஅtheஅcurrentஅvariableநஅஅஅஅஅஅஅஅஅஅஅஅgradsஅ=அ[]நநஅஅஅஅஅஅஅஅஅஅஅஅ#அLoopஅoverஅtheஅgradientsஅforஅtheஅcurrentஅvariableநஅஅஅஅஅஅஅஅஅஅஅஅforஅg,அ_அinஅgrad_and_vars:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அAddஅ0அdimensionஅtoஅtheஅgradientsஅtoஅrepresentஅtheஅtower.நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexpanded_gஅ=அtf.expand_dims(g,அ0)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அAppendஅonஅaஅ'tower'அdimensionஅwhichஅweஅwillஅaverageஅoverஅbelow.நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅgrads.append(expanded_g)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அAverageஅoverஅtheஅ'tower'அdimensionநஅஅஅஅஅஅஅஅஅஅஅஅgradஅ=அtf.concat(grads,அ0)நஅஅஅஅஅஅஅஅஅஅஅஅgradஅ=அtf.reduce_mean(input_tensor=grad,அaxis=0)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அCreateஅaஅgradient/variableஅtupleஅforஅtheஅcurrentஅvariableஅwithஅitsஅaverageஅgradientநஅஅஅஅஅஅஅஅஅஅஅஅgrad_and_varஅ=அ(grad,அgrad_and_vars[0][0])நநஅஅஅஅஅஅஅஅஅஅஅஅ#அAddஅtheஅcurrentஅtupleஅtoஅaverage_gradsநஅஅஅஅஅஅஅஅஅஅஅஅaverage_grads.append(grad_and_var)நநஅஅஅஅ#அReturnஅresultஅtoஅcallerநஅஅஅஅreturnஅaverage_gradsநநநந#அLoggingந#அ=======நநdefஅlog_variable(variable,அgradient=None):நஅஅஅஅr'''நஅஅஅஅWeஅintroduceஅaஅfunctionஅforஅloggingஅaஅtensorஅvariable'sஅcurrentஅstate.நஅஅஅஅItஅlogsஅscalarஅvaluesஅforஅtheஅmean,அstandardஅdeviation,அminimumஅandஅmaximum.நஅஅஅஅFurthermoreஅitஅlogsஅaஅhistogramஅofஅitsஅstateஅandஅ(ifஅgiven)அofஅanஅoptimizationஅgradient.நஅஅஅஅ'''நஅஅஅஅnameஅ=அvariable.name.replace(':',அ'_')நஅஅஅஅmeanஅ=அtf.reduce_mean(input_tensor=variable)நஅஅஅஅtfv0.summary.scalar(name='%s/mean'அஅஅ%அname,அtensor=mean)நஅஅஅஅtfv0.summary.scalar(name='%s/sttdev'அ%அname,அtensor=tf.sqrt(tf.reduce_mean(input_tensor=tf.square(variableஅ-அmean))))நஅஅஅஅtfv0.summary.scalar(name='%s/max'அஅஅஅ%அname,அtensor=tf.reduce_max(input_tensor=variable))நஅஅஅஅtfv0.summary.scalar(name='%s/min'அஅஅஅ%அname,அtensor=tf.reduce_min(input_tensor=variable))நஅஅஅஅtfv0.summary.histogram(name=name,அvalues=variable)நஅஅஅஅifஅgradientஅisஅnotஅNone:நஅஅஅஅஅஅஅஅifஅisinstance(gradient,அtf.IndexedSlices):நஅஅஅஅஅஅஅஅஅஅஅஅgrad_valuesஅ=அgradient.valuesநஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅgrad_valuesஅ=அgradientநஅஅஅஅஅஅஅஅifஅgrad_valuesஅisஅnotஅNone:நஅஅஅஅஅஅஅஅஅஅஅஅtfv0.summary.histogram(name='%s/gradients'அ%அname,அvalues=grad_values)நநநdefஅlog_grads_and_vars(grads_and_vars):நஅஅஅஅr'''நஅஅஅஅLet'sஅalsoஅintroduceஅaஅhelperஅfunctionஅforஅloggingஅcollectionsஅofஅgradient/variableஅtuples.நஅஅஅஅ'''நஅஅஅஅforஅgradient,அvariableஅinஅgrads_and_vars:நஅஅஅஅஅஅஅஅlog_variable(variable,அgradient=gradient)நநநdefஅtrain():நஅஅஅஅexception_boxஅ=அExceptionBox()நநஅஅஅஅifஅFLAGS.horovod:நஅஅஅஅஅஅஅஅimportஅhorovod.tensorflowஅasஅhvdநநஅஅஅஅ#அCreateஅtrainingஅandஅvalidationஅdatasetsநஅஅஅஅsplit_datasetஅ=அFLAGS.horovodநநஅஅஅஅtrain_setஅ=அcreate_dataset(FLAGS.train_files.split(','),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbatch_size=FLAGS.train_batch_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅepochs=FLAGS.epochs,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅaugmentations=Config.augmentations,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcache_path=FLAGS.feature_cache,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_phase=True,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexception_box=exception_box,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprocess_ahead=Config.num_devicesஅ*அFLAGS.train_batch_sizeஅ*அ0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreverse=FLAGS.reverse_train,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlimit=FLAGS.limit_train,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbuffering=FLAGS.read_buffer,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsplit_dataset=split_dataset)நநஅஅஅஅiteratorஅ=அtfv0.data.Iterator.from_structure(tfv0.data.get_output_types(train_set),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtfv0.data.get_output_shapes(train_set),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoutput_classes=tfv0.data.get_output_classes(train_set))நநஅஅஅஅ#அMakeஅinitializationஅopsஅforஅswitchingஅbetweenஅtheஅtwoஅsetsநஅஅஅஅtrain_init_opஅ=அiterator.make_initializer(train_set)நநஅஅஅஅifஅFLAGS.dev_files:நஅஅஅஅஅஅஅஅdev_sourcesஅ=அFLAGS.dev_files.split(',')நஅஅஅஅஅஅஅஅdev_setsஅ=அ[create_dataset([source],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbatch_size=FLAGS.dev_batch_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_phase=False,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexception_box=exception_box,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprocess_ahead=Config.num_devicesஅ*அFLAGS.dev_batch_sizeஅ*அ0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreverse=FLAGS.reverse_dev,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlimit=FLAGS.limit_dev,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbuffering=FLAGS.read_buffer,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsplit_dataset=split_dataset)அforஅsourceஅinஅdev_sources]நஅஅஅஅஅஅஅஅdev_init_opsஅ=அ[iterator.make_initializer(dev_set)அforஅdev_setஅinஅdev_sets]நநஅஅஅஅifஅFLAGS.metrics_files:நஅஅஅஅஅஅஅஅmetrics_sourcesஅ=அFLAGS.metrics_files.split(',')நஅஅஅஅஅஅஅஅmetrics_setsஅ=அ[create_dataset([source],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbatch_size=FLAGS.dev_batch_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_phase=False,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexception_box=exception_box,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprocess_ahead=Config.num_devicesஅ*அFLAGS.dev_batch_sizeஅ*அ0,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreverse=FLAGS.reverse_dev,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlimit=FLAGS.limit_dev,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbuffering=FLAGS.read_buffer,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsplit_dataset=split_dataset)அforஅsourceஅinஅmetrics_sources]நஅஅஅஅஅஅஅஅmetrics_init_opsஅ=அ[iterator.make_initializer(metrics_set)அforஅmetrics_setஅinஅmetrics_sets]நநஅஅஅஅ#அDropoutநஅஅஅஅdropout_ratesஅ=அ[tfv0.placeholder(tf.float00,அname='dropout_{}'.format(i))அforஅiஅinஅrange(0)]நஅஅஅஅdropout_feed_dictஅ=அ{நஅஅஅஅஅஅஅஅdropout_rates[0]:அFLAGS.dropout_rate,நஅஅஅஅஅஅஅஅdropout_rates[0]:அFLAGS.dropout_rate0,நஅஅஅஅஅஅஅஅdropout_rates[0]:அFLAGS.dropout_rate0,நஅஅஅஅஅஅஅஅdropout_rates[0]:அFLAGS.dropout_rate0,நஅஅஅஅஅஅஅஅdropout_rates[0]:அFLAGS.dropout_rate0,நஅஅஅஅஅஅஅஅdropout_rates[0]:அFLAGS.dropout_rate0,நஅஅஅஅ}நஅஅஅஅno_dropout_feed_dictஅ=அ{நஅஅஅஅஅஅஅஅrate:அ0.அforஅrateஅinஅdropout_ratesநஅஅஅஅ}நநஅஅஅஅ#அBuildingஅtheஅgraphநஅஅஅஅlearning_rate_varஅ=அtfv0.get_variable('learning_rate',அinitializer=FLAGS.learning_rate,அtrainable=False)நஅஅஅஅreduce_learning_rate_opஅ=அlearning_rate_var.assign(tf.multiply(learning_rate_var,அFLAGS.plateau_reduction))நஅஅஅஅifஅFLAGS.horovod:நஅஅஅஅஅஅஅஅ#அEffectiveஅbatchஅsizeஅinஅsynchronousஅdistributedஅtrainingஅisஅscaledஅbyஅtheஅnumberஅofஅworkers.அAnஅincreaseஅinஅlearningஅrateஅcompensatesஅforஅtheஅincreasedஅbatchஅsize.நஅஅஅஅஅஅஅஅoptimizerஅ=அcreate_optimizer(learning_rate_varஅ*அhvd.size())நஅஅஅஅஅஅஅஅoptimizerஅ=அhvd.DistributedOptimizer(optimizer)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅoptimizerஅ=அcreate_optimizer(learning_rate_var)நநஅஅஅஅ#அEnableஅmixedஅprecisionஅtrainingநஅஅஅஅifஅFLAGS.automatic_mixed_precision:நஅஅஅஅஅஅஅஅlog_info('Enablingஅautomaticஅmixedஅprecisionஅtraining.')நஅஅஅஅஅஅஅஅoptimizerஅ=அtfv0.train.experimental.enable_mixed_precision_graph_rewrite(optimizer)நநஅஅஅஅifஅFLAGS.horovod:நஅஅஅஅஅஅஅஅloss,அnon_finite_filesஅ=அcalculate_mean_edit_distance_and_loss(iterator,அdropout_rates,அreuse=False)நஅஅஅஅஅஅஅஅgradientsஅ=அoptimizer.compute_gradients(loss)நநஅஅஅஅஅஅஅஅtfv0.summary.scalar(name='step_loss',அtensor=loss,அcollections=['step_summaries'])நஅஅஅஅஅஅஅஅlog_grads_and_vars(gradients)நநஅஅஅஅஅஅஅஅ#அglobal_stepஅisஅautomagicallyஅincrementedஅbyஅtheஅoptimizerநஅஅஅஅஅஅஅஅglobal_stepஅ=அtfv0.train.get_or_create_global_step()நஅஅஅஅஅஅஅஅapply_gradient_opஅ=அoptimizer.apply_gradients(gradients,அglobal_step=global_step)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅgradients,அloss,அnon_finite_filesஅ=அget_tower_results(iterator,அoptimizer,அdropout_rates)நநஅஅஅஅஅஅஅஅ#அAverageஅtowerஅgradientsஅacrossஅGPUsநஅஅஅஅஅஅஅஅavg_tower_gradientsஅ=அaverage_gradients(gradients)நஅஅஅஅஅஅஅஅlog_grads_and_vars(avg_tower_gradients)நநஅஅஅஅஅஅஅஅ#அglobal_stepஅisஅautomagicallyஅincrementedஅbyஅtheஅoptimizerநஅஅஅஅஅஅஅஅglobal_stepஅ=அtfv0.train.get_or_create_global_step()நஅஅஅஅஅஅஅஅapply_gradient_opஅ=அoptimizer.apply_gradients(avg_tower_gradients,அglobal_step=global_step)நநஅஅஅஅ#அSummariesநஅஅஅஅstep_summaries_opஅ=அtfv0.summary.merge_all('step_summaries')நஅஅஅஅstep_summary_writersஅ=அ{நஅஅஅஅஅஅஅஅ'train':அtfv0.summary.FileWriter(os.path.join(FLAGS.summary_dir,அ'train'),அmax_queue=000),நஅஅஅஅஅஅஅஅ'dev':அtfv0.summary.FileWriter(os.path.join(FLAGS.summary_dir,அ'dev'),அmax_queue=000),நஅஅஅஅஅஅஅஅ'metrics':அtfv0.summary.FileWriter(os.path.join(FLAGS.summary_dir,அ'metrics'),அmax_queue=000),நஅஅஅஅ}நநஅஅஅஅhuman_readable_set_namesஅ=அ{நஅஅஅஅஅஅஅஅ'train':அ'Training',நஅஅஅஅஅஅஅஅ'dev':அ'Validation',நஅஅஅஅஅஅஅஅ'metrics':அ'Metrics',நஅஅஅஅ}நநஅஅஅஅ#அCheckpointingநஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅcheckpoint_saverஅ=அtfv0.train.Saver(max_to_keep=FLAGS.max_to_keep)நஅஅஅஅஅஅஅஅcheckpoint_pathஅ=அos.path.join(FLAGS.save_checkpoint_dir,அ'train')நநஅஅஅஅஅஅஅஅbest_dev_saverஅ=அtfv0.train.Saver(max_to_keep=0)நஅஅஅஅஅஅஅஅbest_dev_pathஅ=அos.path.join(FLAGS.save_checkpoint_dir,அ'best_dev')நநஅஅஅஅஅஅஅஅ#அSaveஅflagsஅnextஅtoஅcheckpointsநஅஅஅஅஅஅஅஅifஅnotஅis_remote_path(FLAGS.save_checkpoint_dir):நஅஅஅஅஅஅஅஅஅஅஅஅos.makedirs(FLAGS.save_checkpoint_dir,அexist_ok=True)நஅஅஅஅஅஅஅஅflags_fileஅ=அos.path.join(FLAGS.save_checkpoint_dir,அ'flags.txt')நஅஅஅஅஅஅஅஅwithஅopen_remote(flags_file,அ'w')அasஅfout:நஅஅஅஅஅஅஅஅஅஅஅஅfout.write(FLAGS.flags_into_string())நநஅஅஅஅifஅFLAGS.horovod:நஅஅஅஅஅஅஅஅbcastஅ=அhvd.broadcast_global_variables(0)நநஅஅஅஅwithஅtfv0.Session(config=Config.session_config)அasஅsession:நஅஅஅஅஅஅஅஅlog_debug('Sessionஅopened.')நநஅஅஅஅஅஅஅஅ#அPreventஅfurtherஅgraphஅchangesநஅஅஅஅஅஅஅஅtfv0.get_default_graph().finalize()நநஅஅஅஅஅஅஅஅ#அLoadஅcheckpointஅorஅinitializeஅvariablesநஅஅஅஅஅஅஅஅload_or_init_graph_for_training(session)நஅஅஅஅஅஅஅஅifஅFLAGS.horovod:நஅஅஅஅஅஅஅஅஅஅஅஅbcast.run()நநஅஅஅஅஅஅஅஅdefஅrun_set(set_name,அepoch,அinit_op,அdataset=None):நஅஅஅஅஅஅஅஅஅஅஅஅis_trainஅ=அset_nameஅ==அ'train'நஅஅஅஅஅஅஅஅஅஅஅஅtrain_opஅ=அapply_gradient_opஅifஅis_trainஅelseஅ[]நஅஅஅஅஅஅஅஅஅஅஅஅfeed_dictஅ=அdropout_feed_dictஅifஅis_trainஅelseஅno_dropout_feed_dictநநஅஅஅஅஅஅஅஅஅஅஅஅtotal_lossஅ=அ0.0நஅஅஅஅஅஅஅஅஅஅஅஅstep_countஅ=அ0நநஅஅஅஅஅஅஅஅஅஅஅஅstep_summary_writerஅ=அstep_summary_writers.get(set_name)நஅஅஅஅஅஅஅஅஅஅஅஅcheckpoint_timeஅ=அtime.time()நநஅஅஅஅஅஅஅஅஅஅஅஅifஅis_trainஅandஅFLAGS.cache_for_epochsஅ>அ0அandஅFLAGS.feature_cache:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfeature_cache_indexஅ=அFLAGS.feature_cacheஅ+அ'.index'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅepochஅ%அFLAGS.cache_for_epochsஅ==அ0அandஅos.path.isfile(feature_cache_index):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Invalidatingஅfeatureஅcache')நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅremove_remote(feature_cache_index)அஅ#அthisஅwillஅletஅTFஅalsoஅoverwriteஅtheஅrelatedஅcacheஅdataஅfilesநநஅஅஅஅஅஅஅஅஅஅஅஅ#அSetupஅprogressஅbarநஅஅஅஅஅஅஅஅஅஅஅஅclassஅLossWidget(progressbar.widgets.FormatLabel):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdefஅ__init__(self):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprogressbar.widgets.FormatLabel.__init__(self,அformat='Loss:அ%(mean_loss)f')நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdefஅ__call__(self,அprogress,அdata,அ**kwargs):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdata['mean_loss']அ=அtotal_lossஅ/அstep_countஅifஅstep_countஅelseஅ0.0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreturnஅprogressbar.widgets.FormatLabel.__call__(self,அprogress,அdata,அ**kwargs)நநஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprefixஅ=அ'Epochஅ{}அ|அ{:>00}'.format(epoch,அhuman_readable_set_names[set_name])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwidgetsஅ=அ['அ|அ',அprogressbar.widgets.Timer(),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'அ|அSteps:அ',அprogressbar.widgets.Counter(),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'அ|அ',அLossWidget()]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsuffixஅ=அ'அ|அDataset:அ{}'.format(dataset)அifஅdatasetஅelseஅNoneநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅpbarஅ=அcreate_progressbar(prefix=prefix,அwidgets=widgets,அsuffix=suffix).start()நநஅஅஅஅஅஅஅஅஅஅஅஅ#அInitializeஅiteratorஅtoஅtheஅappropriateஅdatasetநஅஅஅஅஅஅஅஅஅஅஅஅsession.run(init_op)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அBatchஅloopநஅஅஅஅஅஅஅஅஅஅஅஅwhileஅTrue:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ_,அcurrent_step,அbatch_loss,அproblem_files,அstep_summaryஅ=அ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsession.run([train_op,அglobal_step,அloss,அnon_finite_files,அstep_summaries_op],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfeed_dict=feed_dict)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexception_box.raise_if_set()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexceptஅtf.errors.OutOfRangeError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexception_box.raise_if_set()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbreakநநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅproblem_files.sizeஅ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅproblem_filesஅ=அ[f.decode('utf0')அforஅfஅinஅproblem_files[...,அ0]]நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_error('Theஅfollowingஅfilesஅcausedஅanஅinfiniteஅ(orஅNaN)அ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'loss:அ{}'.format(','.join(problem_files)))நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtotal_lossஅ+=அbatch_lossநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstep_countஅ+=அ0நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅpbar.update(step_count)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstep_summary_writer.add_summary(step_summary,அcurrent_step)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅis_trainஅandஅFLAGS.checkpoint_secsஅ>அ0அandஅtime.time()அ-அcheckpoint_timeஅ>அFLAGS.checkpoint_secs:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcheckpoint_saver.save(session,அcheckpoint_path,அglobal_step=current_step)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcheckpoint_timeஅ=அtime.time()நநஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅpbar.finish()நஅஅஅஅஅஅஅஅஅஅஅஅmean_lossஅ=அtotal_lossஅ/அstep_countஅifஅstep_countஅ>அ0அelseஅ0.0நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅmean_loss,அstep_countநநஅஅஅஅஅஅஅஅlog_info('STARTINGஅOptimization')நஅஅஅஅஅஅஅஅtrain_start_timeஅ=அdatetime.utcnow()நஅஅஅஅஅஅஅஅbest_dev_lossஅ=அfloat('inf')நஅஅஅஅஅஅஅஅdev_lossesஅ=அ[]நஅஅஅஅஅஅஅஅepochs_without_improvementஅ=அ0நஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅforஅepochஅinஅrange(FLAGS.epochs):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அTrainingநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_progress('Trainingஅepochஅ%d...'அ%அepoch)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_loss,அ_அ=அrun_set('train',அepoch,அtrain_init_op)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_progress('Finishedஅtrainingஅepochஅ%dஅ-அloss:அ%f'அ%அ(epoch,அtrain_loss))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcheckpoint_saver.save(session,அcheckpoint_path,அglobal_step=global_step)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅFLAGS.dev_files:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அValidationநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_lossஅ=அ0.0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtotal_stepsஅ=அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅsource,அinit_opஅinஅzip(dev_sources,அdev_init_ops):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_progress('Validatingஅepochஅ%dஅonஅ%s...'அ%அ(epoch,அsource))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅset_loss,அstepsஅ=அrun_set('dev',அepoch,அinit_op,அdataset=source)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_lossஅ+=அset_lossஅ*அstepsநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtotal_stepsஅ+=அstepsநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_progress('Finishedஅvalidatingஅepochஅ%dஅonஅ%sஅ-அloss:அ%f'அ%அ(epoch,அsource,அset_loss))நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_lossஅ=அdev_lossஅ/அtotal_stepsநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdev_losses.append(dev_loss)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அCountஅepochsஅwithoutஅanஅimprovementஅforஅearlyஅstoppingஅandஅreductionஅofஅlearningஅrateஅonஅaஅplateauநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அtheஅimprovementஅhasஅtoஅbeஅgreaterஅthanஅFLAGS.es_min_deltaநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅdev_lossஅ>அbest_dev_lossஅ-அFLAGS.es_min_delta:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅepochs_without_improvementஅ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅepochs_without_improvementஅ=அ0நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அSaveஅnewஅbestஅmodelநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅdev_lossஅ<அbest_dev_loss:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbest_dev_lossஅ=அdev_lossநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsave_pathஅ=அbest_dev_saver.save(session,அbest_dev_path,அglobal_step=global_step,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlatest_filename='best_dev_checkpoint')நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_info("Savedஅnewஅbestஅvalidatingஅmodelஅwithஅlossஅ%fஅto:அ%s"அ%அ(best_dev_loss,அsave_path))நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அEarlyஅstoppingநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅFLAGS.early_stopஅandஅepochs_without_improvementஅ==அFLAGS.es_epochs:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Earlyஅstopஅtriggeredஅasஅtheஅlossஅdidஅnotஅimproveஅtheஅlastஅ{}அepochs'.format(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅepochs_without_improvement))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbreakநநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அReduceஅlearningஅrateஅonஅplateauநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அIfஅtheஅlearningஅrateஅwasஅreducedஅandஅthereஅisஅstillஅnoஅimprovementநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அwaitஅFLAGS.plateau_epochsஅbeforeஅtheஅlearningஅrateஅisஅreducedஅagainநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅ(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅFLAGS.reduce_lr_on_plateauநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅandஅepochs_without_improvementஅ>அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅandஅepochs_without_improvementஅ%அFLAGS.plateau_epochsஅ==அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அReloadஅcheckpointஅthatஅweஅuseஅtheஅbest_devஅweightsஅagainநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreload_best_checkpoint(session)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அReduceஅlearningஅrateநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsession.run(reduce_learning_rate_op)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcurrent_learning_rateஅ=அlearning_rate_var.eval()நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Encounteredஅaஅplateau,அreducingஅlearningஅrateஅtoஅ{}'.format(நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcurrent_learning_rate))நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அOverwriteஅbestஅcheckpointஅwithஅnewஅlearningஅrateஅvalueநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsave_pathஅ=அbest_dev_saver.save(session,அbest_dev_path,அglobal_step=global_step,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlatest_filename='best_dev_checkpoint')நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_info("Savedஅbestஅvalidatingஅmodelஅwithஅreducedஅlearningஅrateஅto:அ%s"அ%அ(save_path))நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅFLAGS.metrics_files:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ#அReadஅonlyஅmetrics,அnotஅaffectingஅbestஅvalidationஅlossஅtrackingநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅforஅsource,அinit_opஅinஅzip(metrics_sources,அmetrics_init_ops):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_progress('Metricsஅforஅepochஅ%dஅonஅ%s...'அ%அ(epoch,அsource))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅset_loss,அ_அ=அrun_set('metrics',அepoch,அinit_op,அdataset=source)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_progress('Metricsஅforஅepochஅ%dஅonஅ%sஅ-அloss:அ%f'அ%அ(epoch,அsource,அset_loss))நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprint('-'அ*அ00)நநநஅஅஅஅஅஅஅஅexceptஅKeyboardInterrupt:நஅஅஅஅஅஅஅஅஅஅஅஅpassநஅஅஅஅஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅஅஅஅஅlog_info('FINISHEDஅoptimizationஅinஅ{}'.format(datetime.utcnow()அ-அtrain_start_time))நஅஅஅஅlog_debug('Sessionஅclosed.')நநநdefஅtest():நஅஅஅஅsamplesஅ=அevaluate(FLAGS.test_files.split(','),அcreate_model)நஅஅஅஅifஅFLAGS.test_output_file:நஅஅஅஅஅஅஅஅsave_samples_json(samples,அFLAGS.test_output_file)நநநdefஅcreate_inference_graph(batch_size=0,அn_steps=00,அtflite=False):நஅஅஅஅbatch_sizeஅ=அbatch_sizeஅifஅbatch_sizeஅ>அ0அelseஅNoneநநஅஅஅஅ#அCreateஅfeatureஅcomputationஅgraphநஅஅஅஅinput_samplesஅ=அtfv0.placeholder(tf.float00,அ[Config.audio_window_samples],அ'input_samples')நஅஅஅஅsamplesஅ=அtf.expand_dims(input_samples,அ-0)நஅஅஅஅmfccs,அ_அ=அaudio_to_features(samples,அFLAGS.audio_sample_rate)நஅஅஅஅmfccsஅ=அtf.identity(mfccs,அname='mfccs')நநஅஅஅஅ#அInputஅtensorஅwillஅbeஅofஅshapeஅ[batch_size,அn_steps,அ0*n_context+0,அn_input]நஅஅஅஅ#அThisஅshapeஅisஅreadஅbyஅtheஅnative_clientஅinஅDS_CreateModelஅtoஅknowஅtheநஅஅஅஅ#அvalueஅofஅn_steps,அn_contextஅandஅn_input.அMakeஅsureஅyouஅupdateஅtheஅcodeநஅஅஅஅ#அthereஅifஅthisஅshapeஅisஅchanged.நஅஅஅஅinput_tensorஅ=அtfv0.placeholder(tf.float00,அ[batch_size,அn_stepsஅifஅn_stepsஅ>அ0அelseஅNone,அ0அ*அConfig.n_contextஅ+அ0,அConfig.n_input],அname='input_node')நஅஅஅஅseq_lengthஅ=அtfv0.placeholder(tf.int00,அ[batch_size],அname='input_lengths')நநஅஅஅஅifஅbatch_sizeஅ<=அ0:நஅஅஅஅஅஅஅஅ#அnoஅstateஅmanagementஅsinceஅn_stepஅisஅexpectedஅtoஅbeஅdynamicஅtooஅ(seeஅbelow)நஅஅஅஅஅஅஅஅprevious_stateஅ=அNoneநஅஅஅஅelse:நஅஅஅஅஅஅஅஅprevious_state_cஅ=அtfv0.placeholder(tf.float00,அ[batch_size,அConfig.n_cell_dim],அname='previous_state_c')நஅஅஅஅஅஅஅஅprevious_state_hஅ=அtfv0.placeholder(tf.float00,அ[batch_size,அConfig.n_cell_dim],அname='previous_state_h')நநஅஅஅஅஅஅஅஅprevious_stateஅ=அtf.nn.rnn_cell.LSTMStateTuple(previous_state_c,அprevious_state_h)நநஅஅஅஅ#அOneஅrateஅperஅlayerநஅஅஅஅno_dropoutஅ=அ[None]அ*அ0நநஅஅஅஅifஅtflite:நஅஅஅஅஅஅஅஅrnn_implஅ=அrnn_impl_static_rnnநஅஅஅஅelse:நஅஅஅஅஅஅஅஅrnn_implஅ=அrnn_impl_lstmblockfusedcellநநஅஅஅஅlogits,அlayersஅ=அcreate_model(batch_x=input_tensor,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbatch_size=batch_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅseq_length=seq_lengthஅifஅnotஅFLAGS.export_tfliteஅelseஅNone,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdropout=no_dropout,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅprevious_state=previous_state,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoverlap=False,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅrnn_impl=rnn_impl)நநஅஅஅஅ#அTFஅLiteஅruntimeஅwillஅcheckஅthatஅinputஅdimensionsஅareஅ0,அ0அorஅ0நஅஅஅஅ#அbyஅdefaultஅweஅgetஅ0,அtheஅmiddleஅoneஅbeingஅbatch_sizeஅwhichஅisஅforcedஅtoநஅஅஅஅ#அoneஅonஅinferenceஅgraph,அsoஅremoveஅthatஅdimensionநஅஅஅஅifஅtflite:நஅஅஅஅஅஅஅஅlogitsஅ=அtf.squeeze(logits,அ[0])நநஅஅஅஅ#அApplyஅsoftmaxஅforஅCTCஅdecoderநஅஅஅஅprobsஅ=அtf.nn.softmax(logits,அname='logits')நநஅஅஅஅifஅbatch_sizeஅ<=அ0:நஅஅஅஅஅஅஅஅifஅtflite:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅNotImplementedError('dynamicஅbatch_sizeஅdoesஅnotஅsupportஅtfliteஅnorஅstreaming')நஅஅஅஅஅஅஅஅifஅn_stepsஅ>அ0:நஅஅஅஅஅஅஅஅஅஅஅஅraiseஅNotImplementedError('dynamicஅbatch_sizeஅexpectஅn_stepsஅtoஅbeஅdynamicஅtoo')நஅஅஅஅஅஅஅஅreturnஅ(நஅஅஅஅஅஅஅஅஅஅஅஅ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'input':அinput_tensor,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'input_lengths':அseq_length,நஅஅஅஅஅஅஅஅஅஅஅஅ},நஅஅஅஅஅஅஅஅஅஅஅஅ{நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'outputs':அprobs,நஅஅஅஅஅஅஅஅஅஅஅஅ},நஅஅஅஅஅஅஅஅஅஅஅஅlayersநஅஅஅஅஅஅஅஅ)நநஅஅஅஅnew_state_c,அnew_state_hஅ=அlayers['rnn_output_state']நஅஅஅஅnew_state_cஅ=அtf.identity(new_state_c,அname='new_state_c')நஅஅஅஅnew_state_hஅ=அtf.identity(new_state_h,அname='new_state_h')நநஅஅஅஅinputsஅ=அ{நஅஅஅஅஅஅஅஅ'input':அinput_tensor,நஅஅஅஅஅஅஅஅ'previous_state_c':அprevious_state_c,நஅஅஅஅஅஅஅஅ'previous_state_h':அprevious_state_h,நஅஅஅஅஅஅஅஅ'input_samples':அinput_samples,நஅஅஅஅ}நநஅஅஅஅifஅnotஅFLAGS.export_tflite:நஅஅஅஅஅஅஅஅinputs['input_lengths']அ=அseq_lengthநநஅஅஅஅoutputsஅ=அ{நஅஅஅஅஅஅஅஅ'outputs':அprobs,நஅஅஅஅஅஅஅஅ'new_state_c':அnew_state_c,நஅஅஅஅஅஅஅஅ'new_state_h':அnew_state_h,நஅஅஅஅஅஅஅஅ'mfccs':அmfccs,நநஅஅஅஅஅஅஅஅ#அExposeஅinternalஅlayersஅforஅdownstreamஅapplicationsநஅஅஅஅஅஅஅஅ'layer_0':அlayers['layer_0'],நஅஅஅஅஅஅஅஅ'layer_0':அlayers['layer_0']நஅஅஅஅ}நநஅஅஅஅreturnஅinputs,அoutputs,அlayersநநநdefஅfile_relative_read(fname):நஅஅஅஅreturnஅopen(os.path.join(os.path.dirname(__file__),அfname)).read()நநநdefஅexport():நஅஅஅஅr'''நஅஅஅஅRestoresஅtheஅtrainedஅvariablesஅintoஅaஅsimplerஅgraphஅthatஅwillஅbeஅexportedஅforஅserving.நஅஅஅஅ'''நஅஅஅஅlog_info('Exportingஅtheஅmodel...')நநஅஅஅஅinputs,அoutputs,அ_அ=அcreate_inference_graph(batch_size=FLAGS.export_batch_size,அn_steps=FLAGS.n_steps,அtflite=FLAGS.export_tflite)நநஅஅஅஅgraph_versionஅ=அint(file_relative_read('GRAPH_VERSION').strip())நஅஅஅஅassertஅgraph_versionஅ>அ0நநஅஅஅஅoutputs['metadata_version']அ=அtf.constant([graph_version],அname='metadata_version')நஅஅஅஅoutputs['metadata_sample_rate']அ=அtf.constant([FLAGS.audio_sample_rate],அname='metadata_sample_rate')நஅஅஅஅoutputs['metadata_feature_win_len']அ=அtf.constant([FLAGS.feature_win_len],அname='metadata_feature_win_len')நஅஅஅஅoutputs['metadata_feature_win_step']அ=அtf.constant([FLAGS.feature_win_step],அname='metadata_feature_win_step')நஅஅஅஅoutputs['metadata_beam_width']அ=அtf.constant([FLAGS.export_beam_width],அname='metadata_beam_width')நஅஅஅஅoutputs['metadata_alphabet']அ=அtf.constant([Config.alphabet.Serialize()],அname='metadata_alphabet')நநஅஅஅஅifஅFLAGS.export_language:நஅஅஅஅஅஅஅஅoutputs['metadata_language']அ=அtf.constant([FLAGS.export_language.encode('utf-0')],அname='metadata_language')நநஅஅஅஅ#அPreventஅfurtherஅgraphஅchangesநஅஅஅஅtfv0.get_default_graph().finalize()நநஅஅஅஅoutput_names_tensorsஅ=அ[tensor.op.nameஅforஅtensorஅinஅoutputs.values()அifஅisinstance(tensor,அtf.Tensor)]நஅஅஅஅoutput_names_opsஅ=அ[op.nameஅforஅopஅinஅoutputs.values()அifஅisinstance(op,அtf.Operation)]நஅஅஅஅoutput_namesஅ=அoutput_names_tensorsஅ+அoutput_names_opsநநஅஅஅஅwithஅtf.Session()அasஅsession:நஅஅஅஅஅஅஅஅ#அRestoreஅvariablesஅfromஅcheckpointநஅஅஅஅஅஅஅஅload_graph_for_evaluation(session)நநஅஅஅஅஅஅஅஅoutput_filenameஅ=அFLAGS.export_file_nameஅ+அ'.pb'நஅஅஅஅஅஅஅஅifஅFLAGS.remove_export:நஅஅஅஅஅஅஅஅஅஅஅஅifஅisdir_remote(FLAGS.export_dir):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_info('Removingஅoldஅexport')நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅremove_remote(FLAGS.export_dir)நநஅஅஅஅஅஅஅஅoutput_graph_pathஅ=அos.path.join(FLAGS.export_dir,அoutput_filename)நநஅஅஅஅஅஅஅஅifஅnotஅis_remote_path(FLAGS.export_dir)அandஅnotஅos.path.isdir(FLAGS.export_dir):நஅஅஅஅஅஅஅஅஅஅஅஅos.makedirs(FLAGS.export_dir)நநஅஅஅஅஅஅஅஅfrozen_graphஅ=அtfv0.graph_util.convert_variables_to_constants(நஅஅஅஅஅஅஅஅஅஅஅஅsess=session,நஅஅஅஅஅஅஅஅஅஅஅஅinput_graph_def=tfv0.get_default_graph().as_graph_def(),நஅஅஅஅஅஅஅஅஅஅஅஅoutput_node_names=output_names)நநஅஅஅஅஅஅஅஅfrozen_graphஅ=அtfv0.graph_util.extract_sub_graph(நஅஅஅஅஅஅஅஅஅஅஅஅgraph_def=frozen_graph,நஅஅஅஅஅஅஅஅஅஅஅஅdest_nodes=output_names)நநஅஅஅஅஅஅஅஅifஅnotஅFLAGS.export_tflite:நஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen_remote(output_graph_path,அ'wb')அasஅfout:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfout.write(frozen_graph.SerializeToString())நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅoutput_tflite_pathஅ=அos.path.join(FLAGS.export_dir,அoutput_filename.replace('.pb',அ'.tflite'))நநஅஅஅஅஅஅஅஅஅஅஅஅconverterஅ=அtf.lite.TFLiteConverter(frozen_graph,அinput_tensors=inputs.values(),அoutput_tensors=outputs.values())நஅஅஅஅஅஅஅஅஅஅஅஅconverter.optimizationsஅ=அ[tf.lite.Optimize.DEFAULT]நஅஅஅஅஅஅஅஅஅஅஅஅ#அAudioSpectrogramஅandஅMfccஅopsஅareஅcustomஅbutஅhaveஅbuilt-inஅkernelsஅinஅTFLiteநஅஅஅஅஅஅஅஅஅஅஅஅconverter.allow_custom_opsஅ=அTrueநஅஅஅஅஅஅஅஅஅஅஅஅtflite_modelஅ=அconverter.convert()நநஅஅஅஅஅஅஅஅஅஅஅஅwithஅopen_remote(output_tflite_path,அ'wb')அasஅfout:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅfout.write(tflite_model)நநஅஅஅஅஅஅஅஅlog_info('Modelsஅexportedஅatஅ%s'அ%அ(FLAGS.export_dir))நநஅஅஅஅmetadata_fnameஅ=அos.path.join(FLAGS.export_dir,அ'{}_{}_{}.md'.format(நஅஅஅஅஅஅஅஅFLAGS.export_author_id,நஅஅஅஅஅஅஅஅFLAGS.export_model_name,நஅஅஅஅஅஅஅஅFLAGS.export_model_version))நநஅஅஅஅmodel_runtimeஅ=அ'tflite'அifஅFLAGS.export_tfliteஅelseஅ'tensorflow'நஅஅஅஅwithஅopen_remote(metadata_fname,அ'w')அasஅf:நஅஅஅஅஅஅஅஅf.write('---\n')நஅஅஅஅஅஅஅஅf.write('author:அ{}\n'.format(FLAGS.export_author_id))நஅஅஅஅஅஅஅஅf.write('model_name:அ{}\n'.format(FLAGS.export_model_name))நஅஅஅஅஅஅஅஅf.write('model_version:அ{}\n'.format(FLAGS.export_model_version))நஅஅஅஅஅஅஅஅf.write('contact_info:அ{}\n'.format(FLAGS.export_contact_info))நஅஅஅஅஅஅஅஅf.write('license:அ{}\n'.format(FLAGS.export_license))நஅஅஅஅஅஅஅஅf.write('language:அ{}\n'.format(FLAGS.export_language))நஅஅஅஅஅஅஅஅf.write('runtime:அ{}\n'.format(model_runtime))நஅஅஅஅஅஅஅஅf.write('min_ds_version:அ{}\n'.format(FLAGS.export_min_ds_version))நஅஅஅஅஅஅஅஅf.write('max_ds_version:அ{}\n'.format(FLAGS.export_max_ds_version))நஅஅஅஅஅஅஅஅf.write('acoustic_model_url:அ<replaceஅthisஅwithஅaஅpubliclyஅavailableஅURLஅofஅtheஅacousticஅmodel>\n')நஅஅஅஅஅஅஅஅf.write('scorer_url:அ<replaceஅthisஅwithஅaஅpubliclyஅavailableஅURLஅofஅtheஅscorer,அifஅpresent>\n')நஅஅஅஅஅஅஅஅf.write('---\n')நஅஅஅஅஅஅஅஅf.write('{}\n'.format(FLAGS.export_description))நநஅஅஅஅlog_info('Modelஅmetadataஅfileஅsavedஅtoஅ{}.அBeforeஅsubmittingஅtheஅexportedஅmodelஅforஅpublishingஅmakeஅsureஅallஅinformationஅinஅtheஅmetadataஅfileஅisஅcorrect,அandஅcompleteஅtheஅURLஅfields.'.format(metadata_fname))நநநdefஅpackage_zip():நஅஅஅஅ#அ--export_dirஅpath/to/export/LANG_CODE/அ=>அpath/to/export/LANG_CODE.zipநஅஅஅஅexport_dirஅ=அos.path.join(os.path.abspath(FLAGS.export_dir),அ'')அ#அForceஅendingஅ'/'நஅஅஅஅifஅis_remote_path(export_dir):நஅஅஅஅஅஅஅஅlog_error("Cannotஅpackageஅremoteஅpathஅzipஅ%s.அPleaseஅdoஅthisஅmanually."அ%அexport_dir)நஅஅஅஅஅஅஅஅreturnநநஅஅஅஅzip_filenameஅ=அos.path.dirname(export_dir)நஅஅஅஅநஅஅஅஅshutil.copy(FLAGS.scorer_path,அexport_dir)நநஅஅஅஅarchiveஅ=அshutil.make_archive(zip_filename,அ'zip',அexport_dir)நஅஅஅஅlog_info('Exportedஅpackagedஅmodelஅ{}'.format(archive))நநநdefஅdo_single_file_inference(input_file_path):நஅஅஅஅwithஅtfv0.Session(config=Config.session_config)அasஅsession:நஅஅஅஅஅஅஅஅinputs,அoutputs,அ_அ=அcreate_inference_graph(batch_size=0,அn_steps=-0)நநஅஅஅஅஅஅஅஅ#அRestoreஅvariablesஅfromஅtrainingஅcheckpointநஅஅஅஅஅஅஅஅload_graph_for_evaluation(session)நநஅஅஅஅஅஅஅஅfeatures,அfeatures_lenஅ=அaudiofile_to_features(input_file_path)நஅஅஅஅஅஅஅஅprevious_state_cஅ=அnp.zeros([0,அConfig.n_cell_dim])நஅஅஅஅஅஅஅஅprevious_state_hஅ=அnp.zeros([0,அConfig.n_cell_dim])நநஅஅஅஅஅஅஅஅ#அAddஅbatchஅdimensionநஅஅஅஅஅஅஅஅfeaturesஅ=அtf.expand_dims(features,அ0)நஅஅஅஅஅஅஅஅfeatures_lenஅ=அtf.expand_dims(features_len,அ0)நநஅஅஅஅஅஅஅஅ#அEvaluateநஅஅஅஅஅஅஅஅfeaturesஅ=அcreate_overlapping_windows(features).eval(session=session)நஅஅஅஅஅஅஅஅfeatures_lenஅ=அfeatures_len.eval(session=session)நநஅஅஅஅஅஅஅஅprobsஅ=அoutputs['outputs'].eval(feed_dict={நஅஅஅஅஅஅஅஅஅஅஅஅinputs['input']:அfeatures,நஅஅஅஅஅஅஅஅஅஅஅஅinputs['input_lengths']:அfeatures_len,நஅஅஅஅஅஅஅஅஅஅஅஅinputs['previous_state_c']:அprevious_state_c,நஅஅஅஅஅஅஅஅஅஅஅஅinputs['previous_state_h']:அprevious_state_h,நஅஅஅஅஅஅஅஅ},அsession=session)நநஅஅஅஅஅஅஅஅprobsஅ=அnp.squeeze(probs)நநஅஅஅஅஅஅஅஅifஅFLAGS.scorer_path:நஅஅஅஅஅஅஅஅஅஅஅஅscorerஅ=அScorer(FLAGS.lm_alpha,அFLAGS.lm_beta,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅFLAGS.scorer_path,அConfig.alphabet)நஅஅஅஅஅஅஅஅelse:நஅஅஅஅஅஅஅஅஅஅஅஅscorerஅ=அNoneநஅஅஅஅஅஅஅஅdecodedஅ=அctc_beam_search_decoder(probs,அConfig.alphabet,அFLAGS.beam_width,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅscorer=scorer,அcutoff_prob=FLAGS.cutoff_prob,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcutoff_top_n=FLAGS.cutoff_top_n)நஅஅஅஅஅஅஅஅ#அPrintஅhighestஅprobabilityஅresultநஅஅஅஅஅஅஅஅprint(decoded[0][0])நநநdefஅearly_training_checks():நஅஅஅஅ#அCheckஅforஅproperஅscorerஅearlyநஅஅஅஅifஅFLAGS.scorer_path:நஅஅஅஅஅஅஅஅscorerஅ=அScorer(FLAGS.lm_alpha,அFLAGS.lm_beta,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅFLAGS.scorer_path,அConfig.alphabet)நஅஅஅஅஅஅஅஅdelஅscorerநநஅஅஅஅifஅFLAGS.train_filesஅandஅFLAGS.test_filesஅandஅFLAGS.load_checkpoint_dirஅ!=அFLAGS.save_checkpoint_dir:நஅஅஅஅஅஅஅஅlog_warn('WARNING:அYouஅspecifiedஅdifferentஅvaluesஅforஅ--load_checkpoint_dirஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'andஅ--save_checkpoint_dir,அbutஅyouஅareஅrunningஅtrainingஅandஅtestingஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'inஅaஅsingleஅinvocation.அTheஅtestingஅstepஅwillஅrespectஅ--load_checkpoint_dir,அ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'andஅthusஅWILLஅNOTஅTESTஅTHEஅCHECKPOINTஅCREATEDஅBYஅTHEஅTRAININGஅSTEP.அ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'Trainஅandஅtestஅinஅtwoஅseparateஅinvocations,அspecifyingஅtheஅcorrectஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'--load_checkpoint_dirஅinஅbothஅcases,அorஅuseஅtheஅsameஅlocationஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'forஅloadingஅandஅsaving.')நநநdefஅmain(_):நஅஅஅஅinitialize_globals()நஅஅஅஅearly_training_checks()நநஅஅஅஅifஅFLAGS.train_files:நஅஅஅஅஅஅஅஅtfv0.reset_default_graph()நஅஅஅஅஅஅஅஅtfv0.set_random_seed(FLAGS.random_seed)நநஅஅஅஅஅஅஅஅtrain()நநஅஅஅஅifஅConfig.is_master_process:நஅஅஅஅஅஅஅஅifஅFLAGS.test_files:நஅஅஅஅஅஅஅஅஅஅஅஅtfv0.reset_default_graph()நஅஅஅஅஅஅஅஅஅஅஅஅtest()நநஅஅஅஅஅஅஅஅifஅFLAGS.export_dirஅandஅnotஅFLAGS.export_zip:நஅஅஅஅஅஅஅஅஅஅஅஅtfv0.reset_default_graph()நஅஅஅஅஅஅஅஅஅஅஅஅexport()நநஅஅஅஅஅஅஅஅifஅFLAGS.export_zip:நஅஅஅஅஅஅஅஅஅஅஅஅtfv0.reset_default_graph()நஅஅஅஅஅஅஅஅஅஅஅஅFLAGS.export_tfliteஅ=அTrueநநஅஅஅஅஅஅஅஅஅஅஅஅifஅlistdir_remote(FLAGS.export_dir):நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlog_error('Directoryஅ{}அisஅnotஅempty,அpleaseஅfixஅthis.'.format(FLAGS.export_dir))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅஅஅஅஅஅஅஅஅexport()நஅஅஅஅஅஅஅஅஅஅஅஅpackage_zip()நநஅஅஅஅஅஅஅஅifஅFLAGS.one_shot_infer:நஅஅஅஅஅஅஅஅஅஅஅஅtfv0.reset_default_graph()நஅஅஅஅஅஅஅஅஅஅஅஅdo_single_file_inference(FLAGS.one_shot_infer)நநநdefஅrun_script():நஅஅஅஅcreate_flags()நஅஅஅஅabsl.app.run(main)நநifஅ__name__அ==அ'__main__':நஅஅஅஅrun_script()ந#!/usr/bin/envஅpythonந#அ-*-அcoding:அutf-0அ-*-நfromஅ__future__அimportஅabsolute_import,அdivision,அprint_functionநநimportஅjsonநimportஅsysநநfromஅmultiprocessingஅimportஅcpu_countநநimportஅabsl.appநimportஅprogressbarநimportஅtensorflowஅasஅtfநimportஅtensorflow.compat.v0அasஅtfv0நநfromஅds_ctcdecoderஅimportஅctc_beam_search_decoder_batch,அScorerநfromஅsix.movesஅimportஅzipநநfromஅ.util.configஅimportஅConfig,அinitialize_globalsநfromஅ.util.checkpointsஅimportஅload_graph_for_evaluationநfromஅ.util.evaluate_toolsஅimportஅcalculate_and_print_report,அsave_samples_jsonநfromஅ.util.feedingஅimportஅcreate_datasetநfromஅ.util.flagsஅimportஅcreate_flags,அFLAGSநfromஅ.util.helpersஅimportஅcheck_ctcdecoder_versionநfromஅ.util.loggingஅimportஅcreate_progressbar,அlog_error,அlog_progressநநcheck_ctcdecoder_version()நநdefஅsparse_tensor_value_to_texts(value,அalphabet):நஅஅஅஅr"""நஅஅஅஅGivenஅaஅ:class:`tf.SparseTensor`அ``value``,அreturnஅanஅarrayஅofஅPythonஅstringsநஅஅஅஅrepresentingஅitsஅvalues,அconvertingஅtokensஅtoஅstringsஅusingஅ``alphabet``.நஅஅஅஅ"""நஅஅஅஅreturnஅsparse_tuple_to_texts((value.indices,அvalue.values,அvalue.dense_shape),அalphabet)நநநdefஅsparse_tuple_to_texts(sp_tuple,அalphabet):நஅஅஅஅindicesஅ=அsp_tuple[0]நஅஅஅஅvaluesஅ=அsp_tuple[0]நஅஅஅஅresultsஅ=அ[[]அforஅ_அinஅrange(sp_tuple[0][0])]நஅஅஅஅforஅi,அindexஅinஅenumerate(indices):நஅஅஅஅஅஅஅஅresults[index[0]].append(values[i])நஅஅஅஅ#அListஅofஅstringsநஅஅஅஅreturnஅ[alphabet.Decode(res)அforஅresஅinஅresults]நநநdefஅevaluate(test_csvs,அcreate_model):நஅஅஅஅifஅFLAGS.scorer_path:நஅஅஅஅஅஅஅஅscorerஅ=அScorer(FLAGS.lm_alpha,அFLAGS.lm_beta,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅFLAGS.scorer_path,அConfig.alphabet)நஅஅஅஅelse:நஅஅஅஅஅஅஅஅscorerஅ=அNoneநநஅஅஅஅtest_setsஅ=அ[create_dataset([csv],நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbatch_size=FLAGS.test_batch_size,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtrain_phase=False,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅreverse=FLAGS.reverse_test,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlimit=FLAGS.limit_test)அforஅcsvஅinஅtest_csvs]நஅஅஅஅiteratorஅ=அtfv0.data.Iterator.from_structure(tfv0.data.get_output_types(test_sets[0]),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtfv0.data.get_output_shapes(test_sets[0]),நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅoutput_classes=tfv0.data.get_output_classes(test_sets[0]))நஅஅஅஅtest_init_opsஅ=அ[iterator.make_initializer(test_set)அforஅtest_setஅinஅtest_sets]நநஅஅஅஅbatch_wav_filename,அ(batch_x,அbatch_x_len),அbatch_yஅ=அiterator.get_next()நநஅஅஅஅ#அOneஅrateஅperஅlayerநஅஅஅஅno_dropoutஅ=அ[None]அ*அ0நஅஅஅஅlogits,அ_அ=அcreate_model(batch_x=batch_x,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅseq_length=batch_x_len,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdropout=no_dropout)நநஅஅஅஅ#அTransposeஅtoஅbatchஅmajorஅandஅapplyஅsoftmaxஅforஅdecoderநஅஅஅஅtransposedஅ=அtf.nn.softmax(tf.transpose(a=logits,அperm=[0,அ0,அ0]))நநஅஅஅஅlossஅ=அtfv0.nn.ctc_loss(labels=batch_y,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅinputs=logits,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsequence_length=batch_x_len)நநஅஅஅஅtfv0.train.get_or_create_global_step()நநஅஅஅஅ#அGetஅnumberஅofஅaccessibleஅCPUஅcoresஅforஅthisஅprocessநஅஅஅஅtry:நஅஅஅஅஅஅஅஅnum_processesஅ=அcpu_count()நஅஅஅஅexceptஅNotImplementedError:நஅஅஅஅஅஅஅஅnum_processesஅ=அ0நநஅஅஅஅwithஅtfv0.Session(config=Config.session_config)அasஅsession:நஅஅஅஅஅஅஅஅload_graph_for_evaluation(session)நநஅஅஅஅஅஅஅஅdefஅrun_test(init_op,அdataset):நஅஅஅஅஅஅஅஅஅஅஅஅwav_filenamesஅ=அ[]நஅஅஅஅஅஅஅஅஅஅஅஅlossesஅ=அ[]நஅஅஅஅஅஅஅஅஅஅஅஅpredictionsஅ=அ[]நஅஅஅஅஅஅஅஅஅஅஅஅground_truthsஅ=அ[]நநஅஅஅஅஅஅஅஅஅஅஅஅbarஅ=அcreate_progressbar(prefix='Testஅepochஅ|அ',நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwidgets=['Steps:அ',அprogressbar.Counter(),அ'அ|அ',அprogressbar.Timer()]).start()நஅஅஅஅஅஅஅஅஅஅஅஅlog_progress('Testஅepoch...')நநஅஅஅஅஅஅஅஅஅஅஅஅstep_countஅ=அ0நநஅஅஅஅஅஅஅஅஅஅஅஅ#அInitializeஅiteratorஅtoஅtheஅappropriateஅdatasetநஅஅஅஅஅஅஅஅஅஅஅஅsession.run(init_op)நநஅஅஅஅஅஅஅஅஅஅஅஅ#அFirstஅpass,அcomputeஅlossesஅandஅtransposedஅlogitsஅforஅdecodingநஅஅஅஅஅஅஅஅஅஅஅஅwhileஅTrue:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbatch_wav_filenames,அbatch_logits,அbatch_loss,அbatch_lengths,அbatch_transcriptsஅ=அ\நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅsession.run([batch_wav_filename,அtransposed,அloss,அbatch_x_len,அbatch_y])நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅexceptஅtf.errors.OutOfRangeError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbreakநநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅdecodedஅ=அctc_beam_search_decoder_batch(batch_logits,அbatch_lengths,அConfig.alphabet,அFLAGS.beam_width,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅnum_processes=num_processes,அscorer=scorer,நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅcutoff_prob=FLAGS.cutoff_prob,அcutoff_top_n=FLAGS.cutoff_top_n)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅpredictions.extend(d[0][0]அforஅdஅinஅdecoded)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅground_truths.extend(sparse_tensor_value_to_texts(batch_transcripts,அConfig.alphabet))நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅwav_filenames.extend(wav_filename.decode('UTF-0')அforஅwav_filenameஅinஅbatch_wav_filenames)நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlosses.extend(batch_loss)நநஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅstep_countஅ+=அ0நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅbar.update(step_count)நநஅஅஅஅஅஅஅஅஅஅஅஅbar.finish()நநஅஅஅஅஅஅஅஅஅஅஅஅ#அPrintஅtestஅsummaryநஅஅஅஅஅஅஅஅஅஅஅஅtest_samplesஅ=அcalculate_and_print_report(wav_filenames,அground_truths,அpredictions,அlosses,அdataset)நஅஅஅஅஅஅஅஅஅஅஅஅreturnஅtest_samplesநநஅஅஅஅஅஅஅஅsamplesஅ=அ[]நஅஅஅஅஅஅஅஅforஅcsv,அinit_opஅinஅzip(test_csvs,அtest_init_ops):நஅஅஅஅஅஅஅஅஅஅஅஅprint('Testingஅmodelஅonஅ{}'.format(csv))நஅஅஅஅஅஅஅஅஅஅஅஅsamples.extend(run_test(init_op,அdataset=csv))நஅஅஅஅஅஅஅஅreturnஅsamplesநநநdefஅmain(_):நஅஅஅஅinitialize_globals()நநஅஅஅஅifஅnotஅFLAGS.test_files:நஅஅஅஅஅஅஅஅlog_error('Youஅneedஅtoஅspecifyஅwhatஅfilesஅtoஅuseஅforஅevaluationஅviaஅ'நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅ'theஅ--test_filesஅflag.')நஅஅஅஅஅஅஅஅsys.exit(0)நநஅஅஅஅfromஅ.trainஅimportஅcreate_modelஅ#அpylint:அdisable=cyclic-import,import-outside-toplevelநஅஅஅஅsamplesஅ=அevaluate(FLAGS.test_files.split(','),அcreate_model)நநஅஅஅஅifஅFLAGS.test_output_file:நஅஅஅஅஅஅஅஅsave_samples_json(samples,அFLAGS.test_output_file)நநநdefஅrun_script():நஅஅஅஅcreate_flags()நஅஅஅஅabsl.app.run(main)நநifஅ__name__அ==அ'__main__':நஅஅஅஅrun_script()நdefஅvalidate_label(label):நஅஅஅஅreturnஅlabelநimportஅunittestநimportஅosநநfromஅds_ctcdecoderஅimportஅAlphabetநநclassஅTestAlphabetParsing(unittest.TestCase):நநஅஅஅஅdefஅ_ending_tester(self,அfile,அexpected):நஅஅஅஅஅஅஅஅalphabetஅ=அAlphabet(os.path.join(os.path.dirname(__file__),அ'test_data',அfile))நஅஅஅஅஅஅஅஅlabelஅ=அ''நஅஅஅஅஅஅஅஅlabel_idஅ=அ-0நஅஅஅஅஅஅஅஅforஅexpected_label,அexpected_label_idஅinஅexpected:நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabel_idஅ=அalphabet.Encode(expected_label)நஅஅஅஅஅஅஅஅஅஅஅஅexceptஅKeyError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅpassநஅஅஅஅஅஅஅஅஅஅஅஅself.assertEqual(label_id,அ[expected_label_id])நஅஅஅஅஅஅஅஅஅஅஅஅtry:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅlabelஅ=அalphabet.Decode([expected_label_id])நஅஅஅஅஅஅஅஅஅஅஅஅexceptஅKeyError:நஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅஅpassநஅஅஅஅஅஅஅஅஅஅஅஅself.assertEqual(label,அexpected_label)நநஅஅஅஅdefஅtest_macos_ending(self):நஅஅஅஅஅஅஅஅself._ending_tester('alphabet_macos.txt',அ[('a',அ0),அ('b',அ0),அ('c',அ0)])நநஅஅஅஅdefஅtest_unix_ending(self):நஅஅஅஅஅஅஅஅself._ending_tester('alphabet_unix.txt',அ[('a',அ0),அ('b',அ0),அ('c',அ0)])நநஅஅஅஅdefஅtest_windows_ending(self):நஅஅஅஅஅஅஅஅself._ending_tester('alphabet_windows.txt',அ[('a',அ0),அ('b',அ0),அ('c',அ0)])நநifஅ__name__அ==அ'__main__':நஅஅஅஅunittest.main()நimportஅunittestநநfromஅargparseஅimportஅNamespaceநfromஅdeepspeech_training.util.importersஅimportஅvalidate_label_eng,அget_validate_labelநfromஅpathlibஅimportஅPathநநdefஅfrom_here(path):நஅஅஅஅhereஅ=அPath(__file__)நஅஅஅஅreturnஅhere.parentஅ/அpathநநclassஅTestValidateLabelEng(unittest.TestCase):நஅஅஅஅdefஅtest_numbers(self):நஅஅஅஅஅஅஅஅlabelஅ=அvalidate_label_eng("thisஅisஅaஅ0அ0அ0அtest")நஅஅஅஅஅஅஅஅself.assertEqual(label,அNone)நநclassஅTestGetValidateLabel(unittest.TestCase):நநஅஅஅஅdefஅtest_no_validate_label_locale(self):நஅஅஅஅஅஅஅஅfஅ=அget_validate_label(Namespace())நஅஅஅஅஅஅஅஅself.assertEqual(f('toto'),அ'toto')நஅஅஅஅஅஅஅஅself.assertEqual(f('toto0000'),அNone)நஅஅஅஅஅஅஅஅself.assertEqual(f('toto0000[{[{[]'),அNone)நநஅஅஅஅdefஅtest_validate_label_locale_default(self):நஅஅஅஅஅஅஅஅfஅ=அget_validate_label(Namespace(validate_label_locale=None))நஅஅஅஅஅஅஅஅself.assertEqual(f('toto'),அ'toto')நஅஅஅஅஅஅஅஅself.assertEqual(f('toto0000'),அNone)நஅஅஅஅஅஅஅஅself.assertEqual(f('toto0000[{[{[]'),அNone)நநஅஅஅஅdefஅtest_get_validate_label_missing(self):நஅஅஅஅஅஅஅஅargsஅ=அNamespace(validate_label_locale=from_here('test_data/validate_locale_ger.py'))நஅஅஅஅஅஅஅஅfஅ=அget_validate_label(args)நஅஅஅஅஅஅஅஅself.assertEqual(f,அNone)நநஅஅஅஅdefஅtest_get_validate_label(self):நஅஅஅஅஅஅஅஅargsஅ=அNamespace(validate_label_locale=from_here('test_data/validate_locale_fra.py'))நஅஅஅஅஅஅஅஅfஅ=அget_validate_label(args)நஅஅஅஅஅஅஅஅlஅ=அf('toto')நஅஅஅஅஅஅஅஅself.assertEqual(l,அ'toto')நநifஅ__name__அ==அ'__main__':நஅஅஅஅunittest.main()நimportஅunittestநநimportஅnumpyஅasஅnpநimportஅtensorflowஅasஅtfநfromஅdeepspeech_training.util.helpersஅimportஅValueRange,அget_value_range,அpick_value_from_range,அtf_pick_value_from_rangeநநநclassஅTestValueRange(unittest.TestCase):ந